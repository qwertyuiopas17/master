<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sehat Sahara - Doctor Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: rgba(245, 245, 245, 0.6);
            --card-bg-color: rgba(255, 255, 255, 0.7);
            --text-color: #0f172a;
            --text-color-secondary: #475569;
            --primary-color: #0d9488;
            --primary-color-light: #2dd4bf;
            --primary-color-dark: #14b8a6;
            --sos-color: #ef4444;
            --border-color: rgba(0, 0, 0, 0.07);
            --shadow-color: rgba(100, 116, 139, 0.1);
            --font-family: 'Poppins', sans-serif;
            --color-secondary: #f1f5f9;
            --radius-lg: 16px;
            --color-video: #3b82f6;
            --color-audio: #16a34a;
            --color-photo: #f97316;
            --color-pending: #f59e0b;
            --color-paid: #22c55e;
        }

        [data-theme="dark"] {
            --bg-color: rgba(20, 20, 30, 0.75);
            --card-bg-color: rgba(30, 41, 59, 0.6);
            --text-color: #e2e8f0;
            --text-color-secondary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.12);
            --primary-color: var(--primary-color-dark);
            --color-secondary: #334155;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        html { scroll-behavior: smooth; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: var(--font-family); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            line-height: 1.6; 
            padding-bottom: 80px; /* Space for bottom nav */
            transition: background-color 0.3s, color 0.3s;
        }
        .main-container { position: relative; min-height: 100vh; width: 100vw; }
        .background-image { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-image: url('https://i.ibb.co/84XpXLXW/hero-pic.png'); 
            background-size: cover; background-position: center; 
            filter: blur(14px) brightness(0.9); 
            transform: scale(1.15); z-index: -1; 
            transition: filter 0.3s;
        }
        [data-theme="dark"] .background-image { filter: blur(14px) brightness(0.6); }

        .page-content { flex-grow: 1; padding: 1rem; max-width: 1200px; margin: 0 auto; width: 100%; padding-top: 80px; }
        
        /* Header */
        .header {
            position: fixed; top: 1rem; left: 50%; transform: translateX(-50%);
            width: calc(100% - 2rem); max-width: 1200px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1.25rem; z-index: 1000;
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            border-radius: 999px;
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
        }
        .header .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        .header .actions { display: flex; align-items: center; gap: 0.75rem; }
        
        .top-nav { display: none; align-items: center; gap: 0.25rem; }
        .top-nav a { text-decoration: none; color: var(--text-color-secondary); font-weight: 500; padding: 0.5rem 1.25rem; border-radius: 999px; transition: all 0.25s ease; position: relative; }
        .top-nav a:hover { color: var(--text-color); background-color: rgba(128, 128, 128, 0.1); }
        .top-nav a.active { color: var(--text-color); background-color: rgba(128, 128, 128, 0.15); }

        .btn { padding: 0.6rem 1.2rem; border-radius: 9999px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.25s ease; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.12); }
        .btn-sos { background-color: var(--sos-color); color: white; }
        .btn-primary { background-color: var(--primary-color); color: white; border: 2px solid var(--primary-color); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 12px; }
        .btn-call { background-color: var(--color-audio); color: white; }
        .btn-message { background-color: var(--color-video); color: white; }
        .btn-neutral { background-color: white; color: var(--text-color-secondary); border: 1px solid var(--border-color); }
        .btn-neutral:hover { background-color: #f8fafc; }

        [data-theme="dark"] .btn-neutral {
            background-color: var(--color-secondary);
            color: var(--text-color);
        }
        [data-theme="dark"] .btn-neutral:hover {
            background-color: #475569;
        }


        .card { 
            background-color: var(--card-bg-color); border-radius: var(--radius-lg); 
            padding: 1.5rem; border: 1px solid var(--border-color); 
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); 
            box-shadow: 0 8px 32px 0 var(--shadow-color); transition: all 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px 0 var(--shadow-color); }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Dashboard Screen */
        .welcome-card { 
            background: linear-gradient(45deg, var(--primary-color), var(--primary-color-light)); 
            color: white; 
            margin-bottom: 1.5rem;
            margin-top: 2rem;
        }
        .welcome-card h1 { font-size: 2.25rem; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .info-card { cursor: pointer; transition: all 0.2s ease-in-out; }
        .info-card:hover { transform: scale(1.03); box-shadow: 0 10px 30px 0 var(--shadow-color); }
        .info-card h3 { font-size: 1rem; }
        .info-card .highlight { font-size: 1.25rem; font-weight: 600; }
        
        /* Appointments & History*/
        .appointments-list { display: flex; flex-direction: column; gap: 1rem; }
        .appointment-card, .history-card { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; }
        .appointment-card-details h4 { font-size: 1.1rem; }
        .appointment-card-details p { font-size: 0.9rem; color: var(--text-color-secondary); }
        .appointment-type-indicator { width: 10px; height: 40px; border-radius: 5px; margin-right: 1rem; }
        .type-video { background-color: var(--color-video); }
        .type-audio { background-color: var(--color-audio); }
        .type-photo { background-color: var(--color-photo); }
        .appointment-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end; }
        
        /* Page Headers */
        .page-header { text-align: center; margin-bottom: 2rem; margin-top: 2rem; }
        .page-header h1 { font-size: 2rem; }

        /* History */
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.8rem; font-weight: 600; color: white; text-transform: capitalize; }
        .status-done { background-color: var(--color-paid); }
        .status-missed { background-color: var(--sos-color); }
        .status-rescheduled { background-color: var(--color-pending); }


        /* Consultation Screen */
        .consultation-view { 
            text-align: center; 
            background: linear-gradient(145deg, rgba(173, 216, 230, 0.5), rgba(240, 248, 255, 0.5));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 2rem;
        }
        .consultation-view h1 { font-size: 1.75rem; margin-bottom: 1.5rem; color: var(--text-color); }
        .video-placeholder { width: 100%; max-width: 600px; height: 400px; background: #000; color: white; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-lg); margin: 1rem auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* Prescription Form */
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control { width: 100%; padding: 0.85rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--color-secondary); color: var(--text-color); }
        .upload-area { border: 2px dashed var(--border-color); border-radius: var(--radius-lg); padding: 2rem; text-align: center; cursor: pointer; }
        .upload-area:hover { border-color: var(--primary-color); }

        /* Add this to your existing <style> block in doctor.html */
#start-recording-btn {
    transition: background-color 0.3s ease; /* Smooth transition */
}
#start-recording-btn:disabled {
    cursor: not-allowed;
    opacity: 0.7;
}
/* Style for when recording is active */
#start-recording-btn.recording-active,
#start-recording-btn.recording-active:hover {
    background-color: #dc3545 !important; /* Red */
    border-color: #dc3545 !important;
}
/* Style for when processing */
#start-recording-btn:disabled:not(.recording-active) {
     background-color: #6c757d !important; /* Grey when processing */
     border-color: #6c757d !important;
}
        
        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; background-color: var(--card-bg-color); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); box-shadow: 0 -4px 20px var(--shadow-color); border-top: 1px solid var(--border-color); padding: 0.5rem 0; z-index: 1000; }
        .nav-button { background: none; border: none; cursor: pointer; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-color-secondary); padding: 0.5rem 0; transition: color 0.2s ease; }
        .nav-button.active { color: var(--primary-color); font-weight: 600; }
        .nav-button svg { width: 24px; height: 24px; }
        .nav-button span { font-size: 12px; }
        
        /* Language & Theme */
        .language-dropdown { position: relative; }
        .language-dropdown-toggle { cursor: pointer; background: transparent; border: none; color: var(--text-color-secondary); font-size: 1rem; padding: 8px; display: flex; align-items: center; border-radius: 999px; }
        .language-dropdown-menu { display: none; position: absolute; top: calc(100% + 8px); right: 0; min-width: 150px; border-radius: var(--radius-lg); padding: 8px; background: var(--card-bg-color); border: 1px solid var(--border-color); z-index: 1001; }
        .language-dropdown.open .language-dropdown-menu { display: block; }
        .language-option { display: block; padding: 8px 12px; color: var(--text-color-secondary); border-radius: 8px; cursor: pointer; }
        .theme-toggle { cursor: pointer; background-color: transparent; border: none; padding: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-color-secondary); }

        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg-color); border-radius: var(--radius-lg); padding: 2rem; max-width: 500px; width: calc(100% - 2rem); text-align: left; }
        .modal-content h3 { margin-bottom: 1rem; text-align: center; }
        .modal-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; }
        
        /* AI Summary & Rx Modals */
        .summary-section { margin-bottom: 1rem; }
        .summary-section h4 { font-weight: 600; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 0.5rem;}
        .summary-section ul, .summary-section p { list-style: none; padding-left: 0.5rem; }
        .summary-section li { margin-bottom: 0.25rem; }
        [data-theme="dark"] #prescriptionViewModal .modal-content { color: var(--text-color); }

        /* Message Modal */
        .chat-box { background-color: var(--color-secondary); border-radius: 8px; padding: 1rem; height: 40vh; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; }
        .chat-message { padding: 0.75rem 1rem; border-radius: 12px; max-width: 80%; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border-color); line-height: 1.4; }
        .patient-message { background: white; border-radius: 12px 12px 12px 0; align-self: flex-start; }
        .doctor-message { background: var(--primary-color-light); color: white; border-radius: 12px 12px 0 12px; align-self: flex-end; }
        [data-theme="dark"] .patient-message { background: #475569; }
        .message-time { display: block; text-align: right; font-size: 0.75rem; margin-top: 0.25rem; }
        .patient-message .message-time { color: var(--text-color-secondary); }
        .doctor-message .message-time { color: rgba(255,255,255,0.7); }
        .chat-input-area { display: flex; gap: 0.5rem; margin-top: 1rem; align-items: center; }
        
        /* Responsive */
        @media (min-width: 768px) { .bottom-nav { display: none; } .top-nav { display: flex; } .header .actions { gap: 1rem; } .header { border-radius: 999px; } }
        @media (max-width: 767px) { 
            .header { position: static; transform: none; width: 100%; border-radius: 0; padding: 1rem; } 
            .page-content { padding-top: 1rem; } 
            .info-grid { grid-template-columns: 1fr; } 
            .appointment-card, .history-card { flex-direction: column; align-items: flex-start; gap: 1rem; } 
            .appointment-actions { width: 100%; justify-content: center; }
            .status-badge { width: 100%; text-align: center; }
        }
    </style>
</head>
<script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.2.js"></script>
<body data-theme="light">
    <div class="main-container">
        <div class="background-image"></div>
        <header class="header">
            <div class="logo">Sehat Sahara</div>
            <nav class="top-nav">
                <a href="#" class="active" data-key="dashboard_nav" data-screen="dashboardScreen">Dashboard</a>
                <a href="#" data-key="appointments_nav" data-screen="appointmentsScreen">Appointments</a>
                <a href="#" data-key="upload_nav" data-screen="uploadRxScreen">Upload Rx</a>
                <a href="#" data-key="earnings_nav" data-screen="earningsScreen">Earnings</a>
            </nav>
            <div class="actions">
                <div class="language-dropdown">
                    <button class="language-dropdown-toggle"><span id="selectedLanguage">English</span></button>
                    <div class="language-dropdown-menu"></div>
                </div>
                <button class="theme-toggle" id="themeToggle">
                    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                 <button class="btn" id="logoutBtn" style="background-color: var(--text-color-secondary); color: white;" data-key="logout">Logout</button>
            </div>
        </header>
        <div class="page-content">
            <main class="main">
                <section id="dashboardScreen" class="screen active">
                     <div class="welcome-card card">
                        <h1 id="welcomeMessage" data-key="welcome_message">Welcome, Dr. Verma</h1>
                        <p data-key="welcome_subtitle">Your dashboard is ready.</p>
                    </div>
                    <div class="info-grid">
                        <div class="card" style="margin-top: 1.5rem; text-align: center;">
                        <h3>Demonstration</h3>
                        <p>Use this to connect to a patient's "Live Demo Call" for presentation.</p>
                        <button class="btn btn-primary" id="joinDemoCallBtn" style="margin-top: 1rem;">Join Demo Call</button>
                    </div>
                        <div class="info-card card" data-screen="appointmentsScreen"><h3 data-key="upcoming_appointments">Upcoming Appointments</h3><p class="highlight">3</p><p data-key="for_today">For today</p></div>
                        <div class="info-card card" data-screen="historyScreen"><h3 data-key="recent_activity">Recent Activity</h3><p class="highlight">7</p><p data-key="last_4_days">Last 4 days</p></div>
                    </div>
                </section>
                
                <section id="appointmentsScreen" class="screen">
                    <div class="page-header"><h1 data-key="appointments_title">Today's Appointments</h1></div>
                    <div class="appointments-list" id="appointmentsList"></div>
                </section>
                
                <section id="historyScreen" class="screen">
                    <div class="page-header"><h1 data-key="history_title">Recent Activity</h1></div>
                    <div id="historyList" class="appointments-list"></div>
                </section>

                <section id="uploadRxScreen" class="screen">
                    <div class="page-header"><h1 data-key="upload_rx_title">Upload Offline Prescription</h1></div>
                     <form class="card" id="uploadRxForm">
                        <div class="form-group">
                            <label for="patient-select" data-key="select_patient">Select Patient</label>
                            <select id="patient-select" class="form-control"><option>Ramesh Kumar</option><option>Sunita Devi</option></select>
                        </div>
                        <div class="form-group">
                             <label data-key="upload_image">Upload Prescription Image</label>
                            <label data-key="upload_image">Upload Prescription Image</label>
                        <input type="file" id="prescriptionFile" class="form-control" accept="image/*" style="padding: 1rem; height: auto;">
                        <p data-key="drag_drop" style="text-align: center; margin-top: 0.5rem; color: var(--text-color-secondary);">Select an image file to upload.</p>
                        </label>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width:100%" data-key="save_to_record">Save to Patient Record</button>
                    </form>
                </section>

                <section id="earningsScreen" class="screen">
                    <div class="page-header"><h1 data-key="earnings_title">Earnings & History</h1></div>
                    <div class="card">
                        <div id="earningsList"></div>
                    </div>
                </section>
                <section id="prescriptionWriterScreen" class="screen">
    <div class="page-header"><h1 data-key="prescription_writer_title">New Digital Prescription</h1></div>
     <form class="card" id="prescriptionForm">
        <p style="margin-bottom: 1rem;"><strong>Patient:</strong> <span id="prescriptionPatientName">No patient selected</span></p>

        <div class="form-group text-center" style="margin-bottom: 2rem;">
            <button type="button" class="btn btn-lg" id="start-recording-btn" style="width: 100%; max-width: 300px; margin: auto; padding: 1rem 0; background-color: #28a745; color: white;">
                <span id="record-icon">🎤</span> <span id="record-text">Record Prescription via Speech</span>
            </button>
            <p id="recording-status" style="margin-top: 10px; font-weight: bold; color: #dc3545; display: none;">🔴 Recording... (Click again to stop)</p>
            <p id="processing-status" style="margin-top: 10px; font-weight: bold; color: var(--primary-color); display: none;">⚙️ Processing with AI, please wait...</p>
        </div>

        <hr style="margin-top: 1rem; margin-bottom: 2rem; border-top: 1px solid var(--border-color);">

        <h4 style="text-align: center; margin-bottom: 1.5rem; color: var(--text-color-secondary);">AI Generated Output (Review & Edit)</h4>

        <div class="form-group">
            <label for="medicine-name" data-key="medicine_name">Medicine Name</label>
            <input type="text" id="medicine-name" class="form-control" placeholder="AI will fill this (e.g., Paracetamol 500mg)">
        </div>

        <div class="form-group">
            <label for="medicine-dosage" data-key="dosage">Dosage Instructions</label>
            <input type="text" id="medicine-dosage" class="form-control" placeholder="AI will fill this (e.g., 1 tablet twice a day after food for 3 days)">
        </div>

        <div class="form-group">
            <label for="medicine-advice" data-key="advice">General Advice (Optional)</label>
            <textarea id="medicine-advice" class="form-control" rows="3" placeholder="AI will fill this if mentioned (e.g., Drink plenty of water.)"></textarea>
        </div>

        <button type="submit" class="btn btn-primary" style="width:100%; margin-top: 1rem;" data-key="send_prescription">Sign & Send Prescription</button>
    </form>
</section>

                <section id="consultationScreen" class="screen">
    <div class="consultation-view card">
        <h1 id="consultationHeader"></h1>
        <div class="video-container" style="display: flex; justify-content: center; position: relative; width: 100%; max-width: 600px; margin: 1rem auto; background-color: #000; border-radius: var(--radius-lg);">
            <video id="remoteVideo" autoplay playsinline style="width: 100%; border-radius: var(--radius-lg);"></video>
            <video id="localVideo" autoplay playsinline muted style="width: 150px; position: absolute; bottom: 1rem; right: 1rem; border: 2px solid white; border-radius: 8px;"></video>
        </div>
        <div class="modal-actions" style="justify-content: center;">
             <button class="btn btn-primary" id="startCallBtn">Start Call</button>
             
        <button class="btn btn-sos" id="endCallBtn" data-key="end_call">End Call</button> </div>
        <div id="connectionStatus" style="text-align: center; margin-top: 1rem; padding: 0.5rem; border-radius: 8px; background: rgba(0,0,0,0.1); display: none;">
            <span id="statusText">Connecting...</span>
        </div>
        <div id="videoStatus" style="text-align: center; margin-top: 0.5rem; padding: 0.25rem; font-size: 0.8rem; color: var(--text-color-secondary); display: none;">
            <span id="videoStatusText">Video status will appear here</span>
        </div>
    </div>
</section>

                
            </main>
        </div>
    </div>
    
    <nav class="bottom-nav">
        <button class="nav-button active" data-screen="dashboardScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span data-key="dashboard_nav">Dashboard</span></button>
        <button class="nav-button" data-screen="appointmentsScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span data-key="appointments_nav">Appointments</span></button>
        <button class="nav-button" data-screen="uploadRxScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.8-3.3-4.9-6.3-4.9h-1.2c-.3-1.4-1-2.7-2.1-3.6-1.5-1.2-3.5-1.4-5.2-.6S3 4.9 3 6.8v.2c0 2.4 1.7 4.5 4 5.1"/><path d="M8 12h8"/><path d="M12 16v-8"/></svg><span data-key="upload_nav">Upload Rx</span></button>
        <button class="nav-button" data-screen="earningsScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg><span data-key="earnings_nav">Earnings</span></button>
    </nav>
    
    <!-- Modals -->
    <div id="aiSummaryModal" class="modal">
        <div class="modal-content">
            <h3 id="summaryModalTitle"></h3>
            <div class="summary-section">
                <h4 data-key="summary_symptoms">Logged Symptoms</h4>
                <ul id="summarySymptoms"></ul>
            </div>
             <div class="summary-section">
                <h4 data-key="summary_vitals">Recent Vitals (from ASHA)</h4>
                <ul id="summaryVitals"></ul>
            </div>
             <div class="summary-section">
                <h4 data-key="summary_prescriptions">Active Prescriptions</h4>
                <ul id="summaryPrescriptions"></ul>
            </div>
            <div class="modal-actions">
                <button class="btn" id="closeSummaryModal" style="background: var(--color-secondary); color: var(--text-color);">Close</button>
                <button class="btn btn-primary" id="writeRxFromSummaryBtn" data-key="write_prescription">Write Prescription</button>
            </div>
        </div>
    </div>
    
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <h3 id="messageModalTitle">Message Patient</h3>
            <div id="chatBox" class="chat-box">
                <!-- Messages will be dynamically injected here -->
            </div>
            <div class="chat-input-area">
                <textarea id="doctor-reply" class="form-control" rows="2" placeholder="Type your reply..."></textarea>
                <button id="sendMessageBtn" class="btn btn-primary" style="border-radius: 8px; padding: 0.85rem;">Send</button>
            </div>
            <button class="btn" id="closeMessageModal" style="background: var(--color-secondary); color: var(--text-color); width: 100%; margin-top: 1rem;">Close Conversation</button>
        </div>
    </div>

    <div id="prescriptionViewModal" class="modal">
        <div class="modal-content">
            <h3>Last Digital Prescription for <span id="rxPatientName"></span></h3>
            <div class="summary-section">
                <h4 data-key="medicine_name">Medicine Name</h4>
                <p id="rxMedicine"></p>
            </div>
            <div class="summary-section">
                <h4 data-key="dosage">Dosage</h4>
                <p id="rxDosage"></p>
            </div>
            <div class="summary-section">
                <h4 data-key="advice">Advice</h4>
                <p id="rxAdvice"></p>
            </div>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn btn-primary" id="closeRxModal">Close</button>
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="modal"><div class="modal-content" style="text-align:center;"><h3 id="modalTitle"></h3><p id="modalMessage"></p><button class="btn btn-primary" id="closeModal">OK</button></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            //const API_BASE_URL = 'https://sahara-sathi.onrender.com/v1';
            const API_BASE_URL = '/api';// <-- ADD THIS LINE
            let doctor = null;
            let currentLanguage = 'en';
            let currentAppointment = null;
            let appointmentPollingInterval = null;
            // <<<--- ADD THIS ENTIRE WEBRTC SECTION ---<<<
            
            let mediaRecorder;
            let audioChunks = [];
            let isRecording = false;
            let currentStream = null;
            // WebRTC variables
// --- START: Agora Variables ---
const AGORA_APP_ID = "5ce1cf67c1f142478e0f3ed61cb8958f"; // Use the SAME App ID

let agoraClient = null
let localAudioTrack = null;
let localVideoTrack = null;
let remoteUser = null; // To keep track of the remote participant
let currentChannelName = null; // Will be set based on appointmentId
// --- END: Agora Variables ---

            const startRecordingBtn = document.getElementById('start-recording-btn');
            const recordIcon = document.getElementById('record-icon');
            const recordText = document.getElementById('record-text');
            const recordingStatus = document.getElementById('recording-status');
            const processingStatus = document.getElementById('processing-status');

            const prescriptionForm = document.getElementById('prescriptionForm');
            const medicineNameInput = document.getElementById('medicine-name');
            const medicineDosageInput = document.getElementById('medicine-dosage');
            const medicineAdviceInput = document.getElementById('medicine-advice');
            const patientNameSpan = document.getElementById('prescriptionPatientName');


            
            const clearPrescriptionForm = () => {
                medicineNameInput.value = '';
                medicineDosageInput.value = '';
                medicineAdviceInput.value = '';
                // Don't clear patientId or name here, as it's set by navigation context
            };
            const resetRecordingUI = (enableButton = true) => {
                isRecording = false;
                recordIcon.textContent = '🎤';
                recordText.textContent = 'Record Prescription via Speech';
                startRecordingBtn.style.backgroundColor = '#28a745'; // Reset to green
                recordingStatus.style.display = 'none';
                processingStatus.style.display = 'none';
                startRecordingBtn.disabled = !enableButton;
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
            };
            // --- ADD THIS ENTIRE FUNCTION ---
        function setupAiPrescription() {
            
            // Check if the button exists before proceeding
            if (!startRecordingBtn) {
                console.warn("AI Prescription recording button not found on this page.");
                return; // Exit if the button isn't part of the current view
            }

            

            // Check for MediaRecorder support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !window.MediaRecorder) {
                console.warn('Audio recording or MediaRecorder API not supported.');
                startRecordingBtn.textContent = 'Recording Not Supported';
                startRecordingBtn.disabled = true;
                return;
            }


            

            // Call once on script load to set initial state
            resetRecordingUI();

            startRecordingBtn.addEventListener('click', async () => {
                const currentPatientId = prescriptionForm.dataset.patientId;
                if (!currentPatientId) {
                    showConfirmationModal('Patient Not Selected', 'Please view a patient\'s summary or start a call before recording a prescription.');
                    return;
                }

                if (!isRecording) {
                    // --- Start Recording ---
                    try {
                        currentStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                        const options = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
                            ? { mimeType: 'audio/webm;codecs=opus' }
                            : MediaRecorder.isTypeSupported('audio/webm')
                            ? { mimeType: 'audio/webm' }
                            : {};

                        mediaRecorder = new MediaRecorder(currentStream, options);
                        audioChunks = [];

                        mediaRecorder.ondataavailable = event => {
                            if (event.data.size > 0) audioChunks.push(event.data);
                        };

                        mediaRecorder.onstop = async () => {
                            if (audioChunks.length === 0) {
                                console.warn("No audio data recorded.");
                                showConfirmationModal('Recording Error', 'No audio was recorded. Microphone might not be capturing input.');
                                resetRecordingUI();
                                return;
                            }

                            const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                            // Use a more specific filename if desired
                            const audioFile = new File([audioBlob], `prescription_${currentPatientId}_${Date.now()}.webm`, { type: mediaRecorder.mimeType || 'audio/webm' });

                            recordingStatus.style.display = 'none';
                            processingStatus.style.display = 'block';
                            startRecordingBtn.disabled = true;
                            recordText.textContent = 'Processing AI...';

                            const formData = new FormData();
                            formData.append('audio', audioFile);
                            formData.append('patientId', currentPatientId);

                            try {
                                console.log(`Sending audio for patient ${currentPatientId}...`);
                                const response = await fetch(`${API_BASE_URL}/v1/doctor/generate-prescription-from-speech`, {
                                    method: 'POST',
                                    body: formData,
                                    credentials: 'include' // Crucial for authentication
                                });

                                const data = await response.json();
                                console.log("Backend AI response:", data);

                                if (response.ok && data.success) {
                                    const structuredRx = data.structuredPrescription;
                                    medicineNameInput.value = structuredRx.medicineName || '';
                                    medicineDosageInput.value = structuredRx.dosage || '';
                                    medicineAdviceInput.value = structuredRx.advice || '';
                                    // Optional: Briefly show success before resetting button
                                    processingStatus.textContent = '✅ Draft Ready!';
                                    await new Promise(resolve => setTimeout(resolve, 1500)); // Show checkmark briefly
                                } else {
                                     // Provide specific feedback based on backend message
                                     showConfirmationModal('AI Processing Failed', data.message || `Server error: ${response.status}. Please try again or enter manually.`);
                                }
                            } catch (error) {
                                console.error('Error sending audio or processing AI response:', error);
                                showConfirmationModal('Network Error', `Could not reach AI service: ${error.message}. Please check connection or enter manually.`);
                            } finally {
                                // Always reset the UI after processing attempt
                                resetRecordingUI();
                            }
                        };

                        mediaRecorder.start();
                        isRecording = true;

                        recordIcon.textContent = '■';
                        recordText.textContent = 'Stop Recording';
                        startRecordingBtn.style.backgroundColor = '#dc3545'; // Red color
                        recordingStatus.style.display = 'block';
                        processingStatus.style.display = 'none';
                        clearPrescriptionForm(); // Clear fields for new recording

                    } catch (err) {
                        console.error('Error accessing microphone/starting recorder:', err);
                        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                            showConfirmationModal('Permission Denied', 'Microphone access is required. Please allow permission in browser settings.');
                        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                             showConfirmationModal('No Microphone', 'No microphone found on your device.');
                        } else {
                             showConfirmationModal('Microphone Error', 'Could not start recording. Ensure microphone is working and allowed.');
                        }
                        resetRecordingUI(false); // Keep button disabled if mic failed critically
                    }
                } else {
                    // --- Stop Recording ---
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                         mediaRecorder.stop(); // This triggers the 'onstop' event
                    }
                     // UI reset happens within the 'onstop' handler after processing
                }
            });

            // Set up listener for the form submission (digital prescription save)
            // This listener should already exist in your setupFormsAndModals,
            // ensure it correctly reads the patientId from prescriptionForm.dataset.patientId
            // and sends the content of the input fields.
             prescriptionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const patientId = e.target.dataset.patientId; // Get patient context
                if (!patientId) {
                    showConfirmationModal('Error', 'No patient context. Please select a patient first.');
                    return;
                }
                const medicineName = medicineNameInput.value.trim();
                const dosage = medicineDosageInput.value.trim();
                const advice = medicineAdviceInput.value.trim();

                if (!medicineName || !dosage) {
                    showConfirmationModal('Missing Info', 'Please ensure Medicine Name and Dosage Instructions are filled (either by AI or manually).');
                    return;
                }

                // Show loading/saving state
                const submitButton = prescriptionForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.textContent;
                submitButton.textContent = 'Sending...';
                submitButton.disabled = true;

                try {
                    const response = await fetch(`${API_BASE_URL}/v1/doctor/create-digital-prescription`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify({
                            patientId,
                            medicineName,
                            dosage,
                            advice
                        })
                    });
                    // Check if the response was actually received and OK
                     if (!response.ok) {
                         // Try to get error message from backend if possible
                         let errorMsg = `Server error: ${response.status}`;
                         try {
                              const errorData = await response.json();
                              errorMsg = errorData.message || errorMsg;
                         } catch(jsonError) { /* Ignore if response not JSON */ }
                         throw new Error(errorMsg); // Throw error to be caught below
                     }
                    const data = await response.json();
                    if (data.success) {
                        showConfirmationModal('Prescription Sent', 'The digital prescription has been saved and sent to the patient.');
                        // Optionally clear form and navigate away
                        clearPrescriptionForm();
                        resetRecordingUI(); // Reset mic button too
                        showScreen('dashboardScreen');
                    } else {
                        throw new Error(data.message || 'Failed to save digital prescription.');
                    }
                } catch (error) {
                    showConfirmationModal('Save Failed', `Error saving prescription: ${error.message}`);
                } finally {
                    submitButton.textContent = originalButtonText;
                    submitButton.disabled = false;
                }
             });
        }
        // --- END OF setupAiPrescription FUNCTION ---

            
            // In doctor.html, inside the <script> block
// In doctor.html
function showCallScreen(patientName, appointmentId) { // <<< Use patientName here
    currentAppointmentId = appointmentId;
    currentChannelName = appointmentId;

    const headerElement = document.getElementById('consultationHeader');
    if (headerElement) headerElement.textContent = `Consultation with ${patientName}`; // <<< Use patientName here

    showScreen('consultationScreen'); // Doctor uses showScreen

    // Clear video elements and hide status
    const localVideoPlayer = document.getElementById('localVideo');
    const remoteVideoPlayer = document.getElementById('remoteVideo');
    if (localVideoPlayer) localVideoPlayer.innerHTML = '';
    if (remoteVideoPlayer) remoteVideoPlayer.innerHTML = '<p>Waiting to connect...</p>';
    hideConnectionStatus();

    // Initialize Agora Client if needed (or if disconnected)
    // Using agoraClient = null in leaveCall makes this check reliable
    if (!agoraClient || agoraClient.connectionState === 'DISCONNECTED') {
        console.log("Initializing Agora Client for new call...");
        initializeAgoraClient();
    } else {
        console.log("Agora Client already exists, state:", agoraClient.connectionState);
        // Even if client exists but wasn't fully cleaned up, ensure button is ready
    }

    // *** CRITICAL CHANGE: Ensure Start Button is ready ***
    const startBtn = document.getElementById('startCallBtn');
    if (startBtn) {
        startBtn.textContent = 'Start Call'; // Set text correctly
        startBtn.disabled = false;         // Ensure it's enabled
    } else {
        console.error("Start Call button not found!");
    }

    // *** REMOVED THE AUTOMATIC CALL TO joinAndPublish ***
    // console.log(`Attempting to join channel: ${appointmentId}`); // No longer joining here
    // joinAndPublish(appointmentId, TEMP_TOKEN); // <--- REMOVED THIS LINE
}



// Helper to set up data channel event listeners
function setupDataChannelEvents(channel) {
    channel.onmessage = event => console.log(`Doctor: Patient message: ${event.data}`); // Just log for now
    channel.onopen = () => console.log('Doctor: Data channel opened');
    channel.onclose = () => console.log('Doctor: Data channel closed');
    channel.onerror = (error) => console.error('Doctor: Data channel error:', error);
}

// Helper to play remote video robustly
async function playRemoteVideo(videoElement, retryCount = 0) {
     try {
         console.log(`Doctor: Attempting to play remote video (Attempt ${retryCount + 1})`);
         await videoElement.play();
         console.log('Doctor: Remote video playing successfully');
         showConnectionStatus('Remote video connected!', 'success'); // Update status
     } catch (e) {
         console.warn(`Doctor: Remote video play failed (Attempt ${retryCount + 1}):`, e);
         if (e.name === 'NotAllowedError') {
             showConnectionStatus('Video autoplay blocked. Click video to play.', 'warning');
             videoElement.addEventListener('click', () => playRemoteVideo(videoElement), { once: true });
         } else if (retryCount < 3) {
             setTimeout(() => playRemoteVideo(videoElement, retryCount + 1), 500); // Retry shortly
         } else {
              showConnectionStatus('Could not play remote video.', 'error');
         }
     }
}



// Helper function to process queued ICE candidates
async function processQueuedIceCandidates() {
    while (iceCandidateQueue.length > 0) {
        const candidate = iceCandidateQueue.shift();
        try {
            await peerConnection.addIceCandidate(candidate);
            console.log('Doctor: Processed queued ICE candidate');
        } catch (error) {
            console.warn('Doctor: Error adding queued ICE candidate:', error);
        }
    }
}




// UI Status Functions (showConnectionStatus, hideConnectionStatus, etc.) - Keep these
function showConnectionStatus(message, type = 'info') {
    const statusDiv = document.getElementById('connectionStatus');
    const statusText = document.getElementById('statusText');
    if (statusDiv && statusText) {
        statusText.textContent = message;
        let bgColor = 'rgba(0, 0, 0, 0.1)';
        let color = 'inherit';
        if (type === 'success') { bgColor = 'rgba(34, 197, 94, 0.2)'; color = '#16a34a'; }
        else if (type === 'error') { bgColor = 'rgba(239, 68, 68, 0.2)'; color = '#ef4444'; }
        else if (type === 'warning') { bgColor = 'rgba(245, 158, 11, 0.2)'; color = '#f59e0b'; }
        statusDiv.style.background = bgColor;
        statusDiv.style.color = color;
        statusDiv.style.display = 'block';
    }
}

function hideConnectionStatus() {
    const statusDiv = document.getElementById('connectionStatus');
    if (statusDiv) statusDiv.style.display = 'none';
}

// You might not need toggleAudio/toggleVideo if the buttons aren't in doctor UI
// function toggleAudio() { ... }
// function toggleVideo() { ... }



// --- START: Agora Functions ---

// Initialize Agora Client
function initializeAgoraClient() {
    agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

    // Event listener for when a remote user publishes tracks
    agoraClient.on("user-published", async (user, mediaType) => {
        await agoraClient.subscribe(user, mediaType);
        console.log("Subscribed to remote user:", user.uid, "MediaType:", mediaType);
        remoteUser = user; // Store the remote user

        if (mediaType === "video") {
            const remoteVideoTrack = user.videoTrack;
            const remoteVideoPlayer = document.getElementById("remoteVideo");
            remoteVideoPlayer.textContent = ""; // Clear any previous placeholder
            remoteVideoTrack.play("remoteVideo");
            showConnectionStatus('Patient connected!', 'success');
        }

        if (mediaType === "audio") {
            const remoteAudioTrack = user.audioTrack;
            remoteAudioTrack.play();
        }
    });

    // Event listener for when a remote user unpublishes tracks
    agoraClient.on("user-unpublished", (user, mediaType) => {
        console.log("Remote user unpublished:", user.uid, "MediaType:", mediaType);
        if (mediaType === "video") {
            // Optionally clear the video element or show a placeholder
            const remoteVideoPlayer = document.getElementById("remoteVideo");
            remoteVideoPlayer.innerHTML = '<p>Patient video stopped</p>';
        }
    });

    // Event listener for when a remote user leaves
    agoraClient.on("user-left", (user) => {
        console.log("Remote user left:", user.uid);
        remoteUser = null;
        const remoteVideoPlayer = document.getElementById("remoteVideo");
        remoteVideoPlayer.innerHTML = '<p>Patient has left the call</p>';
        showConnectionStatus('Patient left', 'warning');
        // Optionally end the call for the doctor too, or wait
    });

    // Handle network quality reports (optional)
    agoraClient.on("network-quality", (stats) => {
         console.log("Downlink network quality:", stats.downlinkNetworkQuality);
         console.log("Uplink network quality:", stats.uplinkNetworkQuality);
    });

     // Handle connection state changes
    agoraClient.on("connection-state-change", (curState, prevState, reason) => {
        console.log(`Agora Connection State Change: ${prevState} -> ${curState}, Reason: ${reason}`);
        if (curState === "DISCONNECTED" && reason !== "UID_BANNED" && reason !== "CHANNEL_BANNED") {
             // Handle temporary disconnections (e.g., network issues)
             showConnectionStatus('Connection lost, attempting to reconnect...', 'warning');
        } else if (curState === "CONNECTED") {
             showConnectionStatus('Connected to Agora channel', 'success');
             document.getElementById('startCallBtn').textContent = 'Call Active';
             document.getElementById('startCallBtn').disabled = true; // Disable after joining
        } else if (curState === "FAILED") {
             showConnectionStatus('Failed to connect to Agora. Check network/App ID.', 'error');
             leaveCall(); // Clean up on failure
        }
    });

}

// Join Agora Channel and Publish Tracks
async function joinAndPublish(channelName, token) {
    if (!agoraClient) {
        console.error("Agora client not initialized.");
        return;
    }
    currentChannelName = channelName;

    try {
        showConnectionStatus('Joining channel...', 'info');
        // Join the channel - Using UID 0 allows Agora to assign one automatically
        const uid = await agoraClient.join(AGORA_APP_ID, channelName, token, null);
        console.log("Successfully joined channel:", channelName, "with UID:", uid);

        // Create microphone and camera tracks
        // Create microphone and camera tracks explicitly
showConnectionStatus('Accessing microphone...', 'info');
localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();

showConnectionStatus('Accessing front camera...', 'info');
try {
    localVideoTrack = await AgoraRTC.createCameraVideoTrack({
        // encoderConfig: "480p_1", // Optional: Specify resolution like 480p, 720p etc.
        facingMode: "user" // Request the front camera
    });
} catch (cameraError) {
    console.error("Failed to get front camera:", cameraError);
    showConnectionStatus('Could not access front camera. Trying default.', 'warning');
    // Fallback to default camera if front camera fails
    try {
        localVideoTrack = await AgoraRTC.createCameraVideoTrack({ /* encoderConfig: "480p_1" */ });
    } catch (fallbackError) {
         console.error("Failed to get any camera:", fallbackError);
         showConnectionStatus('Error accessing camera.', 'error');
         // Handle the case where no camera is available (e.g., disable video features)
         // You might want to call leaveCall() or show an error message.
         leaveCall(); // Example: End call attempt if camera fails critically
         return; // Stop further execution in joinAndPublish
    }
}

        // Play local video
        const localVideoPlayer = document.getElementById("localVideo");
        localVideoPlayer.textContent = ""; // Clear placeholder
        localVideoTrack.play("localVideo");
        console.log("Local video playing.");

        // Publish local tracks
        showConnectionStatus('Publishing your stream...', 'info');
        await agoraClient.publish([localAudioTrack, localVideoTrack]);
        console.log("Local tracks published successfully.");
        showConnectionStatus('Waiting for patient...', 'success');


    } catch (error) {
        console.error("Failed to join/publish:", error);
        showConnectionStatus(`Error: ${error.message}`, 'error');
        leaveCall(); // Clean up on error
    }
}
async function fetchAgoraToken(channelName) {
    try {
        console.log(`Requesting Agora token for channel: ${channelName}`);
        const response = await fetch(`${API_BASE_URL}/v1/agora/token`, { // Use your API_BASE_URL
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            // *** IMPORTANT: Tells fetch to send cookies (like your session cookie) ***
            credentials: 'include',
            body: JSON.stringify({
                channelName: channelName
                // uid: 0 // Optional: Backend defaults to 0 if not sent
            })
        });

        if (!response.ok) {
            // Try to get error message from backend
            let errorMsg = `Server error: ${response.status}`;
            try {
                 const errorData = await response.json();
                 errorMsg = errorData.error || errorMsg;
            } catch(jsonError) { /* Ignore if response not JSON */ }
            throw new Error(errorMsg);
        }

        const data = await response.json();

        if (data.success && data.token) {
            console.log("Successfully received Agora token.");
            return data.token;
        } else {
            throw new Error(data.error || 'Backend failed to provide a token.');
        }

    } catch (error) {
        console.error('Error fetching Agora token:', error);
        showConnectionStatus(`Error getting call token: ${error.message}`, 'error'); // Show error to user
        return null; // Indicate failure
    }
}

// Leave Agora Channel and Clean Up
async function leaveCall() {
    console.log("Leaving call...");
    showConnectionStatus('Ending call...', 'info');
    currentChannelName = null;
    remoteUser = null;

    // Stop and close local tracks
    if (localAudioTrack) {
        localAudioTrack.stop();
        localAudioTrack.close();
        localAudioTrack = null;
    }
    if (localVideoTrack) {
        localVideoTrack.stop();
        localVideoTrack.close();
        localVideoTrack = null;
    }

    // Leave the Agora channel
    if (agoraClient) {
        try {
            await agoraClient.leave();
            console.log("Left Agora channel successfully.");
        } catch (error) {
             console.error("Error leaving Agora channel:", error);
        }
        // Optional: Destroy the client instance if completely done
        agoraClient = null;
    }

    // Reset UI
    document.getElementById('localVideo').innerHTML = ''; // Clear local video
    document.getElementById('remoteVideo').innerHTML = '<p>Call ended</p>'; // Clear remote video
    document.getElementById('startCallBtn').textContent = 'Start Call';
    document.getElementById('startCallBtn').disabled = false;
    hideConnectionStatus();
    showScreen('dashboardScreen'); // Go back to dashboard after ending call
}

// --- END: Agora Functions ---


        // In doctor.html, inside the <script> block
// REPLACE your async showPatientSummary with this improved version:

async function showPatientSummary(appointmentId) {
    console.log("Showing summary for appointment ID:", appointmentId);
    let patientId = null;
    let patientName = "Unknown Patient";
    let apptData = null; // Initialize apptData

    // 1. Find appointment details robustly
    if (appData && appData.appointments && Array.isArray(appData.appointments)) {
        apptData = appData.appointments.find(a =>
            String(a.id) === String(appointmentId) ||
            String(a.appointmentId) === String(appointmentId) ||
            String(a.appointment_id) === String(appointmentId)
        );
    }

    if (apptData && apptData.patientId) {
        patientId = apptData.patientId;
        patientName = apptData.patient || patientName;
        console.log(`Context found in appData: Patient ID=${patientId}, Name=${patientName}`);
    } else {
        // --- Fallback if not found in appData (e.g., race condition or data issue) ---
        console.warn("Could not find appointment data or patientId for ID:", appointmentId, "in appData. Attempting direct lookup if possible (e.g., from button dataset if added).");
        // If the button itself had data-patient-id (optional improvement):
        // const buttonElement = document.querySelector(`.view-summary-btn[data-id="${appointmentId}"]`);
        // if (buttonElement && buttonElement.dataset.patientId) {
        //     patientId = buttonElement.dataset.patientId;
        //     patientName = buttonElement.dataset.patientName || patientName; // Assuming data-patient-name exists too
        //     console.log(`Context found via button dataset fallback: Patient ID=${patientId}, Name=${patientName}`);
        // } else {
            showConfirmationModal("Error", `Could not load patient context for appointment ${appointmentId}. Data might be loading.`);
            return; // Stop execution if no patientId can be determined
        // }
    }

    // --- Ensure patientId is now valid before proceeding ---
    if (!patientId) {
        showConfirmationModal("Error", "Patient identifier is missing. Cannot fetch summary.");
        return;
    }

    // Update global context and form dataset
    currentAppointment = apptData ? { ...apptData } : { id: appointmentId, patientId: patientId, patient: patientName }; // Use found or fallback context
    const prescriptionForm = document.getElementById('prescriptionForm');
    const uploadRxForm = document.getElementById('uploadRxForm');

    if (prescriptionForm) {
        prescriptionForm.dataset.patientId = patientId;
        const nameSpan = document.getElementById('prescriptionPatientName');
        if (nameSpan) nameSpan.textContent = patientName;
         // Clear form and reset mic button
         if (typeof clearPrescriptionForm === 'function') clearPrescriptionForm();
         if (typeof resetRecordingUI === 'function') resetRecordingUI();
    }
    if (uploadRxForm) {
        uploadRxForm.dataset.patientId = patientId;
        const patientSelectDropdown = document.getElementById('patient-select');
        if (patientSelectDropdown) patientSelectDropdown.value = patientId;
    }

    // 2. Prepare Modal UI (Show loading state) - No changes needed here
    const modal = document.getElementById('aiSummaryModal');
    // ... (get titleEl, symptomsList, vitalsList, prescriptionsList, startCallBtn) ...
    const titleEl = document.getElementById('summaryModalTitle');
    const symptomsList = document.getElementById('summarySymptoms');
    const vitalsList = document.getElementById('summaryVitals');
    const prescriptionsList = document.getElementById('summaryPrescriptions');

    titleEl.textContent = `Loading Summary: ${patientName}...`;
    symptomsList.innerHTML = '<li>Loading...</li>';
    vitalsList.innerHTML = '<li>Loading...</li>';
    prescriptionsList.innerHTML = '<li>Loading...</li>';
    if(startCallBtn) startCallBtn.disabled = true;
    if(modal) modal.classList.add('active');

    // 3. Fetch live summary data from the backend
    try {
        const response = await fetch(`${API_BASE_URL}/v1/patient-summary/${patientId}`, { /* ... */ });
        // ... (check response.ok) ...
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const summaryData = await response.json();

        if (summaryData.success) {
            // 4. Populate Modal with Fetched Data - WITH DEFAULTS
            titleEl.textContent = `AI Pre-Read: ${patientName}`;

            // --- FIX: Ensure arrays exist before mapping, provide defaults ---
            const symptoms = summaryData.symptoms || [];
            const vitals = summaryData.vitals || [];
            const prescriptions = summaryData.prescriptions || [];
            // --- END FIX ---

            symptomsList.innerHTML = symptoms.length > 0 ? symptoms.map(s => `<li>${s}</li>`).join('') : '<li>No recent symptoms logged.</li>';
            vitalsList.innerHTML = vitals.length > 0 ? vitals.map(v => `<li>${v}</li>`).join('') : '<li>No recent vitals available.</li>';
            prescriptionsList.innerHTML = prescriptions.length > 0 ? prescriptions.map(p => `<li>${p}</li>`).join('') : '<li>No active prescriptions found.</li>';

            if(startCallBtn) startCallBtn.disabled = false;
        } else {
            throw new Error(summaryData.message || 'Backend failed to retrieve summary.');
        }

    } catch (error) {
        // ... (existing error handling for fetch) ...
        console.error('Error fetching patient summary:', error);
        titleEl.textContent = `Error Loading Summary: ${patientName}`;
        symptomsList.innerHTML = `<li>Error: ${error.message}</li>`;
        vitalsList.innerHTML = '<li>Could not load vitals.</li>';
        prescriptionsList.innerHTML = '<li>Could not load prescriptions.</li>';
        if(startCallBtn) startCallBtn.disabled = true;
    }
}


            const translations = {
                en: { welcome_message: "Welcome, {name}", welcome_subtitle: "Your dashboard is ready.", upcoming_appointments: "Upcoming Appointments", for_today: "For today", completed_today: "Completed Today", consultations: "Consultations", dashboard_nav: "Dashboard", upload_nav: "Upload Rx", earnings_nav: "Earnings", upload_rx_title: "Upload Offline Prescription", select_patient: "Select Patient", upload_image: "Upload Prescription Image", drag_drop: "Click to upload a photo", save_to_record: "Save to Patient Record", earnings_title: "Earnings & History", write_prescription: "Write Prescription", end_call: "End Call", prescription_writer_title: "New Digital Prescription", medicine_name: "Medicine Name", dosage: "Dosage", advice: "Advice", send_prescription: "Sign & Send Prescription", summary_symptoms: "Logged Symptoms", summary_vitals: "Recent Vitals (from ASHA)", summary_prescriptions: "Active Prescriptions", logout: "Logout", appointments_nav: "Appointments", appointments_title: "Today's Appointments", your_reply: "Your Reply", call_patient: "Call", message_patient: "Message", view_summary: "Summary", view_prescription: "View Rx", history_title: "Recent Activity", recent_activity: "Recent Activity", last_4_days: "Last 4 days"},
                hi: { welcome_message: "नमस्ते, {name}", welcome_subtitle: "आपका डैशबोर्ड तैयार है।", upcoming_appointments: "आगामी अपॉइंटमेंट्स", for_today: "आज के लिए", completed_today: "आज पूर्ण हुए", consultations: "परामर्श", dashboard_nav: "डैशबोर्ड", upload_nav: "Rx अपलोड करें", earnings_nav: "कमाई", upload_rx_title: "ऑफलाइन प्रिस्क्रिप्शन अपलोड करें", select_patient: "मरीज़ चुनें", upload_image: "प्रिस्क्रिप्शन फोटो अपलोड करें", drag_drop: "फोटो अपलोड करने के लिए क्लिक करें", save_to_record: "मरीज़ के रिकॉर्ड में सहेजें", earnings_title: "कमाई और इतिहास", write_prescription: "प्रिस्क्रिप्शन लिखें", end_call: "कॉल समाप्त करें", prescription_writer_title: "नया डिजिटल प्रिस्क्रिप्शन", medicine_name: "दवा का नाम", dosage: "खुराक", advice: "सलाह", send_prescription: "हस्ताक्षर करें और भेजें", summary_symptoms: "दर्ज लक्षण", summary_vitals: "हाल के वाइटल्स (आशा से)", summary_prescriptions: "सक्रिय प्रिस्क्रिप्शन", logout: "लॉग आउट", appointments_nav: "अपॉइंटमेंट्स", appointments_title: "आज की अपॉइंटमेंट्स", your_reply: "आपका जवाब", call_patient: "कॉल", message_patient: "मैसेज", view_summary: "विवरण", view_prescription: "Rx देखें", history_title: "हाल की गतिविधि", recent_activity: "हाल की गतिविधि", last_4_days: "पिछले 4 दिन"}
            };

            const appData = {
                appointments: [
                    { id: 1, patient: "Ramesh Kumar", time: "10:30 AM", type: "video", message: "Hello Doctor, I've been having a slight headache since yesterday morning." },
                    { id: 2, patient: "Sunita Devi", time: "11:00 AM", type: "audio", message: "Good morning Dr, just confirming my appointment for today." },
                    { id: 3, patient: "Geeta Singh", time: "02:15 PM", type: "video", message: "Hi, I wanted to ask about the rash on my arm. Is it serious?" },
                ],
                history: [
                    { id: 101, patient: "Amit Patel", date: "2025-09-28", time: "09:00 AM", status: "Done" },
                    { id: 102, patient: "Priya Sharma", date: "2025-09-28", time: "09:30 AM", status: "Done" },
                    { id: 1, patient: "Ramesh Kumar", date: "2025-09-28", time: "10:30 AM", status: "Done" },
                    { id: 103, patient: "Anil Kapoor", date: "2025-09-27", time: "02:00 PM", status: "Missed" },
                    { id: 104, patient: "Sunita Reddy", date: "2025-09-27", time: "03:00 PM", status: "Done" },
                    { id: 105, patient: "Karan Verma", date: "2025-09-26", time: "11:00 AM", status: "Rescheduled" },
                    { id: 106, patient: "Meena Kumari", date: "2025-09-25", time: "04:00 PM", status: "Done" },
                ],
                summaries: {
                    1: { patient: "Ramesh Kumar", symptoms: ["Fever, cough for 3 days"], vitals: ["BP: 120/80 mmHg"], prescriptions: ["None active"] },
                    2: { patient: "Sunita Devi", symptoms: ["Headache, fatigue"], vitals: ["SPO2: 98%"], prescriptions: ["Paracetamol 500mg"] },
                    3: { patient: "Geeta Singh", symptoms: ["Skin rash on arm"], vitals: ["N/A"], prescriptions: ["None active"] }
                },
                prescriptions: {
                    1: { patient: "Ramesh Kumar", medicine: "Paracetamol 500mg", dosage: "1-0-1 After Food", advice: "Take for 3 days if fever persists." },
                    2: { patient: "Sunita Devi", medicine: "Cetirizine 10mg", dosage: "0-0-1 After Food", advice: "Take for 5 days for allergy symptoms." },
                    3: { patient: "Geeta Singh", medicine: "Betamethasone Cream", dosage: "Apply twice daily", advice: "Apply a thin layer on the affected area." }
                },
                earnings: [
                    { date: "2025-09-27", patient: "Amit Patel", fee: 150, status: "Paid" },
                    { date: "2025-09-27", patient: "Priya Sharma", fee: 150, status: "Paid" },
                    { date: "2025-09-28", patient: "Ramesh Kumar", fee: 150, status: "Pending" }
                ]
            };
            
            function checkAuth() {
                // Fetch doctor profile from backend
                return fetch(`${API_BASE_URL}/v1/doctor/profile`, { // <-- MODIFY THIS LINE
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.doctor) {
                        doctor = {
                            fullName: data.doctor.fullName,
                            doctorId: data.doctor.doctorId,
                            email: data.doctor.email,
                            specialization: data.doctor.specialization,
                            qualification: data.doctor.qualification,
                            experience: data.doctor.experience,
                            clinicName: data.doctor.clinicName,
                            phoneNumber: data.doctor.phoneNumber,
                            profileImageUrl: data.doctor.profileImageUrl
                        };
                        return true;
                    } else {
                        // Redirect to login if not authenticated
                        window.location.href = 'index.html';
                        return false;
                    }
                })
                .catch(error => {
                    console.error('Auth check failed:', error);
                    window.location.href = 'index.html';
                    return false;
                });
            }

            function updateUIText() {
                const langPack = translations[currentLanguage] || translations.en;
                document.querySelectorAll('[data-key]').forEach(el => {
                    const key = el.getAttribute('data-key');
                    let text = langPack[key];
                    if (key === 'welcome_message' && doctor) {
                        text = text.replace('{name}', doctor.fullName);
                    }
                    if (text) el.textContent = text;
                });
            }

            function showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId)?.classList.add('active');
                
                document.querySelectorAll('.nav-button, .top-nav a').forEach(link => {
                    link.classList.toggle('active', link.dataset.screen === screenId);
                });
            }
            
            function setupNavigation() {
                document.querySelectorAll('[data-screen]').forEach(el => {
                    el.addEventListener('click', (e) => {
                        // If the element is a card AND the click target is a button inside it, ignore the card's navigation.
                        if (el.classList.contains('card') && e.target.closest('button')) {
                            return;
                        }
                        // Allow navigation for all other cases (e.g., clicking the card itself, or clicking a button that has a data-screen attribute).
                        e.preventDefault();
                        showScreen(el.dataset.screen);
                    });
                });
            }

            function setupThemeAndLanguage() {
                const themeToggle = document.getElementById('themeToggle');
                const themeIcon = document.getElementById('themeIcon');
                const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
                const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;

                themeToggle.addEventListener('click', () => {
                    const currentTheme = document.body.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    document.body.setAttribute('data-theme', newTheme);
                    themeIcon.innerHTML = newTheme === 'dark' ? sunIcon : moonIcon;
                });
                
                const langDropdown = document.querySelector('.language-dropdown');
                const langMenu = langDropdown.querySelector('.language-dropdown-menu');
                Object.keys(translations).forEach(lang => {
                    const option = document.createElement('a');
                    option.href = "#"; option.className = 'language-option'; option.dataset.lang = lang;
                    option.textContent = new Intl.DisplayNames([lang], { type: 'language' }).of(lang);
                    langMenu.appendChild(option);
                });

                langDropdown.querySelector('.language-dropdown-toggle').addEventListener('click', () => langDropdown.classList.toggle('open'));
                document.addEventListener('click', e => { if (!langDropdown.contains(e.target)) langDropdown.classList.remove('open'); });
                langMenu.addEventListener('click', e => {
                    if (e.target.classList.contains('language-option')) {
                        currentLanguage = e.target.dataset.lang;
                        document.getElementById('selectedLanguage').textContent = e.target.textContent;
                        updateUIText();
                        langDropdown.classList.remove('open');
                    }
                });
            }

            // In doctor.html, replace the entire generateAppointments function with this

async function generateAppointments() {
    const container = document.getElementById('appointmentsList');
    const pageHeader = document.querySelector('#appointmentsScreen .page-header h1');

    // Update Page Header Title (only once or if needed)
    if (pageHeader && pageHeader.dataset.key !== 'all_appointments_title') {
        pageHeader.textContent = 'My Appointments';
        pageHeader.dataset.key = 'all_appointments_title';
    }

    // --- Subtle Loading Indication for Polling ---
    // If the container already has content (not just a placeholder), don't show the full "Loading..." text during polling.
    // You could add a small spinner or briefly change opacity here if desired, but for simplicity, we'll just fetch.
    //let showFullLoading = !container.innerHTML || container.innerHTML.includes('<p style="text-align: center');
    //if (showFullLoading) {
        // container.innerHTML = '<p style="text-align: center; padding: 2rem;">Loading appointments...</p>';
    //}
    // --- End Loading Indication ---


    let fetchedAppointments = [];
    let fetchError = null;

    try {
        const response = await fetch(`${API_BASE_URL}/v1/doctor/dashboard`, { credentials: 'include' });
        // --- Added basic error check for non-OK HTTP status ---
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        if (data.success && data.appointments) {
            // Sort fetched data immediately for consistent comparison later
            fetchedAppointments = data.appointments.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
            // console.log("Fetched live appointments:", JSON.stringify(fetchedAppointments)); // Keep for debugging if needed
        } else {
            console.warn("API call failed or no appointments returned by backend.");
            // Keep existing appData if fetch fails during polling, otherwise use empty array
            fetchedAppointments = (appData.appointments || []).sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
        }
    } catch (error) {
        console.error("Error fetching appointments:", error);
        fetchError = error; // Store error
        // Keep existing appData on error during polling, otherwise use empty array
        fetchedAppointments = (appData.appointments || []).sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
    }

    // --- Re-rendering Check ---
    // Compare sorted arrays as strings. Only re-render if data has actually changed.
    const currentDataString = JSON.stringify(appData.appointments || []); // Use empty array if appData.appointments is null/undefined
    const fetchedDataString = JSON.stringify(fetchedAppointments);

    if (currentDataString !== fetchedDataString) {
        console.log("Appointment data changed, updating appData and re-rendering.");
        appData.appointments = fetchedAppointments; // Update global appData

        // --- Populate Patient Dropdown (Only when data changes) ---
        const patientSelectDropdown = document.getElementById('patient-select');
        if (patientSelectDropdown) {
             patientSelectDropdown.innerHTML = ''; // Clear existing options
            const validAppointments = appData.appointments.filter(appt => appt && appt.patientId && appt.patient);
            const uniquePatients = [...new Map(validAppointments.map(item => [item.patientId, item])).values()];

            if (uniquePatients.length > 0) {
                 uniquePatients.sort((a, b) => a.patient.localeCompare(b.patient)).forEach(appt => {
                    const option = document.createElement('option');
                    option.value = appt.patientId;
                    option.textContent = appt.patient;
                    patientSelectDropdown.appendChild(option);
                });
                if (document.getElementById('uploadRxForm')) { // Check if form exists before setting dataset
                   document.getElementById('uploadRxForm').dataset.patientId = patientSelectDropdown.value;
                }
                patientSelectDropdown.removeEventListener('change', updateUploadFormPatientId);
                patientSelectDropdown.addEventListener('change', updateUploadFormPatientId);
            } else {
                const option = document.createElement('option');
                option.textContent = "No patients found";
                option.disabled = true;
                patientSelectDropdown.appendChild(option);
                 if (document.getElementById('uploadRxForm')) { // Check if form exists
                    document.getElementById('uploadRxForm').removeAttribute('data-patient-id');
                 }
            }
        }
        // --- End Patient Dropdown Population ---


        // --- Render Upcoming/Past Sections (Only when data changes) ---
        const now = new Date();
        const validAppointmentsForRender = appData.appointments.filter(appt => appt && appt.dateTime);

        const upcoming = validAppointmentsForRender.filter(a => new Date(a.dateTime) >= now);
        const past = validAppointmentsForRender.filter(a => new Date(a.dateTime) < now)
                                        .sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));

        let html = `<h3 class="appointments-section-title" data-key="upcoming_section_title">Upcoming</h3>`;
        if (upcoming.length === 0 && past.length === 0 && !fetchError) { // Show message only if truly empty and no error
             html = `<p style="text-align: center; padding: 2rem;" data-key="no_appointments_found">No appointments found.</p>`;
        } else {
             if (upcoming.length === 0) {
                 html += `<p style="text-align: center; padding: 1rem;" data-key="no_upcoming">No upcoming appointments found.</p>`;
             } else {
                 html += upcoming.map(appt => {
                     const appointmentKey = appt.id || `appt-${appt.dateTime}`;
                     const patientId = appt.patientId || '';
                     const patientName = appt.patient || 'Unknown Patient';
                     return `
                     <div class="card appointment-card" data-id="${appointmentKey}" data-patient-id="${patientId}">
                    <div style="display: flex; align-items: center;">
                       <div class="appointment-type-indicator type-${appt.type || 'video'}"></div>
                       <div class="appointment-card-details">
                            <h4>${patientName}</h4>
                            <p>${new Date(appt.dateTime).toLocaleDateString()} ${appt.time || new Date(appt.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} &middot; ${(appt.type || 'Video').charAt(0).toUpperCase() + (appt.type || 'Video').slice(1)} Call</p>
                       </div>
                    </div>  
                         <div class="appointment-actions">
                              <button class="btn btn-sm btn-call" data-patient="${patientName}" data-patient-id="${patientId}" data-appointment-id="${appointmentKey}" data-key="call_patient">Call</button>
                              <button class="btn btn-sm btn-message" data-id="${appointmentKey}" data-key="message_patient">Message</button>
                              <button class="btn btn-sm btn-primary view-summary-btn" data-id="${appointmentKey}" data-patient-id="${patientId}" data-patient-name="${patientName}" data-key="view_summary">Summary</button>
                         </div>
                     </div>`;
                 }).join('');
             }

             html += `<h3 class="appointments-section-title" style="margin-top: 2rem;" data-key="past_section_title">Past</h3>`;
             if (past.length === 0) {
                 html += `<p style="text-align: center; padding: 1rem;" data-key="no_past">No past appointments found.</p>`;
             } else {
                  html += past.map(appt => {
                     const appointmentKey = appt.id || `appt-${appt.dateTime}`;
                     const patientId = appt.patientId || '';
                     const patientName = appt.patient || 'Unknown Patient';
                     return `
                     <div class="card appointment-card" data-id="${appointmentKey}" data-patient-id="${patientId}">
                    <div style="display: flex; align-items: center;">
                       <div class="appointment-type-indicator type-${appt.type || 'video'}"></div>
                       <div class="appointment-card-details">
                            <h4>${patientName}</h4>
                             <p>${new Date(appt.dateTime).toLocaleDateString()} ${appt.time || new Date(appt.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} &middot; ${(appt.type || 'Video').charAt(0).toUpperCase() + (appt.type || 'Video').slice(1)} Call</p>
                       </div>
                    </div>
                          <div class="appointment-actions">
                              <button class="btn btn-sm btn-message" data-id="${appointmentKey}" data-key="message_patient">Message</button>
                              <button class="btn btn-sm btn-neutral view-rx-btn" data-id="${appointmentKey}" data-key="view_prescription">View Rx</button>
                              <button class="btn btn-sm btn-primary view-summary-btn" data-id="${appointmentKey}" data-patient-id="${patientId}" data-patient-name="${patientName}" data-key="view_summary">Summary</button>
                         </div>
                     </div>`;
                 }).join('');
             }
        } // End of main else block (if appointments exist)

        // --- Render the final HTML ---
        container.innerHTML = html;

        // --- Re-attach event listeners using cloning method ---
        attachAppointmentButtonListenersCloning(container); // Use cloning helper

    } else {
        console.log("Appointment data hasn't changed, skipping re-render.");
        // --- Handle Fetch Error Display ---
        // Show error only if polling failed AND there's no data currently displayed
        if (fetchError && (!appData.appointments || appData.appointments.length === 0)) {
             container.innerHTML = `<p style="text-align: center; padding: 2rem; color: red;">Could not load appointments. ${fetchError.message}</p>`;
        }
        // --- End Fetch Error Display ---
    }
    // --- End Re-rendering Check ---

    updateUIText(); // Apply translations after rendering or confirming no change
}

// --- NEW HELPER using cloning for reliable listener re-attachment during polling ---
function attachAppointmentButtonListenersCloning(containerElement) {
    containerElement.querySelectorAll('.view-summary-btn').forEach(btn => {
        const apptId = btn.dataset.id;
        const patId = btn.dataset.patientId; // Get patientId directly
        const patName = btn.dataset.patientName; // Get patientName directly
        if (apptId && patId) {
            const newBtn = btn.cloneNode(true); // Clone the button
            btn.parentNode.replaceChild(newBtn, btn); // Replace old with clone
            // Add listener to the NEW button
            newBtn.addEventListener('click', () => showPatientSummary(patId, patName)); // Pass patId and patName
        } else {
            console.error("Summary button missing required data attributes (data-id, data-patient-id):", btn);
        }
    });

    containerElement.querySelectorAll('.view-rx-btn').forEach(btn => {
        const apptId = btn.dataset.id;
        if (apptId) {
             const newBtn = btn.cloneNode(true);
             btn.parentNode.replaceChild(newBtn, btn);
             newBtn.addEventListener('click', () => showPrescriptionModal(apptId));
        }
    });

    containerElement.querySelectorAll('.btn-call').forEach(btn => {
        const apptId = btn.dataset.appointmentId;
        const patId = btn.dataset.patientId;
        const patName = btn.dataset.patient;
        if (apptId && patId && patName) { // Check all required data
             const newBtn = btn.cloneNode(true);
             btn.parentNode.replaceChild(newBtn, btn);
             newBtn.addEventListener('click', () => {
                // Set context for prescription forms before showing call screen
                currentAppointment = { id: apptId, patientId: patId, patient: patName }; // Update global context
                const prescriptionForm = document.getElementById('prescriptionForm');
                const uploadRxForm = document.getElementById('uploadRxForm'); // Needed? Maybe not directly here.
                if(prescriptionForm) {
                    prescriptionForm.dataset.patientId = patId;
                    const nameSpan = document.getElementById('prescriptionPatientName');
                    if(nameSpan) nameSpan.textContent = patName;
                    // Reset AI form/button state when starting a call for a patient
                    clearPrescriptionForm(); // Assumes exists
                    resetRecordingUI();    // Assumes exists
                }
                // Ensure dropdown on upload screen reflects current patient if relevant
                const patientSelect = document.getElementById('patient-select');
                if(patientSelect) patientSelect.value = patId;
                if(uploadRxForm) uploadRxForm.dataset.patientId = patId; // Also set dataset here

                showCallScreen(patName, apptId);
            });
        } else {
             console.error("Call button missing required data attributes:", btn);
        }
    });

    containerElement.querySelectorAll('.btn-message').forEach(btn => {
         const apptId = btn.dataset.id;
         if(apptId){
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener('click', () => showMessageModal(apptId));
         }
    });
}

// --- Make sure this function exists (from your previous code) ---
// Helper function to update the upload form's patientId when dropdown changes
function updateUploadFormPatientId(event) {
    document.getElementById('uploadRxForm').dataset.patientId = event.target.value;
    console.log("Upload form patientId updated via dropdown:", event.target.value);
}

// --- Modified showPatientSummary to accept patientId and patientName ---
// Replace the existing showPatientSummary function
async function showPatientSummary(patientId, patientName) { // Changed parameters
    console.log("Showing summary for patient ID:", patientId, "Name:", patientName);

    if (!patientId) {
        showConfirmationModal("Error", "Patient ID is missing. Cannot load summary.");
        return;
    }

     // --- Update global context and form dataset ---
    // Find the latest appointment details for this patient for context (optional but good)
    const latestAppt = appData.appointments.find(a => a.patientId === patientId);
    currentAppointment = {
        id: latestAppt?.id || null, // Use latest appt ID or null
        patientId: patientId,
        patient: patientName
    };
    const prescriptionForm = document.getElementById('prescriptionForm');
    prescriptionForm.dataset.patientId = patientId; // Set form context
    document.getElementById('prescriptionPatientName').textContent = patientName; // Update name display
    // Clear form and reset mic button when summary is shown
    if (typeof clearPrescriptionForm === 'function') clearPrescriptionForm();
    if (typeof resetRecordingUI === 'function') resetRecordingUI();
    // --- End context update ---


    // --- Prepare Modal UI (Show loading state) ---
    const modal = document.getElementById('aiSummaryModal');
    const titleEl = document.getElementById('summaryModalTitle');
    const symptomsList = document.getElementById('summarySymptoms');
    const vitalsList = document.getElementById('summaryVitals');
    const prescriptionsList = document.getElementById('summaryPrescriptions');

    titleEl.textContent = `Loading Summary: ${patientName}...`;
    symptomsList.innerHTML = '<li>Loading...</li>';
    vitalsList.innerHTML = '<li>Loading...</li>';
    prescriptionsList.innerHTML = '<li>Loading...</li>';
    startCallBtn.disabled = true;

    modal.classList.add('active'); // Show modal

    // --- Fetch live summary data from the backend ---
    try {
        const response = await fetch(`${API_BASE_URL}/v1/patient-summary/${patientId}`, { // Use patientId in URL
            method: 'GET',
            credentials: 'include'
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: `Server error: ${response.status}` }));
            throw new Error(errorData.message || `HTTP ${response.status}`);
        }

        const summaryData = await response.json();

        if (summaryData.success) {
            // --- Populate Modal with Fetched Data ---
            titleEl.textContent = `AI Pre-Read: ${summaryData.patientName || patientName}`; // Use fetched name if available
            symptomsList.innerHTML = summaryData.symptoms?.length
                ? summaryData.symptoms.map(s => `<li>${s}</li>`).join('')
                : '<li>No recent symptoms logged.</li>';
            vitalsList.innerHTML = summaryData.vitals?.length
                ? summaryData.vitals.map(v => `<li>${v}</li>`).join('')
                : '<li>No recent vitals available.</li>';
            prescriptionsList.innerHTML = summaryData.prescriptions?.length
                ? summaryData.prescriptions.map(p => `<li>${p}</li>`).join('')
                : '<li>No active prescriptions found.</li>';
            startCallBtn.disabled = false; // Re-enable call button
        } else {
            throw new Error(summaryData.message || 'Backend failed to retrieve summary.');
        }

    } catch (error) {
        console.error('Error fetching patient summary:', error);
        titleEl.textContent = `Error Loading Summary: ${patientName}`;
        symptomsList.innerHTML = `<li>Error: ${error.message}</li>`;
        vitalsList.innerHTML = '<li>Could not load vitals.</li>';
        prescriptionsList.innerHTML = '<li>Could not load prescriptions.</li>';
        startCallBtn.disabled = true;
    }
}

            function generateHistoryList() {
                const container = document.getElementById('historyList');
                container.innerHTML = appData.history.map(appt => `
                    <div class="card history-card">
                        <div>
                            <h4>${appt.patient}</h4>
                            <p>${new Date(appt.date).toLocaleDateString()} - ${appt.time}</p>
                        </div>
                        <span class="status-badge status-${appt.status.toLowerCase()}">${appt.status}</span>
                    </div>`).join('');
            }
            // Define this function in the main script scope

            
            

            function showPrescriptionModal(appointmentId) {
                const prescription = appData.prescriptions[appointmentId];
                if (!prescription) {
                    showConfirmationModal('No Prescription Found', 'There is no recent digital prescription for this patient.');
                    return;
                }

                const modal = document.getElementById('prescriptionViewModal');
                modal.querySelector('#rxPatientName').textContent = prescription.patient;
                modal.querySelector('#rxMedicine').textContent = prescription.medicine;
                modal.querySelector('#rxDosage').textContent = prescription.dosage;
                modal.querySelector('#rxAdvice').textContent = prescription.advice;
                modal.classList.add('active');
            }
            
            function showMessageModal(appointmentId) {
                const appointment = appData.appointments.find(a => a.id == appointmentId);
                if (!appointment) return;
                
                const modal = document.getElementById('messageModal');
                const chatBox = document.getElementById('chatBox');
                
                modal.querySelector('#messageModalTitle').textContent = `Message with ${appointment.patient}`;
                
                chatBox.innerHTML = `
                    <div class="chat-message patient-message">
                        <p>${appointment.message}</p>
                        <span class="message-time">10:45 AM</span>
                    </div>
                `;
                modal.querySelector('#doctor-reply').value = '';
                modal.dataset.appointmentId = appointmentId;
                modal.classList.add('active');
            }

            

            function generateEarningsHistory() {
                 const container = document.getElementById('earningsList');
                 container.innerHTML = appData.earnings.map(item => `
                    <div class="history-item">
                        <div>
                            <h4>${item.patient}</h4>
                            <p>${new Date(item.date).toLocaleDateString()}</p>
                        </div>
                        <div>
                            <h4>₹${item.fee}</h4>
                            <span class="status-badge status-${item.status.toLowerCase()}">${item.status}</span>
                        </div>
                    </div>`).join('');
            }

            function setupFormsAndModals() {
                document.getElementById('closeSummaryModal').addEventListener('click', () => document.getElementById('aiSummaryModal').classList.remove('active'));
                // --- MODIFIED LINE ---
                // When starting call from summary
            

            // Handle direct navigation to prescription screen (e.g., from consultation view)
            // Find the button inside the consultation view that navigates
            const writePrescriptionBtn = document.querySelector('#consultationScreen [data-screen="prescriptionWriterScreen"]');
            if (writePrescriptionBtn) {
                 writePrescriptionBtn.addEventListener('click', (e) => {
                     // Prevent default navigation if context is missing
                     if (!currentAppointment || !currentAppointment.patientId) {
                          e.preventDefault();
                          e.stopPropagation(); // Stop further event bubbling
                          showConfirmationModal('Patient Context Missing', 'Cannot write prescription without selecting a patient from appointments or summary.');
                     } else {
                          // Context is presumably set from the call screen initiation
                          // Ensure form is clear and button reset before showing screen
                          clearPrescriptionForm(); // Defined in setupAiPrescription
                          resetRecordingUI();    // Defined in setupAiPrescription
                          // Let the default navigation happen (showScreen will be called by data-screen attribute)
                     }
                 });
            }
                
                document.getElementById('closeMessageModal').addEventListener('click', () => document.getElementById('messageModal').classList.remove('active'));
                document.getElementById('closeRxModal').addEventListener('click', () => document.getElementById('prescriptionViewModal').classList.remove('active'));

                document.getElementById('sendMessageBtn').addEventListener('click', () => {
                    const modal = document.getElementById('messageModal');
                    const chatBox = document.getElementById('chatBox');
                    const replyTextarea = document.getElementById('doctor-reply');
                    const replyText = replyTextarea.value.trim();

                    if (replyText) {
                        const doctorMessage = document.createElement('div');
                        doctorMessage.className = 'chat-message doctor-message';
                        doctorMessage.innerHTML = `<p>${replyText}</p><span class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>`;
                        chatBox.appendChild(doctorMessage);
                        chatBox.scrollTop = chatBox.scrollHeight;
                        replyTextarea.value = '';

                        setTimeout(() => {
                           modal.classList.remove('active');
                        }, 800);
                    }
                });
                
                document.getElementById('closeModal').addEventListener('click', () => document.getElementById('confirmationModal').classList.remove('active'));

                document.getElementById('uploadRxForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                // --- Get patientId (Ensure context is set, e.g., from summary/call) ---
                const patientId = e.target.dataset.patientId;
                // --- Fallback using dropdown (if dataset isn't reliably set) ---
                const selectedPatientName = document.getElementById('patient-select').value; // Get selected name from dropdown
                const patientFromDropdown = appData.appointments.find(appt => appt.patient === selectedPatientName);
                const finalPatientId = patientId || patientFromDropdown?.patientId; // Prioritize dataset, fallback to dropdown lookup

                if (!finalPatientId) {
                     showConfirmationModal('Error', 'No patient selected. Please view patient summary/start call or select from dropdown.');
                     return;
                }
                console.log("Uploading prescription for patient ID:", finalPatientId);


                const fileInput = document.getElementById('prescriptionFile');
                const file = fileInput.files[0];

                if (!file) {
                    showConfirmationModal('No File Selected', 'Please select an image file to upload.');
                    return;
                }

                // Show processing state
                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.textContent;
                submitButton.textContent = 'Uploading & Analyzing...';
                submitButton.disabled = true;

                // Read file as Base64 Data URL
                const reader = new FileReader();
                reader.readAsDataURL(file);

                reader.onload = async () => {
                    const imageDataUrl = reader.result; // This is the base64 string with prefix

                    try {
                        const response = await fetch(`${API_BASE_URL}/v1/doctor/upload-prescription`, { // Correct endpoint
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                //'Credentials': 'include' // Important for auth
                                // ---> ADD THIS LINE <---
    credentials: 'include', // Tells the browser to send cookies with this request
    // ---> END ADDED LINE <---
                            },
                            body: JSON.stringify({
                                patientId: finalPatientId, // Send the determined patient ID
                                imageData: imageDataUrl // Send the full Data URL
                            })
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            showConfirmationModal('Upload Successful', data.message || 'Prescription saved to patient record.');
                            // Optionally, show extracted info if needed: console.log("Extracted:", data.extractedData);
                            // Clear the file input
                            fileInput.value = null;
                            // Navigate back or reset view
                            showScreen('dashboardScreen');
                        } else {
                            throw new Error(data.message || data.error || `Server error: ${response.status}`);
                        }
                    } catch (error) {
                        console.error('Doctor prescription upload error:', error);
                        showConfirmationModal('Upload Failed', `Error: ${error.message}. Please try again.`);
                    } finally {
                        // Reset button state
                        submitButton.textContent = originalButtonText;
                        submitButton.disabled = false;
                    }
                };

                reader.onerror = () => {
                    console.error('Failed to read file.');
                    showConfirmationModal('File Error', 'Could not read the selected image file.');
                    // Reset button state
                    submitButton.textContent = originalButtonText;
                    submitButton.disabled = false;
                };
            });
                
                 document.getElementById('prescriptionForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    showConfirmationModal('Prescription Sent', 'The digital prescription has been sent to the patient and their pharmacy.');
                    showScreen('dashboardScreen');
                });
                const writeRxBtn = document.getElementById('writeRxFromSummaryBtn');
    if (writeRxBtn) {
        writeRxBtn.addEventListener('click', () => {
            // Context (currentAppointment, form dataset) is ALREADY set by showPatientSummary

            // 1. Close the summary modal
            document.getElementById('aiSummaryModal').classList.remove('active');

            // 2. Ensure form is clear and recording reset (essential before showing)
            if (typeof clearPrescriptionForm === 'function') {
                clearPrescriptionForm();
            } else {
                console.warn("clearPrescriptionForm function not found");
            }
            if (typeof resetRecordingUI === 'function') {
                resetRecordingUI();
            } else {
                console.warn("resetRecordingUI function not found");
            }

            // 3. Navigate to the prescription writer screen
            showScreen('prescriptionWriterScreen');
        });
    } else {
        console.warn("Write Prescription button (from summary modal) not found.");
    }
    // --- END ADDED Listener ---
                // --- ADD THIS EVENT LISTENER FOR THE END CALL BUTTON ---
                document.getElementById('endCallBtn')?.addEventListener('click', leaveCall);

                // --- ADD WebRTC EVENT LISTENERS ---
                //document.getElementById('startCallBtn').addEventListener('click', startCall);
            }

            function showConfirmationModal(title, message) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('confirmationModal').classList.add('active');
            }

            async function initializeApp() {
                const isAuthenticated = await checkAuth();
                if(isAuthenticated){
                    setupNavigation();
                    setupThemeAndLanguage();
                    
                    generateAppointments();
                    generateHistoryList();
                    generateEarningsHistory();
                    setupFormsAndModals();
                    setupAiPrescription();
                    // --- ADD THIS EVENT LISTENER ---
                    // Add this listener during initialization (e.g., inside initializeApp or setupFormsAndModals)

const startCallButton = document.getElementById('startCallBtn');
if (startCallButton) {
    startCallButton.addEventListener('click', async () => { // Make the listener async
        if (currentChannelName) {
            console.log(`Start Call button clicked. Attempting join for channel: ${currentChannelName}`);
            startCallButton.textContent = 'Connecting...'; // Update text
            startCallButton.disabled = true;

            // --- Fetch the token ---
            const token = await fetchAgoraToken(currentChannelName);

            if (token) {
                // --- Join only if token was successfully fetched ---
                joinAndPublish(currentChannelName, token); // Use the fetched token
            } else {
                // Token fetch failed, reset the button
                showConnectionStatus("Failed to get call token. Please try again.", "error");
                startCallButton.textContent = 'Start Call';
                startCallButton.disabled = false;
            }

        } else {
            console.error("Cannot start call, channel name (appointmentId) is missing.");
            showConnectionStatus("Error: Appointment ID missing.", "error");
            startCallButton.textContent = 'Start Call'; // Reset button if context is missing
            startCallButton.disabled = false;
        }
    });
} else {
    console.error("Could not find the Start Call button element!");
}
                    // Inside initializeApp() or where the listener is added:
// Find this listener in doctor.html ONLY
document.getElementById('joinDemoCallBtn')?.addEventListener('click', async () => { // Make async
    const demoChannelName = 'demo-call-123';

    // Set context (keep this part)
    currentAppointment = { id: demoChannelName, patientId: 'DEMO_PATIENT_ID', patient: 'Live Demo Patient' };
    // ... (rest of the context setting code) ...

    // UI Updates (keep this part)
    document.getElementById('consultationHeader').textContent = `Consultation with Live Demo Patient`;
    showScreen('consultationScreen');
    hideConnectionStatus();

    if (!agoraClient) {
        initializeAgoraClient();
    }

    console.log(`Attempting to join demo channel: ${demoChannelName}`);

    // --- FETCH TOKEN FOR DEMO ---
    const startBtn = document.getElementById('startCallBtn'); // Temporarily disable main btn
    if(startBtn) startBtn.disabled = true;
    showConnectionStatus("Getting demo call token...", "info"); // Show status

    // Fetch the token directly here
    const token = await fetchAgoraToken(demoChannelName); // Fetch token for demo channel

    if (token) {
        // Use the fetched token directly
        joinAndPublish(demoChannelName, token); // Join with fetched token
        // The joinAndPublish function will update the start button state upon success/failure
    } else {
        showConnectionStatus("Failed to get demo call token.", "error");
        if(startBtn) startBtn.disabled = false; // Re-enable main btn on failure
        // Consider navigating back or showing a persistent error
        showScreen('dashboardScreen');
    }
    // --- END FETCH LOGIC ---
});
                    // --- END OF NEW LISTENER ---

                    // Inside your doctor.html <script> tag, find the logoutBtn event listener
// Replace the existing listener with this corrected version:

document.getElementById('logoutBtn').addEventListener('click', async () => {
    // Stop polling (keep this part)
    if (appointmentPollingInterval) {
        clearInterval(appointmentPollingInterval);
        console.log("Stopped polling for appointments on logout.");
        appointmentPollingInterval = null; // Clear the interval ID
    }

    try {
        // --- ADDED: Call the backend logout endpoint ---
        const response = await fetch(`${API_BASE_URL}/v1/logout`, {
            method: 'POST',
            credentials: 'include', // Important: Sends the session cookie
            headers: {
                'Content-Type': 'application/json'
                // No body needed for this specific logout endpoint
            }
        });

        // Check if the backend logout was successful (optional but good practice)
        if (response.ok) {
            console.log('Backend logout successful.');
        } else {
            console.warn('Backend logout failed or session might have already expired.');
            // We proceed with frontend cleanup regardless
        }
        // --- END ADDED SECTION ---

    } catch (error) {
        console.error('Error calling backend logout:', error);
        // Still proceed with frontend cleanup even if the backend call fails
    } finally {
        // --- Frontend Cleanup and Redirect ---
        // Remove potentially problematic localStorage item (consider removing if not strictly needed)
        // localStorage.removeItem('sehatSaharaDoctor'); // If checkAuth relies ONLY on the backend, this isn't necessary

        // Redirect to the landing page
        window.location.href = 'index.html';
    }
});

                    // --- START POLLING AFTER INITIAL LOAD ---
    // Clear any previous interval just in case
    if (appointmentPollingInterval) {
        clearInterval(appointmentPollingInterval);
    }
    // Check for new appointments every 30 seconds (30000 milliseconds)
    appointmentPollingInterval = setInterval(generateAppointments, 30000);
    console.log("Started polling for appointments every 30 seconds.");
    // --- END POLLING START ---

    document.getElementById('logoutBtn').addEventListener('click', () => {
       // --- STOP POLLING ON LOGOUT ---
       if (appointmentPollingInterval) {
           clearInterval(appointmentPollingInterval);
           console.log("Stopped polling for appointments on logout.");
       }
       // --- END STOP POLLING ---
       localStorage.removeItem('sehatSaharaDoctor');
       window.location.href = 'index.html';
    });

    updateUIText();
    // ... (rest of initializeApp if any) ...
}
            }

            initializeApp();
        });
    </script>
</body>
</html>