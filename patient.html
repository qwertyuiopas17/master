<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sehat Sahara - Patient Dashboard</title>
    <style>
        :root {
            --bg-color: rgba(245, 245, 245, 0.6);
            --card-bg-color: rgba(255, 255, 255, 0.7);
            --text-color: #0f172a;
            --text-color-secondary: #475569;
            --primary-color: #0d9488;
            --primary-color-light: #2dd4bf;
            --primary-color-dark: #14b8a6;
            --sos-color: #ef4444;
            --border-color: rgba(0, 0, 0, 0.07);
            --shadow-color: rgba(100, 116, 139, 0.1);
            /* --- MODIFIED: Removed Poppins font and used system fonts --- */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --color-secondary: #f1f5f9;
            --radius-lg: 16px;
            --radius-full: 9999px;
        }

        [data-theme="dark"] {
            --bg-color: rgba(20, 20, 30, 0.75);
            --card-bg-color: rgba(30, 41, 59, 0.6);
            --text-color: #e2e8f0;
            --text-color-secondary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.12);
            --primary-color: var(--primary-color-dark);
            --color-secondary: #334155;
            --shadow-color: rgba(0, 0, 0, 0.2);
            /* --- START: Add these Chat Message Dark Mode Fixes --- */
            .chat-message.bot-message {
                background-color: #475569; /* Lighter grey for bot messages */
                color: #e2e8f0; /* Ensure text is light */
                box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* Optional: Slightly enhance shadow */
            }

            .chat-message.user-message {
                background-color: #14b8a6; /* Keep primary color or adjust slightly if needed */
                color: #ffffff; /* Ensure user message text is white */
                box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* Optional: Slightly enhance shadow */
            }

            .chat-window {
                 background-color: #1e293b; /* Slightly darker chat window background */
            }
             /* Ensure input fields have good contrast */
            .form-control, #chatInput {
                 background-color: #334155;
                 color: #e2e8f0;
                 border: 1px solid #475569;
            }
            .form-control::placeholder, #chatInput::placeholder {
                 color: #94a3b8;
            }
            /* --- END: Add these Chat Message Dark Mode Fixes --- */
        }
        

        html { scroll-behavior: smooth; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: var(--font-family); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            line-height: 1.6; 
            padding-bottom: 80px; /* Space for bottom nav */
            transition: background-color 0.3s, color 0.3s;
        }
        .main-container { position: relative; min-height: 100vh; width: 100vw; }
        .background-image { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-image: url('https://i.ibb.co/84XpXLXW/hero-pic.png'); 
            background-size: cover; background-position: center; 
            filter: blur(14px) brightness(0.9); 
            transform: scale(1.15); z-index: -1; 
            transition: filter 0.3s;
        }
        [data-theme="dark"] .background-image { filter: blur(14px) brightness(0.6); }

        .page-content { flex-grow: 1; padding: 1.5rem; max-width: 1200px; margin: 0 auto; width: 100%; padding-top: 110px; }
        
        /* Header */
        .header {
            position: fixed; top: 1rem; left: 50%; transform: translateX(-50%);
            width: calc(100% - 2rem); max-width: 1200px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem; z-index: 1000;
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            border-radius: 999px; /* Make header fully rounded */
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
        }
        .header .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin-left: 1rem; }
        .header .actions { display: flex; align-items: center; gap: 0.5rem; margin-right: 0.5rem; }
        
        .top-nav { display: none; align-items: center; gap: 0.5rem; }
        .top-nav a { 
            text-decoration: none; 
            color: var(--text-color-secondary); 
            font-weight: 500; 
            padding: 0.6rem 1.25rem;
            border-radius: 999px; 
            transition: all 0.25s ease;
            position: relative;
        }
        .top-nav a:hover {
            color: var(--text-color);
            background-color: rgba(128, 128, 128, 0.1);
        }
        .top-nav a.active { 
            color: var(--text-color); 
            background-color: rgba(128, 128, 128, 0.15); 
        }

        .btn { padding: 0.6rem 1.2rem; border-radius: 9999px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.25s ease; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.12); }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .btn-sos { 
    background-color: var(--sos-color); 
    color: white; 
    animation: pulse 2s infinite; 
}
.btn-sos:hover { 
    animation: pulse 1s infinite; 
    transform: scale(1.05); 
}
        /* And add the animation properties to it like this: */
.btn-sos { 
    background-color: var(--sos-color); 
    color: white; 
    animation: pulse 2s infinite; 
}
.btn-sos:hover { 
    animation: pulse 1s infinite; 
    transform: scale(1.05); 
}
/* --- ADDED: Style for active recording button --- */
        #record-button.recording-active,
        #record-button.recording-active:hover {
            background-color: var(--sos-color);
            color: white; /* Ensure icon is visible */
            border-color: var(--sos-color);
            opacity: 1;
        }
        #record-button.recording-active:hover {
            background-color: #dc2626; /* A slightly darker red */
            border-color: #dc2626;
        }
        /* --- END ADDED --- */
        .btn-primary { background-color: var(--primary-color); color: white; border: 2px solid var(--primary-color); }
        
        .card { 
            background-color: var(--card-bg-color); border-radius: var(--radius-lg); 
            padding: 1.5rem; border: 1px solid var(--border-color); 
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); 
            box-shadow: 0 8px 32px 0 var(--shadow-color); transition: all 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px 0 var(--shadow-color); }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Home Screen */
        .welcome-card { background: linear-gradient(45deg, var(--primary-color), var(--primary-color-light)); color: white; margin-bottom: 2rem;}
        .welcome-card h1 { font-size: 2.25rem; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1.5rem;
        }
        .dashboard-grid > .info-card {
            grid-column: span 3;
        }
        .dashboard-grid > .tool-card {
            grid-column: span 2;
        }
        
        .info-card h3 { font-size: 1rem; }
        .info-card .highlight { font-size: 1.25rem; font-weight: 600; }

        .tool-card { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            text-align: center; 
            gap: 0.75rem; 
            cursor: pointer; 
            padding: 1.5rem 1rem; 
        }
        .tool-card .icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; }
        .tool-card h3 { font-size: 1rem; font-weight: 600; }
        .icon-report { background-image: linear-gradient(45deg, #64748b, #94a3b8); }

        /* Page Headers */
        .page-header { text-align: center; margin-bottom: 2.5rem; padding-top: 1rem; }
        .page-header h1 { font-size: 2.25rem; }

        /* Health Record */
        .timeline-item { position: relative; padding-left: 2.5rem; padding-bottom: 2rem; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-item::before { content: ''; position: absolute; left: 0.6rem; top: 0.25rem; width: 2px; height: 100%; background-color: var(--border-color); }
        .timeline-dot { position: absolute; left: 0; top: 0.25rem; width: 20px; height: 20px; border-radius: 50%; background-color: var(--primary-color); border: 4px solid var(--card-bg-color); }
        .timeline-date { font-size: 0.9rem; color: var(--text-color-secondary); }

        /* Appointments Screen */
        .appointments-section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary-color); }
        .appointment-card { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
        .appointment-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .appointment-card-doctor h4 { font-size: 1.25rem; font-weight: 600; }
        .appointment-card-doctor p { color: var(--text-color-secondary); font-size: 0.9rem; line-height: 1.2; }
        .appointment-card-tag { font-size: 0.8rem; font-weight: 500; padding: 0.25rem 0.75rem; border-radius: var(--radius-full); color: white; }
        .tag-video { background-color: #3b82f6; }
        .tag-audio { background-color: #16a34a; }
        .tag-offline { background-color: #64748b; }
        .appointment-card-footer { display: flex; justify-content: flex-end; gap: 0.75rem; }
        
        /* Booking Flow */
        .booking-step { display: none; margin-bottom: 1.5rem; }
        .booking-step.active { display: block; }
        .selection-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .selection-card { text-align: center; cursor: pointer; }
        .selection-card.selected { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.3); }
        .doctor-card img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 1rem; object-fit: cover; }
        
        .calendar-container { margin-bottom: 1.5rem; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; text-align: center; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-full); cursor: pointer; transition: all 0.2s ease; }
        .calendar-day.available:hover { background: var(--color-secondary); }
        .calendar-day.disabled { color: var(--text-color-secondary); opacity: 0.5; cursor: not-allowed; text-decoration: line-through;}
        .calendar-day.disabled:hover { transform: none; background: transparent;}
        .calendar-day.selected { background: var(--primary-color); color: white; transform: scale(1.1); }
        
        .time-slots-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.75rem; }
        .time-slot { text-align: center; padding: 0.75rem; background: var(--color-secondary); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .time-slot.selected, .time-slot:hover { background: var(--primary-color); color: white; transform: scale(1.05); }

        .booking-navigation { display: flex; justify-content: space-between; margin-top: 1.5rem; }
        .appointment-summary { margin-top: 1.5rem; }

        /* Scan Medicine Screen */
        .camera-container { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        #camera-feed { width: 100%; max-width: 500px; border-radius: var(--radius-lg); background: #333; aspect-ratio: 4 / 3; }

        /* Book Medicine Screen */
.pharmacy-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
.pharmacy-card { cursor: pointer; }
.pharmacy-card .info { margin-bottom: 1rem; }
.pharmacy-card .actions { display: flex; justify-content: space-between; align-items: center; }
.medicine-list { list-style: none; padding: 0; }
.medicine-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--color-secondary); border-radius: 8px; margin-bottom: 0.5rem;}
.medicine-card {
    background: var(--card-bg-color);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    position: relative;
    overflow: hidden;
}
.medicine-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--primary-color-light));
    opacity: 0;
    transition: opacity 0.3s ease;
}
.medicine-card:hover::before {
    opacity: 1;
}
.medicine-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: var(--primary-color-light);
}
.medicine-name {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}
.medicine-price {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 1rem;
}
.medicine-description {
    font-size: 0.9rem;
    color: var(--text-color-secondary);
    margin-bottom: 1rem;
    line-height: 1.4;
}
.quantity-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    justify-content: center;
}
.quantity-btn {
    width: 36px;
    height: 36px;
    border: 2px solid var(--border-color);
    background: var(--color-secondary);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1.1rem;
    transition: all 0.2s ease;
}
.quantity-btn:hover {
    background: var(--primary-color-light);
    border-color: var(--primary-color);
    color: white;
    transform: scale(1.05);
}
.quantity-btn:active {
    transform: scale(0.95);
}
.quantity-input {
    width: 70px;
    text-align: center;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 0.5rem;
    background: var(--color-secondary);
    font-size: 1rem;
    font-weight: 600;
    transition: border-color 0.2s ease;
}
.quantity-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
}
.category-card {
    cursor: pointer;
    text-align: center;
    padding: 1.5rem;
    transition: all 0.3s ease;
    border-radius: var(--radius-lg);
    background: var(--card-bg-color);
    border: 2px solid var(--border-color);
    position: relative;
}
.category-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: var(--primary-color-light);
}
.category-card.selected {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
    background: linear-gradient(135deg, rgba(13, 148, 136, 0.05), rgba(45, 212, 191, 0.05));
}
.category-card.selected::after {
    content: 'âœ“';
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}
.category-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    font-weight: 600;
}
.category-card p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-color-secondary);
}
.checkout-step {
    display: none;
    animation: fadeIn 0.5s ease;
}
.checkout-step.active { display: block; }
.payment-option {
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: var(--radius-lg);
    border: 2px solid var(--border-color);
    background: var(--card-bg-color);
    padding: 1rem;
    margin-bottom: 0.5rem;
    position: relative;
}
.payment-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    border-color: var(--primary-color-light);
}
.payment-option.selected {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
    background: linear-gradient(135deg, rgba(13, 148, 136, 0.05), rgba(45, 212, 191, 0.05));
}
.payment-option.selected::after {
    content: 'âœ“';
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}
.payment-option input[type="radio"] {
    margin: 0;
    width: 18px;
    height: 18px;
    accent-color: var(--primary-color);
}
.payment-option label {
    cursor: pointer;
    margin-left: 0.5rem;
    font-weight: 500;
}
.cart-icon {
    position: fixed;
    top: 120px;
    right: 1rem;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-color-light));
    color: white;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(13, 148, 136, 0.3);
    z-index: 100;
    font-size: 1.3rem;
    transition: all 0.3s ease;
    border: 3px solid white;
}
.cart-icon:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 25px rgba(13, 148, 136, 0.4);
}
.cart-icon:active {
    transform: scale(0.95);
}
.cart-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 26px;
    height: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
    border: 2px solid white;
    animation: cartPulse 2s infinite;
}
@keyframes cartPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    transition: all 0.2s ease;
    background: var(--card-bg-color);
}
.cart-item:hover {
    background-color: rgba(13, 148, 136, 0.02);
    transform: translateX(4px);
}
.cart-item:last-child { border-bottom: none; }
.cart-item-info { flex: 1; }
.cart-item-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--text-color);
}
.cart-item-details {
    font-size: 0.9rem;
    color: var(--text-color-secondary);
    line-height: 1.3;
}
.cart-item-price {
    font-weight: 600;
    color: var(--primary-color);
    margin-top: 0.25rem;
}
.cart-item-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-direction: column;
}
.cart-quantity {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: var(--color-secondary);
    border-radius: 8px;
    padding: 0.25rem;
}
.cart-quantity-btn {
    width: 28px;
    height: 28px;
    border: 1px solid var(--border-color);
    background: var(--color-secondary);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}
.cart-quantity-btn:hover {
    background: var(--primary-color-light);
    color: white;
    transform: scale(1.1);
}
.cart-quantity-btn:active { transform: scale(0.9); }
.cart-remove-btn {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s ease;
    margin-top: 0.5rem;
}
.cart-remove-btn:hover {
    background: #dc2626;
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}
#medicineOrderingContainer { display: none; }

/* Tracking */
.tracking-step {
    position: relative;
    padding-left: 3rem;
    padding-bottom: 2rem;
    transition: all 0.3s ease;
}
.tracking-step:last-child { padding-bottom: 0; }
.tracking-step::before {
    content: '';
    position: absolute;
    left: 0.75rem;
    top: 1.5rem;
    width: 3px;
    height: calc(100% - 1.5rem);
    background-color: var(--border-color);
    border-radius: 2px;
}
.tracking-dot {
    position: absolute;
    left: 0;
    top: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: var(--color-secondary);
    border: 3px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.tracking-step.completed .tracking-dot {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
}
.tracking-step.completed::before { background-color: var(--primary-color); }
.tracking-step.current .tracking-dot {
    background-color: var(--primary-color-light);
    border-color: var(--primary-color);
    animation: pulse 2s infinite;
}
.tracking-content {
    background: var(--card-bg-color);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}
.tracking-content:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
.tracking-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}
.tracking-description {
    font-size: 0.9rem;
    color: var(--text-color-secondary);
    line-height: 1.4;
}
.tracking-timestamp {
    font-size: 0.8rem;
    color: var(--text-color-secondary);
    margin-top: 0.5rem;
    font-style: italic;
}

/* Payment Form Styles */
.payment-form {
    animation: fadeIn 0.3s ease;
}

.payment-form .form-group {
    margin-bottom: 1rem;
}

.payment-form .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-color);
}

.payment-form .form-control {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--card-bg-color);
    color: var(--text-color);
    font-size: 1rem;
    transition: all 0.3s ease;
}

.payment-form .form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
}

.payment-form .form-control::placeholder {
    color: var(--text-color-secondary);
    opacity: 0.7;
}

.card-preview {
    background: linear-gradient(135deg, #0d9488, #14b8a6);
    color: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-family: 'Courier New', monospace;
}

.card-preview .preview-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}
/* New Gradient & Modal Styles */
        .modal-gradient-unique {
            /* Unique Teal-to-Blue gradient matching your site's primary color */
            background: linear-gradient(135deg, #0d9488, #14b8a6, #2dd4bf);
            border: 1px solid #2dd4bf;
        }

        #missedReminderList .reminder-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            display: flex;
            flex-direction: column; /* Stack info and actions */
            gap: 0.75rem;
        }

        #missedReminderList .reminder-info strong {
            font-size: 1.1rem;
        }

        #missedReminderList .reminder-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Button styles for the new modal */
        #missedReminderList .btn-taken {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        #missedReminderList .btn-skip {
            background-color: #ffc107;
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}


        /* Chatbot Screen */
        .chatbot-container { max-width: 800px; margin: auto; }
        .chat-window { height: 60vh; background-color: var(--color-secondary); border-radius: var(--radius-lg); padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; }
        .chat-message { padding: 0.75rem 1rem; border-radius: 12px; max-width: 75%; }
        .user-message { background-color: var(--primary-color); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .bot-message { background-color: white; color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-input { display: flex; gap: 0.5rem; }
        #chatInput { flex-grow: 1; }

        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; background-color: var(--card-bg-color); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); box-shadow: 0 -4px 20px var(--shadow-color); border-top: 1px solid var(--border-color); padding: 0.5rem 0; z-index: 1000; }
        .nav-button { background: none; border: none; cursor: pointer; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-color-secondary); padding: 0.5rem 0; transition: color 0.2s ease; }
        .nav-button.active { color: var(--primary-color); font-weight: 600; }
        .nav-button svg { width: 24px; height: 24px; }
        .nav-button span { font-size: 12px; }
        
        /* Language & Theme */
        .language-dropdown { position: relative; }
        .language-dropdown-toggle { cursor: pointer; background: transparent; border: none; color: var(--text-color-secondary); font-size: 1rem; padding: 8px; display: flex; align-items: center; border-radius: 999px; }
        .language-dropdown-menu { display: none; position: absolute; top: calc(100% + 8px); right: 0; min-width: 150px; border-radius: var(--radius-lg); padding: 8px; background: var(--card-bg-color); border: 1px solid var(--border-color); z-index: 1001; }
        .language-dropdown.open .language-dropdown-menu { display: block; }
        .language-option { display: block; padding: 8px 12px; color: var(--text-color-secondary); border-radius: 8px; cursor: pointer; }
        .theme-toggle { cursor: pointer; background-color: transparent; border: none; padding: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-color-secondary); }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg-color); border-radius: var(--radius-lg); padding: 2rem; text-align: center; max-width: 400px; width: 90%; }
        .modal-actions { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
        .prescription-content { text-align: left; }
        .prescription-content h3 { margin-bottom: 1rem; text-align: center; }
        .prescription-header { margin-bottom: 1.5rem; }
        .prescription-med-list { list-style: none; margin-bottom: 1.5rem; padding-left: 0; }
        .prescription-med-list li { background-color: var(--color-secondary); padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 0.5rem; }

        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control { width: 100%; padding: 0.85rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--color-secondary); }

        /* Call Screen */
        .call-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(13, 148, 136, 0.8), rgba(45, 212, 191, 0.8)); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; backdrop-filter: blur(10px); animation: fadeIn 0.3s ease; }
        .call-screen.active { display: flex; }
        .call-content { text-align: center; color: white; width: 100%; max-width: 1200px; }
        .call-content h1 { margin-bottom: 1rem; font-size: 2rem; }
        .video-container { display: flex; gap: 1rem; margin-bottom: 1rem; justify-content: center; flex-wrap: wrap; position: relative; }
        .video-wrapper { position: relative; }
        .video-element { width: 300px; height: 225px; background-color: #0f172a; border-radius: var(--radius-lg); object-fit: cover; }
        .local-video { width: 150px; height: 112px; position: absolute; bottom: 10px; right: 10px; border: 2px solid white; }
        .call-actions { display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem; }
        .message-section { background: rgba(255,255,255,0.1); border-radius: var(--radius-lg); padding: 1rem; width: 100%; max-width: 600px; }
        .messages { height: 150px; overflow-y: auto; margin-bottom: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 0.5rem; }
        .message { margin-bottom: 0.5rem; padding: 0.25rem; border-radius: 4px; }
        .message.patient { background: rgba(255,255,255,0.2); text-align: right; }
        .message.doctor { background: rgba(0,0,0,0.2); text-align: left; }
        .message-input { display: flex; gap: 0.5rem; }
        #messageInput { flex-grow: 1; padding: 0.5rem; border-radius: 8px; border: none; }

        /* Responsive */
        @media (min-width: 768px) {
            .bottom-nav { display: none; }
            .top-nav { display: flex; }
        }
        
        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .dashboard-grid > .info-card,
            .dashboard-grid > .tool-card {
                grid-column: auto; /* Reset column span to flow naturally */
            }
        }

        @media (max-width: 767px) {

            .header { 
                /* This was our fix for the dropdown */
                position: relative; 
                z-index: 100;

                /* These reset the desktop centering */
                transform: none; 
                left: 0;
                top: 0;
                
                /* These reset the desktop width */
                width: 100%;
                max-width: 100%;

                /* These reset the desktop style */
                border-radius: 0; 
                padding: 1rem; 
            }

            .page-content { padding-top: 1rem; }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Enhanced Chatbot Features */
        .interactive-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .interactive-buttons-container button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .interactive-buttons-container button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .interactive-buttons-container button.loading {
            animation: pulse-loading 1.5s ease-in-out infinite;
            cursor: not-allowed;
        }
        /* Mobile-specific styles for appointment cards */
@media (max-width: 767px) {
    .appointment-card-footer {
        flex-direction: column;
        align-items: stretch;
    }
    .appointment-card-footer > div {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
    }
    .appointment-card-footer .btn {
        flex: 1;
        text-align: center;
    }
}

        @keyframes pulse-loading {
            0% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.95); }
            100% { opacity: 0.7; transform: scale(1); }
        }

        .interactive-buttons-container .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .interactive-buttons-container .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .interactive-buttons-container .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        /* Medicine Reminder Styles */
        .medicine-reminder-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 1rem;
        }

        .reminder-item {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reminder-info h4 {
            margin: 0;
            font-size: 1rem;
        }

        .reminder-info p {
            margin: 0.25rem 0 0 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .reminder-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-taken {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-skip {
            background-color: #ffc107;
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .sos-alert {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
    </style>
</head>
<script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.2.js"></script>
<body data-theme="light">
    <div class="main-container">
        <div class="background-image"></div>
        <header class="header">
            <div class="cart-icon" aria-label="Cart" role="button" title="View Cart">ðŸ›’
    <div class="cart-badge">0</div>
</div>
            <div class="logo">Sehat Sahara</div>
            <nav class="top-nav">
                <a href="#" class="active" data-key="home_nav" data-screen="homeScreen">Home</a>
                <a href="#" data-key="appointments_nav" data-screen="appointmentsScreen">Appointments</a>
                <a href="#" data-key="records_nav" data-screen="healthRecordScreen">Records</a>
                <a href="#" data-key="book_nav" data-screen="bookingScreen">Book</a>
                <a href="#" data-key="more_nav" data-screen="moreScreen">More</a>
            </nav>
            <div class="actions">
                 <div class="language-dropdown">
                    <button class="language-dropdown-toggle"><span id="selectedLanguage">English</span></button>
                    <div class="language-dropdown-menu"></div>
                </div>
                <button class="theme-toggle" id="themeToggle">
                    <!-- --- MODIFIED: Corrected viewBox --- -->
                    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                <button class="btn btn-sos" id="sosButton">SOS</button>
            </div>
        </header>
        <div class="page-content">
            <main class="main">
                <section id="homeScreen" class="screen active">
                     <div class="welcome-card card">
                        <h1 id="welcomeMessage" data-key="welcome_message">Welcome, Guest</h1>
                        <p data-key="welcome_subtitle">Your health dashboard is ready.</p>
                    </div>
                    <div class="dashboard-grid">
                        <div class="info-card card">
                            <h3 data-key="next_appointment">Next Appointment</h3>
                            <p class="highlight">Today, 4:30 PM</p>
                            <p>Anjali Verma</p>
                        </div>
                        <div id="viewAllPrescriptions" class="info-card card" style="cursor: pointer;">
                              <h3 style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                                      <div class="icon" style="background-image: linear-gradient(45deg, #64748b, #94a3b8); width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                              <ellipse cx="12" cy="12" rx="10" ry="5"></ellipse>
                                          </svg>
                                      </div>
                                      <span data-key="new_prescriptions">New Prescriptions</span>
                                  </div>
                                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                      <path d="M9 18l6-6-6-6"></path>
                                  </svg>
                              </h3>
                              <p class="highlight">3 Total</p>
                              <p data-key="from_last_visit">From past visits</p>
                          </div>
                          <div id="medicineReminders" class="info-card card" style="cursor: pointer;">
    <h3 style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <div class="icon" style="background-image: linear-gradient(45deg, #ff6b6b, #ee5a52); width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                </svg>
            </div>
            <span data-key="medicine_reminders">Medicine Reminders</span>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 18l6-6-6-6"></path>
        </svg>
    </h3>
    <p class="highlight" id="pendingReminders">2 Pending</p>
    <p data-key="reminders_subtitle">Don't forget your medicines</p>
</div>
                        <div data-screen="scanMedicineScreen" class="tool-card card">
                            <div class="icon" style="background-image: linear-gradient(45deg, #3b82f6, #60a5fa);">
                                <!-- --- MODIFIED: Corrected viewBox --- -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                            </div>
                            <h3 data-key="scan_medicine">Scan Medicine</h3>
                        </div>
                        <div data-screen="bookMedicineScreen" class="tool-card card">
                            <div class="icon" style="background-image: linear-gradient(45deg, #16a34a, #4ade80);">
                                <!-- --- MODIFIED: Corrected viewBox --- -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                            </div>
                            <h3 data-key="book_medicine">Book Medicine</h3>
                        </div>
                        <div data-screen="chatbotScreen" class="tool-card card">
                            <div class="icon" style="background-image: linear-gradient(45deg, #8b5cf6, #a78bfa);">
                                <!-- --- MODIFIED: Corrected viewBox --- -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                            </div>
                            <h3 data-key="health_chatbot">Health Chatbot</h3>
                        </div>
                    </div>
                     </section>
                <section id="appointmentsScreen" class="screen">
                    <div class="page-header"><h1 data-key="appointments_title">My Appointments</h1></div>
                    <div id="appointments-container"></div>
                </section>
                <section id="prescriptionsScreen" class="screen">
                     <div class="page-header"><h1 data-key="prescriptions_title">My Prescriptions</h1></div>
                     <button class="btn btn-primary" id="uploadPrescriptionBtn" style="margin-bottom: 1rem;" data-key="upload_prescription_btn">Upload Offline Prescription</button>
                     <div id="prescriptions-container"></div>
                 </section>
                 <section id="medicineRemindersScreen" class="screen">
                     <div class="page-header">
                         <h1 data-key="reminders_title">ðŸ’Š Medicine Reminders</h1>
         <button class="btn btn-primary" id="addReminderBtn" style="margin-top: 1rem;" data-key="add_new_reminder">Add New Reminder</button>
     </div>
                     <div id="remindersContainer">
                         <!-- Medicine reminders will be loaded here -->
                     </div>
                 </section>
                <section id="healthRecordScreen" class="screen">
                    <div class="page-header"><h1 data-key="records_title">Digital Health Record</h1></div><div id="timeline-container"></div>
                </section>
                <section id="bookingScreen" class="screen">
                    <div class="page-header"><h1 data-key="book_title">Book a Consultation</h1></div>
                    <div id="bookingStep1" class="booking-step active">
                        <h3 data-key="book_step1">1. Select a Category</h3>
                        <div class="selection-grid" id="categoryGrid"></div>
                    </div>
                    <div id="bookingStep2" class="booking-step">
                        <h3 data-key="book_step2">2. Select a Doctor</h3>
                        <div class="selection-grid" id="doctorGrid"></div>
                    </div>
                    <div id="bookingStep3" class="booking-step">
                        <h3 data-key="book_step3">3. Select Date & Time</h3>
                        <div class="card calendar-container">
                            <div class="calendar-header">
                                <button class="btn" id="prevMonth">â€¹</button>
                                <h4 id="currentMonthYear"></h4>
                                <button class="btn" id="nextMonth">â€º</button>
                            </div>
                            <div class="calendar-grid">
                                <div style="font-weight: 600;">Sun</div><div style="font-weight: 600;">Mon</div><div style="font-weight: 600;">Tue</div><div style="font-weight: 600;">Wed</div><div style="font-weight: 600;">Thu</div><div style="font-weight: 600;">Fri</div><div style="font-weight: 600;">Sat</div>
                            </div>
                            <div class="calendar-grid" id="calendarDaysGrid"></div>
                        </div>
                        <div class="time-slots-grid" id="timeSlotsGrid"></div>
                    </div>
                    <div id="bookingStep4" class="booking-step">
                        <h3 data-key="book_step4">4. Select Consultation Mode</h3>
                        <div class="selection-grid" id="modeGrid"></div>
                    </div>
                    <div class="appointment-summary card" id="appointmentSummary" style="display:none;"></div>
                    <div class="booking-navigation">
                        <button class="btn" id="prevStep" disabled data-key="book_prev">Previous</button>
                    </div>
                </section>
                <section id="moreScreen" class="screen">
                    <div class="page-header"><h1 data-key="more_title">More Options</h1></div>
                    <div class="tool-card card" data-screen="reportIssueScreen"><div class="icon icon-report"><!-- --- MODIFIED: Corrected viewBox --- --><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div><h3 data-key="report_issue">Report an Issue</h3></div>
                    <button class="btn" id="logoutBtn" style="width: 100%; margin-top: 2rem; background-color: var(--text-color-secondary); color: white;" data-key="logout">Logout</button>
                </section>
                <section id="reportIssueScreen" class="screen">
                     <div class="page-header"><h1>Report an Issue</h1></div>
                     <form class="card" id="reportIssueForm">
                        <div class="form-group"><label for="report-type">Select Doctor/Pharmacy</label><select id="report-type" class="form-control"><option>Anjali Verma</option><option>Apollo Pharmacy</option></select></div>
                        <div class="form-group"><label for="report-reason">Reason</label><select id="report-reason" class="form-control"><option>Overcharged</option><option>Unprofessional</option><option>Wrong Medicine</option></select></div>
                        <div class="form-group"><label for="report-desc">Description</label><textarea id="report-desc" class="form-control" rows="3"></textarea></div>
                        <button type="submit" class="btn btn-primary" style="width:100%">Submit Report</button>
                    </form>
                </section>
                <section id="scanMedicineScreen" class="screen">
                    <div class="page-header"><h1 data-key="scan_medicine_title">Scan Medicine</h1></div>
                    <div class="card camera-container">
                        <video id="camera-feed" playsinline></video>
                        <p id="camera-status" data-key="camera_status_default">Click "Open Camera" to start scanning</p>
                        <div style="display: flex; gap: 1rem;">
    <button id="openCameraBtn" class="btn btn-primary" data-key="open_camera">Open Camera</button>
    <button id="scanCodeBtn" class="btn" data-key="scan_qr_code" disabled>Scan QR Code</button>
</div>
                    </div>
                </section>
                 <section id="bookMedicineScreen" class="screen">
    <div class="page-header">
        <h1 data-key="book_medicine_title">Book Medicine</h1>
        <button id="goToTrackOrdersBtn" class="btn" style="margin-top: 1rem;" data-key="track_my_orders">Track My Orders</button>
    </div>

    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 2rem; text-align: center;">
        <h3 style="margin-bottom: 1rem;" data-key="upload_prescription_banner_title">ðŸ“¤ Upload Prescription</h3>
        <p style="margin-bottom: 1.5rem; opacity: 0.9;" data-key="upload_prescription_banner_desc">Get medicines delivered based on your doctor's prescription</p>
        <button id="uploadPrescriptionBannerBtn" class="btn btn-primary" ... data-key="upload_prescription_banner_btn">Upload Prescription</button>
    </div>

    <div id="pharmacySelectionContainer">
        <h3 style="text-align: center; margin-bottom: 1.5rem;" data-key="select_pharmacy">Select a Pharmacy</h3>
        <div class="pharmacy-grid" id="pharmacyGrid"></div>
    </div>
   <div id="medicineOrderingContainer">
       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
           <h3 id="selectedPharmacyName"></h3>
           <button id="changePharmacyBtn" class="btn">Change</button>
       </div>

       <div class="medicine-categories" style="margin-bottom: 2rem;">
           <h3 style="text-align: center; margin-bottom: 1.5rem;" data-key="browse_by_category">Browse by Category</h3>
           <div class="categories-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
               <div class="category-card card" data-category="pain-fever">
                   <h4 data-key="cat_pain_fever">ðŸ’Š Pain & Fever</h4>
                   <p data-key="cat_pain_fever_desc">Paracetamol, Ibuprofen, Crocin</p>
               </div>
               <div class="category-card card" data-category="cough-cold">
                   <h4 data-key="cat_cough_cold">ðŸ¤§ Cough, Cold & Allergy</h4>
                   <p data-key="cat_cough_cold_desc">Cetirizine, Cough Syrup, Vicks</p>
               </div>
               <div class="category-card card" data-category="stomach">
                   <h4 data-key="cat_stomach">ðŸ«„ Stomach & Digestive</h4>
                   <p data-key="cat_stomach_desc">Digene, Pudin Hara, Eno</p>
               </div>
           </div>
       </div>

       <div id="medicineDisplayContainer">
           <div id="medicineGrid" class="medicine-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
               </div>
       </div>

       <div class="card">
               <div class="form-group">
                   <label for="medicineSearch" data-key="search_for_medicine">Search for medicine</label>
                   
                   <input type="search" id="medicineSearch" class="form-control" data-key="search_placeholder" placeholder="e.g., Paracetamol">
               </div>
               <div id="medicineDisplayContainer">
                   <ul class="medicine-list" id="medicineList"></ul>
               </div>
               
               <button id="checkoutBtn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;" disabled data-key="checkout_btn" data-variables='{"count": 0}'>Checkout (0 items)</button>
           </div>
   </div>
</section>
<section id="trackOrdersScreen" class="screen">
   <div class="page-header">
       <h1>My Medicine Orders</h1>
   </div>
   <div id="orders-list-container"></div>
</section>
<div id="missedReminderModal" class="modal">
        <div class="modal-content modal-gradient-unique" style="color: white;">
            <h3 id="missedReminderTitle" style="color: white;">â° Missed Reminders</h3>
            <p>You didn't acknowledge the following medicine reminders:</p>
            
            <div id="missedReminderList" style="text-align: left; margin-top: 1.5rem; max-height: 200px; overflow-y: auto;">
                </div>
            
            <div class="modal-actions" style="margin-top: 1.5rem;">
                 <button class="btn" id="closeMissedReminderModal" style="background: rgba(255,255,255,0.2);">Close</button>
            </div>
        </div>
    </div>
<div id="cartModal" class="modal">
   <div class="modal-content" style="max-width: 600px; width: 90%;">
       <h3>ðŸ›’ Shopping Cart</h3>
       <div id="cartItemsContainer" style="max-height: 400px; overflow-y: auto; margin: 1.5rem 0;">
           </div>
       <div id="cartSummary" style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-bottom: 1.5rem;">
           <div style="display: flex; justify-content: space-between; font-weight: 600; font-size: 1.1rem;">
               <span>Total:</span>
               <span id="cartTotal">â‚¹0.00</span>
           </div>
       </div>
       <div style="display: flex; gap: 1rem;">
           <button class="btn" onclick="document.getElementById('cartModal').classList.remove('active')">Continue Shopping</button>
           <button id="proceedToCheckoutBtn" class="btn btn-primary">Proceed to Checkout</button>
       </div>
   </div>
</div>

<div id="checkoutModal" class="modal">
   <div class="modal-content" style="max-width: 700px; width: 95%;">
       <div id="checkoutSteps">
           <div class="checkout-step active" id="checkoutStep1">
    <h3 data-key="checkout_step1_title">ðŸ“ Delivery Address</h3>
    <div class="form-group">
        <label for="deliveryAddress" data-key="checkout_address">Full Address</label>
        <textarea id="deliveryAddress" class="form-control" rows="3" placeholder_data_key="checkout_address_placeholder"></textarea> </div>
    <div class="form-group">
        <label for="deliveryInstructions" data-key="checkout_instructions">Delivery Instructions (Optional)</label>
        <input type="text" id="deliveryInstructions" class="form-control" placeholder_data_key="checkout_instructions_placeholder">
    </div>
    <button class="btn btn-primary" onclick="nextCheckoutStep()" data-key="checkout_continue_to_summary">Continue to Order Summary</button>
</div>

           <div class="checkout-step" id="checkoutStep2">
               <h3 data-key="checkout_step2_title">ðŸ“‹ Order Summary</h3>
               <div id="checkoutOrderSummary">
                   <div style="margin-bottom: 1.5rem;">
                       <h4 data-key="checkout_delivery_address">Delivery Address:</h4>
                       <p id="checkoutAddress" style="background: var(--color-secondary); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;"></p>
                   </div>
                   <div style="margin-bottom: 1.5rem;">
                       <h4 data-key="checkout_items">Items:</h4>
                       <div id="checkoutItems" style="max-height: 200px; overflow-y: auto; background: var(--color-secondary); border-radius: 8px; padding: 1rem;">
                           </div>
                   </div>
                   <div style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
                       <div style="display: flex; justify-content: space-between; font-weight: 600; font-size: 1.1rem;">
                           <span data-key="cart_total">Total:</span>
                           <span id="checkoutTotal">â‚¹0.00</span>
                       </div>
                   </div>
               </div>
               <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                   <button class="btn" onclick="prevCheckoutStep()" data-key="back">Back</button>
                   <button class="btn btn-primary" onclick="nextCheckoutStep()" data-key="checkout_continue_to_payment">Continue to Payment</button>
               </div>
           </div>

           <div class="checkout-step" id="checkoutStep3">
               <h3 data-key="checkout_step3_title">ðŸ’³ Payment Method</h3>
               <div class="payment-methods" style="display: grid; gap: 1rem;">
                   
                   <label class="payment-option card" style="display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 1rem;">
                       <input type="radio" name="paymentMethod" value="card" checked>
                       <div>
                           <strong data-key="payment_card">Credit / Debit Card</strong>
                           <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; opacity: 0.8;" data-key="payment_card_desc">Visa, Mastercard, RuPay</p>
                       </div>
                   </label>
                   
                   <label class="payment-option card" style="display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 1rem;">
                       <input type="radio" name="paymentMethod" value="netbanking">
                       <div>
                           <strong data-key="payment_netbanking">Net Banking</strong>
                           <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; opacity: 0.8;" data-key="payment_netbanking_desc">All major banks supported</p>
                       </div>
                   </label>
                   
                   <label class="payment-option card" style="display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 1rem;">
                       <input type="radio" name="paymentMethod" value="upi">
                       <div>
                           <strong data-key="payment_upi">UPI</strong>
                           <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; opacity: 0.8;" data-key="payment_upi_desc">Paytm, Google Pay, PhonePe, etc.</p>
                       </div>
                   </label>
                   
                   <label class="payment-option card" style="display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 1rem;">
                       <input type="radio" name="paymentMethod" value="cod">
                       <div>
                           <strong data-key="payment_cod">Cash on Delivery</strong>
                           <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; opacity: 0.8;" data-key="payment_cod_desc">Pay when you receive your order</p>
                       </div>
                   </label>
               </div>

               <div id="cardPaymentForm" class="payment-form" style="display: none; margin-top: 1.5rem;">
                   <div class="card" style="padding: 1.5rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                       <h4 style="margin-bottom: 1rem; color: var(--primary-color);" data-key="card_details">ðŸ’³ Card Details</h4>
                       <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                           <div class="form-group">
                               <label for="cardNumber" data-key="card_number">Card Number</label>
                               <input type="text" id="cardNumber" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19" oninput="formatCardNumber(this)">
                           </div>
                           <div class="form-group">
                               <label for="expiryDate" data-key="card_expiry">Expiry Date</label>
                               <input type="text" id="expiryDate" class="form-control" placeholder="MM/YY" maxlength="5" oninput="formatExpiryDate(this)">
                           </div>
                       </div>
                       <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                           <div class="form-group">
                               <label for="cvv" data-key="card_cvv">CVV</label>
                               <input type="text" id="cvv" class="form-control" placeholder="123" maxlength="4">
                           </div>
                           <div class="form-group">
                               <label for="cardholderName" data-key="card_name">Cardholder Name</label>
                               <input type="text" id="cardholderName" class="form-control" placeholder="John Doe">
                           </div>
                       </div>
                       </div>
               </div>

               <div id="upiPaymentForm" class="payment-form" style="display: none; margin-top: 1.5rem;">
                   <div class="card" style="padding: 1.5rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                       <h4 style="margin-bottom: 1rem; color: var(--primary-color);" data-key="upi_details">ðŸ“± UPI Payment</h4>
                       <div class="form-group">
                           <label for="upiId" data-key="upi_id">UPI ID</label>
                           <input type="text" id="upiId" class="form-control" placeholder="yourname@paytm / yourname@oksbi">
                       </div>
                       </div>
               </div>

               <div id="netbankingForm" class="payment-form" style="display: none; margin-top: 1.5rem;">
                   <div class="card" style="padding: 1.5rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                       <h4 style="margin-bottom: 1rem; color: var(--primary-color);" data-key="netbanking_details">ðŸ¦ Net Banking</h4>
                       <div class="form-group">
                           <label for="bankSelect" data-key="netbanking_select_bank">Select Your Bank</label>
                           <select id="bankSelect" class="form-control" data-key-placeholder="netbanking_select_bank_placeholder">
                               <option value="" data-key="netbanking_select_bank_placeholder">Choose your bank...</option>
                               </select>
                       </div>
                   </div>
               </div>

               <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                   <button class="btn" onclick="prevCheckoutStep()" data-key="back">Back</button>
                   <button class="btn btn-primary" onclick="processPayment()" data-key="proceed_to_pay">Proceed to Pay</button>
               </div>
           </div>

           <div class="checkout-step" id="checkoutStep4">
               <div style="text-align: center;">
                   <div style="font-size: 3rem; margin-bottom: 1rem;">âœ…</div>
                   <h3 data-key="checkout_step4_title">Order Placed Successfully!</h3>
                   <p style="margin: 1rem 0; color: var(--text-color-secondary);" data-key="checkout_success_msg">Your order has been received and is being processed.</p>
                   <div class="card" style="margin: 1.5rem 0; text-align: left;">
                       <p><strong data-key="order_id">Order ID:</strong> <span id="orderIdDisplay"></span></p>
                       <p><strong data-key="est_delivery">Estimated Delivery:</strong> <span id="deliveryTimeDisplay"></span></p>
                   </div>
                   <button class="btn btn-primary" onclick="trackOrder()" data-key="track_your_order">Track Your Order</button>
               </div>
           </div>
       </div>
   </div>
</div>
                <section id="chatbotScreen" class="screen">
                    <div class="page-header"><h1 data-key="health_chatbot_title">Health Assistant</h1></div>
                    <div class="card chatbot-container">
                        <div class="chat-window" id="chatWindow"></div>
                            <form class="chat-input" id="chatForm">
    <input type="text" id="chatInput" class="form-control" data-key="chatbot_placeholder" placeholder="Ask about symptoms, dosage or press the ðŸŽ¤ button ">

    <button type="button" class="btn" id="record-button" style="min-width: 50px;">ðŸŽ¤</button>

    <button type="submit" class="btn btn-primary" data-key="send">Send</button>
</form>
                    </div>
                </section>
            </main>
        </div>
    </div>
    
    <nav class="bottom-nav">
        <!-- --- MODIFIED: Corrected viewBox on all nav icons --- -->
        <button class="nav-button active" data-screen="homeScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span data-key="home_nav">Home</span></button>
        <button class="nav-button" data-screen="appointmentsScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span data-key="appointments_nav">Appointments</span></button>
        <button class="nav-button" data-screen="healthRecordScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg><span data-key="records_nav">Records</span></button>
        <button class="nav-button" data-screen="bookingScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path><path d="M12 12l4-4"></path><path d="M12 6v6h6"></path></svg><span data-key="book_nav">Book</span></button>
        <button class="nav-button" data-screen="moreScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg><span data-key="more_nav">More</span></button>
    </nav>
    
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div class="modal-actions">
                 <button class="btn btn-primary" id="closeModal">OK</button>
            </div>
        </div>
    </div>
    <div id="sosCountdownModal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 data-key="sos_title">ðŸš¨ EMERGENCY ACTIVATION</h3>
        <p id="countdownText" data-key="sos_countdown_text" data-variables='{"seconds": 5}'>Activating emergency services in 5 seconds...</p>
        <div id="countdownNumber" style="font-size: 3rem; font-weight: bold; color: var(--sos-color); margin: 1rem 0;">5</div>
        <button class="btn" id="cancelCountdown" style="background: #ef4444; color: white;" data-key="sos_cancel">Cancel Emergency</button>
    </div>
</div>
   <div id="sosModal" class="modal">
    <div class="modal-content">
        <h3 data-key="sos_confirm_title">Emergency SOS</h3>
        <p data-key="sos_confirm_msg">This will call emergency services and send your location. Are you sure?</p>
        <div class="modal-actions">
            <button class="btn" id="cancelSos" data-key="sos_confirm_cancel">Cancel</button>
            <button class="btn btn-sos" id="confirmSos" data-key="sos_confirm_ok">Confirm</button>
        </div>
    </div>
</div>
    <div id="prescriptionModal" class="modal"><div class="modal-content prescription-content" id="prescriptionModalContent"></div></div>
    <div id="callScreen" class="call-screen">
        <div class="call-content">
            <h1 id="callWithDoctor"></h1>
            <div class="video-container">
                <div class="video-wrapper">
                    <video id="remoteVideo" class="video-element" autoplay playsinline></video>
                    <video id="localVideo" class="video-element local-video" autoplay playsinline muted></video>
                </div>
            </div>
            <div class="call-actions">
    <button class="btn" id="startCallBtn" data-key="start_call">Start Call</button>
    <button class="btn" id="muteAudioBtn" data-key="mute_audio">Mute Audio</button>
    <button class="btn" id="muteVideoBtn" data-key="mute_video">Mute Video</button>
    <button class="btn btn-sos" id="endCallBtn" data-key="end_call">End Call</button>
</div>
            <div id="connectionStatus" style="text-align: center; margin-top: 1rem; padding: 0.5rem; border-radius: 8px; background: rgba(0,0,0,0.1); display: none;">
                <span id="statusText">Connecting...</span>
            </div>
            <div id="videoStatus" style="text-align: center; margin-top: 0.5rem; padding: 0.25rem; font-size: 0.8rem; color: var(--text-color-secondary); display: none;">
                <span id="videoStatusText">Video status will appear here</span>
            </div>
            <div class="message-section">
                <div id="messages" class="messages"></div>
                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="Type a message...">
                    <button class="btn btn-primary" id="sendMessageBtn">Send</button>
                </div>
            </div>
        </div>
    </div>
    <div id="trackingModal" class="modal">
        <div class="modal-content">
            <h3>Track Your Order</h3>
            <div id="trackingStatusContainer" style="text-align: left; margin-top: 1.5rem;"></div>
            <button class="btn btn-primary" id="closeTrackingModal" style="margin-top: 1.5rem;">Close</button>
        </div>
    </div>
    <div id="uploadPrescriptionModal" class="modal">
    <div class="modal-content">
        <h3 data-key="add_offline_prescription_title">Add Offline Prescription</h3>
        <div class="form-group">
            <label for="providerName" data-key="provider_name">Provider Name</label>
            <input type="text" id="providerName" class="form-control" data-key="provider_name_placeholder" placeholder="e.g., Local Store">
        </div>
        <video id="uploadCameraFeed" playsinline style="width: 100%; max-width: 500px; border-radius: var(--radius-lg); background: #333; aspect-ratio: 4 / 3;"></video>
        <p id="uploadCameraStatus" data-key="camera_status_default">Click "Open Camera" to start scanning</p>
        <div style="display: flex; gap: 1rem;">
            <button id="openUploadCameraBtn" class="btn btn-primary" data-key="open_camera">Open Camera</button>
            <button id="capturePrescriptionBtn" class="btn" data-key="save_prescription" disabled>Save Prescription</button>
        </div>
        <button class="btn" id="closeUploadModal" style="margin-top: 1rem;" data-key="close">Close</button>
    </div>
</div>
    <div id="medicineReminderModal" class="modal">
    <form class="modal-content" id="medicineReminderForm"> 
        <h3 data-key="add_reminder_title">Add Medicine Reminder</h3>
        <div class="form-group">
            <label for="medicineName" data-key="medicine_name">Medicine Name</label>
            <input type="text" id="medicineName" class="form-control" data-key="medicine_name_placeholder" placeholder="e.g., Paracetamol">
        </div>
        <div class="form-group">
            <label for="medicineDosage" data-key="dosage">Dosage</label>
            <input type="text" id="medicineDosage" class="form-control" data-key="medicine_dosage_placeholder" placeholder="e.g., 500mg">
        </div>
        <div class="form-group">
            <label for="medicineTimes" data-key="medicine_times">Times (comma separated)</label>
            <input type="text" id="medicineTimes" class="form-control" data-key="medicine_times_placeholder" placeholder="e.g., 08:00, 14:00, 20:00">
        </div>
        <div class="form-group">
            <label for="medicineDuration" data-key="medicine_duration">Duration (days)</label>
            <input type="number" id="medicineDuration" class="form-control" value="30">
        </div>
        <div class="form-group">
            <label for="medicineInstructions" data-key="instructions">Instructions</label>
            <textarea id="medicineInstructions" class="form-control" rows="2" data-key="medicine_instructions_placeholder" placeholder="e.g., Take after meals"></textarea>
        </div>
        <div style="display: flex; gap: 1rem;">
            <button id="saveReminderBtn" class="btn btn-primary" data-key="save_reminder">Save Reminder</button>
            <button type="button" class="btn" onclick="document.getElementById('medicineReminderModal').classList.remove('active')" data-key="cancel">Cancel</button>
        </div>
    </form> 
</div>


    <script>
    
        // Dynamic API URL configuration
        
        // For local development, uncomment and modify:
        // const API_BASE_URL = 'http://localhost:5000';

        // For Render deployment, uncomment if needed:
         //const API_BASE_URL = 'https://sahara-sathi.onrender.com';
        const API_BASE_URL = '/api';
         // --- REPLACE this line: let user = null, currentLanguage = 'en', ... 
         console.log('Using API base URL:', API_BASE_URL);
         
            let user = null, bookingState = {}, currentMonth = new Date().getMonth(), currentYear = new Date().getFullYear(), medicineCart = [], selectedPharmacy = null, doctors = [];
            
            // --- ADD THIS BLOCK to load the saved language ---
            let currentLanguage = localStorage.getItem('userLanguage') || 'en'; // Load saved lang, default to 'en'
            // --- END ADD ---

            const translations = {
                // REPLACE your old 'en' object with this COMPLETE one
en: {
    // --- Nav & Header ---
    home_nav: "Home",
    appointments_nav: "Appointments",
    records_nav: "Records",
    book_nav: "Book",
    more_nav: "More",
    logout: "Logout",
    
    // --- Home Screen ---
    welcome_message: "Welcome, {name}",
    welcome_subtitle: "Your health dashboard is ready.",
    next_appointment: "Next Appointment",
    new_prescriptions: "New Prescriptions",
    from_last_visit: "From past visits",
    medicine_reminders: "Medicine Reminders",
    pending_reminders: "{count} Pending", // Or "Total Active" if you prefer
    reminders_subtitle: "Don't forget your medicines",
    scan_medicine: "Scan Medicine",
    book_medicine: "Book Medicine",
    health_chatbot: "Health Chatbot",

    // --- Page Titles ---
    appointments_title: "My Appointments",
    prescriptions_title: "My Prescriptions",
    reminders_title: "ðŸ’Š Medicine Reminders",
    records_title: "Digital Health Record",
    book_title: "Book a Consultation",
    more_title: "More Options",
    report_issue_title: "Report an Issue",
    scan_medicine_title: "Scan Medicine",
    book_medicine_title: "Book Medicine",
    health_chatbot_title: "Health Assistant",
    track_orders_title: "My Medicine Orders",
    
    // --- Appointments Screen ---
    upcoming: "Upcoming",
    past: "Past",
    demo_call_title: "Live Demo Call",
    demo_call_subtitle: "Test the Video Call Feature",
    demo_call_desc: "Available anytime for demonstration",
    demo_call_tag: "Demo",
    call_doctor: "Call Doctor",
    message_doctor: "Message Doctor",
    join_call: "Join Call",
    join_call_now: "Join Call Now",
    reschedule: "Reschedule",
    view_prescription: "View Prescription",
    no_upcoming_appts: "No upcoming appointments.",
    no_upcoming_appts_subtitle: "You can book a new one anytime.",
    no_past_appts: "No past appointments.",
    today_at_time: "Today, {time}",
    
    // --- Prescriptions Screen ---
    upload_prescription_btn: "Upload Offline Prescription",
    no_prescriptions_found: "No prescriptions found.",

    // --- Reminders Screen ---
    add_new_reminder: "Add New Reminder",
    active_reminders: "Active Reminders",
    reminders_scheduled: "{count} medicine reminder(s) scheduled",
    dosage: "Dosage",
    frequency: "Frequency",
    duration: "Duration",
    times: "Times",
    instructions: "Instructions",
    mark_as_taken: "Mark as Taken",
    edit: "Edit",
    delete: "Delete",
    no_reminders_title: "No Medicine Reminders",
    no_reminders_subtitle: "You don't have any active medicine reminders yet.",
    
    // --- Booking Screen ---
    book_step1: "1. Select a Category",
    book_step2: "2. Select a Doctor",
    book_step3: "3. Select Date & Time",
    book_step4: "4. Select Consultation Mode",
    book_prev: "Previous",
    appt_summary_title: "Appointment Summary",
    book_appt_btn: "Book Appointment",
    
    // --- More Screen ---
    report_issue: "Report an Issue",
    
    // --- Report Issue Screen ---
    report_select_placeholder: "Select Doctor/Pharmacy",
    report_reason: "Reason",
    report_reason_overcharged: "Overcharged",
    report_reason_unprofessional: "Unprofessional",
    report_reason_wrong_medicine: "Wrong Medicine",
    report_desc: "Description",
    report_submit_btn: "Submit Report",
    
    // --- Scan Medicine Screen ---
    camera_status_default: "Click \"Open Camera\" to start scanning",
    open_camera: "Open Camera",
    scan_qr_code: "Scan QR Code",
    scan_medicine_btn: "Scan Medicine",
    camera_active_status: "Camera is active. Point camera at medicine packaging and click 'Scan Medicine'.",
    camera_permission_error: "Could not access camera. Please check permissions.",
    scanning_medicine: "Scanning medicine...",
    
    // --- Book Medicine Screen ---
    track_my_orders: "Track My Orders",
    upload_prescription_banner_title: "ðŸ“¤ Upload Prescription",
    upload_prescription_banner_desc: "Get medicines delivered based on your doctor's prescription",
    upload_prescription_banner_btn: "Upload Prescription",
    select_pharmacy: "Select a Pharmacy",
    change: "Change",
    ordering_from: "Ordering from: {name}",
    browse_by_category: "Browse by Category",
    cat_pain_fever: "ðŸ’Š Pain & Fever",
    cat_pain_fever_desc: "Paracetamol, Ibuprofen, Crocin",
    cat_cough_cold: "ðŸ¤§ Cough, Cold & Allergy",
    cat_cough_cold_desc: "Cetirizine, Cough Syrup, Vicks",
    cat_stomach: "ðŸ«„ Stomach & Digestive",
    cat_stomach_desc: "Digene, Pudin Hara, Eno",
    search_for_medicine: "Search for medicine",
    search_placeholder: "e.g., Paracetamol",
    add_to_cart: "Add to Cart",
    checkout_btn: "Checkout ({count} items)",
    
    // --- Cart & Checkout Modals ---
    shopping_cart_title: "ðŸ›’ Shopping Cart",
    cart_empty: "Your cart is empty",
    cart_total: "Total:",
    continue_shopping: "Continue Shopping",
    proceed_to_checkout: "Proceed to Checkout",
    checkout_step1_title: "ðŸ“ Delivery Address",
    checkout_address: "Full Address",
    checkout_address_placeholder: "Enter your complete delivery address",
    checkout_instructions: "Delivery Instructions (Optional)",
    checkout_instructions_placeholder: "e.g., Ring doorbell twice",
    checkout_continue_to_summary: "Continue to Order Summary",
    checkout_step2_title: "ðŸ“‹ Order Summary",
    checkout_delivery_address: "Delivery Address:",
    checkout_items: "Items:",
    checkout_continue_to_payment: "Continue to Payment",
    back: "Back",
    checkout_step3_title: "ðŸ’³ Payment Method",
    payment_card: "Credit / Debit Card",
    payment_card_desc: "Visa, Mastercard, RuPay",
    payment_netbanking: "Net Banking",
    payment_netbanking_desc: "All major banks supported",
    payment_upi: "UPI",
    payment_upi_desc: "Paytm, Google Pay, PhonePe, etc.",
    payment_cod: "Cash on Delivery",
    payment_cod_desc: "Pay when you receive your order",
    card_details: "ðŸ’³ Card Details",
    card_number: "Card Number",
    card_expiry: "Expiry Date",
    card_cvv: "CVV",
    card_name: "Cardholder Name",
    upi_details: "ðŸ“± UPI Payment",
    upi_id: "UPI ID",
    netbanking_details: "ðŸ¦ Net Banking",
    netbanking_select_bank: "Select Your Bank",
    netbanking_select_bank_placeholder: "Choose your bank...",
    proceed_to_pay: "Proceed to Pay",
    processing: "Processing...",
    checkout_step4_title: "âœ… Order Placed Successfully!",
    checkout_success_msg: "Your order has been received and is being processed.",
    order_id: "Order ID:",
    est_delivery: "Estimated Delivery:",
    track_your_order: "Track Your Order",
    
    // --- Track Orders Screen ---
    order_status_placed: "Order Confirmed",
    order_status_preparing: "Processing at Pharmacy",
    order_status_delivery: "Out for Delivery",
    order_status_delivered: "Delivered",
    order_status_placed_desc: "Your order has been received and confirmed.",
    order_status_preparing_desc: "The pharmacy is preparing your items.",
    order_status_delivery_desc: "Your delivery partner is on the way.",
    order_status_delivered_desc: "Your order has been delivered successfully.",
    
    // --- Chatbot ---
    chatbot_placeholder: "Ask about symptoms, dosage...",
    send: "Send",
    chatbot_welcome: "Welcome to Enhanced Sehat Sahara! I can help with appointments, prescriptions, medicine reminders, and health guidance.",
    chatbot_typing: "Typing...",
    chatbot_processing_voice: "... (Processing voice input) ...",
    chatbot_voice_error: "I'm sorry, I couldn't process your voice. Please try again.",
    chatbot_connect_error: "I'm sorry, I'm having trouble connecting right now. Please try again in a moment.",
    chatbot_record_hint: "Press again to stop recording and send âž”", // <-- ADD THIS

    // --- Call Screen ---
    call_with: "Consultation with {name}",
    call_waiting: "Waiting to connect...",
    start_call: "Start Call",
    mute_audio: "Mute Audio",
    unmute_audio: "Unmute Audio",
    mute_video: "Mute Video",
    unmute_video: "Unmute Video",
    end_call: "End Call",
    call_connecting: "Connecting...",
    call_doctor_connected: "Doctor connected!",
    call_doctor_left: "Doctor left",
    call_ended: "Call ended",
    call_status_connecting: "Joining channel...",
    call_status_access_mic: "Accessing microphone...",
    call_status_access_cam: "Accessing front camera...",
    call_status_cam_error: "Could not access front camera. Trying default.",
    call_status_cam_fail: "Error accessing camera.",
    call_status_publishing: "Publishing your stream...",
    call_status_waiting_doctor: "Waiting for doctor...",
    call_token_error: "Failed to get call token. Please try again.",
    call_id_missing_error: "Error: Appointment ID missing.",

    // --- Modals (SOS, Confirmation, etc.) ---
    sos_title: "ðŸš¨ EMERGENCY ACTIVATION",
    sos_countdown_text: "Activating emergency services in {seconds} seconds...",
    sos_cancel: "Cancel Emergency",
    sos_confirm_title: "Emergency SOS",
    sos_confirm_msg: "This will call emergency services and send your location. Are you sure?",
    sos_confirm_cancel: "Cancel",
    sos_confirm_ok: "Confirm",
    
    // --- JavaScript Confirmation Modals (Titles) ---
    sos_activated_title: "SOS Activated",
    sos_failed_title: "SOS Failed",
    report_submitted_title: "Report Submitted",
    appt_booked_title: "Appointment Booked!",
    scan_successful_title: "Scan Successful",
    scan_failed_title: "Scan Failed",
    upload_failed_title: "Upload Failed",
    added_to_cart_title: "Added to Cart",
    cart_empty_title: "Cart Empty",
    address_required_title: "Address Required",
    invalid_card_title: "Invalid Card",
    invalid_upi_title: "Invalid UPI",
    login_required_title: "Login Required",
    pharmacy_required_title: "Pharmacy Not Selected",
    order_failed_title: "Order Failed",
    reminder_success_title: "Success",
    reminder_deleted_title: "Reminder Deleted",
    reminder_error_title: "Error",
    reminder_delete_confirm: "Are you sure you want to delete the reminder for {name}?",
    logged_out_title: "Logged Out",
    
    // --- JavaScript Confirmation Modals (Messages) ---
    sos_activated_msg: "Emergency services have been notified. Help is on the way.",
    sos_failed_msg: "Failed to activate emergency services. Please call 108 directly.",
    report_submitted_msg: "Your report has been sent for review.",
    appt_booked_msg: "Your appointment has been successfully scheduled.",
    scan_failed_generic_msg: "Could not identify the medicine.",
    upload_failed_msg: "Failed to save prescription. Please try again.",
    cart_empty_msg: "Please add items to your cart.",
    address_required_msg: "Please enter your delivery address.",
    invalid_card_msg: "Please enter a valid 16-digit card number.",
    invalid_upi_msg: "Please enter a valid UPI ID.",
    login_required_msg: "You must be logged in to place an order.",
    pharmacy_required_msg: "Please select a pharmacy before placing an order.",
    order_failed_generic_msg: "There was an error placing your order: {error}",
    reminder_added_msg: "Medicine reminder added!",
    reminder_updated_msg: "Medicine reminder updated!",
    reminder_deleted_msg: "The reminder for {name} has been removed.",
    reminder_delete_failed_msg: "Failed to delete reminder.",
    reminder_taken_msg: "{name} marked as taken!",
    reminder_load_error_msg: "Could not find reminder details to edit.",
    logged_out_msg: "You have been successfully logged out.",
    try_again_msg: "Please try again.",
    is_required_msg: "is required.",

    // --- Missed Reminder Modal ---
    missed_reminders_title: "â° Missed Reminders",
    missed_reminders_desc: "You didn't acknowledge the following medicine reminders:",
    close: "Close",
    skip_this_time: "Skip This Time",
    
    // --- Add/Edit Reminder Modal ---
    add_reminder_title: "Add Medicine Reminder",
    update_reminder_title: "Update Medicine Reminder",
    medicine_name: "Medicine Name",
    medicine_name_placeholder: "e.g., Paracetamol",
    medicine_dosage_placeholder: "e.g., 500mg",
    medicine_times: "Times (comma separated)",
    medicine_times_placeholder: "e.g., 08:00, 14:00, 20:00",
    medicine_duration: "Duration (days)",
    medicine_instructions_placeholder: "e.g., Take after meals",
    save_reminder: "Save Reminder",
    update_reminder: "Update Reminder",
    cancel: "Cancel",
    med_desc_paracetamol: "Effective pain relief and fever reducer",
    med_desc_ibuprofen: "Anti-inflammatory pain relief",
    med_desc_crocin: "Advanced pain relief formula",
    med_desc_cetirizine: "Allergy relief and antihistamine",
    med_desc_grilinctus: "Effective cough suppressant",
    med_desc_vicks: "Multi-symptom cold relief",
    med_desc_digene: "Fast relief from acidity and gas",
    med_desc_pudin_hara: "Ayurvedic digestive relief",
    med_desc_eno: "Instant relief from acidity",
    
    // --- Upload Prescription Modal ---
    add_offline_prescription_title: "Add Offline Prescription",
    provider_name: "Provider Name",
    provider_name_placeholder: "e.g., Local Store",
    save_prescription: "Save Prescription",
    // Add these keys inside 'en'
"General Physician": "General Physician",
"Dermatologist": "Dermatologist",
"Child Specialist": "Child Specialist",
"Video": "Video",
"Audio": "Audio",
"Offline": "Offline"
},
hi: {
    // --- Nav & Header ---
    home_nav: "à¤¹à¥‹à¤®",
    appointments_nav: "à¤…à¤ªà¥‰à¤‡à¤‚à¤Ÿà¤®à¥‡à¤‚à¤Ÿà¥à¤¸",
    records_nav: "à¤°à¤¿à¤•à¥‰à¤°à¥à¤¡à¥à¤¸",
    book_nav: "à¤¬à¥à¤• à¤•à¤°à¥‡à¤‚",
    more_nav: "à¤”à¤°",
    logout: "à¤²à¥‰à¤—à¤†à¤‰à¤Ÿ",
    
    // --- Home Screen ---
    welcome_message: "à¤¨à¤®à¤¸à¥à¤¤à¥‡, {name}",
    welcome_subtitle: "à¤†à¤ªà¤•à¤¾ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤¡à¥ˆà¤¶à¤¬à¥‹à¤°à¥à¤¡ à¤¤à¥ˆà¤¯à¤¾à¤° à¤¹à¥ˆà¥¤",
    next_appointment: "à¤…à¤—à¤²à¥€ à¤…à¤ªà¥‰à¤‡à¤‚à¤Ÿà¤®à¥‡à¤‚à¤Ÿ",
    new_prescriptions: "à¤¨à¤ à¤¨à¥à¤¸à¥à¤–à¥‡",
    from_last_visit: "à¤ªà¤¿à¤›à¤²à¥€ à¤®à¥à¤²à¤¾à¤•à¤¼à¤¾à¤¤ à¤¸à¥‡",
    medicine_reminders: "à¤¦à¤µà¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤°",
    pending_reminders: "{count} à¤ªà¥‡à¤‚à¤¡à¤¿à¤‚à¤—",
    reminders_subtitle: "à¤…à¤ªà¤¨à¥€ à¤¦à¤µà¤¾à¤à¤‚ à¤¨ à¤­à¥‚à¤²à¥‡à¤‚",
    scan_medicine: "à¤¦à¤µà¤¾ à¤¸à¥à¤•à¥ˆà¤¨ à¤•à¤°à¥‡à¤‚",
    book_medicine: "à¤¦à¤µà¤¾ à¤¬à¥à¤• à¤•à¤°à¥‡à¤‚",
    health_chatbot: "à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤¸à¤¹à¤¾à¤¯à¤•",

    // --- Page Titles ---
    appointments_title: "à¤®à¥‡à¤°à¥€ à¤…à¤ªà¥‰à¤‡à¤‚à¤Ÿà¤®à¥‡à¤‚à¤Ÿà¥à¤¸",
    prescriptions_title: "à¤®à¥‡à¤°à¥‡ à¤¨à¥à¤¸à¥à¤–à¥‡",
    reminders_title: "ðŸ’Š à¤¦à¤µà¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤°",
    records_title: "à¤¡à¤¿à¤œà¤¿à¤Ÿà¤² à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤°à¤¿à¤•à¥‰à¤°à¥à¤¡",
    book_title: "à¤ªà¤°à¤¾à¤®à¤°à¥à¤¶ à¤¬à¥à¤• à¤•à¤°à¥‡à¤‚",
    more_title: "à¤…à¤¨à¥à¤¯ à¤µà¤¿à¤•à¤²à¥à¤ª",
    report_issue_title: "à¤¸à¤®à¤¸à¥à¤¯à¤¾ à¤•à¥€ à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ à¤•à¤°à¥‡à¤‚",
    scan_medicine_title: "à¤¦à¤µà¤¾ à¤¸à¥à¤•à¥ˆà¤¨ à¤•à¤°à¥‡à¤‚",
    book_medicine_title: "à¤¦à¤µà¤¾ à¤¬à¥à¤• à¤•à¤°à¥‡à¤‚",
    health_chatbot_title: "à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤¸à¤¹à¤¾à¤¯à¤•",
    track_orders_title: "à¤®à¥‡à¤°à¥‡ à¤®à¥‡à¤¡à¤¿à¤¸à¤¿à¤¨ à¤‘à¤°à¥à¤¡à¤°à¥à¤¸",
    
    // --- Appointments Screen ---
    upcoming: "à¤†à¤—à¤¾à¤®à¥€",
    past: "à¤ªà¤¿à¤›à¤²à¥‡",
    demo_call_title: "à¤²à¤¾à¤‡à¤µ à¤¡à¥‡à¤®à¥‹ à¤•à¥‰à¤²",
    demo_call_subtitle: "à¤µà¥€à¤¡à¤¿à¤¯à¥‹ à¤•à¥‰à¤² à¤«à¤¼à¥€à¤šà¤° à¤•à¤¾ à¤ªà¤°à¥€à¤•à¥à¤·à¤£ à¤•à¤°à¥‡à¤‚",
    demo_call_desc: "à¤ªà¥à¤°à¤¦à¤°à¥à¤¶à¤¨ à¤•à¥‡ à¤²à¤¿à¤ à¤•à¤¿à¤¸à¥€ à¤­à¥€ à¤¸à¤®à¤¯ à¤‰à¤ªà¤²à¤¬à¥à¤§",
    demo_call_tag: "à¤¡à¥‡à¤®à¥‹",
    call_doctor: "à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤•à¥‹ à¤•à¥‰à¤² à¤•à¤°à¥‡à¤‚",
    message_doctor: "à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤•à¥‹ à¤®à¥ˆà¤¸à¥‡à¤œ à¤•à¤°à¥‡à¤‚",
    join_call: "à¤•à¥‰à¤² à¤®à¥‡à¤‚ à¤¶à¤¾à¤®à¤¿à¤² à¤¹à¥‹à¤‚",
    join_call_now: "à¤…à¤­à¥€ à¤•à¥‰à¤² à¤®à¥‡à¤‚ à¤¶à¤¾à¤®à¤¿à¤² à¤¹à¥‹à¤‚",
    reschedule: "à¤ªà¥à¤¨à¤°à¥à¤¨à¤¿à¤°à¥à¤§à¤¾à¤°à¤¿à¤¤ à¤•à¤°à¥‡à¤‚",
    view_prescription: "à¤¨à¥à¤¸à¥à¤–à¤¾ à¤¦à¥‡à¤–à¥‡à¤‚",
    no_upcoming_appts: "à¤•à¥‹à¤ˆ à¤†à¤—à¤¾à¤®à¥€ à¤…à¤ªà¥‰à¤‡à¤‚à¤Ÿà¤®à¥‡à¤‚à¤Ÿ à¤¨à¤¹à¥€à¤‚à¥¤",
    no_upcoming_appts_subtitle: "à¤†à¤ª à¤•à¤­à¥€ à¤­à¥€ à¤à¤• à¤¨à¤¯à¤¾ à¤¬à¥à¤• à¤•à¤° à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤",
    no_past_appts: "à¤•à¥‹à¤ˆ à¤ªà¤¿à¤›à¤²à¥€ à¤…à¤ªà¥‰à¤‡à¤‚à¤Ÿà¤®à¥‡à¤‚à¤Ÿ à¤¨à¤¹à¥€à¤‚à¥¤",
    
    // --- Prescriptions Screen ---
    upload_prescription_btn: "à¤‘à¤«à¤²à¤¾à¤‡à¤¨ à¤¨à¥à¤¸à¥à¤–à¤¾ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚",
    no_prescriptions_found: "à¤•à¥‹à¤ˆ à¤¨à¥à¤¸à¥à¤–à¤¾ à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾à¥¤",

    // --- Reminders Screen ---
    add_new_reminder: "à¤¨à¤¯à¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤œà¥‹à¤¡à¤¼à¥‡à¤‚",
    active_reminders: "à¤¸à¤•à¥à¤°à¤¿à¤¯ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤°",
    reminders_scheduled: "{count} à¤¦à¤µà¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤¨à¤¿à¤°à¥à¤§à¤¾à¤°à¤¿à¤¤ à¤¹à¥ˆà¤‚",
    dosage: "à¤–à¥à¤°à¤¾à¤•",
    frequency: "à¤†à¤µà¥ƒà¤¤à¥à¤¤à¤¿",
    duration: "à¤…à¤µà¤§à¤¿",
    times: "à¤¸à¤®à¤¯",
    instructions: "à¤¨à¤¿à¤°à¥à¤¦à¥‡à¤¶",
    mark_as_taken: "à¤²à¥‡ à¤²à¤¿à¤¯à¤¾ à¤•à¥‡ à¤°à¥‚à¤ª à¤®à¥‡à¤‚ à¤šà¤¿à¤¹à¥à¤¨à¤¿à¤¤ à¤•à¤°à¥‡à¤‚",
    edit: "à¤¸à¤‚à¤ªà¤¾à¤¦à¤¿à¤¤ à¤•à¤°à¥‡à¤‚",
    delete: "à¤¹à¤Ÿà¤¾à¤à¤‚",
    no_reminders_title: "à¤•à¥‹à¤ˆ à¤¦à¤µà¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤¨à¤¹à¥€à¤‚",
    no_reminders_subtitle: "à¤†à¤ªà¤•à¥‡ à¤ªà¤¾à¤¸ à¤…à¤­à¥€ à¤¤à¤• à¤•à¥‹à¤ˆ à¤¸à¤•à¥à¤°à¤¿à¤¯ à¤¦à¤µà¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆà¥¤",
    
    // --- Booking Screen ---
    book_step1: "1. à¤à¤• à¤¶à¥à¤°à¥‡à¤£à¥€ à¤šà¥à¤¨à¥‡à¤‚",
    book_step2: "2. à¤à¤• à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤šà¥à¤¨à¥‡à¤‚",
    book_step3: "3. à¤¤à¤¿à¤¥à¤¿ à¤”à¤° à¤¸à¤®à¤¯ à¤šà¥à¤¨à¥‡à¤‚",
    book_step4: "4. à¤ªà¤°à¤¾à¤®à¤°à¥à¤¶ à¤®à¥‹à¤¡ à¤šà¥à¤¨à¥‡à¤‚",
    book_prev: "à¤ªà¤¿à¤›à¤²à¤¾",
    appt_summary_title: "à¤…à¤ªà¥‰à¤‡à¤‚à¤Ÿà¤®à¥‡à¤‚à¤Ÿ à¤¸à¤¾à¤°à¤¾à¤‚à¤¶",
    book_appt_btn: "à¤…à¤ªà¥‰à¤‡à¤‚à¤Ÿà¤®à¥‡à¤‚à¤Ÿ à¤¬à¥à¤• à¤•à¤°à¥‡à¤‚",
    
    // --- More Screen ---
    report_issue: "à¤¸à¤®à¤¸à¥à¤¯à¤¾ à¤•à¥€ à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ à¤•à¤°à¥‡à¤‚",
    
    // --- Report Issue Screen ---
    report_select_placeholder: "à¤¡à¥‰à¤•à¥à¤Ÿà¤°/à¤«à¤¾à¤°à¥à¤®à¥‡à¤¸à¥€ à¤šà¥à¤¨à¥‡à¤‚",
    report_reason: "à¤•à¤¾à¤°à¤£",
    report_reason_overcharged: "à¤…à¤§à¤¿à¤• à¤¶à¥à¤²à¥à¤• à¤²à¤¿à¤¯à¤¾",
    report_reason_unprofessional: "à¤…à¤µà¥à¤¯à¤¾à¤µà¤¸à¤¾à¤¯à¤¿à¤•",
    report_reason_wrong_medicine: "à¤—à¤²à¤¤ à¤¦à¤µà¤¾",
    report_desc: "à¤µà¤¿à¤µà¤°à¤£",
    report_submit_btn: "à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ à¤œà¤®à¤¾ à¤•à¤°à¥‡à¤‚",
    
    // --- Scan Medicine Screen ---
    camera_status_default: "à¤¸à¥à¤•à¥ˆà¤¨à¤¿à¤‚à¤— à¤¶à¥à¤°à¥‚ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ \"à¤•à¥ˆà¤®à¤°à¤¾ à¤–à¥‹à¤²à¥‡à¤‚\" à¤ªà¤° à¤•à¥à¤²à¤¿à¤• à¤•à¤°à¥‡à¤‚",
    open_camera: "à¤•à¥ˆà¤®à¤°à¤¾ à¤–à¥‹à¤²à¥‡à¤‚",
    scan_qr_code: "QR à¤•à¥‹à¤¡ à¤¸à¥à¤•à¥ˆà¤¨ à¤•à¤°à¥‡à¤‚",
    scan_medicine_btn: "à¤¦à¤µà¤¾ à¤¸à¥à¤•à¥ˆà¤¨ à¤•à¤°à¥‡à¤‚",
    camera_active_status: "à¤•à¥ˆà¤®à¤°à¤¾ à¤¸à¤•à¥à¤°à¤¿à¤¯ à¤¹à¥ˆà¥¤ à¤¦à¤µà¤¾ à¤•à¥€ à¤ªà¥ˆà¤•à¥‡à¤œà¤¿à¤‚à¤— à¤ªà¤° à¤•à¥ˆà¤®à¤°à¤¾ à¤‡à¤‚à¤—à¤¿à¤¤ à¤•à¤°à¥‡à¤‚ à¤”à¤° 'à¤¦à¤µà¤¾ à¤¸à¥à¤•à¥ˆà¤¨ à¤•à¤°à¥‡à¤‚' à¤ªà¤° à¤•à¥à¤²à¤¿à¤• à¤•à¤°à¥‡à¤‚à¥¤",
    camera_permission_error: "à¤•à¥ˆà¤®à¤°à¥‡ à¤¤à¤• à¤¨à¤¹à¥€à¤‚ à¤ªà¤¹à¥à¤‚à¤š à¤¸à¤•à¤¾à¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤…à¤¨à¥à¤®à¤¤à¤¿ à¤œà¤¾à¤‚à¤šà¥‡à¤‚à¥¤",
    scanning_medicine: "à¤¦à¤µà¤¾ à¤¸à¥à¤•à¥ˆà¤¨ à¤•à¥€ à¤œà¤¾ à¤°à¤¹à¥€ à¤¹à¥ˆ...",
    
    // --- Book Medicine Screen ---
    track_my_orders: "à¤®à¥‡à¤°à¥‡ à¤‘à¤°à¥à¤¡à¤°à¥à¤¸ à¤Ÿà¥à¤°à¥ˆà¤• à¤•à¤°à¥‡à¤‚",
    upload_prescription_banner_title: "ðŸ“¤ à¤¨à¥à¤¸à¥à¤–à¤¾ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚",
    upload_prescription_banner_desc: "à¤…à¤ªà¤¨à¥‡ à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤•à¥‡ à¤¨à¥à¤¸à¥à¤–à¥‡ à¤•à¥‡ à¤†à¤§à¤¾à¤° à¤ªà¤° à¤¦à¤µà¤¾à¤à¤‚ à¤®à¤‚à¤—à¤µà¤¾à¤à¤‚",
    upload_prescription_banner_btn: "à¤¨à¥à¤¸à¥à¤–à¤¾ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚",
    select_pharmacy: "à¤à¤• à¤«à¤¾à¤°à¥à¤®à¥‡à¤¸à¥€ à¤šà¥à¤¨à¥‡à¤‚",
    change: "à¤¬à¤¦à¤²à¥‡à¤‚",
    ordering_from: "à¤¸à¥‡ à¤‘à¤°à¥à¤¡à¤° à¤•à¤¿à¤¯à¤¾ à¤œà¤¾ à¤°à¤¹à¤¾ à¤¹à¥ˆ: {name}",
    browse_by_category: "à¤¶à¥à¤°à¥‡à¤£à¥€ à¤•à¥‡ à¤…à¤¨à¥à¤¸à¤¾à¤° à¤¬à¥à¤°à¤¾à¤‰à¤œà¤¼ à¤•à¤°à¥‡à¤‚",
    cat_pain_fever: "ðŸ’Š à¤¦à¤°à¥à¤¦ à¤”à¤° à¤¬à¥à¤–à¤¾à¤°",
    cat_pain_fever_desc: "à¤ªà¥ˆà¤°à¤¾à¤¸à¤¿à¤Ÿà¤¾à¤®à¥‹à¤², à¤‡à¤¬à¥à¤ªà¥à¤°à¥‹à¤«à¥‡à¤¨, à¤•à¥à¤°à¥‹à¤¸à¤¿à¤¨",
    cat_cough_cold: "ðŸ¤§ à¤–à¤¾à¤‚à¤¸à¥€, à¤œà¥à¤•à¤¾à¤® à¤”à¤° à¤à¤²à¤°à¥à¤œà¥€",
    cat_cough_cold_desc: "à¤¸à¥‡à¤Ÿà¤¿à¤°à¤¿à¤œà¤¼à¤¿à¤¨, à¤•à¤« à¤¸à¤¿à¤°à¤ª, à¤µà¤¿à¤•à¥à¤¸",
    cat_stomach: "ðŸ«„ à¤ªà¥‡à¤Ÿ à¤”à¤° à¤ªà¤¾à¤šà¤¨",
    cat_stomach_desc: "à¤¡à¤¾à¤‡à¤œà¥€à¤¨, à¤ªà¥à¤¦à¥€à¤¨ à¤¹à¤°à¤¾, à¤ˆà¤¨à¥‹",
    search_for_medicine: "à¤¦à¤µà¤¾ à¤–à¥‹à¤œà¥‡à¤‚",
    search_placeholder: "à¤œà¥ˆà¤¸à¥‡, à¤ªà¥ˆà¤°à¤¾à¤¸à¤¿à¤Ÿà¤¾à¤®à¥‹à¤²",
    add_to_cart: "à¤•à¤¾à¤°à¥à¤Ÿ à¤®à¥‡à¤‚ à¤¡à¤¾à¤²à¥‡à¤‚",
    checkout_btn: "à¤šà¥‡à¤•à¤†à¤‰à¤Ÿ ({count} à¤†à¤‡à¤Ÿà¤®)",
    
    // --- Cart & Checkout Modals ---
    shopping_cart_title: "ðŸ›’ à¤¶à¥‰à¤ªà¤¿à¤‚à¤— à¤•à¤¾à¤°à¥à¤Ÿ",
    cart_empty: "à¤†à¤ªà¤•à¤¾ à¤•à¤¾à¤°à¥à¤Ÿ à¤–à¤¾à¤²à¥€ à¤¹à¥ˆ",
    cart_total: "à¤•à¥à¤²:",
    continue_shopping: "à¤–à¤°à¥€à¤¦à¤¾à¤°à¥€ à¤œà¤¾à¤°à¥€ à¤°à¤–à¥‡à¤‚",
    proceed_to_checkout: "à¤šà¥‡à¤•à¤†à¤‰à¤Ÿ à¤•à¥‡ à¤²à¤¿à¤ à¤†à¤—à¥‡ à¤¬à¤¢à¤¼à¥‡à¤‚",
    checkout_step1_title: "ðŸ“ à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€ à¤ªà¤¤à¤¾",
    checkout_address: "à¤ªà¥‚à¤°à¤¾ à¤ªà¤¤à¤¾",
    checkout_address_placeholder: "à¤…à¤ªà¤¨à¤¾ à¤ªà¥‚à¤°à¤¾ à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€ à¤ªà¤¤à¤¾ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚",
    checkout_instructions: "à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€ à¤¨à¤¿à¤°à¥à¤¦à¥‡à¤¶ (à¤µà¥ˆà¤•à¤²à¥à¤ªà¤¿à¤•)",
    checkout_instructions_placeholder: "à¤œà¥ˆà¤¸à¥‡, à¤˜à¤‚à¤Ÿà¥€ à¤¦à¥‹ à¤¬à¤¾à¤° à¤¬à¤œà¤¾à¤à¤‚",
    checkout_continue_to_summary: "à¤‘à¤°à¥à¤¡à¤° à¤¸à¤¾à¤°à¤¾à¤‚à¤¶ à¤ªà¤° à¤œà¤¾à¤à¤‚",
    checkout_step2_title: "ðŸ“‹ à¤‘à¤°à¥à¤¡à¤° à¤¸à¤¾à¤°à¤¾à¤‚à¤¶",
    checkout_delivery_address: "à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€ à¤ªà¤¤à¤¾:",
    checkout_items: "à¤†à¤‡à¤Ÿà¤®:",
    checkout_continue_to_payment: "à¤­à¥à¤—à¤¤à¤¾à¤¨ à¤ªà¤° à¤œà¤¾à¤à¤‚",
    back: "à¤µà¤¾à¤ªà¤¸",
    checkout_step3_title: "ðŸ’³ à¤­à¥à¤—à¤¤à¤¾à¤¨ à¤µà¤¿à¤§à¤¿",
    payment_card: "à¤•à¥à¤°à¥‡à¤¡à¤¿à¤Ÿ / à¤¡à¥‡à¤¬à¤¿à¤Ÿ à¤•à¤¾à¤°à¥à¤¡",
    payment_card_desc: "à¤µà¥€à¤œà¤¼à¤¾, à¤®à¤¾à¤¸à¥à¤Ÿà¤°à¤•à¤¾à¤°à¥à¤¡, à¤°à¥à¤ªà¥‡",
    payment_netbanking: "à¤¨à¥‡à¤Ÿ à¤¬à¥ˆà¤‚à¤•à¤¿à¤‚à¤—",
    payment_netbanking_desc: "à¤¸à¤­à¥€ à¤ªà¥à¤°à¤®à¥à¤– à¤¬à¥ˆà¤‚à¤• à¤¸à¤®à¤°à¥à¤¥à¤¿à¤¤ à¤¹à¥ˆà¤‚",
    payment_upi: "UPI",
    payment_upi_desc: "à¤ªà¥‡à¤Ÿà¥€à¤à¤®, à¤—à¥‚à¤—à¤² à¤ªà¥‡, à¤«à¥‹à¤¨à¤ªà¥‡, à¤†à¤¦à¤¿à¥¤",
    payment_cod: "à¤•à¥ˆà¤¶ à¤‘à¤¨ à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€",
    payment_cod_desc: "à¤‘à¤°à¥à¤¡à¤° à¤®à¤¿à¤²à¤¨à¥‡ à¤ªà¤° à¤­à¥à¤—à¤¤à¤¾à¤¨ à¤•à¤°à¥‡à¤‚",
    card_details: "ðŸ’³ à¤•à¤¾à¤°à¥à¤¡ à¤µà¤¿à¤µà¤°à¤£",
    card_number: "à¤•à¤¾à¤°à¥à¤¡ à¤¨à¤‚à¤¬à¤°",
    card_expiry: "à¤¸à¤®à¤¾à¤ªà¥à¤¤à¤¿ à¤¤à¤¿à¤¥à¤¿",
    card_cvv: "CVV",
    card_name: "à¤•à¤¾à¤°à¥à¤¡à¤§à¤¾à¤°à¤• à¤•à¤¾ à¤¨à¤¾à¤®",
    upi_details: "ðŸ“± UPI à¤­à¥à¤—à¤¤à¤¾à¤¨",
    upi_id: "UPI ID",
    netbanking_details: "ðŸ¦ à¤¨à¥‡à¤Ÿ à¤¬à¥ˆà¤‚à¤•à¤¿à¤‚à¤—",
    netbanking_select_bank: "à¤…à¤ªà¤¨à¤¾ à¤¬à¥ˆà¤‚à¤• à¤šà¥à¤¨à¥‡à¤‚",
    netbanking_select_bank_placeholder: "à¤…à¤ªà¤¨à¤¾ à¤¬à¥ˆà¤‚à¤• à¤šà¥à¤¨à¥‡à¤‚...",
    proceed_to_pay: "à¤­à¥à¤—à¤¤à¤¾à¤¨ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤†à¤—à¥‡ à¤¬à¤¢à¤¼à¥‡à¤‚",
    processing: "à¤ªà¥à¤°à¥‹à¤¸à¥‡à¤¸ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
    checkout_step4_title: "âœ… à¤‘à¤°à¥à¤¡à¤° à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤¦à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾!",
    checkout_success_msg: "à¤†à¤ªà¤•à¤¾ à¤‘à¤°à¥à¤¡à¤° à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤¹à¥‹ à¤—à¤¯à¤¾ à¤¹à¥ˆ à¤”à¤° à¤ªà¥à¤°à¥‹à¤¸à¥‡à¤¸ à¤•à¤¿à¤¯à¤¾ à¤œà¤¾ à¤°à¤¹à¤¾ à¤¹à¥ˆà¥¤",
    order_id: "à¤‘à¤°à¥à¤¡à¤° ID:",
    est_delivery: "à¤…à¤¨à¥à¤®à¤¾à¤¨à¤¿à¤¤ à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€:",
    track_your_order: "à¤…à¤ªà¤¨à¤¾ à¤‘à¤°à¥à¤¡à¤° à¤Ÿà¥à¤°à¥ˆà¤• à¤•à¤°à¥‡à¤‚",
    
    // --- Track Orders Screen ---
    order_status_placed: "à¤‘à¤°à¥à¤¡à¤° à¤¦à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾",
    order_status_preparing: "à¤‘à¤°à¥à¤¡à¤° à¤¤à¥ˆà¤¯à¤¾à¤° à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ",
    order_status_delivery: "à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€ à¤•à¥‡ à¤²à¤¿à¤ à¤¬à¤¾à¤¹à¤°",
    order_status_delivered: "à¤¡à¤¿à¤²à¥€à¤µà¤° à¤¹à¥‹ à¤—à¤¯à¤¾",
    order_status_placed_desc: "à¤†à¤ªà¤•à¤¾ à¤‘à¤°à¥à¤¡à¤° à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤¹à¥‹ à¤—à¤¯à¤¾ à¤¹à¥ˆ à¤”à¤° à¤ªà¥à¤·à¥à¤Ÿà¤¿ à¤¹à¥‹ à¤—à¤ˆ à¤¹à¥ˆà¥¤",
    order_status_preparing_desc: "à¤«à¤¾à¤°à¥à¤®à¥‡à¤¸à¥€ à¤†à¤ªà¤•à¥‡ à¤†à¤‡à¤Ÿà¤® à¤¤à¥ˆà¤¯à¤¾à¤° à¤•à¤° à¤°à¤¹à¥€ à¤¹à¥ˆà¥¤",
    order_status_delivery_desc: "à¤†à¤ªà¤•à¤¾ à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€ à¤ªà¤¾à¤°à¥à¤Ÿà¤¨à¤° à¤°à¤¾à¤¸à¥à¤¤à¥‡ à¤®à¥‡à¤‚ à¤¹à¥ˆà¥¤",
    order_status_delivered_desc: "à¤†à¤ªà¤•à¤¾ à¤‘à¤°à¥à¤¡à¤° à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤¡à¤¿à¤²à¥€à¤µà¤° à¤¹à¥‹ à¤—à¤¯à¤¾ à¤¹à¥ˆà¥¤",
    
    // --- Chatbot ---
    chatbot_placeholder: "à¤²à¤•à¥à¤·à¤£à¥‹à¤‚, à¤–à¥à¤°à¤¾à¤• à¤•à¥‡ à¤¬à¤¾à¤°à¥‡ à¤®à¥‡à¤‚ à¤ªà¥‚à¤›à¥‡à¤‚...",
    send: "à¤­à¥‡à¤œà¥‡à¤‚",
    chatbot_welcome: "à¤‰à¤¨à¥à¤¨à¤¤ à¤¸à¥‡à¤¹à¤¤ à¤¸à¤¹à¤¾à¤°à¤¾ à¤®à¥‡à¤‚ à¤†à¤ªà¤•à¤¾ à¤¸à¥à¤µà¤¾à¤—à¤¤ à¤¹à¥ˆ! à¤®à¥ˆà¤‚ à¤…à¤ªà¥‰à¤‡à¤‚à¤Ÿà¤®à¥‡à¤‚à¤Ÿ, à¤¨à¥à¤¸à¥à¤–à¥‡, à¤¦à¤µà¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤”à¤° à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤®à¤¾à¤°à¥à¤—à¤¦à¤°à¥à¤¶à¤¨ à¤®à¥‡à¤‚ à¤®à¤¦à¤¦ à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤‚à¥¤",
    chatbot_typing: "à¤Ÿà¤¾à¤‡à¤ª à¤•à¤° à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
    chatbot_processing_voice: "... (à¤µà¥‰à¤¯à¤¸ à¤‡à¤¨à¤ªà¥à¤Ÿ à¤ªà¥à¤°à¥‹à¤¸à¥‡à¤¸ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ) ...",
    chatbot_voice_error: "à¤®à¥à¤à¥‡ à¤–à¥‡à¤¦ à¤¹à¥ˆ, à¤®à¥ˆà¤‚ à¤†à¤ªà¤•à¥€ à¤†à¤µà¤¾à¤œà¤¼ à¤•à¥‹ à¤ªà¥à¤°à¥‹à¤¸à¥‡à¤¸ à¤¨à¤¹à¥€à¤‚ à¤•à¤° à¤¸à¤•à¤¾à¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤ªà¥à¤¨à¤ƒ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚à¥¤",
    chatbot_connect_error: "à¤®à¥à¤à¥‡ à¤–à¥‡à¤¦ à¤¹à¥ˆ, à¤®à¥à¤à¥‡ à¤…à¤­à¥€ à¤•à¤¨à¥‡à¤•à¥à¤Ÿ à¤¹à¥‹à¤¨à¥‡ à¤®à¥‡à¤‚ à¤¸à¤®à¤¸à¥à¤¯à¤¾ à¤¹à¥‹ à¤°à¤¹à¥€ à¤¹à¥ˆà¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤•à¥à¤› à¤¦à¥‡à¤° à¤¬à¤¾à¤¦ à¤ªà¥à¤¨à¤ƒ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚à¥¤",
    chatbot_record_hint: "à¤°à¤¿à¤•à¥‰à¤°à¥à¤¡à¤¿à¤‚à¤— à¤°à¥‹à¤•à¤¨à¥‡ à¤”à¤° à¤­à¥‡à¤œà¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤«à¤¿à¤° à¤¸à¥‡ à¤¦à¤¬à¤¾à¤à¤ âž”", // <-- ADD THIS
    
    // --- Call Screen ---
    call_with: "à¤•à¥‡ à¤¸à¤¾à¤¥ à¤ªà¤°à¤¾à¤®à¤°à¥à¤¶ {name}",
    call_waiting: "à¤•à¤¨à¥‡à¤•à¥à¤Ÿ à¤¹à¥‹à¤¨à¥‡ à¤•à¥€ à¤ªà¥à¤°à¤¤à¥€à¤•à¥à¤·à¤¾ à¤•à¥€ à¤œà¤¾ à¤°à¤¹à¥€ à¤¹à¥ˆ...",
    start_call: "à¤•à¥‰à¤² à¤¶à¥à¤°à¥‚ à¤•à¤°à¥‡à¤‚",
    mute_audio: "à¤‘à¤¡à¤¿à¤¯à¥‹ à¤®à¥à¤¯à¥‚à¤Ÿ à¤•à¤°à¥‡à¤‚",
    unmute_audio: "à¤‘à¤¡à¤¿à¤¯à¥‹ à¤…à¤¨à¤®à¥à¤¯à¥‚à¤Ÿ à¤•à¤°à¥‡à¤‚",
    mute_video: "à¤µà¥€à¤¡à¤¿à¤¯à¥‹ à¤®à¥à¤¯à¥‚à¤Ÿ à¤•à¤°à¥‡à¤‚",
    unmute_video: "à¤µà¥€à¤¡à¤¿à¤¯à¥‹ à¤…à¤¨à¤®à¥à¤¯à¥‚à¤Ÿ à¤•à¤°à¥‡à¤‚",
    end_call: "à¤•à¥‰à¤² à¤¸à¤®à¤¾à¤ªà¥à¤¤ à¤•à¤°à¥‡à¤‚",
    call_connecting: "à¤•à¤¨à¥‡à¤•à¥à¤Ÿ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
    call_doctor_connected: "à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤œà¥à¤¡à¤¼ à¤—à¤ à¤¹à¥ˆà¤‚!",
    call_doctor_left: "à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤¨à¥‡ à¤•à¥‰à¤² à¤›à¥‹à¤¡à¤¼ à¤¦à¥€",
    call_ended: "à¤•à¥‰à¤² à¤¸à¤®à¤¾à¤ªà¥à¤¤ à¤¹à¥‹ à¤—à¤ˆ",
    call_status_connecting: "à¤šà¥ˆà¤¨à¤² à¤¸à¥‡ à¤œà¥à¤¡à¤¼ à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
    call_status_access_mic: "à¤®à¤¾à¤‡à¤•à¥à¤°à¥‹à¤«à¤¼à¥‹à¤¨ à¤à¤•à¥à¤¸à¥‡à¤¸ à¤•à¤¿à¤¯à¤¾ à¤œà¤¾ à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
    call_status_access_cam: "à¤«à¥à¤°à¤‚à¤Ÿ à¤•à¥ˆà¤®à¤°à¤¾ à¤à¤•à¥à¤¸à¥‡à¤¸ à¤•à¤¿à¤¯à¤¾ à¤œà¤¾ à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
    call_status_cam_error: "à¤«à¥à¤°à¤‚à¤Ÿ à¤•à¥ˆà¤®à¤°à¤¾ à¤à¤•à¥à¤¸à¥‡à¤¸ à¤¨à¤¹à¥€à¤‚ à¤¹à¥‹ à¤¸à¤•à¤¾à¥¤ à¤¡à¤¿à¤«à¤¼à¥‰à¤²à¥à¤Ÿ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤¿à¤¯à¤¾ à¤œà¤¾ à¤°à¤¹à¤¾ à¤¹à¥ˆà¥¤",
    call_status_cam_fail: "à¤•à¥ˆà¤®à¤°à¤¾ à¤à¤•à¥à¤¸à¥‡à¤¸ à¤•à¤°à¤¨à¥‡ à¤®à¥‡à¤‚ à¤¤à¥à¤°à¥à¤Ÿà¤¿à¥¤",
    call_status_publishing: "à¤†à¤ªà¤•à¥€ à¤¸à¥à¤Ÿà¥à¤°à¥€à¤® à¤ªà¥à¤°à¤•à¤¾à¤¶à¤¿à¤¤ à¤•à¥€ à¤œà¤¾ à¤°à¤¹à¥€ à¤¹à¥ˆ...",
    call_status_waiting_doctor: "à¤¡à¥‰à¤•à¥à¤Ÿà¤° à¤•à¥€ à¤ªà¥à¤°à¤¤à¥€à¤•à¥à¤·à¤¾ à¤•à¥€ à¤œà¤¾ à¤°à¤¹à¥€ à¤¹à¥ˆ...",
    call_token_error: "à¤•à¥‰à¤² à¤Ÿà¥‹à¤•à¤¨ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤•à¤°à¤¨à¥‡ à¤®à¥‡à¤‚ à¤µà¤¿à¤«à¤²à¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤ªà¥à¤¨à¤ƒ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚à¥¤",
    call_id_missing_error: "à¤¤à¥à¤°à¥à¤Ÿà¤¿: à¤…à¤ªà¥‰à¤‡à¤‚à¤Ÿà¤®à¥‡à¤‚à¤Ÿ ID à¤—à¤¾à¤¯à¤¬ à¤¹à¥ˆà¥¤",

    // --- Modals (SOS, Confirmation, etc.) ---
    sos_title: "ðŸš¨ à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¤•à¥à¤°à¤¿à¤¯à¤£",
    sos_countdown_text: "{seconds} à¤¸à¥‡à¤•à¤‚à¤¡ à¤®à¥‡à¤‚ à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¥‡à¤µà¤¾à¤à¤‚ à¤¸à¤•à¥à¤°à¤¿à¤¯ à¤•à¥€ à¤œà¤¾ à¤°à¤¹à¥€ à¤¹à¥ˆà¤‚...",
    sos_cancel: "à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤² à¤°à¤¦à¥à¤¦ à¤•à¤°à¥‡à¤‚",
    sos_confirm_title: "à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ SOS",
    sos_confirm_msg: "à¤¯à¤¹ à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¥‡à¤µà¤¾à¤“à¤‚ à¤•à¥‹ à¤•à¥‰à¤² à¤•à¤°à¥‡à¤—à¤¾ à¤”à¤° à¤†à¤ªà¤•à¤¾ à¤¸à¥à¤¥à¤¾à¤¨ à¤­à¥‡à¤œà¥‡à¤—à¤¾à¥¤ à¤•à¥à¤¯à¤¾ à¤†à¤ª à¤¨à¤¿à¤¶à¥à¤šà¤¿à¤¤ à¤¹à¥ˆà¤‚?",
    sos_confirm_cancel: "à¤°à¤¦à¥à¤¦ à¤•à¤°à¥‡à¤‚",
    sos_confirm_ok: "à¤ªà¥à¤·à¥à¤Ÿà¤¿ à¤•à¤°à¥‡à¤‚",
    
    // --- JavaScript Confirmation Modals (Titles) ---
    sos_activated_title: "SOS à¤¸à¤•à¥à¤°à¤¿à¤¯!",
    sos_failed_title: "SOS à¤µà¤¿à¤«à¤²",
    report_submitted_title: "à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ à¤œà¤®à¤¾ à¤•à¥€ à¤—à¤ˆ",
    appt_booked_title: "à¤…à¤ªà¥‰à¤‡à¤‚à¤Ÿà¤®à¥‡à¤‚à¤Ÿ à¤¬à¥à¤• à¤¹à¥‹ à¤—à¤ˆ!",
    scan_successful_title: "à¤¸à¥à¤•à¥ˆà¤¨ à¤¸à¤«à¤²",
    scan_failed_title: "à¤¸à¥à¤•à¥ˆà¤¨ à¤µà¤¿à¤«à¤²",
    upload_failed_title: "à¤…à¤ªà¤²à¥‹à¤¡ à¤µà¤¿à¤«à¤²",
    added_to_cart_title: "à¤•à¤¾à¤°à¥à¤Ÿ à¤®à¥‡à¤‚ à¤œà¥‹à¤¡à¤¼à¤¾ à¤—à¤¯à¤¾",
    cart_empty_title: "à¤•à¤¾à¤°à¥à¤Ÿ à¤–à¤¾à¤²à¥€ à¤¹à¥ˆ",
    address_required_title: "à¤ªà¤¤à¤¾ à¤†à¤µà¤¶à¥à¤¯à¤• à¤¹à¥ˆ",
    invalid_card_title: "à¤…à¤®à¤¾à¤¨à¥à¤¯ à¤•à¤¾à¤°à¥à¤¡",
    invalid_upi_title: "à¤…à¤®à¤¾à¤¨à¥à¤¯ UPI",
    login_required_title: "à¤²à¥‰à¤—à¤¿à¤¨ à¤†à¤µà¤¶à¥à¤¯à¤• à¤¹à¥ˆ",
    pharmacy_required_title: "à¤«à¤¾à¤°à¥à¤®à¥‡à¤¸à¥€ à¤šà¤¯à¤¨à¤¿à¤¤ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆ",
    order_failed_title: "à¤‘à¤°à¥à¤¡à¤° à¤µà¤¿à¤«à¤²",
    reminder_success_title: "à¤¸à¤«à¤²à¤¤à¤¾",
    reminder_deleted_title: "à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤¹à¤Ÿà¤¾à¤¯à¤¾ à¤—à¤¯à¤¾",
    reminder_error_title: "à¤¤à¥à¤°à¥à¤Ÿà¤¿",
    reminder_delete_confirm: "à¤•à¥à¤¯à¤¾ à¤†à¤ª à¤µà¤¾à¤•à¤ˆ {name} à¤•à¥‡ à¤²à¤¿à¤ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤¹à¤Ÿà¤¾à¤¨à¤¾ à¤šà¤¾à¤¹à¤¤à¥‡ à¤¹à¥ˆà¤‚?",
    logged_out_title: "à¤²à¥‰à¤— à¤†à¤‰à¤Ÿ",
    
    // --- JavaScript Confirmation Modals (Messages) ---
    sos_activated_msg: "à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¥‡à¤µà¤¾à¤“à¤‚ à¤•à¥‹ à¤¸à¥‚à¤šà¤¿à¤¤ à¤•à¤° à¤¦à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾ à¤¹à¥ˆà¥¤ à¤®à¤¦à¤¦ à¤°à¤¾à¤¸à¥à¤¤à¥‡ à¤®à¥‡à¤‚ à¤¹à¥ˆà¥¤",
    sos_failed_msg: "à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²à¥€à¤¨ à¤¸à¥‡à¤µà¤¾à¤“à¤‚ à¤•à¥‹ à¤¸à¤•à¥à¤°à¤¿à¤¯ à¤•à¤°à¤¨à¥‡ à¤®à¥‡à¤‚ à¤µà¤¿à¤«à¤²à¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤¸à¥€à¤§à¥‡ 108 à¤ªà¤° à¤•à¥‰à¤² à¤•à¤°à¥‡à¤‚à¥¤",
    report_submitted_msg: "à¤†à¤ªà¤•à¥€ à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ à¤¸à¤®à¥€à¤•à¥à¤·à¤¾ à¤•à¥‡ à¤²à¤¿à¤ à¤­à¥‡à¤œ à¤¦à¥€ à¤—à¤ˆ à¤¹à¥ˆà¥¤",
    appt_booked_msg: "à¤†à¤ªà¤•à¥€ à¤…à¤ªà¥‰à¤‡à¤‚à¤Ÿà¤®à¥‡à¤‚à¤Ÿ à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤¨à¤¿à¤°à¥à¤§à¤¾à¤°à¤¿à¤¤ à¤¹à¥‹ à¤—à¤ˆ à¤¹à¥ˆà¥¤",
    scan_failed_generic_msg: "à¤¦à¤µà¤¾ à¤•à¥€ à¤ªà¤¹à¤šà¤¾à¤¨ à¤¨à¤¹à¥€à¤‚ à¤¹à¥‹ à¤¸à¤•à¥€à¥¤",
    upload_failed_msg: "à¤¨à¥à¤¸à¥à¤–à¤¾ à¤¸à¤¹à¥‡à¤œà¤¨à¥‡ à¤®à¥‡à¤‚ à¤µà¤¿à¤«à¤²à¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤ªà¥à¤¨à¤ƒ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚à¥¤",
    cart_empty_msg: "à¤•à¥ƒà¤ªà¤¯à¤¾ à¤…à¤ªà¤¨à¥‡ à¤•à¤¾à¤°à¥à¤Ÿ à¤®à¥‡à¤‚ à¤†à¤‡à¤Ÿà¤® à¤œà¥‹à¤¡à¤¼à¥‡à¤‚à¥¤",
    address_required_msg: "à¤•à¥ƒà¤ªà¤¯à¤¾ à¤…à¤ªà¤¨à¤¾ à¤¡à¤¿à¤²à¥€à¤µà¤°à¥€ à¤ªà¤¤à¤¾ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚à¥¤",
    invalid_card_msg: "à¤•à¥ƒà¤ªà¤¯à¤¾ à¤à¤• à¤µà¥ˆà¤§ 16-à¤…à¤‚à¤•à¥€à¤¯ à¤•à¤¾à¤°à¥à¤¡ à¤¨à¤‚à¤¬à¤° à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚à¥¤",
    invalid_upi_msg: "à¤•à¥ƒà¤ªà¤¯à¤¾ à¤à¤• à¤µà¥ˆà¤§ UPI ID à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚à¥¤",
    login_required_msg: "à¤‘à¤°à¥à¤¡à¤° à¤¦à¥‡à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤†à¤ªà¤•à¥‹ à¤²à¥‰à¤— à¤‡à¤¨ à¤¹à¥‹à¤¨à¤¾ à¤šà¤¾à¤¹à¤¿à¤à¥¤",
    pharmacy_required_msg: "à¤•à¥ƒà¤ªà¤¯à¤¾ à¤‘à¤°à¥à¤¡à¤° à¤¦à¥‡à¤¨à¥‡ à¤¸à¥‡ à¤ªà¤¹à¤²à¥‡ à¤à¤• à¤«à¤¾à¤°à¥à¤®à¥‡à¤¸à¥€ à¤šà¥à¤¨à¥‡à¤‚à¥¤",
    order_failed_generic_msg: "à¤†à¤ªà¤•à¤¾ à¤‘à¤°à¥à¤¡à¤° à¤¦à¥‡à¤¨à¥‡ à¤®à¥‡à¤‚ à¤à¤• à¤¤à¥à¤°à¥à¤Ÿà¤¿ à¤¹à¥à¤ˆ: {error}",
    reminder_added_msg: "à¤¦à¤µà¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤œà¥‹à¤¡à¤¼à¤¾ à¤—à¤¯à¤¾!",
    reminder_updated_msg: "à¤¦à¤µà¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤…à¤ªà¤¡à¥‡à¤Ÿ à¤•à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾!",
    reminder_deleted_msg: "{name} à¤•à¥‡ à¤²à¤¿à¤ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤¹à¤Ÿà¤¾ à¤¦à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾ à¤¹à¥ˆà¥¤",
    reminder_delete_failed_msg: "à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤¹à¤Ÿà¤¾à¤¨à¥‡ à¤®à¥‡à¤‚ à¤µà¤¿à¤«à¤²à¥¤",
    reminder_taken_msg: "{name} à¤•à¥‹ à¤²à¥‡ à¤²à¤¿à¤¯à¤¾ à¤•à¥‡ à¤°à¥‚à¤ª à¤®à¥‡à¤‚ à¤šà¤¿à¤¹à¥à¤¨à¤¿à¤¤ à¤•à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾!",
    reminder_load_error_msg: "à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤µà¤¿à¤µà¤°à¤£ à¤¸à¤‚à¤ªà¤¾à¤¦à¤¿à¤¤ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤² à¤¸à¤•à¤¾à¥¤",
    logged_out_msg: "à¤†à¤ª à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤²à¥‰à¤— à¤†à¤‰à¤Ÿ à¤¹à¥‹ à¤—à¤ à¤¹à¥ˆà¤‚à¥¤",

    // --- Missed Reminder Modal ---
    missed_reminders_title: "â° à¤›à¥‚à¤Ÿà¥‡ à¤¹à¥à¤ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤°",
    missed_reminders_desc: "à¤†à¤ªà¤¨à¥‡ à¤¨à¤¿à¤®à¥à¤¨à¤²à¤¿à¤–à¤¿à¤¤ à¤¦à¤µà¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤°à¥‹à¤‚ à¤•à¥‹ à¤¸à¥à¤µà¥€à¤•à¤¾à¤° à¤¨à¤¹à¥€à¤‚ à¤•à¤¿à¤¯à¤¾:",
    close: "à¤¬à¤‚à¤¦ à¤•à¤°à¥‡à¤‚",
    skip_this_time: "à¤‡à¤¸ à¤¬à¤¾à¤° à¤›à¥‹à¤¡à¤¼à¥‡à¤‚",
    
    // --- Add/Edit Reminder Modal ---
    add_reminder_title: "à¤¦à¤µà¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤œà¥‹à¤¡à¤¼à¥‡à¤‚",
    update_reminder_title: "à¤¦à¤µà¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤…à¤ªà¤¡à¥‡à¤Ÿ à¤•à¤°à¥‡à¤‚",
    medicine_name: "à¤¦à¤µà¤¾ à¤•à¤¾ à¤¨à¤¾à¤®",
    medicine_name_placeholder: "à¤œà¥ˆà¤¸à¥‡, à¤ªà¥ˆà¤°à¤¾à¤¸à¤¿à¤Ÿà¤¾à¤®à¥‹à¤²",
    medicine_dosage_placeholder: "à¤œà¥ˆà¤¸à¥‡, 500mg",
    medicine_times: "à¤¸à¤®à¤¯ (à¤…à¤²à¥à¤ªà¤µà¤¿à¤°à¤¾à¤® à¤¸à¥‡ à¤…à¤²à¤—)",
    medicine_times_placeholder: "à¤œà¥ˆà¤¸à¥‡, 08:00, 14:00, 20:00",
    medicine_duration: "à¤…à¤µà¤§à¤¿ (à¤¦à¤¿à¤¨)",
    medicine_instructions_placeholder: "à¤œà¥ˆà¤¸à¥‡, à¤­à¥‹à¤œà¤¨ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤²à¥‡à¤‚",
    save_reminder: "à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤¸à¤¹à¥‡à¤œà¥‡à¤‚",
    update_reminder: "à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤…à¤ªà¤¡à¥‡à¤Ÿ à¤•à¤°à¥‡à¤‚",
    cancel: "à¤°à¤¦à¥à¤¦ à¤•à¤°à¥‡à¤‚",

    med_desc_paracetamol: "à¤ªà¥à¤°à¤­à¤¾à¤µà¥€ à¤¦à¤°à¥à¤¦ à¤¨à¤¿à¤µà¤¾à¤°à¤• à¤”à¤° à¤¬à¥à¤–à¤¾à¤° à¤•à¤® à¤•à¤°à¤¨à¥‡ à¤µà¤¾à¤²à¥€",
    med_desc_ibuprofen: "à¤¸à¥‚à¤œà¤¨-à¤°à¥‹à¤§à¥€ à¤¦à¤°à¥à¤¦ à¤¨à¤¿à¤µà¤¾à¤°à¤•",
    med_desc_crocin: "à¤‰à¤¨à¥à¤¨à¤¤ à¤¦à¤°à¥à¤¦ à¤¨à¤¿à¤µà¤¾à¤°à¤• à¤«à¤¾à¤°à¥à¤®à¥‚à¤²à¤¾",
    med_desc_cetirizine: "à¤à¤²à¤°à¥à¤œà¥€ à¤¸à¥‡ à¤°à¤¾à¤¹à¤¤ à¤”à¤° à¤à¤‚à¤Ÿà¥€à¤¹à¤¿à¤¸à¥à¤Ÿà¤¾à¤®à¤¾à¤‡à¤¨",
    med_desc_grilinctus: "à¤ªà¥à¤°à¤­à¤¾à¤µà¥€ à¤–à¤¾à¤‚à¤¸à¥€ à¤¦à¤®à¤¨à¤•à¤¾à¤°à¥€",
    med_desc_vicks: "à¤¬à¤¹à¥-à¤²à¤•à¥à¤·à¤£ à¤¸à¤°à¥à¤¦à¥€ à¤¸à¥‡ à¤°à¤¾à¤¹à¤¤",
    med_desc_digene: "à¤à¤¸à¤¿à¤¡à¤¿à¤Ÿà¥€ à¤”à¤° à¤—à¥ˆà¤¸ à¤¸à¥‡ à¤¤à¥à¤°à¤‚à¤¤ à¤°à¤¾à¤¹à¤¤",
    med_desc_pudin_hara: "à¤†à¤¯à¥à¤°à¥à¤µà¥‡à¤¦à¤¿à¤• à¤ªà¤¾à¤šà¤¨ à¤°à¤¾à¤¹à¤¤",
    med_desc_eno: "à¤à¤¸à¤¿à¤¡à¤¿à¤Ÿà¥€ à¤¸à¥‡ à¤¤à¥à¤°à¤‚à¤¤ à¤°à¤¾à¤¹à¤¤",
    
    // --- Upload Prescription Modal ---
    add_offline_prescription_title: "à¤‘à¤«à¤¼à¤²à¤¾à¤‡à¤¨ à¤¨à¥à¤¸à¥à¤–à¤¾ à¤œà¥‹à¤¡à¤¼à¥‡à¤‚",
    provider_name: "à¤ªà¥à¤°à¤¦à¤¾à¤¤à¤¾ à¤•à¤¾ à¤¨à¤¾à¤®",
    provider_name_placeholder: "à¤œà¥ˆà¤¸à¥‡, à¤¸à¥à¤¥à¤¾à¤¨à¥€à¤¯ à¤¸à¥à¤Ÿà¥‹à¤°",
    save_prescription: "à¤¨à¥à¤¸à¥à¤–à¤¾ à¤¸à¤¹à¥‡à¤œà¥‡à¤‚",
    // Add these keys inside 'hi'
"General Physician": "à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯ à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤•",
"Dermatologist": "à¤¤à¥à¤µà¤šà¤¾ à¤µà¤¿à¤¶à¥‡à¤·à¤œà¥à¤ž",
"Child Specialist": "à¤¬à¤¾à¤² à¤µà¤¿à¤¶à¥‡à¤·à¤œà¥à¤ž",
"Video": "à¤µà¥€à¤¡à¤¿à¤¯à¥‹",
"Audio": "à¤‘à¤¡à¤¿à¤¯à¥‹",
"Offline": "à¤‘à¤«à¤²à¤¾à¤‡à¤¨"
}
            };
            // PASTE THE 'getText' FUNCTION RIGHT HERE
    /**
     * Gets a translated string from the translations object.
     * @param {string} key - The key for the translation (e.g., 'welcome_message').
     * @param {object} [variables={}] - An object of variables to replace (e.g., { name: 'Rohan' }).
     */
    function getText(key, variables = {}) {
        // Default to English if the current language isn't found
        const langObject = translations[currentLanguage] || translations.en;
        
        let text = langObject[key];
        
        if (!text) {
            // Fallback to English if the key is missing in the current language
            text = translations.en[key];
            if (!text) {
                // If the key is missing entirely, return the key itself
                // This makes it VERY obvious what translation is missing.
                console.warn(`Translation key not found: ${key}`);
                return key;
            }
        }
        
        // Replace all variables like {name} or {count}
        for (const variableName in variables) {
            text = text.replace(new RegExp(`\\{${variableName}\\}`, 'g'), variables[variableName]);
        }
        
        return text;
    }
                    // SOS Countdown Function
let sosCountdownInterval;
// REPLACE your old 'startSosCountdown' function with this:
function startSosCountdown(user) {
    document.getElementById('sosCountdownModal').classList.add('active');
    let countdown = 5;
    const countdownElement = document.getElementById('countdownNumber');
    const countdownTextEl = document.getElementById('countdownText'); // Get the text element

    // Set initial text using the helper
    countdownTextEl.textContent = getText('sos_countdown_text', { seconds: countdown });
    countdownElement.textContent = countdown;

    sosCountdownInterval = setInterval(() => {
        countdown--;
        countdownElement.textContent = countdown;
        // Update text every second
        countdownTextEl.textContent = getText('sos_countdown_text', { seconds: countdown });

        if (countdown <= 0) {
            clearInterval(sosCountdownInterval);
            document.getElementById('sosCountdownModal').classList.remove('active');
            triggerSos(user);
        }
    }, 1000);

    // Cancel button
    document.getElementById('cancelCountdown').onclick = () => {
        clearInterval(sosCountdownInterval);
        document.getElementById('sosCountdownModal').classList.remove('active');
    };
}

// Trigger SOS after countdown
// REPLACE your old 'triggerSos' function with this:
async function triggerSos(user) {
    try {
        // Get location
        if (!navigator.geolocation) {
            // Using a generic title. You could add a 'geolocation_failed_title' key
            showConfirmationModal(getText('sos_failed_title'), 'Geolocation is not supported by this browser.');
            return;
        }

        navigator.geolocation.getCurrentPosition(async (position) => {
            const location = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
            };

            // NOTE: This endpoint does not exist in your backend yet.
            const response = await fetch(`${API_BASE_URL}/v1/sos-trigger`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: user.patientId,
                    location: location,
                    message: 'Emergency SOS activated by patient'
                })
            });

            if (response.ok) {
                showConfirmationModal(getText('sos_activated_title'), getText('sos_activated_msg'));
            } else {
                showConfirmationModal(getText('sos_failed_title'), getText('sos_failed_msg'));
            }
        }, (error) => {
            console.error('Geolocation error:', error);
            // Fallback: trigger SOS without location
            fetch(`${API_BASE_URL}/v1/sos-trigger`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: user.patientId,
                    message: 'Emergency SOS activated by patient (location unavailable)'
                })
            }).then(response => {
                if (response.ok) {
                    showConfirmationModal(getText('sos_activated_title'), getText('sos_activated_msg'));
                } else {
                    showConfirmationModal(getText('sos_failed_title'), getText('sos_failed_msg'));
                }
            });
        });
    } catch (error) {
        console.error('SOS trigger error:', error);
        showConfirmationModal(getText('sos_failed_title'), getText('sos_failed_msg'));
    }
}

       

        document.addEventListener('DOMContentLoaded', async function() {
           

            const appData = {
                records: [ { date: "2025-09-15", title: "Consultation with Dr. Priya Sharma", description: "Follow-up regarding skin rash. Prescription for ointment updated." }, { date: "2025-08-02", title: "Blood Test Report Uploaded", description: "Complete Blood Count (CBC) report added." } ],
                appointments: [
                    { id: 1, doctor: "Anjali Verma", type: "General Physician", date: "2025-09-28", time: "04:30 PM", mode: "Video"},
                    { id: 2, doctor: "Priya Sharma", type: "Child Specialist", date: "2025-09-15", time: "10:00 AM", mode: "Video", prescription: { medications: [{name: 'Paracetamol 500mg', dosage: '1 tablet thrice a day', time: 'Morning, Afternoon, Evening'}, {name: 'Azithromycin 250mg', dosage: '1 tablet daily', time: 'Morning'}], tests: ['Blood Test', 'X-Ray'] }},
                    { id: 3, doctor: "Sameer Patel", type: "General Physician", date: "2025-09-20", time: "11:00 AM", mode: "Audio", prescription: { medications: [{name: 'Vitamin C 1000mg', dosage: '1 tablet daily', time: 'Morning'}], tests: ['Complete Blood Count'] }}
                ],
                offlinePrescriptions: [{ doctor: "Local Store", type: "Offline", date: "2025-07-20", prescription: { medications: [{name: 'Antacid Syrup', dosage: '2 spoons after meals', time: 'After meals'}], tests: ['Ultrasound'] }}],
                orders: [],
                pharmacy: [ 
                    {id: 1, name: "Apollo Pharmacy", address: "123, Park Street, Kolkata", delivery: "30-45 mins", contact: "9876543210"},
                    {id: 2, name: "Frank Ross", address: "45, AJC Bose Road, Kolkata", delivery: "45-60 mins", contact: "9876543211"},
                    {id: 3, name: "Wellness Forever", address: "78, Ballygunge Circular, Kolkata", delivery: "20-35 mins", contact: "9876543212"}
                ],
                // START: REPLACE YOUR OLD 'medicines' ARRAY WITH THIS OBJECT
    medicines: {
        'pain-fever': [
            {id: 1, name: "Paracetamol (500mg)", price: 25.00, description: "med_desc_paracetamol"},
            {id: 2, name: "Ibuprofen (400mg)", price: 35.00, description: "med_desc_ibuprofen"},
            {id: 3, name: "Crocin Pain Relief", price: 45.00, description: "med_desc_crocin"}
        ],
        'cough-cold': [
            {id: 4, name: "Cetirizine (10mg)", price: 18.00, description: "med_desc_cetirizine"},
            {id: 5, name: "Grilinctus Cough Syrup (100ml)", price: 85.00, description: "med_desc_grilinctus"},
            {id: 6, name: "Vicks Action 500 Advanced", price: 55.00, description: "med_desc_vicks"}
        ],
        'stomach': [
            {id: 7, name: "Digene Antacid Gel", price: 65.00, description: "med_desc_digene"},
            {id: 8, name: "Pudin Hara Pearls", price: 45.00, description: "med_desc_pudin_hara"},
            {id: 9, name: "Eno Fruit Salt", price: 15.00, description: "med_desc_eno"}
        ]
    },
    
                
            };
            // Add these two new functions


            // In patient.html, add this new function inside the main script area

    async function loadChatHistory() {
        try {
            const response = await fetch(`${API_BASE_URL}/v1/history`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: user.patientId, limit: 50, language: currentLanguage })
            });
            const data = await response.json();
            if (data.success && data.history) {
                const chatWindow = document.getElementById('chatWindow');
                chatWindow.innerHTML = ''; // Clear the welcome message
                data.history.forEach(turn => {
                    let content = turn.content;
                    if (turn.role === 'assistant') {
                        try {
                            content = JSON.parse(turn.content).response;
                        } catch (e) { /* It's just a string, use as is */ }
                    }
                    enhancedChatbot.displayMessage(content, turn.role);
                });
            }
        } catch (error) {
            console.error('Failed to load chat history:', error);
        }
    }

            async function loadDoctors() {
                try {
                    const response = await fetch(`${API_BASE_URL}/v1/doctors`);
                    const data = await response.json();
                    doctors = (data.doctors || []).filter(d => d && d.id);
                    if (doctors.length === 0) {
                        // Use mock data flattened
                        doctors = [];
                        for (let cat in appData.booking.doctors) {
                            doctors = doctors.concat(appData.booking.doctors[cat]);
                        }
                    }
                } catch (e) {
                    console.error('Failed to load doctors:', e);
                    // Use mock data flattened
                    doctors = [];
                    for (let cat in appData.booking.doctors) {
                        doctors = doctors.concat(appData.booking.doctors[cat]);
                    }
                }
            }
            // In patient.html, add this new function

            async function loadBookingData() {
                try {
                    // Fetch all categories and doctors from the backend endpoint
                    const response = await fetch(`${API_BASE_URL}/v1/booking-data`);
                    const data = await response.json();

                    if (data.success && data.booking_data) {
                        // Update the global appData object with live data from the database
                        appData.booking = data.booking_data;
                        console.log('Successfully loaded booking data from backend.');
                    } else {
                        console.warn('Could not load booking data from backend, using mock data.');
                    }
                } catch (error) {
                    console.error('Failed to fetch booking data:', error);
                }
            }

            // In patient.html, replace your checkAuth function with this one:
            function checkAuth() {
                // This is a REAL auth check, just like in doctor.html
                // It verifies the session cookie with the backend.
                const userData = localStorage.getItem('sehatSaharaUser');
                if (!userData) {
                    window.location.href = 'index.html';
                    return Promise.resolve(false);
                }

                const tempUser = JSON.parse(userData);

                return fetch(`${API_BASE_URL}/v1/user-stats`, {
                    method: 'POST',
                    credentials: 'include', // This sends the cookie for verification
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: tempUser.patientId }) // Use the ID from localStorage
                })
                .then(response => {
                    if (response.status === 401) {
                         // 401 means our cookie is invalid or missing
                         throw new Error('Not authenticated');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Success! We are really logged in.
                        // Now we can safely set the global user variable.
                        user = tempUser; 
                        return true;
                    } else {
                        throw new Error(data.message || 'Auth check failed');
                    }
                })
                .catch(error => {
                    console.error('Auth check failed:', error.message);
                    localStorage.removeItem('sehatSaharaUser'); // Clear bad localStorage
                    window.location.href = 'index.html';
                    return false;
                });
            }
            // REPLACE your old updateUIText function with this one
function updateUIText() {
    document.querySelectorAll('[data-key]').forEach(el => {
        const key = el.getAttribute('data-key');
        
        // Use the new helper function
        let text = getText(key);

        // Special case for the welcome message
        if (key === 'welcome_message' && user) {
            text = getText(key, { name: user.fullName || user.username || 'User' });
        }
        
        if (text) {
            el.textContent = text;
        }
    });
}
            // Add this new function
function updateView(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId)?.classList.add('active');
    
    document.querySelectorAll('.nav-button, .top-nav a').forEach(link => {
        link.classList.toggle('active', link.dataset.screen === screenId);
    });
}
            // Replace your old showScreen function with this
// Replace your old showScreen function with this
function showScreen(screenId) {
    updateView(screenId); // Update the UI
    
    const state = { screen: screenId };
    const url = '#' + screenId;

    if (screenId === 'homeScreen') {
        // If navigating TO the home screen, REPLACE the current history
        history.replaceState(state, '', url);
    } else {
        // For any other screen, PUSH a new history state
        history.pushState(state, '', url);
    }
}
            
            function showConfirmationModal(title, message) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('confirmationModal').classList.add('active');
            }

            function setupNavigation() { 
                document.querySelectorAll('[data-screen]').forEach(el => { el.addEventListener('click', (e) => { e.preventDefault(); showScreen(el.dataset.screen); }); });
                document.getElementById('goToTrackOrdersBtn').addEventListener('click', () => showScreen('trackOrdersScreen'));
                document.getElementById('uploadPrescriptionBannerBtn').addEventListener('click', () => document.getElementById('uploadPrescriptionModal').classList.add('active'));
            }
            
            function setupThemeAndLanguage() {
                const themeToggle = document.getElementById('themeToggle');
                const themeIcon = document.getElementById('themeIcon');
                // --- MODIFIED: Corrected viewBox in SVG strings ---
                const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
                const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;

                themeToggle.addEventListener('click', () => {
                    const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
                    document.body.dataset.theme = newTheme;
                    themeIcon.innerHTML = newTheme === 'dark' ? sunIcon : moonIcon;
                });
                
                const langDropdown = document.querySelector('.language-dropdown');
                const langMenu = langDropdown.querySelector('.language-dropdown-menu');
                Object.keys(translations).forEach(lang => { const option = document.createElement('a'); option.href = "#"; option.className = 'language-option'; option.dataset.lang = lang; option.textContent = new Intl.DisplayNames([lang], { type: 'language' }).of(lang); langMenu.appendChild(option); });
                langDropdown.querySelector('.language-dropdown-toggle').addEventListener('click', () => langDropdown.classList.toggle('open'));
                document.addEventListener('click', e => { if (!langDropdown.contains(e.target)) langDropdown.classList.remove('open'); });
                // REPLACE your old listener with this new 'async' one
langMenu.addEventListener('click', async (e) => {
    if (e.target.classList.contains('language-option')) {
        const newLang = e.target.dataset.lang;
        if (newLang === currentLanguage) {
            langDropdown.classList.remove('open');
            return; 
        }
        currentLanguage = newLang; 
        document.getElementById('selectedLanguage').textContent = e.target.textContent; 
        localStorage.setItem('userLanguage', currentLanguage); 
        langDropdown.classList.remove('open'); 

        console.log(`Language changed to: ${currentLanguage}. Refreshing all UI components...`);

        // 1. Update all STATIC text (navbar, titles, search bar)
        updateUIText(); 

        // 2. Manually re-translate DYNAMIC text
        // This fixes "Ordering from:" and "Change"
        if (selectedPharmacy) {
            document.getElementById('selectedPharmacyName').textContent = getText('ordering_from', { name: selectedPharmacy.name });
            document.getElementById('changePharmacyBtn').textContent = getText('change');
        }

        // 3. Re-build DYNAMIC components
        await loadDashboard(); 
        await generateAppointments(); 
        await generateAllPrescriptions();
        await loadOrderHistory();  
        renderBookingStep(1); 

        // 4. --- THIS IS THE FIX for your screenshot ---
        // Re-draw all medicine cards with translated descriptions and buttons
        if (window.renderMedicines) {
             window.renderMedicines(document.querySelector('.category-card.selected')?.dataset.category || 'pain-fever');
        }
        // Re-translate the "Checkout (0 items)" button
        if (window.updateCartIcon) {
            window.updateCartIcon();
        }
        // --- END OF FIX ---

        // 5. Update other screens
        if (document.getElementById('medicineRemindersScreen').classList.contains('active')) {
            await loadMedicineRemindersScreen();
        }
        if (window.updateCartModal) {
            window.updateCartModal();
        }

        // 6. Re-load chat and reminder tile
        await loadChatHistory();
        await checkMedicineReminders();
    } 
});
            }

            function generateTimeline() { document.getElementById('timeline-container').innerHTML = appData.records.map(rec => `<div class="timeline-item"><div class="timeline-dot"></div><p class="timeline-date">${new Date(rec.date).toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}</p><div class="card"><h4>${rec.title}</h4><p>${rec.description}</p></div></div>`).join(''); }

            // REPLACE your old 'generateAppointments' function
async function generateAppointments() {
    try {
        const response = await fetch(`${API_BASE_URL}/v1/appointments?userId=${user.patientId}`);
        const data = await response.json();
        if (data.success && data.appointments) {
            appData.appointments = data.appointments.map(appt => ({
                dateTime: appt.dateTime, 
                id: appt.id,
                doctor: appt.doctorName,
                type: appt.specialization,
                date: new Date(appt.dateTime).toISOString().split('T')[0],
                time: new Date(appt.dateTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                mode: 'Video' // default
            }));
        } else {
            // Keep mock data if API fails
            appData.appointments = [
                { id: 1, doctor: "Anjali Verma", type: "General Physician", date: "2025-09-28", time: "04:30 PM", mode: "Video"},
                { id: 2, doctor: "Priya Sharma", type: "Child Specialist", date: "2025-09-15", time: "10:00 AM", mode: "Video", prescription: { medications: [{name: 'Paracetamol 500mg', dosage: '1 tablet thrice a day'}, {name: 'Azithromycin 250mg', dosage: '1 tablet daily'}] }},
                { id: 3, doctor: "Sameer Patel", type: "General Physician", date: "2025-09-20", time: "11:00 AM", mode: "Audio", prescription: { medications: [{name: 'Vitamin C 1000mg', dosage: '1 tablet daily'}] }}
            ];
        }
    } catch (e) {
        console.error('Failed to load appointments:', e);
        // Keep mock data on network error
        appData.appointments = [
            { id: 1, doctor: "Anjali Verma", type: "General Physician", date: "2025-09-28", time: "04:30 PM", mode: "Video"},
            { id: 2, doctor: "Priya Sharma", type: "Child Specialist", date: "2025-09-15", time: "10:00 AM", mode: "Video", prescription: { medications: [{name: 'Paracetamol 500mg', dosage: '1 tablet thrice a day'}, {name: 'Azithromycin 250mg', dosage: '1 tablet daily'}] }},
            { id: 3, doctor: "Sameer Patel", type: "General Physician", date: "2025-09-20", time: "11:00 AM", mode: "Audio", prescription: { medications: [{name: 'Vitamin C 1000mg', dosage: '1 tablet daily'}] }}
        ];
    }

    const container = document.getElementById('appointments-container');
    const now = new Date(); // Use the current actual date and time
    const upcoming = appData.appointments.filter(a => new Date(a.dateTime) >= now).sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));
    const past = appData.appointments.filter(a => new Date(a.dateTime) < now).sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime));

    const nextAppointmentCard = document.querySelector('#homeScreen .info-card');
    if (nextAppointmentCard) {
        const highlightEl = nextAppointmentCard.querySelector('.highlight');
        const doctorNameEl = nextAppointmentCard.querySelector('p:last-of-type');

        if (upcoming.length > 0) {
            const nextAppt = upcoming[0];
            const apptDate = new Date(nextAppt.date);
            const today = new Date();
            let dateString;

            if (apptDate.toDateString() === today.toDateString()) {
                dateString = getText('today_at_time', { time: nextAppt.time });
            } else {
                dateString = `${apptDate.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' })}, ${nextAppt.time}`;
            }
            
            highlightEl.textContent = dateString;
            doctorNameEl.textContent = nextAppt.doctor;
        } else {
            highlightEl.textContent = getText('no_upcoming_appts');
            doctorNameEl.textContent = getText('no_upcoming_appts_subtitle');
        }
    }
    
    // --- START REFACTORED SECTION ---
    const demoCallHtml = `
        <div class="card appointment-card" style="border: 2px solid var(--primary-color-dark);">
            <div class="appointment-card-header">
                <div class="appointment-card-doctor">
                    <h4>${getText('demo_call_title')}</h4>
                    <p>${getText('demo_call_subtitle')}</p>
                    <p>${getText('demo_call_desc')}</p>
                </div>
                <span class="appointment-card-tag tag-video">${getText('demo_call_tag')}</span>
            </div>
            <div class="appointment-card-footer">
                <div style="display: flex; gap: 0.75rem;">
                    <button class="btn call-doctor-btn">${getText('call_doctor')}</button>
                    <button class="btn message-doctor-btn">${getText('message_doctor')}</button>
                </div>
                <button class="btn btn-primary join-call-btn" data-doctor="Demo Doctor" data-appointment-id="demo-call-123">
                    ${getText('join_call_now')}
                </button>
            </div>
        </div>
    `;

    let html = `<h3 class="appointments-section-title">${getText('upcoming')}</h3>`;
    html += demoCallHtml; // Add the demo call to the top of the list
    
    html += upcoming.length ? upcoming.map(a => { 
        const apptTime = new Date(`${a.date} ${a.time}`); 
        const timeDiffMinutes = (apptTime - now) / 60000; 
        const canJoin = timeDiffMinutes <= 10 && timeDiffMinutes >= -15; 
        return `<div class="card appointment-card">
                    <div class="appointment-card-header">
                        <div class="appointment-card-doctor">
                            <h4>${a.doctor}</h4>
                            <p>${a.type}</p>
                            <p>${new Date(a.date).toDateString()}, ${a.time}</p>
                        </div>
                        <span class="appointment-card-tag ${a.mode === 'Video' ? 'tag-video' : 'tag-audio'}">${a.mode}</span>
                    </div>
                    <div class="appointment-card-footer">
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn call-doctor-btn">${getText('call_doctor')}</button>
                            <button class="btn message-doctor-btn">${getText('message_doctor')}</button>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn" style="background: var(--color-secondary); color: var(--text-color);">${getText('reschedule')}</button>
                            <button class="btn btn-primary join-call-btn" data-doctor="${a.doctor}" data-appointment-id="${a.id}" ${canJoin ? '' : 'disabled'}>${getText('join_call')}</button>
                        </div>
                    </div>
                </div>`; 
    }).join('') : `<p>${getText('no_upcoming_appts')}</p>`;
    
    html += `<h3 class="appointments-section-title" style="margin-top: 2rem;">${getText('past')}</h3>`;
    html += past.length ? past.map((a, index) => 
        `<div class="card appointment-card">
            <div class="appointment-card-header">
                <div class="appointment-card-doctor">
                    <h4>${a.doctor}</h4>
                    <p>${a.type}</p>
                    <p>${new Date(a.date).toDateString()}, ${a.time}</p>
                </div>
                <span class="appointment-card-tag ${a.mode === 'Video' ? 'tag-video' : 'tag-audio'}">${a.mode}</span>
            </div>
            <div class="appointment-card-footer">
                ${a.prescription ? `<button class="btn btn-primary view-prescription-btn" data-past-index="${index}">${getText('view_prescription')}</button>` : ''}
            </div>
        </div>`
    ).join('') : `<p>${getText('no_past_appts')}</p>`;
    // --- END REFACTORED SECTION ---

    container.innerHTML = html;
    container.querySelectorAll('.join-call-btn').forEach(btn => btn.addEventListener('click', (e) => showCallScreen(e.currentTarget.dataset.doctor, e.currentTarget.dataset.appointmentId)));
    container.querySelectorAll('.view-prescription-btn').forEach(btn => btn.addEventListener('click', (e) => showPrescription(past[e.currentTarget.dataset.pastIndex])));
    
    container.querySelectorAll('.call-doctor-btn').forEach(btn => btn.addEventListener('click', () => {
        const phoneNumber = '7003665342';
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (isMobile) {
            window.location.href = `tel:${phoneNumber}`;
        } else {
            window.open(`https://web.whatsapp.com/send?phone=${phoneNumber}`, '_blank');
        }
    }));
    container.querySelectorAll('.message-doctor-btn').forEach(btn => btn.addEventListener('click', () => {
        const phoneNumber = '7003665342';
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (isMobile) {
            window.location.href = `sms:${phoneNumber}`;
        } else {
            window.open(`https://web.whatsapp.com/send?phone=${phoneNumber}`, '_blank');
        }
    }));
}
            // REPLACE your old 'generateAllPrescriptions' function with this:
async function generateAllPrescriptions() {
    const container = document.getElementById('prescriptions-container');
    let prescriptions = []; // <<<--- Store fetched prescriptions here

    try {
        const response = await fetch(`${API_BASE_URL}/v1/dashboard?userId=${user.patientId}`);
        const data = await response.json();

        if (data.success && data.healthRecords) {
            // Filter and store the prescription records in the local 'prescriptions' array
            prescriptions = data.healthRecords.filter(record => record.recordType === 'prescription');

            // --- MODIFIED ---
            container.innerHTML = prescriptions.length ? prescriptions.map((p, index) => `
                <div class="card appointment-card">
                    <div class="appointment-card-header">
                        <div class="appointment-card-doctor">
                            <h4>${p.title.replace('Prescription from ', '')}</h4>
                            <p>Offline</p>
                            <p>${new Date(p.date).toDateString()}</p>
                        </div>
                        <span class="appointment-card-tag tag-offline">Offline</span>
                    </div>
                    <div class="appointment-card-footer">
                        
                        <button class="btn btn-primary view-prescription-btn" data-prescription-index="${index}">${getText('view_prescription')}</button>
                    </div>
                </div>`).join('') : `<p>${getText('no_prescriptions_found')}</p>`;
            // --- END MODIFIED ---

            // --- MODIFIED EVENT LISTENER ---
            container.querySelectorAll('.view-prescription-btn').forEach(btn => btn.addEventListener('click', e => {
                // Get the index from the button's data attribute
                const index = parseInt(e.currentTarget.dataset.prescriptionIndex, 10);
                // Retrieve the correct prescription object from the array using the index
                const prescriptionData = prescriptions[index];

                if (prescriptionData) {
                    showPrescriptionFromRecord(prescriptionData); // Call the display function
                } else {
                    console.error("Could not find prescription data for index:", index);
                    // --- MODIFIED ---
                    showConfirmationModal(getText('reminder_error_title'), getText('reminder_load_error_msg')); // Generic error
                    // --- END MODIFIED ---
                }
            }));
            // --- END MODIFIED EVENT LISTENER ---

        } else {
            // --- MODIFIED ---
            container.innerHTML = `<p>${getText('no_prescriptions_found')}</p>`;
            // --- END MODIFIED ---
        }
    } catch (e) {
        console.error('Failed to load prescriptions:', e);
        // --- MODIFIED ---
        container.innerHTML = `<p>${getText('reminder_error_title')}</p>`; // Generic error
        // --- END MODIFIED ---
    }
}
             // In patient.html, add this new function near your other 'generate' functions
async function loadOrderHistory() {
    if (!user || !user.patientId) return; // Don't run if not logged in
    try {
        const response = await fetch(`${API_BASE_URL}/v1/orders/history?userId=${user.patientId}`);
        const data = await response.json();
        if (data.success && data.orders) {
            appData.orders = data.orders; // Populate the local array
        } else {
            appData.orders = []; // Clear any old data if fetch fails
        }
    } catch (error) {
        console.error('Failed to load order history:', error);
        appData.orders = []; // Clear on error
    }
    // Finally, render the list with the fetched (or empty) data
    generateOrdersList();
}


            
            // REPLACE your old 'showPrescription' function with this:
function showPrescription(appointment) {
    const modalContent = document.getElementById('prescriptionModalContent');
    const imageHtml = appointment.prescription.image ? `<img src="${appointment.prescription.image}" style="max-width: 100%; margin-bottom: 1rem; border-radius: var(--radius-lg);" />` : '';

    // Check if AI extracted meaningful data
    const hasExtractedData = appointment.prescription.medications && appointment.prescription.medications.length > 0 &&
        !appointment.prescription.medications.every(med => med.name === 'Scanned Medication');

    if (!hasExtractedData && appointment.prescription.image) {
        // Fallback: just show the image
        // --- MODIFIED ---
        modalContent.innerHTML = `<h3>${getText('prescriptions_title')}</h3><div class="prescription-header"><p><strong>${getText('provider_name')}:</strong> ${appointment.doctor}</p><p><strong>Date:</strong> ${new Date(appointment.date).toDateString()}</p><p><strong>Mode:</strong> Offline</p></div>${imageHtml}<p style="text-align: center; color: var(--text-color-secondary);">Unable to extract prescription details. Please refer to the image above.</p><button class="btn btn-primary" id="closePrescriptionModal">${getText('close')}</button>`;
        // --- END MODIFIED ---
    } else {
        // Show extracted data
        const diagnosisHtml = appointment.prescription.diagnosis ? `<p><strong>Diagnosis:</strong> ${appointment.prescription.diagnosis}</p>` : '';
        const testsHtml = appointment.prescription.tests && appointment.prescription.tests.length ? `<h4>Recommended Tests:</h4><ul class="prescription-med-list">${appointment.prescription.tests.map(test => `<li>${test}</li>`).join('')}</ul>` : '';
        // --- MODIFIED ---
        modalContent.innerHTML = `<h3>${getText('prescriptions_title')}</h3>${imageHtml}<div class="prescription-header"><p><strong>${appointment.mode ? 'Doctor' : getText('provider_name')}:</strong> ${appointment.doctor}</p><p><strong>Date:</strong> ${new Date(appointment.date).toDateString()}</p><p><strong>Mode:</strong> ${appointment.mode || 'Offline'}</p>${diagnosisHtml}</div><h4>Medications:</h4><ul class="prescription-med-list">${appointment.prescription.medications.map(med => `<li><strong>${med.name}</strong><br><small>${med.dosage} - ${med.time || 'As prescribed'}</small></li>`).join('')}</ul>${testsHtml}<button class="btn btn-primary" id="closePrescriptionModal">${getText('close')}</button>`;
        // --- END MODIFIED ---
    }

    document.getElementById('prescriptionModal').classList.add('active');
    document.getElementById('closePrescriptionModal').addEventListener('click', () => document.getElementById('prescriptionModal').classList.remove('active'), { once: true });
}
             // REPLACE your old 'showPrescriptionFromRecord' function with this:
function showPrescriptionFromRecord(record) {
    const modalContent = document.getElementById('prescriptionModalContent');
    const imageHtml = record.imageData 
        ? `<img src="data:image/jpeg;base64,${record.imageData}" style="max-width: 100%; margin-bottom: 1rem; border-radius: var(--radius-lg);" />`
        : (record.imageUrl ? `<img src="${API_BASE_URL}${record.imageUrl}" style="max-width: 100%; margin-bottom: 1rem; border-radius: var(--radius-lg);" />` : '');
    // Determine prescription source
    const isPatientUpload = record.title.includes('Offline') || record.description.includes('offline');
    const sourceBadge = isPatientUpload ?
        '<span style="background: #ffc107; color: #000; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Patient Upload</span>' :
        '<span style="background: #007bff; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Doctor Prescription</span>';

    // --- MODIFIED ---
    modalContent.innerHTML = `
        <h3>${getText('prescriptions_title')} ${sourceBadge}</h3>
        <div class="prescription-header">
            <p><strong>Title:</strong> ${record.title}</p>
            <p><strong>Date:</strong> ${new Date(record.date).toDateString()}</p>
            <p><strong>${getText('report_desc')}:</strong> ${record.description}</p>
        </div>
        ${imageHtml}
        <p style="text-align: center; color: var(--text-color-secondary);">
            ${isPatientUpload ? 'Patient-uploaded prescription. AI-extracted details shown below if available.' : 'Doctor-provided prescription from consultation.'}
        </p>
        <button class="btn btn-primary" id="closePrescriptionModal">${getText('close')}</button>
    `;
    // --- END MODIFIED ---

    document.getElementById('prescriptionModal').classList.add('active');
    document.getElementById('closePrescriptionModal').addEventListener('click', () => document.getElementById('prescriptionModal').classList.remove('active'), { once: true });
}

            // REPLACE your old 'renderBookingStep' function
function renderBookingStep(step) {
    document.querySelectorAll('.booking-step').forEach(s => s.classList.remove('active'));
    const stepEl = document.getElementById(`bookingStep${step}`);
    if(stepEl) stepEl.classList.add('active');
    document.getElementById('prevStep').disabled = step === 1;
    document.getElementById('appointmentSummary').style.display = 'none';

    let grid, data, handler;
    // --- START REFACTORED SECTION ---
    if (step === 1) { 
        grid = document.getElementById('categoryGrid'); 
        data = appData.booking.categories; 
        handler = (item) => { bookingState.category = item; renderBookingStep(2); }; 
        // Translate the item as it's rendered
        grid.innerHTML = data.map(item => `<div class="selection-card card"><h4>${getText(item)}</h4></div>`).join(''); 
    }
    else if (step === 2) { 
        grid = document.getElementById('doctorGrid'); 
        data = doctors.filter(d => d.specialization === bookingState.category); 
        handler = (item) => { bookingState.doctorId = item.id; bookingState.doctor = item.name; renderBookingStep(3); }; 
        // Doctor names/languages are dynamic from DB, so we don't translate them
        grid.innerHTML = data.map(item => `<div class="doctor-card selection-card card"><img src="${item.img || 'https://placehold.co/100x100/0d9488/FFFFFF?text=Doc'}"><h4>${item.name}</h4><p>${item.languages}</p></div>`).join(''); 
    }
    else if (step === 3) { 
        generateCalendar(); 
        document.getElementById('timeSlotsGrid').innerHTML = ''; 
    }
    else if (step === 4) {
        grid = document.getElementById('modeGrid');
        data = appData.booking.modes;
        handler = (item) => {
            bookingState.mode = item;
            showSummary();
        };
        // Translate the item as it's rendered
        grid.innerHTML = data.map(item => `<div class="selection-card card"><h4>${getText(item)}</h4></div>`).join('');
    }
    // --- END REFACTORED SECTION ---

    if (grid) { Array.from(grid.children).forEach((child, index) => { child.addEventListener('click', () => handler(data[index])); }); }
}
             function generateCalendar() {
                const daysGrid = document.getElementById('calendarDaysGrid');
                const monthYearEl = document.getElementById('currentMonthYear');
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                monthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
                daysGrid.innerHTML = '';
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const today = new Date(); today.setHours(0, 0, 0, 0);
                document.getElementById('prevMonth').disabled = (currentYear < today.getFullYear() || (currentYear === today.getFullYear() && currentMonth <= today.getMonth()));

                for(let i = 0; i < firstDayOfMonth; i++) { daysGrid.insertAdjacentHTML('beforeend', '<div></div>'); }
                for(let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    const currentDate = new Date(currentYear, currentMonth, day);
                    dayEl.textContent = day; dayEl.classList.add('calendar-day');
                    if (currentDate < today) { dayEl.classList.add('disabled'); } 
                    else { dayEl.classList.add('available'); dayEl.addEventListener('click', () => { bookingState.date = `${day} ${monthNames[currentMonth]} ${currentYear}`; document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected')); dayEl.classList.add('selected'); generateTimeSlots(); }); }
                    daysGrid.appendChild(dayEl);
                }
            }
            function generateTimeSlots() {
                const slotsGrid = document.getElementById('timeSlotsGrid');
                let availableSlots = appData.booking.slots;

                // --- NEW LOGIC TO FILTER PAST TIME SLOTS FOR TODAY ---
                const today = new Date();
                const selectedDate = new Date(bookingState.date);
                
                // Check if the selected date is today
                if (selectedDate.toDateString() === today.toDateString()) {
                    const now = new Date();
                    
                    // Filter to keep only future time slots
                    availableSlots = appData.booking.slots.filter(slot => {
                        // Create a full Date object for the slot to compare it accurately
                        const [time, modifier] = slot.split(' ');
                        let [hours, minutes] = time.split(':');
                        hours = parseInt(hours);
                        minutes = parseInt(minutes);

                        if (modifier === 'PM' && hours < 12) {
                            hours += 12;
                        }
                        if (modifier === 'AM' && hours === 12) { // Midnight case
                            hours = 0;
                        }

                        const slotTime = new Date(selectedDate);
                        slotTime.setHours(hours, minutes, 0, 0);

                        return slotTime > now; // Keep the slot only if it's in the future
                    });
                }
                // --- END OF NEW LOGIC ---

                slotsGrid.innerHTML = availableSlots.map(slot => `<div class="time-slot">${slot}</div>`).join('');
                slotsGrid.querySelectorAll('.time-slot').forEach(slotEl => {
                    slotEl.addEventListener('click', () => {
                        document.querySelectorAll('.time-slot.selected').forEach(s => s.classList.remove('selected'));
                        slotEl.classList.add('selected');
                        bookingState.slot = slotEl.textContent;
                        renderBookingStep(4);
                    });
                });
            }
            // REPLACE your old 'showSummary' function with this:
function showSummary() {
    if (!user || !user.patientId) {
        // --- MODIFIED ---
        alert(getText('login_required_msg')); // Changed to the more descriptive message
        // --- END MODIFIED ---
        return;
    }
    document.querySelectorAll('.booking-step').forEach(s => s.classList.remove('active'));
    const summaryEl = document.getElementById('appointmentSummary');
    summaryEl.style.display = 'block';
    // --- MODIFIED ---
    summaryEl.innerHTML = `<h4>${getText('appt_summary_title')}</h4><p><strong>Category:</strong> ${bookingState.category}</p><p><strong>Doctor:</strong> ${bookingState.doctor}</p><p><strong>Date:</strong> ${bookingState.date}</p><p><strong>${getText('times')}:</strong> ${bookingState.slot}</p><p><strong>Mode:</strong> ${bookingState.mode}</p><button class="btn btn-primary" id="confirmBtn" style="width:100%; margin-top:1rem;">${getText('book_appt_btn')}</button>`;
    // --- END MODIFIED ---
    
    document.getElementById('confirmBtn').addEventListener('click', async () => {
        const appointmentDatetime = new Date(`${bookingState.date} ${bookingState.slot}`).toISOString();

        const bookingData = {
            userId: user.patientId,
            doctorId: bookingState.doctorId,
            appointmentDatetime: appointmentDatetime,
            appointmentType: bookingState.category,
            chiefComplaint: 'General consultation',
            symptoms: []
        };

        try {
            const response = await fetch(`${API_BASE_URL}/v1/book-doctor`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingData)
            });
            const data = await response.json();
            if (data.success) {
                // --- MODIFIED ---
                showConfirmationModal(getText('appt_booked_title'), getText('appt_booked_msg'));
                // --- END MODIFIED ---
                await generateAppointments(); // Refresh appointments
                setTimeout(() => { document.getElementById('confirmationModal').classList.remove('active'); showScreen('homeScreen'); }, 2500);
            } else {
                // --- MODIFIED ---
                alert(`${getText('reminder_error_title')}: ` + (data.error || 'Unknown error'));
                // --- END MODIFIED ---
            }
        } catch (e) {
            console.error('Booking error:', e);
            // --- MODIFIED ---
            alert(`${getText('reminder_error_title')}. ${getText('try_again_msg') || 'Please try again.'}`); // Added a fallback as 'try_again_msg' isn't in the list
            // --- END MODIFIED ---
        }
    });
    updateUIText();
}
            // REPLACE your old 'generateOrdersList' function with this:
function generateOrdersList() {
    const container = document.getElementById('orders-list-container');
    if (appData.orders.length === 0) {
        container.innerHTML = '<p style="text-align:center;">You have no active or past medicine orders.</p>';
        return;
    }
    // --- MODIFIED ---
    container.innerHTML = appData.orders.sort((a,b) => new Date(b.date) - new Date(a.date)).map(order => `
        <div class="card appointment-card">
            <div class="appointment-card-header">
                <div class="appointment-card-doctor">
                    <h4>${getText('order_id')} ${order.id}</h4>
                    <p>${order.pharmacyName}</p>
                    <p>${getText('cart_total')} â‚¹${order.total.toFixed(2)}</p>
                </div>
                <span class="appointment-card-tag ${order.status === 'Delivered' ? 'tag-audio' : 'tag-video'}">${order.status}</span>
            </div>
            <div class="appointment-card-footer">
                <button class="btn btn-primary track-order-list-btn" data-order-id="${order.id}">${getText('track_your_order')}</button>
            </div>
        </div>
    `).join('');
    // --- END MODIFIED ---

    container.querySelectorAll('.track-order-list-btn').forEach(btn => {
        btn.addEventListener('click', (e) => showTrackingModal(e.currentTarget.dataset.orderId));
    });
}

// REPLACE your old 'showTrackingModal' function with this:
function showTrackingModal(orderId) {
    const order = appData.orders.find(o => o.id === orderId);
    if (!order) return;

    const container = document.getElementById('trackingStatusContainer');
    // --- MODIFIED ---
    const statuses = [
        { title: getText('order_status_placed'), description: getText('order_status_placed_desc'), icon: 'ðŸ“‹' },
        { title: getText('order_status_preparing'), description: getText('order_status_preparing_desc'), icon: 'ðŸ¥' },
        { title: getText('order_status_delivery'), description: getText('order_status_delivery_desc'), icon: 'ðŸšš' },
        { title: getText('order_status_delivered'), description: getText('order_status_delivered_desc'), icon: 'âœ…' }
    ];
    // --- END MODIFIED ---
    
    const currentStatusIndex = ['Order Placed', 'Preparing Order', 'Out for Delivery', 'Delivered'].indexOf(order.status);

    container.innerHTML = statuses.map((status, index) => {
        const isCompleted = index < currentStatusIndex;
        const isCurrent = index === currentStatusIndex;
        const statusClass = isCompleted ? 'completed' : (isCurrent ? 'current' : '');
        const timestamp = isCompleted ? new Date(order.date).toLocaleString() : '';

        return `
            <div class="tracking-step ${statusClass}">
                <div class="tracking-dot">
                    ${isCompleted ? 'âœ“' : (isCurrent ? status.icon : 'â—‹')}
                </div>
                <div class="tracking-content">
                    <div class="tracking-title">${status.title}</div>
                    <div class="tracking-description">${status.description}</div>
                    ${timestamp ? `<div class="tracking-timestamp">${timestamp}</div>` : ''}
                </div>
            </div>
        `;
    }).join('');

    document.getElementById('trackingModal').classList.add('active');
}



            // REPLACE your old 'setupModalsAndActions' function with this:
function setupModalsAndActions() { 
    document.getElementById('closeModal').addEventListener('click', () => document.getElementById('confirmationModal').classList.remove('active'));
    document.getElementById('sosButton').addEventListener('click', () => document.getElementById('sosModal').classList.add('active'));
    document.getElementById('cancelSos').addEventListener('click', () => document.getElementById('sosModal').classList.remove('active'));
    document.getElementById('endCallBtn')?.addEventListener('click', leaveCall);
    document.getElementById('closeTrackingModal').addEventListener('click', () => document.getElementById('trackingModal').classList.remove('active'));
    document.getElementById('uploadPrescriptionBtn').addEventListener('click', () => document.getElementById('uploadPrescriptionModal').classList.add('active'));
    document.getElementById('closeUploadModal').addEventListener('click', () => { const modal = document.getElementById('uploadPrescriptionModal'); modal.classList.remove('active'); const feed = document.getElementById('uploadCameraFeed'); if (feed.srcObject) { feed.srcObject.getTracks().forEach(track => track.stop()); feed.srcObject = null; } openCameraBtn.disabled = false; captureBtn.disabled = true; cameraStatus.textContent = "Click 'Open Camera' to start scanning"; });
    // Should be present in setupModalsAndActions or similar function
    document.getElementById('muteAudioBtn')?.addEventListener('click', toggleAgoraAudio);
    document.getElementById('muteVideoBtn')?.addEventListener('click', toggleAgoraVideo);
    // Medicine reminder modal
    document.getElementById('addReminderBtn').addEventListener('click', () => document.getElementById('medicineReminderModal').classList.add('active'));
    document.getElementById('saveReminderBtn').addEventListener('click', async (event) => {
    event.preventDefault(); // <-- THIS IS THE FIX
    await saveMedicineReminder();
});
document.getElementById('logoutBtn').addEventListener('click', () => {
    // 1. Remove user data from local storage
    localStorage.removeItem('sehatSaharaUser'); // Make sure the key matches what you use for login

    // 2. Show a confirmation message (optional, but good UX)
    // --- MODIFIED ---
    showConfirmationModal(getText('logged_out_title'), getText('logged_out_msg'));
    // --- END MODIFIED ---

    // 3. Redirect to the login page after a short delay
    setTimeout(() => {
        window.location.href = 'index.html'; // Redirect to your login page
    }, 1500); // Wait 1.5 seconds before redirecting
});
// REPLACE the old 'confirmSos' listener with this:
document.getElementById('confirmSos').addEventListener('click', () => { 
    document.getElementById('sosModal').classList.remove('active'); 
    startSosCountdown(user); // This correctly starts the countdown
});
    document.getElementById('reportIssueForm')?.addEventListener('submit', (e) => { 
        e.preventDefault(); 
        // --- MODIFIED ---
        showConfirmationModal(getText('report_submitted_title'), getText('report_submitted_msg')); 
        // --- END MODIFIED ---
        e.target.reset(); 
        setTimeout(() => showScreen('moreScreen'), 2000); 
    });
    document.getElementById('prevMonth').addEventListener('click', () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } generateCalendar(); });
    document.getElementById('nextMonth').addEventListener('click', () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } generateCalendar(); });
    document.getElementById('prevStep').addEventListener('click', () => {
        const activeStep = document.querySelector('.booking-step.active');
        if (activeStep) {
            const currentStep = parseInt(activeStep.id.replace('bookingStep', ''));
            if (currentStep > 1) renderBookingStep(currentStep - 1);
        }
    });
    document.getElementById('viewAllPrescriptions').addEventListener('click', () => showScreen('prescriptionsScreen'));
    document.getElementById('medicineReminders').addEventListener('click', () => { showScreen('medicineRemindersScreen'); loadMedicineRemindersScreen(); });
}
            // REPLACE your entire 'setupBookMedicine' function with this
function setupBookMedicine() {
    // --- Element Selectors ---
    const pharmacySelectionContainer = document.getElementById('pharmacySelectionContainer');
    const medicineOrderingContainer = document.getElementById('medicineOrderingContainer');
    const pharmacyGrid = document.getElementById('pharmacyGrid');
    const searchInput = document.getElementById('medicineSearch');
    const selectedPharmacyNameEl = document.getElementById('selectedPharmacyName');
    const changePharmacyBtn = document.getElementById('changePharmacyBtn');
    
    // --- NEW: Add translations for category cards ---
    document.querySelector('.category-card[data-category="pain-fever"] h4').textContent = getText('cat_pain_fever');
    document.querySelector('.category-card[data-category="pain-fever"] p').textContent = getText('cat_pain_fever_desc');
    document.querySelector('.category-card[data-category="cough-cold"] h4').textContent = getText('cat_cough_cold');
    document.querySelector('.category-card[data-category="cough-cold"] p').textContent = getText('cat_cough_cold_desc');
    document.querySelector('.category-card[data-category="stomach"] h4').textContent = getText('cat_stomach');
    document.querySelector('.category-card[data-category="stomach"] p').textContent = getText('cat_stomach_desc');
    document.querySelector('#medicineOrderingContainer h3').textContent = getText('browse_by_category');
    document.querySelector('#medicineOrderingContainer .form-group label').textContent = getText('search_for_medicine');
    document.querySelector('#medicineSearch').placeholder = getText('search_placeholder');
    // --- END NEW ---

    // --- Event Handling & State Management ---

            // Resets the view to show the pharmacy list again
            const resetAndShowPharmacies = () => {
                pharmacySelectionContainer.style.display = 'block';
                medicineOrderingContainer.style.display = 'none';
                selectedPharmacy = null; // Clear the selected pharmacy state
            };

    // --- Core View & Data Functions ---

    // Renders the initial list of pharmacies for the user to select
    const renderPharmacies = () => {
        pharmacyGrid.innerHTML = appData.pharmacy.map(p => `
            <div class="card pharmacy-card" data-pharmacy-id="${p.id}">
               <div class="info">
                 <h4>${p.name}</h4>
                 <p><small>${p.address}</small></p>
               </div>
               <div class="actions">
                    <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 5.5a.5.5 0 0 0-1 0v3.5h3a.5.5 0 0 0 0-1h-2.5V5.5z"/><path d="M6.5 1A.5.5 0 0 1 7 .5h2a.5.5 0 0 1 0 1H7a.5.5 0 0 1-.5-.5zM8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg> ${p.delivery}</span>
                    <a href="tel:${p.contact}" class="btn">Contact</a>
               </div>
            </div>
        `).join('');
        pharmacyGrid.querySelectorAll('.pharmacy-card').forEach(card => card.addEventListener('click', handlePharmacySelection));
    };

    // Handles switching to the medicine ordering view after a pharmacy is chosen
    const handlePharmacySelection = (e) => {
        if (e.target.tagName === 'A') return; // Ignore clicks on the "Contact" button
        const pharmacyId = parseInt(e.currentTarget.dataset.pharmacyId);
        selectedPharmacy = appData.pharmacy.find(p => p.id === pharmacyId);
        
        pharmacySelectionContainer.style.display = 'none';
        medicineOrderingContainer.style.display = 'block';
        // --- MODIFIED ---
        selectedPharmacyNameEl.textContent = getText('ordering_from', { name: selectedPharmacy.name });
        changePharmacyBtn.textContent = getText('change');
        // --- END MODIFIED ---
        
        const firstCategoryCard = document.querySelector('.category-card');
        if (firstCategoryCard) {
            firstCategoryCard.classList.add('selected');
            renderMedicines(firstCategoryCard.dataset.category);
        }
    };

    // Renders medicine cards based on category or search results
    window.renderMedicines = (source, isSearchResult = false) => {
        const medicineGrid = document.getElementById('medicineGrid');
        let medicinesToShow = isSearchResult ? source : (appData.medicines[source] || []);
        
        // --- MODIFIED ---
        medicineGrid.innerHTML = medicinesToShow.map(med => `
            <div class="medicine-card card">
                <div class="medicine-name">${med.name}</div>
                <div class="medicine-price">â‚¹${med.price.toFixed(2)}</div>
                <div class="medicine-description">${getText(med.description)}</div>
                <div class="quantity-selector">
                    <button class="quantity-btn" data-action="decrease" data-med-id="${med.id}">-</button>
                    <input type="number" class="quantity-input" data-med-id="${med.id}" value="1" min="1" max="99" readonly>
                    <button class="quantity-btn" data-action="increase" data-med-id="${med.id}">+</button>
                </div>
                <button class="btn btn-primary add-to-cart-btn" data-med-id="${med.id}">${getText('add_to_cart')}</button>
            </div>
        `).join('');
        // --- END MODIFIED ---
        
        attachMedicineCardListeners(medicinesToShow);
    };

    // Attaches event listeners to the quantity and "Add to Cart" buttons on medicine cards
    window.attachMedicineCardListeners = (medicineSource) => {
        const medicineGrid = document.getElementById('medicineGrid');
        medicineGrid.querySelectorAll('.quantity-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const medId = parseInt(e.target.dataset.medId);
                const action = e.target.dataset.action;
                const input = medicineGrid.querySelector(`.quantity-input[data-med-id="${medId}"]`);
                if (!input) return;
                let currentValue = parseInt(input.value);
                if (action === 'increase' && currentValue < 99) input.value = currentValue + 1;
                else if (action === 'decrease' && currentValue > 1) input.value = currentValue - 1;
            });
        });

        medicineGrid.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const medId = parseInt(e.target.dataset.medId);
                const input = medicineGrid.querySelector(`.quantity-input[data-med-id="${medId}"]`);
                if (!input) return;
                const quantity = parseInt(input.value);
                const medicine = medicineSource.find(m => m.id === medId);
                if (medicine) {
                    addToCart(medicine, quantity);
                    updateCartIcon();
                    // --- MODIFIED ---
                    showConfirmationModal(getText('added_to_cart_title'), `${medicine.name} (${quantity}) has been added.`);
                    // --- END MODIFIED ---
                }
            });
        });
    };

    // --- Cart & Checkout Management ---

    const addToCart = (medicine, quantity) => {
        const existingItem = medicineCart.find(item => item.id === medicine.id);
        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            medicineCart.push({ ...medicine, quantity });
        }
    };

    window.updateCartIcon = () => {
        const cartBadge = document.querySelector('.cart-badge');
        if (!cartBadge) return;
        const totalItems = medicineCart.reduce((sum, item) => sum + item.quantity, 0);
        cartBadge.textContent = totalItems;
        cartBadge.style.display = totalItems > 0 ? 'flex' : 'none';

        // --- NEW: Also update checkout button text ---
        const checkoutBtn = document.getElementById('checkoutBtn');
        if (checkoutBtn) {
            checkoutBtn.textContent = getText('checkout_btn', { count: totalItems });
            checkoutBtn.disabled = totalItems === 0;
        }
    };

    // Updates the content of the shopping cart modal
    window.updateCartModal = () => {
        const cartItemsContainer = document.getElementById('cartItemsContainer');
        const cartTotalEl = document.getElementById('cartTotal');
        // --- NEW: Also translate modal title and buttons ---
        const cartModal = document.getElementById('cartModal');
        cartModal.querySelector('h3').textContent = getText('shopping_cart_title');
        cartModal.querySelector('.btn:not(.btn-primary)').textContent = getText('continue_shopping');
        cartModal.querySelector('.btn-primary').textContent = getText('proceed_to_checkout');
        // --- END NEW ---

        if (!cartItemsContainer || !cartTotalEl) return;

        if (medicineCart.length === 0) {
            // --- MODIFIED ---
            cartItemsContainer.innerHTML = `<p style="text-align: center; color: var(--text-color-secondary);">${getText('cart_empty')}</p>`;
            cartTotalEl.textContent = 'â‚¹0.00';
            // --- END MODIFIED ---
            return;
        }

        cartItemsContainer.innerHTML = medicineCart.map(item => `
            <div class="cart-item">
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-details">â‚¹${item.price.toFixed(2)} each</div>
                    <div class="cart-item-price">Subtotal: â‚¹${(item.price * item.quantity).toFixed(2)}</div>
                </div>
                <div class="cart-item-actions">
                    <div class="cart-quantity">
                        <button class="cart-quantity-btn" onclick="updateCartItemQuantity(${item.id}, ${item.quantity - 1})">-</button>
                        <span style="padding: 0.5rem; min-width: 40px; text-align: center; display: inline-block;">${item.quantity}</span>
                        <button class="cart-quantity-btn" onclick="updateCartItemQuantity(${item.id}, ${item.quantity + 1})">+</button>
                    </div>
                    <button class="cart-remove-btn" onclick="removeCartItem(${item.id})">Remove</button>
                </div>
            </div>
        `).join('');

        const total = medicineCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        cartTotalEl.textContent = `â‚¹${total.toFixed(2)}`;
    };

    // Make cart modification functions globally accessible for the onclick attributes
    window.updateCartItemQuantity = (medicineId, newQuantity) => {
        const item = medicineCart.find(i => i.id === medicineId);
        if (item) {
            if (newQuantity <= 0) {
                removeCartItem(medicineId);
            } else {
                item.quantity = newQuantity;
                updateCartIcon();
                updateCartModal();
            }
        }
    };

    window.removeCartItem = (medicineId) => {
        const index = medicineCart.findIndex(i => i.id === medicineId);
        if (index > -1) {
            medicineCart.splice(index, 1);
            updateCartIcon();
            updateCartModal();
        }
    };

    // --- Checkout Flow Logic ---
    let checkoutStep = 1;
    const showCheckoutStep = (step) => {
        checkoutStep = step;
        document.querySelectorAll('#checkoutModal .checkout-step').forEach(s => s.classList.remove('active'));
        const stepEl = document.getElementById(`checkoutStep${step}`);
        if (stepEl) stepEl.classList.add('active');
    };

    window.nextCheckoutStep = () => {
        if (checkoutStep === 1) {
            if (!document.getElementById('deliveryAddress').value.trim()) {
                // --- MODIFIED ---
                showConfirmationModal(getText('address_required_title'), getText('address_required_msg'));
                // --- END MODIFIED ---
                return;
            }
            document.getElementById('checkoutAddress').textContent = document.getElementById('deliveryAddress').value;
            const checkoutItems = document.getElementById('checkoutItems');
            checkoutItems.innerHTML = medicineCart.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                    <div><strong>${item.name}</strong><br><small>Quantity: ${item.quantity}</small></div>
                    <div style="font-weight: 600;">â‚¹${(item.price * item.quantity).toFixed(2)}</div>
                </div>`).join('');
            const total = medicineCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('checkoutTotal').textContent = `â‚¹${total.toFixed(2)}`;
        }
        if (checkoutStep < 4) showCheckoutStep(checkoutStep + 1);
    };

    window.prevCheckoutStep = () => {
        if (checkoutStep > 1) showCheckoutStep(checkoutStep - 1);
    };

    // --- Payment Form Logic ---
    const showPaymentForm = (method) => {
        document.getElementById('cardPaymentForm').style.display = 'none';
        document.getElementById('upiPaymentForm').style.display = 'none';
        document.getElementById('netbankingForm').style.display = 'none';
        const form = document.getElementById(`${method}PaymentForm`);
        if (form) form.style.display = 'block';
    };

    window.formatCardNumber = (input) => {
        input.value = input.value.replace(/\s/g, '').replace(/(\d{4})/g, '$1 ').trim();
        document.getElementById('previewCardNumber').textContent = input.value || 'â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢';
    };

    window.formatExpiryDate = (input) => {
        input.value = input.value.replace(/\D/g, '').replace(/(\d{2})(\d)/, '$1/$2').slice(0, 5);
        document.getElementById('previewExpiryDate').textContent = input.value || 'â€¢â€¢/â€¢â€¢';
    };

    window.setUpiId = (app) => {
        const phone = '9876543210'; // Example phone number
        const suffix = { paytm: '@paytm', gpay: '@oksbi', phonepe: '@ybl' }[app];
        document.getElementById('upiId').value = phone + suffix;
    };

    // --- Order Placement ---
    window.processPayment = async () => {
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        
        // --- MODIFIED (VALIDATION LOGIC) ---
        const validatePaymentForm = (method) => {
            // In a real app, you'd have robust validation here
            if (method === 'card' && document.getElementById('cardNumber').value.length < 19) {
                showConfirmationModal(getText('invalid_card_title'), getText('invalid_card_msg'));
                return false;
            }
            if (method === 'upi' && !document.getElementById('upiId').value.includes('@')) {
                showConfirmationModal(getText('invalid_upi_title'), getText('invalid_upi_msg'));
                return false;
            }
            return true;
        };
        // --- END MODIFIED ---

        if (!validatePaymentForm(paymentMethod)) return;

        const processBtn = document.querySelector('#checkoutStep3 .btn-primary');
        // --- MODIFIED ---
        processBtn.textContent = getText('processing');
        processBtn.disabled = true;
        // --- END MODIFIED ---

        await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate API call

        placeOrder(); // Place order on successful payment simulation

        // --- MODIFIED ---
        processBtn.textContent = getText('proceed_to_pay');
        processBtn.disabled = false;
        // --- END MODIFIED ---
    };

    const placeOrder = async () => {
        // Check for user authentication first
        if (!user || !user.patientId) {
            // --- MODIFIED ---
            showConfirmationModal(getText('login_required_title'), getText('login_required_msg'));
            // --- END MODIFIED ---
            return;
        }
        // Check if a pharmacy is selected
        if (!selectedPharmacy || !selectedPharmacy.id) {
            // --- MODIFIED ---
            showConfirmationModal(getText('pharmacy_required_title'), getText('pharmacy_required_msg'));
            // --- END MODIFIED ---
            return;
        }

        const orderData = {
            // --- FIX: ADD THE PATIENT'S ID TO THE REQUEST ---
            userId: user.patientId,
            pharmacyId: selectedPharmacy.id, // The backend expects pharmacyId
            items: medicineCart.map(item => ({ name: item.name, price: item.price, quantity: item.quantity })),
            deliveryAddress: document.getElementById('deliveryAddress').value.trim(),
            paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value
        };

        try {
            const response = await fetch(`${API_BASE_URL}/v1/orders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // Important: Sends the session cookie for authentication
                body: JSON.stringify(orderData)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                // Use the REAL order details from the backend for the confirmation screen
                const newOrder = {
                    id: result.orderId,
                    items: [...medicineCart],
                    total: result.totalAmount,
                    status: 'Order Placed',
                    date: new Date().toISOString(),
                    pharmacyName: selectedPharmacy.name
                };
                appData.orders.unshift(newOrder); // Add to local data for immediate UI update

                // Add to health record timeline
                appData.records.unshift({
                    date: newOrder.date.split('T')[0],
                    title: `Medicine Order - ${selectedPharmacy.name}`,
                    description: `Ordered ${medicineCart.length} items. Order ID: ${result.orderId}`
                });

                // Show confirmation screen using data from the backend
                document.getElementById('orderIdDisplay').textContent = result.orderId;
                document.getElementById('deliveryTimeDisplay').textContent = result.estimatedDelivery;
                showCheckoutStep(4);

                // Reset and update UI
                medicineCart = [];
                updateCartIcon();
                generateTimeline();
                generateOrdersList();
            } else {
                // --- MODIFIED ---
                throw new Error(result.message || getText('order_failed_title'));
                // --- END MODIFIED ---
            }
        } catch (error) {
            console.error('Order placement error:', error);
            // --- MODIFIED ---
            showConfirmationModal(getText('order_failed_title'), getText('order_failed_generic_msg', { error: error.message }));
            // --- END MODIFIED ---
        }
    };
    
    window.trackOrder = () => {
        document.getElementById('checkoutModal').classList.remove('active');
        showCheckoutStep(1); // Reset modal for next time
        showScreen('trackOrdersScreen');
    };
    
    // --- Initial Setup & Event Listeners ---
    
    // Event listener for category card clicks
    document.querySelectorAll('.category-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            searchInput.value = '';
            renderMedicines(card.dataset.category);
        });
    });
    
    // Event listener for the search input
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        if (searchTerm.length > 0) {
            document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
            const allMedicines = Object.values(appData.medicines).flat();
            const filteredMedicines = allMedicines.filter(med => med.name.toLowerCase().includes(searchTerm));
            renderMedicines(filteredMedicines, true);
        } else {
            const firstCategoryCard = document.querySelector('.category-card');
            if(firstCategoryCard) {
                firstCategoryCard.classList.add('selected');
                renderMedicines(firstCategoryCard.dataset.category);
            }
        }
    });

    changePharmacyBtn.addEventListener('click', resetAndShowPharmacies);

    document.querySelector('.cart-icon').addEventListener('click', () => {
        updateCartModal();
        document.getElementById('cartModal').classList.add('active');
    });

    document.getElementById('cartModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) e.currentTarget.classList.remove('active');
    });
    
    document.getElementById('checkoutModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            e.currentTarget.classList.remove('active');
            showCheckoutStep(1);
        }
    });

    document.getElementById('proceedToCheckoutBtn').addEventListener('click', () => {
        if (medicineCart.length === 0) {
            // --- MODIFIED ---
            showConfirmationModal(getText('cart_empty_title'), getText('cart_empty_msg'));
            // --- END MODIFIED ---
            return;
        }
        document.getElementById('cartModal').classList.remove('active');
        document.getElementById('checkoutModal').classList.add('active');
        showCheckoutStep(1);
    });
    
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', (e) => showPaymentForm(e.target.value));
    });

    // Initial function calls
    renderPharmacies();
    updateCartIcon();
    showPaymentForm('card'); // Default to showing the card form
}

            // REPLACE your old 'setupScanMedicine' function with this:
function setupScanMedicine() {
    const cameraFeed = document.getElementById('camera-feed');
    const openCameraBtn = document.getElementById('openCameraBtn');
    const scanCodeBtn = document.getElementById('scanCodeBtn');
    const cameraStatus = document.getElementById('camera-status');
    let stream = null;

    openCameraBtn.addEventListener('click', async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            cameraFeed.srcObject = stream;
            await cameraFeed.play();
            // --- MODIFIED ---
            cameraStatus.textContent = getText('camera_active_status');
            openCameraBtn.disabled = true;
            scanCodeBtn.disabled = false;
            scanCodeBtn.textContent = getText('scan_medicine_btn');
            // --- END MODIFIED ---
        } catch (err) {
            // --- MODIFIED ---
            cameraStatus.textContent = getText('camera_permission_error');
            // --- END MODIFIED ---
            console.error("Camera error:", err);
        }
    });

    scanCodeBtn.addEventListener('click', async () => {
        if (!stream) return;

        // Create canvas to capture image
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = cameraFeed.videoWidth;
        canvas.height = cameraFeed.videoHeight;
        ctx.drawImage(cameraFeed, 0, 0);

        // Get base64 image
        const imageData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

        // --- MODIFIED ---
        cameraStatus.textContent = getText('scanning_medicine');
        scanCodeBtn.disabled = true;
        // --- END MODIFIED ---

        try {
            const response = await fetch(`${API_BASE_URL}/v1/scan-medicine`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imageData: imageData, message: "Scan this medicine packaging" })
            });

            const data = await response.json();

            // --- MODIFIED ---
            if (response.ok && data.success) {
                showConfirmationModal(getText('scan_successful_title'), `Medicine Information: ${data.medicine_info}`);
            } else {
                showConfirmationModal(getText('scan_failed_title'), data.error || getText('scan_failed_generic_msg'));
            }
            // --- END MODIFIED ---
        } catch (error) {
            console.error('Scan error:', error);
            // --- MODIFIED ---
            showConfirmationModal(getText('scan_failed_title'), getText('order_failed_generic_msg', { error: error.message })); // Using a generic network error
            // --- END MODIFIED ---
        } finally {
            // --- MODIFIED ---
            cameraStatus.textContent = getText('camera_active_status');
            scanCodeBtn.disabled = false;
            // --- END MODIFIED ---
        }
    });
}
            
            

            // REPLACE your old 'setupUploadPrescription' function with this:
function setupUploadPrescription() {
    const cameraFeed = document.getElementById('uploadCameraFeed');
    const openCameraBtn = document.getElementById('openUploadCameraBtn');
    const captureBtn = document.getElementById('capturePrescriptionBtn');
    const cameraStatus = document.getElementById('uploadCameraStatus');
    let stream = null;

    openCameraBtn.addEventListener('click', async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            cameraFeed.srcObject = stream;
            await cameraFeed.play();
            // --- MODIFIED ---
            cameraStatus.textContent = getText('camera_active_status'); // Re-using this key
            openCameraBtn.disabled = true;
            captureBtn.disabled = false;
            // --- END MODIFIED ---
        } catch (err) {
            // --- MODIFIED ---
            cameraStatus.textContent = getText('camera_permission_error');
            // --- END MODIFIED ---
            console.error("Camera error:", err);
        }
    });

    captureBtn.addEventListener('click', async () => {
        const providerName = document.getElementById('providerName').value.trim();
        if (!providerName) {
            // --- MODIFIED ---
            alert(getText('provider_name') + ' ' + (getText('is_required_msg') || 'is required.')); // Adding a fallback
            // --- END MODIFIED ---
            return;
        }
        if (!stream) return;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = cameraFeed.videoWidth;
        canvas.height = cameraFeed.videoHeight;
        ctx.drawImage(cameraFeed, 0, 0);
        const imageData = canvas.toDataURL('image/jpeg', 0.8);

        try {
            // Send to backend
            const response = await fetch(`${API_BASE_URL}/v1/upload-prescription`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: user.patientId,
                    providerName: providerName,
                    imageData: imageData
                })
            });

            if (!response.ok) {
                throw new Error('Failed to upload to backend');
            }

            const uploadResult = await response.json();
            
        // --- FIX: REPLACE THE LOGIC AFTER THE FETCH CALL WITH THIS ---
        if (uploadResult.success && uploadResult.formatted_response) {
            
            // Step 1: Close the upload modal and stop the camera
            const uploadModal = document.getElementById('uploadPrescriptionModal');
            const feed = document.getElementById('uploadCameraFeed');
            if (feed.srcObject) {
                feed.srcObject.getTracks().forEach(track => track.stop());
                feed.srcObject = null;
            }
            uploadModal.classList.remove('active');
            
            // Step 2: Navigate the user to the chatbot screen
            showScreen('chatbotScreen');

            // Step 3: Display the summary in the now-visible chat window
            displaySummaryInChat(uploadResult.formatted_response);
            
            // Step 4: Show a less intrusive confirmation
            // --- MODIFIED ---
            showConfirmationModal(getText('reminder_success_title'), getText('reminder_added_msg')); // Re-using this key
            // --- END MODIFIED ---
        }
        // --- END OF FIX ---

            // Refresh the prescriptions list from backend
            await generateAllPrescriptions();
            
        } catch (error) {
            console.error('Upload error:', error);
            // --- MODIFIED ---
            showConfirmationModal(getText('upload_failed_title'), getText('upload_failed_msg'));
            // --- END MODIFIED ---
        }

    });
}

            // Enhanced Chatbot with Smart Button Management
            class SmartSehatSaharaChatbot {
                constructor() {
                    this.chatWindow = document.getElementById('chatWindow');
                    this.currentButtons = [];
                    this.buttonHistory = new Set(); // Track shown buttons to avoid repeats
                    this.userProgress = {};
                    this.lastUserMessage = '';
                    this.currentBookingStep = null;
                    this.bookingContext = {};
                }

                // In patient.html, inside the SmartSehatSaharaChatbot class

                // In patient.html, inside the SmartSehatSaharaChatbot class

// REPLACE this method *inside* the SmartSehatSaharaChatbot class
async handleChatbotResponse(response) {
    this.displayMessage(response.response, 'bot');
    this.clearButtons(); // Always clear old buttons first
    // --- START: ADD THIS NEW CODE BLOCK ---
                if (response.action === 'EXECUTE_BOOKING') {
                    // This action tells the frontend to make the final booking API call
                    console.log('Received EXECUTE_BOOKING action. Calling /v1/book-doctor...');
                    try {
                        const bookingResponse = await fetch(`${API_BASE_URL}/v1/book-doctor`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: user.patientId, // Make sure user object is accessible
                                ...response.parameters // Pass all parameters from the chatbot
                            })
                        });
                        const bookingResult = await bookingResponse.json();
                        if (bookingResult.success) {
                            // --- MODIFIED ---
                            this.displayMessage(`âœ… ${getText('appt_booked_title')}`, 'bot'); // Re-using this key
                            // --- END MODIFIED ---
                            await generateAppointments(); // Refresh the appointment list
                        } else {
                            // --- MODIFIED ---
                            this.displayMessage(`ðŸ˜• ${getText('reminder_error_title')}: ${bookingResult.message}`, 'bot'); // Re-using this key
                            // --- END MODIFIED ---
                        }
                    } catch (error) {
                        console.error('Error during final booking:', error);
                        // --- MODIFIED ---
                        this.displayMessage(getText('chatbot_connect_error'), 'bot'); // Re-using this key
                        // --- END MODIFIED ---
                    }
                    return; // Stop further processing
                }

    if (response.action === 'BOOKING_SUCCESS') {
        await generateAppointments();
    }

    // Priority 1: The ideal case where the AI correctly provides the buttons.
    if (response.interactive_buttons && response.interactive_buttons.length > 0) {
        this.showInteractiveButtons(response.interactive_buttons);
        return; // Buttons are shown, our job is done.
    }

    // --- NEW FALLBACK LOGIC ---
    // Priority 2: If the AI failed to create buttons but the backend INTENDED for it to,
    // we will create them manually here. We know the intent because the action is 'SHOW_GUIDANCE'.
    if (response.action === 'SHOW_GUIDANCE') {
        const contextualButtons = [];
        // The backend also sends the original intent, which we can use here.
        const intent = response.intent;

        if (intent === 'medicine_scan' || intent === 'how_to_medicine_scan') {
            contextualButtons.push({
                // --- MODIFIED ---
                text: `ðŸ“· ${getText('scan_medicine')}`,
                // --- END MODIFIED ---
                action: 'START_MEDICINE_SCANNER',
                parameters: {},
                style: 'primary'
            });
        } else if (intent === 'prescription_upload' || intent === 'how_to_prescription_upload' || intent === 'prescription_inquiry') {
            contextualButtons.push({
                // --- MODIFIED ---
                text: `ðŸ“¤ ${getText('upload_prescription_btn')}`,
                // --- END MODIFIED ---
                action: 'UPLOAD_PRESCRIPTION',
                parameters: {},
                style: 'primary'
            });
        }

        if (contextualButtons.length > 0) {
            this.showInteractiveButtons(contextualButtons);
            return; // Fallback buttons are shown, our job is done.
        }
    }
    // --- END OF NEW FALLBACK LOGIC ---

    // Priority 3 (Final Fallback): If it's just a general inquiry, show the main help buttons.
    if (response.intent === 'general_inquiry') {
        this.showGeneralHelpButtons();
    }
}


                // In patient.html, inside the SmartSehatSaharaChatbot class

                async handleButtonClick(button) {
    console.log('Button clicked:', button.action, button.text, button.parameters);

    // Define actions that should continue the conversation in the chat window
    const conversationalActions = [
        'SELECT_SPECIALTY', 'SELECT_DOCTOR', 'SELECT_DATE', 
        'SELECT_TIME', 'SELECT_MODE'
    ];

    if (conversationalActions.includes(button.action)) {
        // For conversational actions, send the selection back to the backend
        // This simulates the user typing their choice.
        this.displayMessage(button.text, 'user'); // Show the user's choice immediately
        this.clearButtons(); // Remove buttons after selection

        // Send a request to the backend with the button's action and parameters
        await this.sendPredictRequest(button.text, button.action, button.parameters);
        return; // Stop further processing
    }

    // Handle simple NAVIGATION actions as before.
    switch (button.action) {
        case 'START_MEDICINE_SCANNER':
        case 'SCAN_MEDICINE':
            showScreen('scanMedicineScreen');
            break;
        case 'UPLOAD_PRESCRIPTION':
            document.getElementById('uploadPrescriptionModal').classList.add('active');
            break;
        default:
            console.warn(`Unhandled navigation action: ${button.action}`);
            break;
    }

    // Log the click in the background (no changes needed here).
    try {
        await fetch(`${API_BASE_URL}/v1/button-action`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: user.patientId, buttonAction: button.action })
        });
    } catch (error) { console.error('Button action API error:', error); }

    this.clearButtons();
}
// Add this new helper function inside the SmartSehatSaharaChatbot class
// REPLACE this method *inside* the SmartSehatSaharaChatbot class
async sendPredictRequest(message, buttonAction = null, parameters = null) {
    const chatWindow = document.getElementById('chatWindow');
    const typingIndicator = document.createElement('div');
    typingIndicator.classList.add('chat-message', 'bot-message');
    // --- MODIFIED ---
    typingIndicator.textContent = getText('chatbot_typing');
    // --- END MODIFIED ---
    chatWindow.appendChild(typingIndicator);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    try {
        const payload = {
            message: message,
            userId: user.patientId,
            language: currentLanguage
        };
        if (buttonAction) {
            payload.buttonAction = buttonAction;
            payload.parameters = parameters;
        }

        const response = await fetch(`${API_BASE_URL}/v1/predict`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`HTTP Error: ${response.status}`);
        }

        const data = await response.json();
        chatWindow.removeChild(typingIndicator);
        await this.handleChatbotResponse(data);

    } catch (error) {
        console.error('Chat Error:', error);
        chatWindow.removeChild(typingIndicator);
        // --- MODIFIED ---
        this.displayMessage(getText('chatbot_connect_error'), 'bot');
        // --- END MODIFIED ---
    }
}





                showInteractiveButtons(buttons) {
                    this.clearButtons();
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'interactive-buttons-container';

                    buttons.forEach(button => {
                        const buttonElement = this.createButton(button);
                        buttonsContainer.appendChild(buttonElement);
                    });

                    if (this.chatWindow) {
                        this.chatWindow.appendChild(buttonsContainer);
                        // *** THIS IS THE FIX: Use a short timeout to scroll after the DOM updates ***
                        setTimeout(() => {
                            this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
                        }, 50);
                    }
                    this.currentButtons = buttons;
                }

                createButton(button) {
                    const buttonElement = document.createElement('button');
                    buttonElement.textContent = button.text;
                    buttonElement.className = `btn btn-${button.style === 'primary' ? 'primary' : 'secondary'}`;
                    buttonElement.style.cssText = `
                        padding: 10px 20px;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        margin: 5px;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    `;

                    // Set button color based on style with enhanced gradients
                    if (button.style === 'primary') {
                        buttonElement.style.background = 'linear-gradient(45deg, #0d9488, #14b8a6)';
                        buttonElement.style.color = 'white';
                        buttonElement.style.boxShadow = '0 4px 15px rgba(13, 148, 136, 0.3)';
                    } else {
                        buttonElement.style.background = 'linear-gradient(45deg, #64748b, #94a3b8)';
                        buttonElement.style.color = 'white';
                        buttonElement.style.boxShadow = '0 4px 15px rgba(100, 116, 139, 0.3)';
                    }

                    // Add hover effects
                    buttonElement.addEventListener('mouseenter', () => {
                        if (!buttonElement.disabled) {
                            buttonElement.style.transform = 'translateY(-2px)';
                            buttonElement.style.boxShadow = button.style === 'primary'
                                ? '0 6px 20px rgba(13, 148, 136, 0.4)'
                                : '0 6px 20px rgba(100, 116, 139, 0.4)';
                        }
                    });

                    buttonElement.addEventListener('mouseleave', () => {
                        if (!buttonElement.disabled) {
                            buttonElement.style.transform = 'translateY(0)';
                            buttonElement.style.boxShadow = button.style === 'primary'
                                ? '0 4px 15px rgba(13, 148, 136, 0.3)'
                                : '0 4px 15px rgba(100, 116, 139, 0.3)';
                        }
                    });

                    // Handle button click with enhanced conversational booking support
                    buttonElement.addEventListener('click', async (event) => {
                        event.preventDefault();
                        event.stopPropagation();

                        // Handle different button actions
                        if (button.action === 'NAVIGATE_TO_APPOINTMENT_BOOKING') {
                            // Check if user wants conversational booking or direct navigation
                            const userMessage = this.lastUserMessage || '';
                            if (userMessage.toLowerCase().includes('book appointment') ||
                                userMessage.toLowerCase().includes('appointment book') ||
                                userMessage.toLowerCase().includes('need appointment') ||
                                userMessage.toLowerCase().includes('want appointment')) {
                                // Use conversational booking for explicit appointment requests
                                await this.handleConversationalBooking(button);
                            } else {
                                // Use direct navigation for other cases (like general help buttons)
                                this.handleButtonClick(button);
                            }
                        } else {
                            this.handleButtonClick(button);
                        }
                    });

                    return buttonElement;
                }
                

                // REPLACE this method *inside* the SmartSehatSaharaChatbot class
async handleConversationalBooking(button) {
    try {
        console.log('Starting conversational booking...');

        // Show loading state
        const originalText = button.text;
        // --- MODIFIED ---
        button.text = getText('processing'); // Re-using this key
        // --- END MODIFIED ---
        button.disabled = true;

        const response = await fetch(`${API_BASE_URL}/v1/conversational-booking`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: user.patientId,
                action: 'start'
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (data.success) {
            // Display the AI response
            this.displayMessage(data.response, 'bot');

            // Show interactive buttons if provided
            if (data.interactive_buttons && data.interactive_buttons.length > 0) {
                this.showInteractiveButtons(data.interactive_buttons);
            }

            // Handle different conversational booking actions
            if (data.action === 'SELECT_DOCTOR_TYPE') {
                this.currentBookingStep = 'select_doctor_type';
                this.bookingContext = {};
            }
        } else {
            // --- MODIFIED ---
            this.displayMessage(getText('chatbot_connect_error'), 'bot'); // Re-using this key
            // --- END MODIFIED ---
        }

    } catch (error) {
        console.error('Conversational booking error:', error);
        // --- MODIFIED ---
        this.displayMessage(getText('chatbot_connect_error'), 'bot'); // Re-using this key
        // --- END MODIFIED ---
    } finally {
        // Reset button state
        button.text = originalText;
        button.disabled = false;
    }
}
                // In patient.html, inside the SmartSehatSaharaChatbot class



                clearButtons() {
                    const existingButtons = document.querySelector('.interactive-buttons-container');
                    if (existingButtons) {
                        existingButtons.remove();
                    }
                    this.currentButtons = [];
                    // Scroll to bottom after clearing buttons
                    if (this.chatWindow) {
                        this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
                    }
                }

                // REPLACE this method *inside* the SmartSehatSaharaChatbot class
displayMessage(message, sender = 'bot') {
    // Ensure the chat window element exists
    if (!this.chatWindow) return;

    // Create the message bubble element
    const messageElement = document.createElement('div');

    // Apply base and sender-specific CSS classes
    // Using classList.add is slightly more robust than setting className directly
    messageElement.classList.add('chat-message');
    messageElement.classList.add(sender === 'user' ? 'user-message' : 'bot-message');

    // Apply special styling for guidance messages (only if message is a string)
    if (sender === 'bot' && typeof message === 'string' && message.includes('ðŸ’¡')) {
        messageElement.style.background = 'linear-gradient(135deg, #e3f2fd, #f8f9fa)';
        messageElement.style.border = '1px solid #0d9488';
        messageElement.style.borderRadius = '12px';
        messageElement.style.padding = '16px';
        messageElement.style.margin = '12px 0';
    }

    // --- Type Checking and Content Setting ---
    // Check if 'message' is actually a string before trying string operations
    if (typeof message === 'string') {
        // If it's a string and contains newlines, use innerHTML to render line breaks
        if (message.includes('\n')) {
            messageElement.innerHTML = message.replace(/\n/g, '<br>');
        } else {
            // Otherwise, use textContent for safety (prevents HTML injection)
            messageElement.textContent = message;
        }
    }
    // --- Fallback for Non-String Types ---
    else {
        // If 'message' is not a string (e.g., an object due to an error), display it as JSON
        messageElement.textContent = JSON.stringify(message);
        // Log a warning to the console to help with debugging
        console.warn("displayMessage received non-string content:", message);
    }
    // --- End Type Checking ---
    
    // --- START: Add Speaker Icon for Bot Messages ---
if (sender === 'bot') {
    messageElement.style.position = 'relative'; // Ensure relative positioning for absolute icon
    messageElement.style.paddingRight = '30px'; // Add space for the icon

    const speakButton = document.createElement('button');
    speakButton.innerHTML = 'ðŸ”Š';
    speakButton.className = 'speak-button'; // Add class for event delegation
    // --- MODIFIED ---
    speakButton.setAttribute('aria-label', getText('chatbot_placeholder')); // Re-using a key
    // --- END MODIFIED ---
    speakButton.style.cssText = `
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: none;
        border: none;
        font-size: 1rem;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s;
    `;

    // Store the text to be spoken directly on the button's dataset
    // Use the already determined text content (handles strings vs objects)
    speakButton.dataset.textToSpeak = messageElement.textContent; // <<< Use textContent here

    speakButton.addEventListener('mouseenter', () => speakButton.style.opacity = '1');
    speakButton.addEventListener('mouseleave', () => speakButton.style.opacity = '0.6');

    // Click handler will be added via event delegation later (in the next snippet)
    messageElement.appendChild(speakButton);

    // Adjust icon position for guidance messages if needed
        if (typeof message === 'string' && message.includes('ðŸ’¡')) {
        speakButton.style.bottom = '10px';
        speakButton.style.right = '10px';
        }
}
// --- END: Add Speaker Icon --
    // Add the new message bubble to the chat window
    this.chatWindow.appendChild(messageElement);

    // --- Improved Scrolling ---
    // Use setTimeout to ensure scrolling happens *after* the browser has rendered the new message
    setTimeout(() => {
        // Check if chatWindow still exists before trying to scroll (prevents errors if element is removed)
        if (this.chatWindow) {
            // Scroll to the bottom of the chat window
            this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
        }
    }, 50); // A small delay (e.g., 50ms) is usually sufficient
    // --- End Improved Scrolling ---
}

                // REPLACE this method *inside* the SmartSehatSaharaChatbot class
async handleAction(action, parameters) {
    switch (action) {
        case 'Maps_TO_APPOINTMENT_BOOKING':
            // Don't redirect immediately - show button instead
            console.log('Appointment booking intent detected - showing button');
            break;
        case 'TRIGGER_SOS':
            // --- MODIFIED ---
            this.displayMessage(`ðŸš¨ ${getText('sos_activated_title')}! Calling 108...`, 'bot'); // Re-using key
            // --- END MODIFIED ---
            setTimeout(() => {
                window.location.href = 'tel:108';
            }, 2000);
            break;
        case 'CONTINUE_FOLLOWUP':
            // Check if post-appointment follow-up is needed
            await this.checkPostAppointmentFollowup();
            break;
        case 'SHOW_PRESCRIPTION_SUMMARY':
            // Don't redirect immediately - show button instead
            console.log('Prescription inquiry detected - showing button');
            break;
    }
}

                // REPLACE this method *inside* the SmartSehatSaharaChatbot class
async checkPostAppointmentFollowup() {
    try {
        const response = await fetch(`${API_BASE_URL}/v1/user-progress`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: user.patientId })
        });

        const data = await response.json();
        if (data.followup && data.followup.needed) {
            // --- MODIFIED ---
            // This string is not in your translations object.
            // To translate, add a key like 'follow_up_msg' and use getText('follow_up_msg')
            this.displayMessage('How are you feeling after your appointment?', 'bot');
            // --- END MODIFIED ---
        }
    } catch (error) {
        console.error('Follow-up check error:', error);
    }
}

                // REPLACE this method *inside* the SmartSehatSaharaChatbot class
showGeneralHelpButtons() {
    // --- MODIFIED ---
    const generalButtons = [
        {
            type: 'medicine_scan',
            text: `ðŸ“· ${getText('scan_medicine')}`,
            action: 'START_MEDICINE_SCANNER',
            style: 'secondary'
        },
        {
            type: 'prescription_upload',
            text: `ðŸ“¤ ${getText('upload_prescription_btn')}`,
            action: 'UPLOAD_PRESCRIPTION',
            style: 'secondary'
        },
        {
            type: 'prescription_view',
            text: `ðŸ“‹ ${getText('view_prescription')}`,
            action: 'SHOW_PRESCRIPTION_SUMMARY',
            style: 'secondary'
        }
    ];

    this.showInteractiveButtons(generalButtons);
    // This string is not in your translations object.
    // To translate, add a key like 'general_help_msg' and use getText('general_help_msg')
    this.displayMessage('ðŸ’¡ Here are the main features I can help you with:', 'bot');
    // --- END MODIFIED ---
}
                showAppointmentGuidance() {
                    const guidanceDiv = document.createElement('div');
                    guidanceDiv.className = 'guidance-message';
                    guidanceDiv.style.cssText = `
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 1rem;
                        border-radius: 12px;
                        margin: 0.5rem 0;
                        border-left: 4px solid #047857;
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    `;
                    guidanceDiv.innerHTML = `
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">ðŸ“… How to Book an Appointment</h4>
                        <ol style="margin: 0; padding-left: 1.2rem; line-height: 1.6;">
                            <li>Select doctor type (General Physician, Cardiologist, etc.)</li>
                            <li>Choose your preferred doctor from the list</li>
                            <li>Pick a convenient date and time slot</li>
                            <li>Select consultation mode (Video/Audio/In-person)</li>
                            <li>Confirm your booking and get confirmation</li>
                        </ol>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                            ðŸ’¡ You can also say "book cardiologist" for specific specialists!
                        </p>
                    `;
                    this.chatWindow.appendChild(guidanceDiv);
                    this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
                }


                showMedicineScanGuidance() {
                    const guidanceDiv = document.createElement('div');
                    guidanceDiv.className = 'guidance-message';
                    guidanceDiv.style.cssText = `
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 1rem;
                        border-radius: 12px;
                        margin: 0.5rem 0;
                        border-left: 4px solid #047857;
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    `;
                    guidanceDiv.innerHTML = `
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">ðŸ“· How to Scan Medicine</h4>
                        <ol style="margin: 0; padding-left: 1.2rem; line-height: 1.6;">
                            <li>Allow camera access when prompted</li>
                            <li>Point camera at medicine packaging or pill</li>
                            <li>Hold steady for 2-3 seconds while AI analyzes</li>
                            <li>Get medicine name, dosage, and usage info</li>
                            <li>Find nearby pharmacies that stock it</li>
                        </ol>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                            ðŸ’¡ Works with any medicine packaging, tablets, or capsules!
                        </p>
                    `;
                    this.chatWindow.appendChild(guidanceDiv);
                    this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
                }


                showPrescriptionGuidance() {
                    const guidanceDiv = document.createElement('div');
                    guidanceDiv.className = 'guidance-message';
                    guidanceDiv.style.cssText = `
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 1rem;
                        border-radius: 12px;
                        margin: 0.5rem 0;
                        border-left: 4px solid #047857;
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    `;
                    guidanceDiv.innerHTML = `
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">ðŸ“‹ How to Upload/View Prescriptions</h4>
                        <ol style="margin: 0; padding-left: 1.2rem; line-height: 1.6;">
                            <li>Take a clear photo of your prescription</li>
                            <li>Upload the image using the camera button</li>
                            <li>AI will extract medicine details automatically</li>
                            <li>Set up automatic medicine reminders</li>
                            <li>Track your medication schedule</li>
                        </ol>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                            ðŸ’¡ Both doctor prescriptions and your uploads are stored securely!
                        </p>
                    `;
                    this.chatWindow.appendChild(guidanceDiv);
                    this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
                }


                showEmergencyGuidance() {
                    this.displayMessage('ðŸš¨ **EMERGENCY DETECTED!**\n\n**Immediate action being taken:**\nâ€¢ ðŸ“ž Calling emergency services (108)\nâ€¢ ðŸ¥ Connecting you to medical help\nâ€¢ â±ï¸ Help is on the way!\n\n**What to do now:**\nâ€¢ Stay calm and stay on the line\nâ€¢ Tell them your location and condition\nâ€¢ Follow their instructions\n\n*Calling 108 in 1 second...*', 'bot');
                }
            }

            // Initialize enhanced chatbot
            const enhancedChatbot = new SmartSehatSaharaChatbot();

            

            // --- FIX START ---
            // The addMessage function is moved here, to a higher scope, so the event listener can find it.
            const chatWindow = document.getElementById('chatWindow');
            const addMessage = (text, sender) => {
                const msgEl = document.createElement('div');
                msgEl.classList.add('chat-message', `${sender}-message`);
                msgEl.textContent = text;
                chatWindow.appendChild(msgEl);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            };
            
            function handleBotResponse(data) {
                // This function is called by BOTH text and voice inputs
                
                // Check if the backend sent audio data
                if (data.audioData) {
                    // Play the Bhashini audio
                    const audio = new Audio('data:audio/wav;base64,' + data.audioData);
                    audio.play().catch(e => console.error("Audio play failed:", e));
                }
                
                // Remove "Processing..." message if it exists
                const userMessages = chatWindow.querySelectorAll('.user-message');
                const lastUserMessage = userMessages[userMessages.length - 1];
                if (lastUserMessage && lastUserMessage.textContent.includes("... (Processing voice input) ...")) {
                    if (data.transcribed_text) {
                        // If we got the transcription, replace the text
                        lastUserMessage.textContent = data.transcribed_text;
                    } else {
                        // Otherwise, just remove it (fallback)
                        lastUserMessage.remove(); 
                    }
                }

                // Display the (translated) text response
                enhancedChatbot.handleChatbotResponse(data);
            }

            function setupChatbot() {
                
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatWindow = document.getElementById('chatWindow');
    const recordButton = document.getElementById('record-button');
    
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let originalPlaceholder = chatInput.placeholder; // Store the default placeholder

    // --- 1. NEW MediaRecorder LOGIC ---
    recordButton.addEventListener('click', () => {
        if (isRecording) {
            // --- STOP RECORDING ---
            mediaRecorder.stop();
            isRecording = false;
           // --- MODIFIED: Show processing state & reset UI ---
            recordButton.textContent = 'âš™ï¸';
            recordButton.disabled = true;
            chatInput.disabled = true; // Keep input disabled
            recordButton.classList.remove('recording-active'); // Remove red color
            chatInput.placeholder = originalPlaceholder; // Restore placeholder
            // --- END MODIFICATION ---
        } else {
            // --- START RECORDING ---
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' }); 
                    mediaRecorder.start();
                    isRecording = true;
                    audioChunks = []; // Clear old chunks
                    recordButton.textContent = 'â– ';
                    recordButton.classList.add('recording-active'); // Make button red
                    originalPlaceholder = chatInput.placeholder; // Save original placeholder
                    chatInput.placeholder = getText('chatbot_record_hint'); // Show "listening"
                    
                    // --- THIS IS THE FIX ---
                    // The button MUST remain enabled so you can click it to stop.
                    recordButton.disabled = false; 
                    // --- END OF FIX ---

                    chatInput.disabled = true;

                    mediaRecorder.addEventListener("dataavailable", event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener("stop", () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        sendVoiceToBackend(audioBlob);
                        
                        // Stop all audio tracks to turn off mic light
                        stream.getTracks().forEach(track => track.stop());
                    });
                })
                .catch(err => {
                    console.error("Microphone error:", err);
                    alert("Microphone access denied. Please allow microphone access in your browser settings.");
                    recordButton.textContent = 'ðŸŽ¤';
                    recordButton.disabled = false;
                    chatInput.disabled = false;
                    chatInput.placeholder = originalPlaceholder; // Restore placeholder
                    recordButton.classList.remove('recording-active'); // Just in case
                });
        }
    });
                
                // --- 2. NEW FUNCTION TO SEND VOICE TO BACKEND ---
                // --- 2. REPLACE your old 'sendVoiceToBackend' function with this ---
                async function sendVoiceToBackend(audioBlob) {
        // --- MODIFIED ---
        addMessage(getText('chatbot_processing_voice'), 'user');
        // --- END MODIFIED ---

        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        formData.append('userId', user.patientId);
        formData.append('language', currentLanguage);

        const typingIndicator = document.createElement('div');
        typingIndicator.classList.add('chat-message', 'bot-message');
        // --- MODIFIED ---
        typingIndicator.textContent = getText('chatbot_typing');
        // --- END MODIFIED ---
        chatWindow.appendChild(typingIndicator);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        try {
            const response = await fetch(`${API_BASE_URL}/v1/voice-input`, {
                method: 'POST',
                body: formData 
            });

            if (!response.ok) {
                // This will be caught by the catch block below
                throw new Error(`HTTP Error: ${response.status}`); 
            }

            const data = await response.json();
            handleBotResponse(data); 

        } catch (error) {
            console.error('Voice Chat Error:', error); // This is line 3593
            // --- MODIFIED ---
            addMessage(getText('chatbot_voice_error'), 'bot');
            // --- END MODIFIED ---
        
        } finally {
            // This 'finally' block runs *no matter what* (after try OR catch)
            // This fixes your 'removeChild' bug.
            if (chatWindow.contains(typingIndicator)) {
                chatWindow.removeChild(typingIndicator); // This removes the indicator
            }
            // Re-enable buttons after processing
            // --- MODIFIED: Reset icon and re-enable buttons ---
            recordButton.textContent = 'ðŸŽ¤';
            recordButton.disabled = false;
            chatInput.disabled = false;
        }
    }

    // --- 3. MODIFIED TEXT SUBMIT LISTENER ---
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userInput = chatInput.value.trim();
        if (!userInput) return;

        enhancedChatbot.lastUserMessage = userInput;
        addMessage(userInput, 'user');
        chatInput.value = '';

        const typingIndicator = document.createElement('div');
        typingIndicator.classList.add('chat-message', 'bot-message');
        // --- MODIFIED ---
        typingIndicator.textContent = getText('chatbot_typing');
        // --- END MODIFIED ---
        chatWindow.appendChild(typingIndicator);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        try {
            // Your SOS check logic is preserved
            const sosCheck = await checkForEmergency(userInput);
            if (sosCheck.emergency_detected) {
                chatWindow.removeChild(typingIndicator);
                // (Your SOS UI logic here...)
                const sosAlert = document.createElement('div');
                sosAlert.className = 'sos-alert';
                sosAlert.innerHTML = `
                    <h3>ðŸš¨ ${getText('sos_title')}</h3> 
                    <p>${sosCheck.response}</p>
                    <p><strong>Emergency Number: 108</strong></p>
                `; // Partially translated
                chatWindow.appendChild(sosAlert);
                if (sosCheck.critical && sosCheck.parameters.auto_dial) {
                    setTimeout(() => {
                        window.location.href = `tel:${sosCheck.parameters.emergency_number}`;
                    }, 3000);
                }
                chatWindow.scrollTop = chatWindow.scrollHeight;
                chatInput.value = '';
                return;
            }

            // Your original predict call, now with 'language' added
            const response = await fetch(`${API_BASE_URL}/v1/predict`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: userInput,
                    userId: user.patientId,
                    language: currentLanguage 
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }

            const data = await response.json();
            handleBotResponse(data);

        } catch (error) {
            console.error('Text Chat Error:', error);
            chatWindow.removeChild(typingIndicator);
            // --- MODIFIED ---
            addMessage(getText('chatbot_connect_error'), 'bot');
            // --- END MODIFIED ---
        }
    });
    
    // --- 4. Your existing initial messages ---
    // --- MODIFIED ---
    addMessage(getText('chatbot_welcome'), "bot");
    // --- END MODIFIED ---
    checkMedicineReminders();
    testPrescriptionEndpoint();
}

            

            
// --- START: Agora Variables ---
const AGORA_APP_ID = "5ce1cf67c1f142478e0f3ed61cb8958f"; // Use the SAME App ID

let agoraClient = null;
let localAudioTrack = null;
let localVideoTrack = null;
let remoteUser = null;
let currentChannelName = null;
let isAgoraAudioMuted = false; // Separate state for Agora mute
let isAgoraVideoMuted = false; // Separate state for Agora mute
// --- END: Agora Variables ---

// --- START: Agora Functions ---

// Initialize Agora Client
// REPLACE your old 'initializeAgoraClient' function with this:
function initializeAgoraClient() {
    agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

    // Event listener for when a remote user publishes tracks
    agoraClient.on("user-published", async (user, mediaType) => {
        await agoraClient.subscribe(user, mediaType);
        console.log("Subscribed to remote user:", user.uid, "MediaType:", mediaType);
        remoteUser = user; // Store the remote user

        if (mediaType === "video") {
            const remoteVideoTrack = user.videoTrack;
            const remoteVideoPlayer = document.getElementById("remoteVideo");
            remoteVideoPlayer.textContent = ""; // Clear any previous placeholder
            remoteVideoTrack.play("remoteVideo");
            // --- MODIFIED ---
            showConnectionStatus(getText('call_doctor_connected'), 'success');
            // --- END MODIFIED ---
        }

        if (mediaType === "audio") {
            const remoteAudioTrack = user.audioTrack;
            remoteAudioTrack.play();
        }
    });

    // Event listener for when a remote user unpublishes tracks
    agoraClient.on("user-unpublished", (user, mediaType) => {
        console.log("Remote user unpublished:", user.uid, "MediaType:", mediaType);
        if (mediaType === "video") {
            // Optionally clear the video element or show a placeholder
            const remoteVideoPlayer = document.getElementById("remoteVideo");
            // --- MODIFIED ---
            remoteVideoPlayer.innerHTML = `<p>${getText('call_doctor_left')}</p>`; // Using this key as it's similar
            // --- END MODIFIED ---
        }
    });

    // Event listener for when a remote user leaves
    agoraClient.on("user-left", (user) => {
        console.log("Remote user left:", user.uid);
        remoteUser = null;
        const remoteVideoPlayer = document.getElementById("remoteVideo");
        // --- MODIFIED ---
        remoteVideoPlayer.innerHTML = `<p>${getText('call_doctor_left')}</p>`;
        showConnectionStatus(getText('call_doctor_left'), 'warning');
        // --- END MODIFIED ---
        // Optionally end the call for the doctor too, or wait
    });

    // Handle network quality reports (optional)
    agoraClient.on("network-quality", (stats) => {
         console.log("Downlink network quality:", stats.downlinkNetworkQuality);
         console.log("Uplink network quality:", stats.uplinkNetworkQuality);
    });

     // Handle connection state changes
    agoraClient.on("connection-state-change", (curState, prevState, reason) => {
        console.log(`Agora Connection State Change: ${prevState} -> ${curState}, Reason: ${reason}`);
        if (curState === "DISCONNECTED" && reason !== "UID_BANNED" && reason !== "CHANNEL_BANNED") {
             // Handle temporary disconnections (e.g., network issues)
             // --- MODIFIED ---
             showConnectionStatus(getText('call_connecting'), 'warning'); // Re-using a generic key
             // --- END MODIFIED ---
        } else if (curState === "CONNECTED") {
             // --- MODIFIED ---
             showConnectionStatus(getText('call_status_connecting'), 'success'); // Re-using a generic key
             document.getElementById('startCallBtn').textContent = getText('call_connecting'); // Re-using a generic key
             // --- END MODIFIED ---
             document.getElementById('startCallBtn').disabled = true; // Disable after joining
        } else if (curState === "FAILED") {
             // --- MODIFIED ---
             showConnectionStatus(getText('call_token_error'), 'error'); // Re-using a generic key
             // --- END MODIFIED ---
             leaveCall(); // Clean up on failure
        }
    });

}
// Add this helper function somewhere accessible in your script
// REPLACE your old 'fetchAgoraToken' function with this:
async function fetchAgoraToken(channelName) {
    try {
        console.log(`Requesting Agora token for channel: ${channelName}`);
        const response = await fetch(`${API_BASE_URL}/v1/agora/token`, { // Use your API_BASE_URL
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            // *** IMPORTANT: Tells fetch to send cookies (like your session cookie) ***
            credentials: 'include',
            body: JSON.stringify({
                channelName: channelName
                // uid: 0 // Optional: Backend defaults to 0 if not sent
            })
        });

        if (!response.ok) {
            // Try to get error message from backend
            let errorMsg = `Server error: ${response.status}`;
            try {
                 const errorData = await response.json();
                 errorMsg = errorData.error || errorMsg;
            } catch(jsonError) { /* Ignore if response not JSON */ }
            throw new Error(errorMsg);
        }

        const data = await response.json();

        if (data.success && data.token) {
            console.log("Successfully received Agora token.");
            return data.token;
        } else {
            throw new Error(data.error || 'Backend failed to provide a token.');
        }

    } catch (error) {
        console.error('Error fetching Agora token:', error);
        // --- MODIFIED ---
        showConnectionStatus(getText('call_token_error'), 'error'); // Show error to user
        // --- END MODIFIED ---
        return null; // Indicate failure
    }
}

// REPLACE your old 'joinAndPublish' function with this:
async function joinAndPublish(channelName, token) {
    if (!agoraClient) {
        console.error("Agora client not initialized.");
        return;
    }
    currentChannelName = channelName;

    try {
        // --- MODIFIED ---
        showConnectionStatus(getText('call_status_connecting'), 'info');
        // --- END MODIFIED ---
        // Join the channel - Using UID 0 allows Agora to assign one automatically
        const uid = await agoraClient.join(AGORA_APP_ID, channelName, token, null);
        console.log("Successfully joined channel:", channelName, "with UID:", uid);

        // Create microphone and camera tracks
       // Create microphone and camera tracks explicitly
        // --- MODIFIED ---
        showConnectionStatus(getText('call_status_access_mic'), 'info');
        // --- END MODIFIED ---
        localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();

        // --- MODIFIED ---
        showConnectionStatus(getText('call_status_access_cam'), 'info');
        // --- END MODIFIED ---
        try {
            localVideoTrack = await AgoraRTC.createCameraVideoTrack({
                // encoderConfig: "480p_1", // Optional: Specify resolution like 480p, 720p etc.
                facingMode: "user" // Request the front camera
            });
        } catch (cameraError) {
            console.error("Failed to get front camera:", cameraError);
            // --- MODIFIED ---
            showConnectionStatus(getText('call_status_cam_error'), 'warning');
            // --- END MODIFIED ---
            // Fallback to default camera if front camera fails
            try {
                localVideoTrack = await AgoraRTC.createCameraVideoTrack({ /* encoderConfig: "480p_1" */ });
            } catch (fallbackError) {
                console.error("Failed to get any camera:", fallbackError);
                // --- MODIFIED ---
                showConnectionStatus(getText('call_status_cam_fail'), 'error');
                // --- END MODIFIED ---
                // Handle the case where no camera is available (e.g., disable video features)
                // You might want to call leaveCall() or show an error message.
                leaveCall(); // Example: End call attempt if camera fails critically
                return; // Stop further execution in joinAndPublish
            }
        }

        // Play local video
        const localVideoPlayer = document.getElementById("localVideo");
        localVideoPlayer.textContent = ""; // Clear placeholder
        localVideoTrack.play("localVideo");
        console.log("Local video playing.");

        // Publish local tracks
        // --- MODIFIED ---
        showConnectionStatus(getText('call_status_publishing'), 'info');
        // --- END MODIFIED ---
        await agoraClient.publish([localAudioTrack, localVideoTrack]);
        console.log("Local tracks published successfully.");
        // --- MODIFIED ---
        showConnectionStatus(getText('call_status_waiting_doctor'), 'success');
        // --- END MODIFIED ---


    } catch (error) {
        console.error("Failed to join/publish:", error);
        showConnectionStatus(`Error: ${error.message}`, 'error');
        leaveCall(); // Clean up on error
    }
}
// REPLACE your old 'toggleAgoraAudio' function with this:
function toggleAgoraAudio() {
    console.log("toggleAgoraAudio called. localAudioTrack:", localAudioTrack); // Add log
    if (localAudioTrack) {
        isAgoraAudioMuted = !isAgoraAudioMuted;
        localAudioTrack.setEnabled(!isAgoraAudioMuted); // Enable/disable the track
        // --- MODIFIED ---
        document.getElementById('muteAudioBtn').textContent = isAgoraAudioMuted ? getText('unmute_audio') : getText('mute_audio');
        // --- END MODIFIED ---
        console.log(`Agora Audio ${isAgoraAudioMuted ? 'Muted' : 'Unmuted'}`);
    } else {
        console.warn("Cannot toggle audio: localAudioTrack is not available."); // Add warning
    }
}

// REPLACE your old 'toggleAgoraVideo' function with this:
function toggleAgoraVideo() {
    console.log("toggleAgoraVideo called. localVideoTrack:", localVideoTrack); // Add log
    if (localVideoTrack) {
        isAgoraVideoMuted = !isAgoraVideoMuted;
        localVideoTrack.setEnabled(!isAgoraVideoMuted); // Enable/disable the track
        // --- MODIFIED ---
        document.getElementById('muteVideoBtn').textContent = isAgoraVideoMuted ? getText('unmute_video') : getText('mute_video');
        // --- END MODIFIED ---
        document.getElementById('localVideo').style.display = isAgoraVideoMuted ? 'none' : 'block';
        console.log(`Agora Video ${isAgoraVideoMuted ? 'Muted' : 'Unmuted'}`);
    } else {
        console.warn("Cannot toggle video: localVideoTrack is not available."); // Add warning
    }
}

// Leave Agora Channel and Clean Up
// REPLACE your old 'leaveCall' function with this:
async function leaveCall() {
    console.log("Leaving call...");
    // --- MODIFIED ---
    showConnectionStatus(getText('call_ended'), 'info'); // Re-using this key
    // --- END MODIFIED ---
    currentChannelName = null;
    remoteUser = null;

    // Stop and close local tracks
    if (localAudioTrack) {
        localAudioTrack.stop();
        localAudioTrack.close();
        localAudioTrack = null;
    }
    if (localVideoTrack) {
        localVideoTrack.stop();
        localVideoTrack.close();
        localVideoTrack = null;
    }

    // Leave the Agora channel
    if (agoraClient) {
        try {
            await agoraClient.leave();
            console.log("Left Agora channel successfully.");
        } catch (error) {
             console.error("Error leaving Agora channel:", error);
        }
        // Optional: Destroy the client instance if completely done
        agoraClient = null;
    }

    // Reset UI
    document.getElementById('localVideo').innerHTML = ''; // Clear local video
    // --- MODIFIED ---
    document.getElementById('remoteVideo').innerHTML = `<p>${getText('call_ended')}</p>`; // Clear remote video
    document.getElementById('startCallBtn').textContent = getText('start_call');
    // --- END MODIFIED ---
    document.getElementById('startCallBtn').disabled = false;
    // --- Reset Mute Buttons ---
    // --- MODIFIED ---
    document.getElementById('muteAudioBtn').textContent = getText('mute_audio');
    document.getElementById('muteVideoBtn').textContent = getText('mute_video');
    // --- END MODIFIED ---
    isAgoraAudioMuted = false;
    isAgoraVideoMuted = false;
    // --- End Reset Mute Buttons ---
    hideConnectionStatus();
    document.getElementById('callScreen').classList.remove('active'); // Hide the call screen overlay
    showScreen('appointmentsScreen'); // Go back to dashboard after ending call
    await generateAppointments();
}

// --- END: Agora Functions ---

// In patient.html, INSIDE the <script> block
//doctorName
// Corrected showCallScreen function
// REPLACE your old 'showCallScreen' function with this:
function showCallScreen(doctorName, appointmentId) { // <<< Use doctorName here
    currentAppointmentId = appointmentId;
    currentChannelName = appointmentId;

    const headerElement = document.getElementById('callWithDoctor');
    // --- MODIFIED ---
    if (headerElement) headerElement.textContent = getText('call_with', { name: doctorName }); // <<< Use doctorName here
    // --- END MODIFIED ---

    const callScreenElement = document.getElementById('callScreen');
    if (callScreenElement) callScreenElement.classList.add('active');

    // Clear video elements and hide status
    const localVideoPlayer = document.getElementById('localVideo');
    const remoteVideoPlayer = document.getElementById('remoteVideo');
    if (localVideoPlayer) localVideoPlayer.innerHTML = '';
    // --- MODIFIED ---
    if (remoteVideoPlayer) remoteVideoPlayer.innerHTML = `<p>${getText('call_waiting')}</p>`;
    // --- END MODIFIED ---
    hideConnectionStatus();

    // Initialize Agora Client if needed (or if disconnected)
    // Using agoraClient = null in leaveCall makes this check reliable
    if (!agoraClient || agoraClient.connectionState === 'DISCONNECTED') {
        console.log("Initializing Agora Client for new call...");
        initializeAgoraClient();
    } else {
        console.log("Agora Client already exists, state:", agoraClient.connectionState);
        // Even if client exists but wasn't fully cleaned up, ensure button is ready
    }

    // *** CRITICAL CHANGE: Ensure Start Button is ready ***
    const startBtn = document.getElementById('startCallBtn');
    if (startBtn) {
        // --- MODIFIED ---
        startBtn.textContent = getText('start_call'); // Set text correctly
        // --- END MODIFIED ---
        startBtn.disabled = false;         // Ensure it's enabled
    } else {
        console.error("Start Call button not found!");
    }

    // *** REMOVED THE AUTOMATIC CALL TO joinAndPublish ***
    // console.log(`Attempting to join channel: ${appointmentId}`); // No longer joining here
    // joinAndPublish(appointmentId, TEMP_TOKEN); // <--- REMOVED THIS LINE
}




// Helper to play remote video robustly



// UI Status Functions (showConnectionStatus, hideConnectionStatus, etc.) - Keep these as they are

function showConnectionStatus(message, type = 'info') {
    const statusDiv = document.getElementById('connectionStatus');
    const statusText = document.getElementById('statusText');
    if (statusDiv && statusText) {
        statusText.textContent = message;
        let bgColor = 'rgba(0, 0, 0, 0.1)';
        let color = 'inherit';
        if (type === 'success') { bgColor = 'rgba(34, 197, 94, 0.2)'; color = '#16a34a'; }
        else if (type === 'error') { bgColor = 'rgba(239, 68, 68, 0.2)'; color = '#ef4444'; }
        else if (type === 'warning') { bgColor = 'rgba(245, 158, 11, 0.2)'; color = '#f59e0b'; }
        statusDiv.style.background = bgColor;
        statusDiv.style.color = color;
        statusDiv.style.display = 'block';
    }
}

function hideConnectionStatus() {
    const statusDiv = document.getElementById('connectionStatus');
    if (statusDiv) statusDiv.style.display = 'none';
}






function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (message && dataChannel && dataChannel.readyState === 'open') {
        try {
            dataChannel.send(message);
            displayMessage(message, 'patient'); // Display own message
            input.value = '';
        } catch (error) {
             console.error("Error sending data channel message:", error);
             // Optionally inform user message failed to send
        }
    } else {
         console.warn("Cannot send message. Data channel not ready or no message.");
    }
}

// Display messages in the call screen chat
function displayMessage(message, sender) {
    const messagesDiv = document.getElementById('messages');
    if(messagesDiv){
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`; // Use CSS classes 'patient' or 'doctor'
        messageDiv.textContent = message;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to bottom
    }
}



            

            // REPLACE your old 'loadDashboard' function with this:
async function loadDashboard() {
    try {
        // --- CORRECTED CODE ---
        // Switched from 'credentials: include' to the reliable userId parameter
        const response = await fetch(`${API_BASE_URL}/v1/dashboard?userId=${user.patientId}`);
        // --- END OF CORRECTION ---

        const data = await response.json();
        if (data.success) {
            // Update next appointment
            const nextApptCard = document.querySelector('.dashboard-grid .info-card');
            if (nextApptCard) {
                const highlight = nextApptCard.querySelector('.highlight');
                const doctorP = nextApptCard.querySelector('p:last-child');
                if (data.nextAppointment) {
                    const date = new Date(data.nextAppointment.dateTime);
                    highlight.textContent = date.toLocaleDateString() + ', ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                    doctorP.textContent = data.nextAppointment.doctorName;
                } else {
                    // --- MODIFIED ---
                    highlight.textContent = getText('no_upcoming_appts');
                    doctorP.textContent = getText('no_upcoming_appts_subtitle');
                    // --- END MODIFIED ---
                }
            }
            // Update prescription count
            const prescCard = document.getElementById('viewAllPrescriptions');
            if (prescCard) {
                const highlight = prescCard.querySelector('.highlight');
                highlight.textContent = data.prescriptionCount + ' Total';
            // This populates the local records from the server
            if (data.healthRecords) {
                appData.records = data.healthRecords;
                generateTimeline(); // NOW we render the timeline, *after* data is loaded
            }
            // --- END OF FIX ---
            }
        }
    } catch (e) {
        console.error('Failed to load dashboard:', e);
    }
}

      


            async function checkMedicineReminders() {
        try {
            console.log("checkMedicineReminders: Fetching reminders for user:", user.patientId); // Log start
            const response = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: user.patientId,
                    action: 'get'
                })
            });

            // --- START: Add Detailed Logging ---
            if (!response.ok) {
                console.error("checkMedicineReminders: Fetch failed with status:", response.status);
                const errorText = await response.text();
                console.error("checkMedicineReminders: Error response body:", errorText);
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            console.log("checkMedicineReminders: Received data:", data); // Log the full response

            if (data.success) {
                // Log the arrays directly before passing them
                console.log("checkMedicineReminders: Reminders array:", data.reminders);
                console.log("checkMedicineReminders: Alerts array:", data.pending_alerts);
                updateRemindersDisplay(data.reminders || [], data.pending_alerts || []); // Ensure arrays are passed
            } else {
                console.error("checkMedicineReminders: Backend indicated failure:", data.message || "Unknown error");
            }
            // --- END: Add Detailed Logging ---

        } catch (error) {
            // Log the specific error
            console.error('checkMedicineReminders: Caught error during fetch/processing:', error);
        }
    }

            // REPLACE your old 'updateRemindersDisplay' function with this:
function updateRemindersDisplay(reminders, alerts) {
    // (This logic for the homepage card remains the same)
    console.log("updateRemindersDisplay: Received reminders count:", reminders ? reminders.length : 'N/A');
    console.log("updateRemindersDisplay: Received alerts count:", alerts ? alerts.length : 'N/A');

    const pendingEl = document.getElementById('pendingReminders');
    console.log("updateRemindersDisplay: Found pendingEl:", pendingEl);

    if (pendingEl) {
        const totalActiveReminders = reminders ? reminders.length : 0;
        console.log("updateRemindersDisplay: Setting text content to:", `${totalActiveReminders} Total Active`);
        // --- MODIFIED ---
        // Using 'pending_reminders' key which is what the element ID 'pendingReminders' suggests
        // Your hi object has: pending_reminders: "{count} à¤ªà¥‡à¤‚à¤¡à¤¿à¤‚à¤—"
        // If you want "Total Active", you should update your translation key
        pendingEl.textContent = getText('pending_reminders', { count: totalActiveReminders });
        // --- END MODIFIED ---
    } else {
        console.error("updateRemindersDisplay: Could not find element with ID 'pendingReminders'");
    }

    // --- THIS IS THE MODIFICATION ---
    // Instead of showing alerts in chat, show the popup modal.
    if (alerts && alerts.length > 0) {
            console.log("updateRemindersDisplay: Showing missed reminder modal");
        showMissedReminderModal(alerts); // Call the new modal function
    } else {
            console.log("updateRemindersDisplay: No pending alerts to show in modal.");
    }
    // --- END MODIFICATION ---
}

            // This new function shows the popup modal
            // REPLACE your old 'showMissedReminderModal' function with this:
function showMissedReminderModal(alerts) {
    const modal = document.getElementById('missedReminderModal');
    const listContainer = document.getElementById('missedReminderList');
    if (!modal || !listContainer) return;

    // Build the HTML for all missed reminders
    // --- MODIFIED ---
    listContainer.innerHTML = alerts.map(alert => `
        <div class="reminder-item" id="modal-alert-${alert.medicine_name.replace(/[^a-zA-Z0-9]/g, '-')}">
            <div class="reminder-info">
                <strong>${alert.medicine_name}</strong> (${alert.dosage})
                <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Scheduled for: ${alert.time}</p>
            </div>
            <div class="reminder-actions">
                <button class="btn-taken" onclick="markMedicineTaken('${alert.medicine_name}', true)">${getText('mark_as_taken')}</button>
                <button class="btn-skip" onclick="skipMedicine('${alert.medicine_name}', true)">${getText('skip_this_time')}</button>
            </div>
        </div>
    `).join('');
    // --- END MODIFIED ---

    // Add listener to the main close button
    document.getElementById('closeMissedReminderModal').onclick = () => {
        modal.classList.remove('active');
    };
    
    // Show the modal
    modal.classList.add('active');
}

            

            

            async function loadPrescriptionReminders() {
                try {
                    console.log('Loading prescription reminders for user:', user.patientId);
                    // Get user's prescription summary
                    const response = await fetch(`${API_BASE_URL}/v1/prescription-summary`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.patientId
                        })
                    });

                    console.log('Prescription summary response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('Prescription summary data:', data);

                    if (data.success && data.prescription_summary.medications) {
                        showPrescriptionBasedReminders(data.prescription_summary);
                    }
                } catch (error) {
                    console.error('Load prescription reminders error:', error);
                }
            }

            // REPLACE your old 'showAllPrescriptionSources' function with this:
function showAllPrescriptionSources() {
    const chatWindow = document.getElementById('chatWindow');
    if (!chatWindow) return;

    // Show prescription sources summary
    const sourcesDiv = document.createElement('div');
    sourcesDiv.className = 'medicine-reminder-card card';
    // --- MODIFIED ---
    // This function contains a lot of hard-coded text not in your translations object.
    // I have translated the title only.
    sourcesDiv.innerHTML = `
        <h4>ðŸ“‹ ${getText('prescriptions_title')}</h4> 
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
            <div style="background: rgba(0,123,255,0.1); padding: 1rem; border-radius: 8px;">
                <h5 style="color: #007bff; margin: 0 0 0.5rem 0;">ðŸ‘¨â€âš•ï¸ Doctor Prescriptions</h5>
                <p style="margin: 0; font-size: 0.9rem;">From completed appointments</p>
                <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;">Auto-generates medicine reminders</p>
            </div>
            <div style="background: rgba(255,193,7,0.1); padding: 1rem; border-radius: 8px;">
                <h5 style="color: #ffc107; margin: 0 0 0.5rem 0;">ðŸ“± Patient Uploads</h5>
                <p style="margin: 0; font-size: 0.9rem;">Scanned prescription images</p>
                <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;">AI extracts medicine details</p>
            </div>
        </div>
        <p style="font-size: 0.9rem; opacity: 0.8; text-align: center;">
            ðŸ’¡ Both sources automatically create medicine reminders for better health compliance.
        </p>
    `;
    // --- END MODIFIED ---
    chatWindow.appendChild(sourcesDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
}
            // REPLACE your old 'displaySummaryInChat' function with this:
function displaySummaryInChat(summaryText) {
    if (!summaryText) {
        console.log('No summary text provided to display.');
        return;
    }
    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow) {
        const summaryCard = document.createElement('div');
        summaryCard.className = 'card';
        summaryCard.style.cssText = `
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; 
            margin: 0.5rem 0;
        `;
        // --- MODIFIED ---
        summaryCard.innerHTML = `
            <h4>ðŸ“‹ ${getText('prescriptions_title')}</h4>
            <p style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.5rem;">
                ${summaryText.replace(/\n/g, '<br>')}
            </p>`;
        // --- END MODIFIED ---
        chatWindow.appendChild(summaryCard);
        // Scroll to the bottom to make it visible
        setTimeout(() => { chatWindow.scrollTop = chatWindow.scrollHeight; }, 50);
    }
}

            async function testPrescriptionEndpoint() {
                try {
                    console.log('Testing prescription endpoint...');
                    const response = await fetch(`${API_BASE_URL}/v1/test-prescription`, {
                        method: 'GET'
                    });

                    console.log('Test endpoint response status:', response.status);

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Test endpoint working:', data);
                    } else {
                        console.error('Test endpoint failed:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('Test endpoint error:', error);
                }
            }


            



            function showPrescriptionBasedReminders(prescriptionData) {
                const chatWindow = document.getElementById('chatWindow');
                if (!chatWindow) return;

                const medications = prescriptionData.medications;
                if (medications && medications.length > 0) {
                    const reminderDiv = document.createElement('div');
                    reminderDiv.className = 'medicine-reminder-card card';
                    reminderDiv.innerHTML = `
                        <h4>ðŸ’Š Prescription-Based Medicine Reminders</h4>
                        <p><strong>Doctor:</strong> ${prescriptionData.doctor_name || 'Doctor'}</p>
                        <p><strong>Medications Found:</strong> ${medications.length}</p>
                        <div style="margin-top: 1rem;">
                            ${medications.map(med => `
                                <div class="reminder-item">
                                    <div class="reminder-info">
                                        <strong>${med.name}</strong> - ${med.dosage || 'As prescribed'}
                                        <br><small>${med.frequency || 'Timing not specified'}</small>
                                    </div>
                                    <div class="reminder-actions">
                                        <button class="btn-taken" onclick="createReminderFromPrescription('${med.name}', '${med.dosage || ''}', '${med.frequency || ''}')">Set Reminder</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
                            ðŸ’¡ These reminders are auto-generated from your prescriptions. Click "Set Reminder" to schedule daily alerts.
                        </p>
                    `;
                    chatWindow.appendChild(reminderDiv);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }

            

            

            // Enhanced SOS Detection in Chatbot
            async function checkForEmergency(message) {
                try {
                    const response = await fetch(`${API_BASE_URL}/v1/enhanced-sos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.patientId,
                            message: message,
                            language: currentLanguage
                        })
                    });

                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('SOS detection error:', error);
                    return { emergency_detected: false };
                }
            }

            // Function to load and display medicine reminders in the dedicated screen
            // REPLACE your old 'loadMedicineRemindersScreen' function with this:
async function loadMedicineRemindersScreen() {
    try {
        const response = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: user.patientId,
                action: 'get'
            })
        });

        const data = await response.json();
        const container = document.getElementById('remindersContainer');

        if (data.success && data.reminders && data.reminders.length > 0) {
            // --- MODIFIED ---
            container.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">${getText('active_reminders')}</h3>
                    <p style="color: var(--text-color-secondary);">${getText('reminders_scheduled', { count: data.total_reminders })}</p>
                </div>
                ${data.reminders.map(reminder => `
                    <div class="medicine-card card">
                        <div class="medicine-name">${reminder.medicine_name}</div>
                        ${reminder.source === 'prescription_upload' ?
                `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin-bottom: 1rem; display: inline-block; font-weight: 500;">
                    Generated from Prescription
                </span>`
                : ''}
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                            <div>
                                <strong>${getText('dosage')}:</strong> ${reminder.dosage}<br>
                                <strong>${getText('frequency')}:</strong> ${reminder.frequency}<br>
                                <strong>${getText('duration')}:</strong> ${reminder.duration_days} days
                            </div>
                            <div>
                                <strong>${getText('times')}:</strong><br>
                                ${reminder.times.map(time => `<span style="display: inline-block; background: var(--primary-color); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; margin: 0.125rem; font-size: 0.8rem;">${time}</span>`).join('')}
                            </div>
                        </div>
                        ${reminder.instructions ? `<div style="margin-bottom: 1rem;"><strong>${getText('instructions')}:</strong> ${reminder.instructions}</div>` : ''}
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="markMedicineTaken('${reminder.medicine_name}')">${getText('mark_as_taken')}</button>
                            <button class="btn" onclick="editReminder('${reminder.medicine_name}')" style="background: var(--color-secondary);">${getText('edit')}</button>
                            <button class="btn" onclick="deleteReminder('${reminder.medicine_name}')" style="background: #ef4444; color: white;">${getText('delete')}</button>
                        </div>
                    </div>
                `).join('')}
            `;
            // --- END MODIFIED ---
        } else {
            // --- MODIFIED ---
            container.innerHTML = `
                <div class="card" style="text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ’Š</div>
                    <h3>${getText('no_reminders_title')}</h3>
                    <p style="color: var(--text-color-secondary); margin-bottom: 2rem;">${getText('no_reminders_subtitle')}</p>
                </div>
            `;
            // --- END MODIFIED ---
        }

        
    } catch (error) {
        console.error('Load medicine reminders screen error:', error);
        const container = document.getElementById('remindersContainer');
        // --- MODIFIED ---
        container.innerHTML = `
            <div class="card" style="text-align: center; padding: 3rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div>
                <h3>${getText('reminder_error_title')}</h3>
                <p style="color: var(--text-color-secondary);">${getText('reminder_delete_failed_msg')}</p> 
                <button class="btn btn-primary" onclick="loadMedicineRemindersScreen()">${getText('reschedule')}</button> 
            </div>
        `; // Re-using 'reschedule' as 'Retry'
        // --- END MODIFIED ---
    }
}


            // Function to edit a medicine reminder
           // --- START: FULLY FUNCTIONAL REMINDER BLOCK ---

            // Global variable to track the original name of the reminder being edited
            let currentlyEditing = null;

            // Make functions globally accessible for onclick attributes
            // Add a new parameter 'fromModal'
            // REPLACE your old 'window.markMedicineTaken' function with this:
window.markMedicineTaken = async function(medicineName, fromModal = false) {
    try {
        const response = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: user.patientId,
                action: 'update_adherence',
                medicine_name: medicineName,
                taken_time: new Date().toTimeString().slice(0, 5)
            })
        });

        if (response.ok) {
            // Hide the card from the chat window (if it's there)
            const safeName = medicineName.replace(/[^a-zA-Z0-9]/g, '-');
            const chatCard = document.getElementById(`alert-card-${safeName}`);
            if (chatCard) chatCard.style.display = 'none';

            // --- START: NEW MODAL LOGIC ---
            if (fromModal) {
                // Hide just this item from the modal list
                const modalItem = document.getElementById(`modal-alert-${safeName}`);
                if (modalItem) modalItem.style.display = 'none';
                
                // Check if all items are hidden, if so, close the modal
                const modal = document.getElementById('missedReminderModal');
                if (modal.querySelectorAll('.reminder-item[style*="display: none"]').length === modal.querySelectorAll('.reminder-item').length) {
                    modal.classList.remove('active');
                }
            }
            // --- END: NEW MODAL LOGIC ---

            await loadMedicineRemindersScreen(); // Refresh dedicated page
            // --- MODIFIED ---
            showConfirmationModal(getText('reminder_success_title'), getText('reminder_taken_msg', { name: medicineName }));
            // --- END MODIFIED ---
        }
    } catch (error) {
        console.error('Mark medicine taken error:', error);
    }
}

            // --- ADD THIS ENTIRE NEW FUNCTION ---
            // Add a new parameter 'fromModal'
            // REPLACE your old 'window.skipMedicine' function with this:
window.skipMedicine = async function(medicineName, fromModal = false) {
    try {
        const response = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: user.patientId,
                action: 'skip_alert',
                medicine_name: medicineName
            })
        });
        
        if (response.ok) {
            // Hide the card from the chat window (if it's there)
            const safeName = medicineName.replace(/[^a-zA-Z0-9]/g, '-');
            const chatCard = document.getElementById(`alert-card-${safeName}`);
            if (chatCard) chatCard.style.display = 'none';

            // --- START: NEW MODAL LOGIC ---
            if (fromModal) {
                // Hide just this item from the modal list
                const modalItem = document.getElementById(`modal-alert-${safeName}`);
                if (modalItem) modalItem.style.display = 'none';

                // Check if all items are hidden, if so, close the modal
                const modal = document.getElementById('missedReminderModal');
                if (modal.querySelectorAll('.reminder-item[style*="display: none"]').length === modal.querySelectorAll('.reminder-item').length) {
                    modal.classList.remove('active');
                }
            }
            // --- END: NEW MODAL LOGIC ---
            
            console.log(`Skipped alert for ${medicineName}`);
        } else {
            // --- MODIFIED ---
            showConfirmationModal(getText('reminder_error_title'), getText('reminder_delete_failed_msg')); // Re-using failed delete msg
            // --- END MODIFIED ---
        }
    } catch (error) {
        console.error('Skip medicine error:', error);
    }
}
            // --- END NEW FUNCTION ---

            // REPLACE your old 'window.deleteReminder' function with this:
window.deleteReminder = async function(medicineName) {
    // --- MODIFIED ---
    if (!confirm(getText('reminder_delete_confirm', { name: medicineName }))) {
    // --- END MODIFIED ---
        return;
    }
    try {
        const response = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: user.patientId,
                action: 'delete',
                medicine_name: medicineName
            })
        });
        if (response.ok) {
            // --- MODIFIED ---
            showConfirmationModal(getText('reminder_deleted_title'), getText('reminder_deleted_msg', { name: medicineName }));
            // --- END MODIFIED ---
            await loadMedicineRemindersScreen(); // Refresh the display
        }
    } catch (error) {
        console.error('Delete reminder error:', error);
        // --- MODIFIED ---
        showConfirmationModal(getText('reminder_error_title'), getText('reminder_delete_failed_msg'));
        // --- END MODIFIED ---
    }
}

            // ENHANCED editReminder function
            // REPLACE your old 'window.editReminder' function with this:
window.editReminder = async function(medicineName) {
    const remindersResponse = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: user.patientId, action: 'get' })
    });
    const data = await remindersResponse.json();
    const reminderData = data.reminders.find(r => r.medicine_name === medicineName);

    if (reminderData) {
        // --- NEW: Pre-fill the form with existing data ---
        document.getElementById('medicineName').value = reminderData.medicine_name;
        document.getElementById('medicineDosage').value = reminderData.dosage;
        document.getElementById('medicineTimes').value = reminderData.times.join(', ');
        document.getElementById('medicineDuration').value = reminderData.duration_days;
        document.getElementById('medicineInstructions').value = reminderData.instructions;

        // --- NEW: Track which item is being edited and change button text ---
        currentlyEditing = reminderData.medicine_name; // Store original name
        // --- MODIFIED ---
        document.getElementById('saveReminderBtn').textContent = getText('update_reminder');
        document.querySelector('#medicineReminderModal h3').textContent = getText('update_reminder_title'); // Also update title
        // --- END MODIFIED ---
        document.getElementById('medicineReminderModal').classList.add('active');
    } else {
        // --- MODIFIED ---
        showConfirmationModal(getText('reminder_error_title'), getText('reminder_load_error_msg'));
        // --- END MODIFIED ---
    }
}
            
            // REPLACE your old 'saveMedicineReminder' function with this:
async function saveMedicineReminder() {
    const isEdit = currentlyEditing !== null;
    const action = isEdit ? 'update' : 'add';
    const medicineName = document.getElementById('medicineName').value.trim();
    const dosage = document.getElementById('medicineDosage').value.trim();
    const times = document.getElementById('medicineTimes').value.trim();
    const duration = document.getElementById('medicineDuration').value;
    const instructions = document.getElementById('medicineInstructions').value.trim();
    const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

    if (!medicineName || !dosage || !times) {
        alert('Please fill in all required fields'); // Left as-is, as it's a developer-facing validation
        return;
    }

    let payload = {
        userId: user.patientId,
        action: action,
        medicine_data: {
            name: medicineName,
            dosage: dosage,
            // Ensure times are correctly parsed into an array
            times: times.split(',').map(t => t.trim()).filter(t => t), // Filter empty strings
            duration_days: parseInt(duration) || 30, // Default duration if not provided
            instructions: instructions,
            timezone: userTimezone
        }
    };

    if (isEdit) {
        payload.original_medicine_name = currentlyEditing;
    }

    // --- Show loading state ---
    const saveBtn = document.getElementById('saveReminderBtn');
    const originalBtnText = saveBtn.textContent;
    // --- MODIFIED ---
    saveBtn.textContent = getText('processing'); // Re-using this key
    // --- END MODIFIED ---
    saveBtn.disabled = true;

    try {
        console.log("Sending reminder save request:", payload); // Log payload
        const response = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        console.log("Reminder save response status:", response.status); // Log status

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: 'Failed to save reminder' }));
            throw new Error(errorData.message || `HTTP ${response.status}`);
        }

        // --- START: Reordered Refresh Logic ---
        // 1. Close modal and reset form
        document.getElementById('medicineReminderModal').classList.remove('active');
        document.getElementById('medicineReminderForm').reset();
        currentlyEditing = null; // Reset edit state

        // 2. Show confirmation to the user
        // --- MODIFIED ---
        const messageKey = isEdit ? 'reminder_updated_msg' : 'reminder_added_msg';
        showConfirmationModal(getText('reminder_success_title'), getText(messageKey));
        // --- END MODIFIED ---

        // 3. *After* showing confirmation, refresh the data and UI
        console.log("Reminder saved, now refreshing UI...");
        await loadMedicineRemindersScreen(); // Refresh the dedicated reminder screen
        await checkMedicineReminders(); // Refresh homepage counter and chat alerts

        // --- END: Reordered Refresh Logic ---


    } catch (error) {
        console.error('Save reminder error:', error);
        // --- MODIFIED ---
        alert(`${getText('reminder_error_title')}: ${error.message}. ${getText('reminder_delete_failed_msg')}`); // Re-using failed delete msg
        // --- END MODIFIED ---
    } finally {
        // --- Reset button state ---
        saveBtn.textContent = originalBtnText; // Restore original text
        saveBtn.disabled = false;
        // Ensure the button text resets correctly
        // --- MODIFIED ---
        document.getElementById('saveReminderBtn').textContent = getText('save_reminder');
        document.querySelector('#medicineReminderModal h3').textContent = getText('add_reminder_title'); // Also reset title
        // --- END MODIFIED ---
    }
}
        function urlB64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // REPLACE your old 'subscribeUser' function with this:
async function subscribeUser() {
    try {
        // 1. Get the VAPID key from the server
        const response = await fetch(`${API_BASE_URL}/v1/vapid-public-key`);
        const data = await response.json();
        const applicationServerKey = urlB64ToUint8Array(data.publicKey);

        // 2. Check for *any* existing subscription in the browser
        let subscription = await navigator.serviceWorker.ready.then(reg => reg.pushManager.getSubscription());
        
        // At this point, 'subscription' is guaranteed to be null (or was never granted permission)

        // 3. Ask for permission (only if it was never granted or was denied)
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            // --- MODIFIED ---
            // Left this alert as-is, as it's a complex, one-time system message.
            // You can add a key like 'push_required_msg' to your object if you want to translate this.
            alert('Push notifications are required for reminders. Please enable them in your browser settings.');
            // --- END MODIFIED ---
            return;
        }
        
        // 4. Create the new, guaranteed-valid subscription
        subscription = await navigator.serviceWorker.ready.then(reg =>
            reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: applicationServerKey
            })
        );
        console.log('New, clean subscription created successfully.');


        // 5. Send the new subscription to the backend
        await fetch(`${API_BASE_URL}/v1/subscribe`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: user.patientId, subscription: subscription })
        });

        console.log('User subscribed successfully and synced with backend.');
        document.getElementById('notification-banner').style.display = 'none';

    } catch (error) {
        console.error('Failed to subscribe or sync user:', error);
    }
}
        
        function setupNotificationBanner() {
            const banner = document.getElementById('notification-banner');
            const enableBtn = document.getElementById('enable-notifications-btn');
            const dismissBtn = document.getElementById('dismiss-banner-btn');

            if (Notification.permission === 'granted') {
                banner.style.display = 'none';
                subscribeUser(); // --- ADD THIS LINE ---
                return;
            }
            
            banner.style.display = 'block';
            enableBtn.onclick = subscribeUser;
            dismissBtn.onclick = () => banner.style.display = 'none';
        }


            
            // --- END: FULLY FUNCTIONAL REMINDER BLOCK ---
            // New function to handle page load
            function loadAndDisplaySummary() {
                fetch(`${API_BASE_URL}/v1/prescription-summary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.patientId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.formatted_response) {
                        displaySummaryInChat(data.formatted_response);
                    }
                })
                .catch(error => console.error('Error fetching summary on page load:', error));
            }



            

            async function initializeApp() {
                // 1. Check Authentication (Essential First Step)
                const isAuthenticated = await checkAuth(); // <-- ADD 'await'
                if (!isAuthenticated) return; // Stop if not logged in

                // 2. Setup Service Worker & Push Notifications (Can run early)
                if ('serviceWorker' in navigator && 'PushManager' in window) {
                    try {
                        await navigator.serviceWorker.register('/sw.js');
                        console.log('Service Worker registered successfully');
                        // Setup the banner logic (doesn't block other tasks)
                        setupNotificationBanner();
                        // Attempt to subscribe/resubscribe (runs in background)
                        subscribeUser();
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                    }
                } else {
                     console.warn('Push notifications are not supported in this browser.');
                }

                // 3. Load Core Data (Necessary for many UI elements)
                await loadDoctors();       // Fetch doctor list
                await loadBookingData();   // Fetch booking categories, slots etc.

                // 4. Setup Basic UI Elements (Theme, Language, Static Nav)
                updateUIText();            // Apply initial language translations
                setupNavigation();
  // Replace your old popstate listener with this
// Replace your old popstate listener with this
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.screen) {
        // State exists, so just update the view to match the state
        updateView(event.state.screen);
    }
    // NO ELSE BLOCK. This allows the browser to go back to index.html
    // when event.state is null.
});       // Make nav buttons clickable
                setupThemeAndLanguage();  
                // --- ADD THIS BLOCK TO SET THE DROPDOWN TEXT ON LOAD ---
                const initialLangText = document.querySelector(`.language-option[data-lang="${currentLanguage}"]`);
                if (initialLangText) {
                    document.getElementById('selectedLanguage').textContent = initialLangText.textContent;
                } // Setup theme/language toggles

                // 5. Render Initial Screen Content (Depends on Core Data)
                       // Render health records timeline
                await generateAppointments(); // Fetch and render appointments list (also updates homepage 'Next Appt')
                await generateAllPrescriptions(); // Fetch and render prescriptions list
                await loadDashboard();     // Fetch specific dashboard stats (like prescription count)
                await loadChatHistory();   // Fetch past chat messages
                // --- WITH THIS LINE ---
                await loadOrderHistory();  // Fetch and render past medicine orders    // Render past medicine orders list
                loadAndDisplaySummary();   // Fetch latest prescription summary for chat
                renderBookingStep(1);      // Setup the first step of the booking screen

                // 6. Setup Interactive Components & Modals
                setupModalsAndActions();   // Add event listeners for modals, SOS, logout etc.
                setupScanMedicine();       // Initialize camera logic for medicine scan
                setupBookMedicine();       // Initialize UI logic for booking medicine
                setupUploadPrescription(); // Initialize camera logic for prescription upload
                setupChatbot();
                
                // Initialize chatbot, loads initial message & checks reminders ONCE
                // Add this listener during initialization (e.g., inside initializeApp or setupFormsAndModals)

// Modify the #startCallBtn listener (inside initializeApp or setupFormsAndModals)
const startCallButton = document.getElementById('startCallBtn');
if (startCallButton) {
    startCallButton.addEventListener('click', async () => { // Make the listener async
        if (currentChannelName) {
            console.log(`Start Call button clicked. Attempting join for channel: ${currentChannelName}`);
            startCallButton.textContent = 'Connecting...'; // Update text
            startCallButton.disabled = true;

            // --- Fetch the token ---
            const token = await fetchAgoraToken(currentChannelName);

            if (token) {
                // --- Join only if token was successfully fetched ---
                joinAndPublish(currentChannelName, token); // Use the fetched token
            } else {
                // Token fetch failed, reset the button
                showConnectionStatus("Failed to get call token. Please try again.", "error");
                startCallButton.textContent = 'Start Call';
                startCallButton.disabled = false;
            }

        } else {
            console.error("Cannot start call, channel name (appointmentId) is missing.");
            showConnectionStatus("Error: Appointment ID missing.", "error");
            startCallButton.textContent = 'Start Call'; // Reset button if context is missing
            startCallButton.disabled = false;
        }
    });
} else {
    console.error("Could not find the Start Call button element!");
}

                // 7. Perform Final Checks and UI Refreshes (Run AFTER main UI is rendered)
                console.log("initializeApp: Performing final reminder check...");
                await checkMedicineReminders(); // <<< Explicitly refresh reminder count AFTER dashboard etc.

                await checkPostAppointmentFollowup(); // Check if follow-up message is needed in chat

                // Optionally add interval here for periodic checks later if desired
                // setInterval(checkMedicineReminders, 60 * 1000);
                // console.log("Started periodic reminder check.");

                // Load reminders screen content IF that screen is the active one on load
                if (document.getElementById('medicineRemindersScreen').classList.contains('active')) {
                    await loadMedicineRemindersScreen();
                }

                console.log("initializeApp: Initialization complete.");
                // Add these 3 lines at the VERY END of your initializeApp function
const initialScreen = 'homeScreen';
history.replaceState({ screen: initialScreen }, '', '#' + initialScreen);
updateView(initialScreen); // Make sure the view matches this initial state
            }

            // Post-appointment follow-up check
            // REPLACE your old 'checkPostAppointmentFollowup' function with this:
async function checkPostAppointmentFollowup() {
    try {
        const response = await fetch(`${API_BASE_URL}/v1/user-progress`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: user.patientId })
        });

        const data = await response.json();
        if (data.followup && data.followup.needed) {
            // Show follow-up message in chat if chat is active
            const chatWindow = document.getElementById('chatWindow');
            if (chatWindow && chatWindow.children.length > 0) {
                const followupMessage = document.createElement('div');
                followupMessage.className = 'chat-message bot-message';
                // --- MODIFIED ---
                // This string 'How are you feeling...' is not in your object.
                // It should ideally come from the backend, but for now, we leave it hard-coded.
                // To translate, add a key like 'follow_up_msg' to your object and use getText('follow_up_msg')
                followupMessage.textContent = 'How are you feeling after your appointment?';
                // --- END MODIFIED ---
                chatWindow.appendChild(followupMessage);
            }
        }
    } catch (error) {
        console.error('Follow-up check error:', error);
    }
}

            initializeApp();

        });
    </script>
    <!-- Notification Banner for Push Reminders -->
<div id="notification-banner" class="card" style="display: none; position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 1001; width: 90%; max-width: 500px; background-color: var(--card-bg-color); backdrop-filter: blur(10px); padding: 1rem; text-align: center;">
    <p style="margin-bottom: 1rem;">Enable notifications to get medicine reminders even when the app is in the background.</p>
    <div style="display: flex; gap: 1rem; justify-content: center;">
        <button id="enable-notifications-btn" class="btn btn-primary">Enable Notifications</button>
        <button id="dismiss-banner-btn" class="btn">Dismiss</button>
    </div>
</div>
</body>
</html>