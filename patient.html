<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sehat Sahara - Patient Dashboard</title>
    <style>
        :root {
            --bg-color: rgba(245, 245, 245, 0.6);
            --card-bg-color: rgba(255, 255, 255, 0.7);
            --text-color: #0f172a;
            --text-color-secondary: #475569;
            --primary-color: #0d9488;
            --primary-color-light: #2dd4bf;
            --primary-color-dark: #14b8a6;
            --sos-color: #ef4444;
            --border-color: rgba(0, 0, 0, 0.07);
            --shadow-color: rgba(100, 116, 139, 0.1);
            /* --- MODIFIED: Removed Poppins font and used system fonts --- */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --color-secondary: #f1f5f9;
            --radius-lg: 16px;
            --radius-full: 9999px;
        }

        [data-theme="dark"] {
            --bg-color: rgba(20, 20, 30, 0.75);
            --card-bg-color: rgba(30, 41, 59, 0.6);
            --text-color: #e2e8f0;
            --text-color-secondary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.12);
            --primary-color: var(--primary-color-dark);
            --color-secondary: #334155;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        html { scroll-behavior: smooth; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: var(--font-family); 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            line-height: 1.6; 
            padding-bottom: 80px; /* Space for bottom nav */
            transition: background-color 0.3s, color 0.3s;
        }
        .main-container { position: relative; min-height: 100vh; width: 100vw; }
        .background-image { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-image: url('https://i.ibb.co/84XpXLXW/hero-pic.png'); 
            background-size: cover; background-position: center; 
            filter: blur(14px) brightness(0.9); 
            transform: scale(1.15); z-index: -1; 
            transition: filter 0.3s;
        }
        [data-theme="dark"] .background-image { filter: blur(14px) brightness(0.6); }

        .page-content { flex-grow: 1; padding: 1.5rem; max-width: 1200px; margin: 0 auto; width: 100%; padding-top: 110px; }
        
        /* Header */
        .header {
            position: fixed; top: 1rem; left: 50%; transform: translateX(-50%);
            width: calc(100% - 2rem); max-width: 1200px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem; z-index: 1000;
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            border-radius: 999px; /* Make header fully rounded */
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
        }
        .header .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin-left: 1rem; }
        .header .actions { display: flex; align-items: center; gap: 0.5rem; margin-right: 0.5rem; }
        
        .top-nav { display: none; align-items: center; gap: 0.5rem; }
        .top-nav a { 
            text-decoration: none; 
            color: var(--text-color-secondary); 
            font-weight: 500; 
            padding: 0.6rem 1.25rem;
            border-radius: 999px; 
            transition: all 0.25s ease;
            position: relative;
        }
        .top-nav a:hover {
            color: var(--text-color);
            background-color: rgba(128, 128, 128, 0.1);
        }
        .top-nav a.active { 
            color: var(--text-color); 
            background-color: rgba(128, 128, 128, 0.15); 
        }

        .btn { padding: 0.6rem 1.2rem; border-radius: 9999px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.25s ease; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.12); }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .btn-sos { background-color: var(--sos-color); color: white; }
        .btn-primary { background-color: var(--primary-color); color: white; border: 2px solid var(--primary-color); }
        
        .card { 
            background-color: var(--card-bg-color); border-radius: var(--radius-lg); 
            padding: 1.5rem; border: 1px solid var(--border-color); 
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); 
            box-shadow: 0 8px 32px 0 var(--shadow-color); transition: all 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px 0 var(--shadow-color); }

        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Home Screen */
        .welcome-card { background: linear-gradient(45deg, var(--primary-color), var(--primary-color-light)); color: white; margin-bottom: 2rem;}
        .welcome-card h1 { font-size: 2.25rem; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1.5rem;
        }
        .dashboard-grid > .info-card {
            grid-column: span 3;
        }
        .dashboard-grid > .tool-card {
            grid-column: span 2;
        }
        
        .info-card h3 { font-size: 1rem; }
        .info-card .highlight { font-size: 1.25rem; font-weight: 600; }

        .tool-card { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            text-align: center; 
            gap: 0.75rem; 
            cursor: pointer; 
            padding: 1.5rem 1rem; 
        }
        .tool-card .icon { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; }
        .tool-card h3 { font-size: 1rem; font-weight: 600; }
        .icon-report { background-image: linear-gradient(45deg, #64748b, #94a3b8); }

        /* Page Headers */
        .page-header { text-align: center; margin-bottom: 2.5rem; padding-top: 1rem; }
        .page-header h1 { font-size: 2.25rem; }

        /* Health Record */
        .timeline-item { position: relative; padding-left: 2.5rem; padding-bottom: 2rem; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-item::before { content: ''; position: absolute; left: 0.6rem; top: 0.25rem; width: 2px; height: 100%; background-color: var(--border-color); }
        .timeline-dot { position: absolute; left: 0; top: 0.25rem; width: 20px; height: 20px; border-radius: 50%; background-color: var(--primary-color); border: 4px solid var(--card-bg-color); }
        .timeline-date { font-size: 0.9rem; color: var(--text-color-secondary); }

        /* Appointments Screen */
        .appointments-section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary-color); }
        .appointment-card { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
        .appointment-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .appointment-card-doctor h4 { font-size: 1.25rem; font-weight: 600; }
        .appointment-card-doctor p { color: var(--text-color-secondary); font-size: 0.9rem; line-height: 1.2; }
        .appointment-card-tag { font-size: 0.8rem; font-weight: 500; padding: 0.25rem 0.75rem; border-radius: var(--radius-full); color: white; }
        .tag-video { background-color: #3b82f6; }
        .tag-audio { background-color: #16a34a; }
        .tag-offline { background-color: #64748b; }
        .appointment-card-footer { display: flex; justify-content: flex-end; gap: 0.75rem; }
        
        /* Booking Flow */
        .booking-step { display: none; margin-bottom: 1.5rem; }
        .booking-step.active { display: block; }
        .selection-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .selection-card { text-align: center; cursor: pointer; }
        .selection-card.selected { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.3); }
        .doctor-card img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 1rem; object-fit: cover; }
        
        .calendar-container { margin-bottom: 1.5rem; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; text-align: center; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-full); cursor: pointer; transition: all 0.2s ease; }
        .calendar-day.available:hover { background: var(--color-secondary); }
        .calendar-day.disabled { color: var(--text-color-secondary); opacity: 0.5; cursor: not-allowed; text-decoration: line-through;}
        .calendar-day.disabled:hover { transform: none; background: transparent;}
        .calendar-day.selected { background: var(--primary-color); color: white; transform: scale(1.1); }
        
        .time-slots-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.75rem; }
        .time-slot { text-align: center; padding: 0.75rem; background: var(--color-secondary); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .time-slot.selected, .time-slot:hover { background: var(--primary-color); color: white; transform: scale(1.05); }

        .booking-navigation { display: flex; justify-content: space-between; margin-top: 1.5rem; }
        .appointment-summary { margin-top: 1.5rem; }

        /* Scan Medicine Screen */
        .camera-container { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        #camera-feed { width: 100%; max-width: 500px; border-radius: var(--radius-lg); background: #333; aspect-ratio: 4 / 3; }

        /* Book Medicine Screen */
.pharmacy-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
.pharmacy-card { cursor: pointer; }
.pharmacy-card .info { margin-bottom: 1rem; }
.pharmacy-card .actions { display: flex; justify-content: space-between; align-items: center; }
.medicine-list { list-style: none; padding: 0; }
.medicine-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--color-secondary); border-radius: 8px; margin-bottom: 0.5rem;}
.medicine-card {
    background: var(--card-bg-color);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    position: relative;
    overflow: hidden;
}
.medicine-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--primary-color-light));
    opacity: 0;
    transition: opacity 0.3s ease;
}
.medicine-card:hover::before {
    opacity: 1;
}
.medicine-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: var(--primary-color-light);
}
.medicine-name {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}
.medicine-price {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 1rem;
}
.medicine-description {
    font-size: 0.9rem;
    color: var(--text-color-secondary);
    margin-bottom: 1rem;
    line-height: 1.4;
}
.quantity-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    justify-content: center;
}
.quantity-btn {
    width: 36px;
    height: 36px;
    border: 2px solid var(--border-color);
    background: var(--color-secondary);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1.1rem;
    transition: all 0.2s ease;
}
.quantity-btn:hover {
    background: var(--primary-color-light);
    border-color: var(--primary-color);
    color: white;
    transform: scale(1.05);
}
.quantity-btn:active {
    transform: scale(0.95);
}
.quantity-input {
    width: 70px;
    text-align: center;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 0.5rem;
    background: var(--color-secondary);
    font-size: 1rem;
    font-weight: 600;
    transition: border-color 0.2s ease;
}
.quantity-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
}
.category-card {
    cursor: pointer;
    text-align: center;
    padding: 1.5rem;
    transition: all 0.3s ease;
    border-radius: var(--radius-lg);
    background: var(--card-bg-color);
    border: 2px solid var(--border-color);
    position: relative;
}
.category-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: var(--primary-color-light);
}
.category-card.selected {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
    background: linear-gradient(135deg, rgba(13, 148, 136, 0.05), rgba(45, 212, 191, 0.05));
}
.category-card.selected::after {
    content: '✓';
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}
.category-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    font-weight: 600;
}
.category-card p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-color-secondary);
}
.checkout-step {
    display: none;
    animation: fadeIn 0.5s ease;
}
.checkout-step.active { display: block; }
.payment-option {
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: var(--radius-lg);
    border: 2px solid var(--border-color);
    background: var(--card-bg-color);
    padding: 1rem;
    margin-bottom: 0.5rem;
    position: relative;
}
.payment-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    border-color: var(--primary-color-light);
}
.payment-option.selected {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.2);
    background: linear-gradient(135deg, rgba(13, 148, 136, 0.05), rgba(45, 212, 191, 0.05));
}
.payment-option.selected::after {
    content: '✓';
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}
.payment-option input[type="radio"] {
    margin: 0;
    width: 18px;
    height: 18px;
    accent-color: var(--primary-color);
}
.payment-option label {
    cursor: pointer;
    margin-left: 0.5rem;
    font-weight: 500;
}
.cart-icon {
    position: fixed;
    top: 120px;
    right: 1rem;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-color-light));
    color: white;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(13, 148, 136, 0.3);
    z-index: 100;
    font-size: 1.3rem;
    transition: all 0.3s ease;
    border: 3px solid white;
}
.cart-icon:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 25px rgba(13, 148, 136, 0.4);
}
.cart-icon:active {
    transform: scale(0.95);
}
.cart-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 26px;
    height: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
    border: 2px solid white;
    animation: cartPulse 2s infinite;
}
@keyframes cartPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    transition: all 0.2s ease;
    background: var(--card-bg-color);
}
.cart-item:hover {
    background-color: rgba(13, 148, 136, 0.02);
    transform: translateX(4px);
}
.cart-item:last-child { border-bottom: none; }
.cart-item-info { flex: 1; }
.cart-item-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--text-color);
}
.cart-item-details {
    font-size: 0.9rem;
    color: var(--text-color-secondary);
    line-height: 1.3;
}
.cart-item-price {
    font-weight: 600;
    color: var(--primary-color);
    margin-top: 0.25rem;
}
.cart-item-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-direction: column;
}
.cart-quantity {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: var(--color-secondary);
    border-radius: 8px;
    padding: 0.25rem;
}
.cart-quantity-btn {
    width: 28px;
    height: 28px;
    border: 1px solid var(--border-color);
    background: var(--color-secondary);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}
.cart-quantity-btn:hover {
    background: var(--primary-color-light);
    color: white;
    transform: scale(1.1);
}
.cart-quantity-btn:active { transform: scale(0.9); }
.cart-remove-btn {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s ease;
    margin-top: 0.5rem;
}
.cart-remove-btn:hover {
    background: #dc2626;
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}
#medicineOrderingContainer { display: none; }

/* Tracking */
.tracking-step {
    position: relative;
    padding-left: 3rem;
    padding-bottom: 2rem;
    transition: all 0.3s ease;
}
.tracking-step:last-child { padding-bottom: 0; }
.tracking-step::before {
    content: '';
    position: absolute;
    left: 0.75rem;
    top: 1.5rem;
    width: 3px;
    height: calc(100% - 1.5rem);
    background-color: var(--border-color);
    border-radius: 2px;
}
.tracking-dot {
    position: absolute;
    left: 0;
    top: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: var(--color-secondary);
    border: 3px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.tracking-step.completed .tracking-dot {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
}
.tracking-step.completed::before { background-color: var(--primary-color); }
.tracking-step.current .tracking-dot {
    background-color: var(--primary-color-light);
    border-color: var(--primary-color);
    animation: pulse 2s infinite;
}
.tracking-content {
    background: var(--card-bg-color);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}
.tracking-content:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
.tracking-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}
.tracking-description {
    font-size: 0.9rem;
    color: var(--text-color-secondary);
    line-height: 1.4;
}
.tracking-timestamp {
    font-size: 0.8rem;
    color: var(--text-color-secondary);
    margin-top: 0.5rem;
    font-style: italic;
}

/* Payment Form Styles */
.payment-form {
    animation: fadeIn 0.3s ease;
}

.payment-form .form-group {
    margin-bottom: 1rem;
}

.payment-form .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-color);
}

.payment-form .form-control {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--card-bg-color);
    color: var(--text-color);
    font-size: 1rem;
    transition: all 0.3s ease;
}

.payment-form .form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
}

.payment-form .form-control::placeholder {
    color: var(--text-color-secondary);
    opacity: 0.7;
}

.card-preview {
    background: linear-gradient(135deg, #0d9488, #14b8a6);
    color: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-family: 'Courier New', monospace;
}

.card-preview .preview-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}


        /* Chatbot Screen */
        .chatbot-container { max-width: 800px; margin: auto; }
        .chat-window { height: 60vh; background-color: var(--color-secondary); border-radius: var(--radius-lg); padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; }
        .chat-message { padding: 0.75rem 1rem; border-radius: 12px; max-width: 75%; }
        .user-message { background-color: var(--primary-color); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .bot-message { background-color: white; color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-input { display: flex; gap: 0.5rem; }
        #chatInput { flex-grow: 1; }

        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; background-color: var(--card-bg-color); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); box-shadow: 0 -4px 20px var(--shadow-color); border-top: 1px solid var(--border-color); padding: 0.5rem 0; z-index: 1000; }
        .nav-button { background: none; border: none; cursor: pointer; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-color-secondary); padding: 0.5rem 0; transition: color 0.2s ease; }
        .nav-button.active { color: var(--primary-color); font-weight: 600; }
        .nav-button svg { width: 24px; height: 24px; }
        .nav-button span { font-size: 12px; }
        
        /* Language & Theme */
        .language-dropdown { position: relative; }
        .language-dropdown-toggle { cursor: pointer; background: transparent; border: none; color: var(--text-color-secondary); font-size: 1rem; padding: 8px; display: flex; align-items: center; border-radius: 999px; }
        .language-dropdown-menu { display: none; position: absolute; top: calc(100% + 8px); right: 0; min-width: 150px; border-radius: var(--radius-lg); padding: 8px; background: var(--card-bg-color); border: 1px solid var(--border-color); z-index: 1001; }
        .language-dropdown.open .language-dropdown-menu { display: block; }
        .language-option { display: block; padding: 8px 12px; color: var(--text-color-secondary); border-radius: 8px; cursor: pointer; }
        .theme-toggle { cursor: pointer; background-color: transparent; border: none; padding: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-color-secondary); }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg-color); border-radius: var(--radius-lg); padding: 2rem; text-align: center; max-width: 400px; width: 90%; }
        .modal-actions { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
        .prescription-content { text-align: left; }
        .prescription-content h3 { margin-bottom: 1rem; text-align: center; }
        .prescription-header { margin-bottom: 1.5rem; }
        .prescription-med-list { list-style: none; margin-bottom: 1.5rem; padding-left: 0; }
        .prescription-med-list li { background-color: var(--color-secondary); padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 0.5rem; }

        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control { width: 100%; padding: 0.85rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--color-secondary); }

        /* Call Screen */
        .call-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(13, 148, 136, 0.8), rgba(45, 212, 191, 0.8)); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; backdrop-filter: blur(10px); animation: fadeIn 0.3s ease; }
        .call-screen.active { display: flex; }
        .call-content { text-align: center; color: white; width: 100%; max-width: 1200px; }
        .call-content h1 { margin-bottom: 1rem; font-size: 2rem; }
        .video-container { display: flex; gap: 1rem; margin-bottom: 1rem; justify-content: center; flex-wrap: wrap; position: relative; }
        .video-wrapper { position: relative; }
        .video-element { width: 300px; height: 225px; background-color: #0f172a; border-radius: var(--radius-lg); object-fit: cover; }
        .local-video { width: 150px; height: 112px; position: absolute; bottom: 10px; right: 10px; border: 2px solid white; }
        .call-actions { display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem; }
        .message-section { background: rgba(255,255,255,0.1); border-radius: var(--radius-lg); padding: 1rem; width: 100%; max-width: 600px; }
        .messages { height: 150px; overflow-y: auto; margin-bottom: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 0.5rem; }
        .message { margin-bottom: 0.5rem; padding: 0.25rem; border-radius: 4px; }
        .message.patient { background: rgba(255,255,255,0.2); text-align: right; }
        .message.doctor { background: rgba(0,0,0,0.2); text-align: left; }
        .message-input { display: flex; gap: 0.5rem; }
        #messageInput { flex-grow: 1; padding: 0.5rem; border-radius: 8px; border: none; }

        /* Responsive */
        @media (min-width: 768px) {
            .bottom-nav { display: none; }
            .top-nav { display: flex; }
        }
        
        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .dashboard-grid > .info-card,
            .dashboard-grid > .tool-card {
                grid-column: auto; /* Reset column span to flow naturally */
            }
        }

        @media (max-width: 767px) {
            .header { position: static; transform: none; width: 100%; border-radius: 0; padding: 1rem; }
            .page-content { padding-top: 1rem; }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Enhanced Chatbot Features */
        .interactive-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .interactive-buttons-container button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .interactive-buttons-container button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .interactive-buttons-container button.loading {
            animation: pulse-loading 1.5s ease-in-out infinite;
            cursor: not-allowed;
        }

        @keyframes pulse-loading {
            0% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.95); }
            100% { opacity: 0.7; transform: scale(1); }
        }

        .interactive-buttons-container .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .interactive-buttons-container .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .interactive-buttons-container .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        /* Medicine Reminder Styles */
        .medicine-reminder-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 1rem;
        }

        .reminder-item {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reminder-info h4 {
            margin: 0;
            font-size: 1rem;
        }

        .reminder-info p {
            margin: 0.25rem 0 0 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .reminder-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-taken {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-skip {
            background-color: #ffc107;
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .sos-alert {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
    </style>
</head>
<body data-theme="light">
    <div class="main-container">
        <div class="background-image"></div>
        <header class="header">
            <div class="cart-icon" aria-label="Cart" role="button" title="View Cart">🛒
    <div class="cart-badge">0</div>
</div>
            <div class="logo">Sehat Sahara</div>
            <nav class="top-nav">
                <a href="#" class="active" data-key="home_nav" data-screen="homeScreen">Home</a>
                <a href="#" data-key="appointments_nav" data-screen="appointmentsScreen">Appointments</a>
                <a href="#" data-key="records_nav" data-screen="healthRecordScreen">Records</a>
                <a href="#" data-key="book_nav" data-screen="bookingScreen">Book</a>
                <a href="#" data-key="more_nav" data-screen="moreScreen">More</a>
            </nav>
            <div class="actions">
                 <div class="language-dropdown">
                    <button class="language-dropdown-toggle"><span id="selectedLanguage">English</span></button>
                    <div class="language-dropdown-menu"></div>
                </div>
                <button class="theme-toggle" id="themeToggle">
                    <!-- --- MODIFIED: Corrected viewBox --- -->
                    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                <button class="btn btn-sos" id="sosButton">SOS</button>
            </div>
        </header>
        <div class="page-content">
            <main class="main">
                <section id="homeScreen" class="screen active">
                     <div class="welcome-card card">
                        <h1 id="welcomeMessage" data-key="welcome_message">Welcome, Guest</h1>
                        <p data-key="welcome_subtitle">Your health dashboard is ready.</p>
                    </div>
                    <div class="dashboard-grid">
                        <div class="info-card card">
                            <h3 data-key="next_appointment">Next Appointment</h3>
                            <p class="highlight">Today, 4:30 PM</p>
                            <p>Anjali Verma</p>
                        </div>
                        <div id="viewAllPrescriptions" class="info-card card" style="cursor: pointer;">
                              <h3 style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                                      <div class="icon" style="background-image: linear-gradient(45deg, #64748b, #94a3b8); width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                              <ellipse cx="12" cy="12" rx="10" ry="5"></ellipse>
                                          </svg>
                                      </div>
                                      <span data-key="new_prescriptions">New Prescriptions</span>
                                  </div>
                                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                      <path d="M9 18l6-6-6-6"></path>
                                  </svg>
                              </h3>
                              <p class="highlight">3 Total</p>
                              <p data-key="from_last_visit">From past visits</p>
                          </div>
                          <div id="medicineReminders" class="info-card card" style="cursor: pointer;">
                              <h3 style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                                      <div class="icon" style="background-image: linear-gradient(45deg, #ff6b6b, #ee5a52); width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                              <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                                          </svg>
                                      </div>
                                      <span>Medicine Reminders</span>
                                  </div>
                                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                      <path d="M9 18l6-6-6-6"></path>
                                  </svg>
                              </h3>
                              <p class="highlight" id="pendingReminders">2 Pending</p>
                              <p>Don't forget your medicines</p>
                          </div>
                        <div data-screen="scanMedicineScreen" class="tool-card card">
                            <div class="icon" style="background-image: linear-gradient(45deg, #3b82f6, #60a5fa);">
                                <!-- --- MODIFIED: Corrected viewBox --- -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                            </div>
                            <h3 data-key="scan_medicine">Scan Medicine</h3>
                        </div>
                        <div data-screen="bookMedicineScreen" class="tool-card card">
                            <div class="icon" style="background-image: linear-gradient(45deg, #16a34a, #4ade80);">
                                <!-- --- MODIFIED: Corrected viewBox --- -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                            </div>
                            <h3 data-key="book_medicine">Book Medicine</h3>
                        </div>
                        <div data-screen="chatbotScreen" class="tool-card card">
                            <div class="icon" style="background-image: linear-gradient(45deg, #8b5cf6, #a78bfa);">
                                <!-- --- MODIFIED: Corrected viewBox --- -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                            </div>
                            <h3 data-key="health_chatbot">Health Chatbot</h3>
                        </div>
                    </div>
                     </section>
                <section id="appointmentsScreen" class="screen">
                    <div class="page-header"><h1 data-key="appointments_title">My Appointments</h1></div>
                    <div id="appointments-container"></div>
                </section>
                <section id="prescriptionsScreen" class="screen">
                     <div class="page-header"><h1 data-key="prescriptions_title">My Prescriptions</h1></div>
                     <button class="btn btn-primary" id="uploadPrescriptionBtn" style="margin-bottom: 1rem;">Upload Offline Prescription</button>
                     <div id="prescriptions-container"></div>
                 </section>
                 <section id="medicineRemindersScreen" class="screen">
                     <div class="page-header">
                         <h1>💊 Medicine Reminders</h1>
                         <button class="btn btn-primary" id="addReminderBtn" style="margin-top: 1rem;">Add New Reminder</button>
                     </div>
                     <div id="remindersContainer">
                         <!-- Medicine reminders will be loaded here -->
                     </div>
                 </section>
                <section id="healthRecordScreen" class="screen">
                    <div class="page-header"><h1 data-key="records_title">Digital Health Record</h1></div><div id="timeline-container"></div>
                </section>
                <section id="bookingScreen" class="screen">
                    <div class="page-header"><h1 data-key="book_title">Book a Consultation</h1></div>
                    <div id="bookingStep1" class="booking-step active">
                        <h3 data-key="book_step1">1. Select a Category</h3>
                        <div class="selection-grid" id="categoryGrid"></div>
                    </div>
                    <div id="bookingStep2" class="booking-step">
                        <h3 data-key="book_step2">2. Select a Doctor</h3>
                        <div class="selection-grid" id="doctorGrid"></div>
                    </div>
                    <div id="bookingStep3" class="booking-step">
                        <h3 data-key="book_step3">3. Select Date & Time</h3>
                        <div class="card calendar-container">
                            <div class="calendar-header">
                                <button class="btn" id="prevMonth">‹</button>
                                <h4 id="currentMonthYear"></h4>
                                <button class="btn" id="nextMonth">›</button>
                            </div>
                            <div class="calendar-grid">
                                <div style="font-weight: 600;">Sun</div><div style="font-weight: 600;">Mon</div><div style="font-weight: 600;">Tue</div><div style="font-weight: 600;">Wed</div><div style="font-weight: 600;">Thu</div><div style="font-weight: 600;">Fri</div><div style="font-weight: 600;">Sat</div>
                            </div>
                            <div class="calendar-grid" id="calendarDaysGrid"></div>
                        </div>
                        <div class="time-slots-grid" id="timeSlotsGrid"></div>
                    </div>
                    <div id="bookingStep4" class="booking-step">
                        <h3 data-key="book_step4">4. Select Consultation Mode</h3>
                        <div class="selection-grid" id="modeGrid"></div>
                    </div>
                    <div class="appointment-summary card" id="appointmentSummary" style="display:none;"></div>
                    <div class="booking-navigation">
                        <button class="btn" id="prevStep" disabled data-key="book_prev">Previous</button>
                    </div>
                </section>
                <section id="moreScreen" class="screen">
                    <div class="page-header"><h1 data-key="more_title">More Options</h1></div>
                    <div class="tool-card card" data-screen="reportIssueScreen"><div class="icon icon-report"><!-- --- MODIFIED: Corrected viewBox --- --><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div><h3 data-key="report_issue">Report an Issue</h3></div>
                    <button class="btn" id="logoutBtn" style="width: 100%; margin-top: 2rem; background-color: var(--text-color-secondary); color: white;" data-key="logout">Logout</button>
                </section>
                <section id="reportIssueScreen" class="screen">
                     <div class="page-header"><h1>Report an Issue</h1></div>
                     <form class="card" id="reportIssueForm">
                        <div class="form-group"><label for="report-type">Select Doctor/Pharmacy</label><select id="report-type" class="form-control"><option>Anjali Verma</option><option>Apollo Pharmacy</option></select></div>
                        <div class="form-group"><label for="report-reason">Reason</label><select id="report-reason" class="form-control"><option>Overcharged</option><option>Unprofessional</option><option>Wrong Medicine</option></select></div>
                        <div class="form-group"><label for="report-desc">Description</label><textarea id="report-desc" class="form-control" rows="3"></textarea></div>
                        <button type="submit" class="btn btn-primary" style="width:100%">Submit Report</button>
                    </form>
                </section>
                <section id="scanMedicineScreen" class="screen">
                    <div class="page-header"><h1 data-key="scan_medicine_title">Scan Medicine</h1></div>
                    <div class="card camera-container">
                        <video id="camera-feed" playsinline></video>
                        <p id="camera-status">Click "Open Camera" to start scanning</p>
                        <div style="display: flex; gap: 1rem;">
                            <button id="openCameraBtn" class="btn btn-primary">Open Camera</button>
                            <button id="scanCodeBtn" class="btn" disabled>Scan QR Code</button>
                        </div>
                    </div>
                </section>
                 <section id="bookMedicineScreen" class="screen">
    <div class="page-header">
        <h1>Book Medicine</h1>
        <button id="goToTrackOrdersBtn" class="btn" style="margin-top: 1rem;">Track My Orders</button>
    </div>

    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 2rem; text-align: center;">
        <h3 style="margin-bottom: 1rem;">📤 Upload Prescription</h3>
        <p style="margin-bottom: 1.5rem; opacity: 0.9;">Get medicines delivered based on your doctor's prescription</p>
        <button id="uploadPrescriptionBannerBtn" class="btn btn-primary" style="background: white; color: #667eea; border: 2px solid white;">Upload Prescription</button>
    </div>

    <div id="pharmacySelectionContainer">
        <h3 style="text-align: center; margin-bottom: 1.5rem;" data-key="select_pharmacy">Select a Pharmacy</h3>
        <div class="pharmacy-grid" id="pharmacyGrid"></div>
    </div>
   <div id="medicineOrderingContainer">
       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
           <h3 id="selectedPharmacyName"></h3>
           <button id="changePharmacyBtn" class="btn">Change</button>
       </div>

       <div class="medicine-categories" style="margin-bottom: 2rem;">
           <h3 style="text-align: center; margin-bottom: 1.5rem;">Browse by Category</h3>
           <div class="categories-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
               <div class="category-card card" data-category="pain-fever">
                   <h4>💊 Pain & Fever</h4>
                   <p>Paracetamol, Ibuprofen, Crocin</p>
               </div>
               <div class="category-card card" data-category="cough-cold">
                   <h4>🤧 Cough, Cold & Allergy</h4>
                   <p>Cetirizine, Cough Syrup, Vicks</p>
               </div>
               <div class="category-card card" data-category="stomach">
                   <h4>🫄 Stomach & Digestive</h4>
                   <p>Digene, Pudin Hara, Eno</p>
               </div>
           </div>
       </div>

       <div id="medicineDisplayContainer">
           <div id="medicineGrid" class="medicine-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
               </div>
       </div>

       <div class="card">
           <div class="form-group">
               <label for="medicineSearch">Search for medicine</label>
               <input type="search" id="medicineSearch" class="form-control" placeholder="e.g., Paracetamol">
           </div>
           <div id="medicineDisplayContainer">
               <ul class="medicine-list" id="medicineList"></ul>
           </div>
           <button id="checkoutBtn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;" disabled>Checkout (0 items)</button>
       </div>
   </div>
</section>
<section id="trackOrdersScreen" class="screen">
   <div class="page-header">
       <h1>My Medicine Orders</h1>
   </div>
   <div id="orders-list-container"></div>
</section>

<div id="cartModal" class="modal">
   <div class="modal-content" style="max-width: 600px; width: 90%;">
       <h3>🛒 Shopping Cart</h3>
       <div id="cartItemsContainer" style="max-height: 400px; overflow-y: auto; margin: 1.5rem 0;">
           </div>
       <div id="cartSummary" style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-bottom: 1.5rem;">
           <div style="display: flex; justify-content: space-between; font-weight: 600; font-size: 1.1rem;">
               <span>Total:</span>
               <span id="cartTotal">₹0.00</span>
           </div>
       </div>
       <div style="display: flex; gap: 1rem;">
           <button class="btn" onclick="document.getElementById('cartModal').classList.remove('active')">Continue Shopping</button>
           <button id="proceedToCheckoutBtn" class="btn btn-primary">Proceed to Checkout</button>
       </div>
   </div>
</div>

<div id="checkoutModal" class="modal">
   <div class="modal-content" style="max-width: 700px; width: 95%;">
       <div id="checkoutSteps">
           <div class="checkout-step active" id="checkoutStep1">
               <h3>📍 Delivery Address</h3>
               <div class="form-group">
                   <label for="deliveryAddress">Full Address</label>
                   <textarea id="deliveryAddress" class="form-control" rows="3" placeholder="Enter your complete delivery address"></textarea>
               </div>
               <div class="form-group">
                   <label for="deliveryInstructions">Delivery Instructions (Optional)</label>
                   <input type="text" id="deliveryInstructions" class="form-control" placeholder="e.g., Ring doorbell twice">
               </div>
               <button class="btn btn-primary" onclick="nextCheckoutStep()">Continue to Order Summary</button>
           </div>

           <div class="checkout-step" id="checkoutStep2">
               <h3>📋 Order Summary</h3>
               <div id="checkoutOrderSummary">
                   <div style="margin-bottom: 1.5rem;">
                       <h4>Delivery Address:</h4>
                       <p id="checkoutAddress" style="background: var(--color-secondary); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;"></p>
                   </div>
                   <div style="margin-bottom: 1.5rem;">
                       <h4>Items:</h4>
                       <div id="checkoutItems" style="max-height: 200px; overflow-y: auto; background: var(--color-secondary); border-radius: 8px; padding: 1rem;">
                           </div>
                   </div>
                   <div style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
                       <div style="display: flex; justify-content: space-between; font-weight: 600; font-size: 1.1rem;">
                           <span>Total:</span>
                           <span id="checkoutTotal">₹0.00</span>
                       </div>
                   </div>
               </div>
               <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                   <button class="btn" onclick="prevCheckoutStep()">Back</button>
                   <button class="btn btn-primary" onclick="nextCheckoutStep()">Continue to Payment</button>
               </div>
           </div>

           <div class="checkout-step" id="checkoutStep3">
               <h3>💳 Payment Method</h3>
               <div class="payment-methods" style="display: grid; gap: 1rem;">
                   <label class="payment-option card" style="display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 1rem;">
                       <input type="radio" name="paymentMethod" value="card" checked>
                       <div>
                           <strong>Credit / Debit Card</strong>
                           <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">Visa, Mastercard, RuPay</p>
                       </div>
                   </label>
                   <label class="payment-option card" style="display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 1rem;">
                       <input type="radio" name="paymentMethod" value="netbanking">
                       <div>
                           <strong>Net Banking</strong>
                           <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">All major banks supported</p>
                       </div>
                   </label>
                   <label class="payment-option card" style="display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 1rem;">
                       <input type="radio" name="paymentMethod" value="upi">
                       <div>
                           <strong>UPI</strong>
                           <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">Paytm, Google Pay, PhonePe, etc.</p>
                       </div>
                   </label>
                   <label class="payment-option card" style="display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 1rem;">
                       <input type="radio" name="paymentMethod" value="cod">
                       <div>
                           <strong>Cash on Delivery</strong>
                           <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">Pay when you receive your order</p>
                       </div>
                   </label>
               </div>

               <div id="cardPaymentForm" class="payment-form" style="display: none; margin-top: 1.5rem;">
                   <div class="card" style="padding: 1.5rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                       <h4 style="margin-bottom: 1rem; color: var(--primary-color);">💳 Card Details</h4>
                       <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                           <div class="form-group">
                               <label for="cardNumber">Card Number</label>
                               <input type="text" id="cardNumber" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19" oninput="formatCardNumber(this)">
                           </div>
                           <div class="form-group">
                               <label for="expiryDate">Expiry Date</label>
                               <input type="text" id="expiryDate" class="form-control" placeholder="MM/YY" maxlength="5" oninput="formatExpiryDate(this)">
                           </div>
                       </div>
                       <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                           <div class="form-group">
                               <label for="cvv">CVV</label>
                               <input type="text" id="cvv" class="form-control" placeholder="123" maxlength="4">
                           </div>
                           <div class="form-group">
                               <label for="cardholderName">Cardholder Name</label>
                               <input type="text" id="cardholderName" class="form-control" placeholder="John Doe">
                           </div>
                       </div>
                       <div class="card-preview" style="background: linear-gradient(135deg, #0d9488, #14b8a6); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                           <div style="display: flex; justify-content: space-between; align-items: center;">
                               <div>
                                   <div style="font-size: 0.9rem; opacity: 0.8;">Card Number</div>
                                   <div id="previewCardNumber">•••• •••• •••• ••••</div>
                               </div>
                               <div style="text-align: right;">
                                   <div style="font-size: 0.9rem; opacity: 0.8;">Valid Thru</div>
                                   <div id="previewExpiryDate">••/••</div>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>

               <div id="upiPaymentForm" class="payment-form" style="display: none; margin-top: 1.5rem;">
                   <div class="card" style="padding: 1.5rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                       <h4 style="margin-bottom: 1rem; color: var(--primary-color);">📱 UPI Payment</h4>
                       <div class="form-group">
                           <label for="upiId">UPI ID</label>
                           <input type="text" id="upiId" class="form-control" placeholder="yourname@paytm / yourname@oksbi">
                       </div>
                       <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                           <button type="button" class="btn" style="background: #5f259f; color: white;" onclick="setUpiId('paytm')">Paytm</button>
                           <button type="button" class="btn" style="background: #1f4de4; color: white;" onclick="setUpiId('gpay')">Google Pay</button>
                           <button type="button" class="btn" style="background: #5f259f; color: white;" onclick="setUpiId('phonepe')">PhonePe</button>
                       </div>
                   </div>
               </div>

               <div id="netbankingForm" class="payment-form" style="display: none; margin-top: 1.5rem;">
                   <div class="card" style="padding: 1.5rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                       <h4 style="margin-bottom: 1rem; color: var(--primary-color);">🏦 Net Banking</h4>
                       <div class="form-group">
                           <label for="bankSelect">Select Your Bank</label>
                           <select id="bankSelect" class="form-control">
                               <option value="">Choose your bank...</option>
                               <option value="sbi">State Bank of India</option>
                               <option value="hdfc">HDFC Bank</option>
                               <option value="icici">ICICI Bank</option>
                               <option value="axis">Axis Bank</option>
                               <option value="pnb">Punjab National Bank</option>
                               <option value="kotak">Kotak Mahindra Bank</option>
                               <option value="other">Other Banks</option>
                           </select>
                       </div>
                   </div>
               </div>

               <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                   <button class="btn" onclick="prevCheckoutStep()">Back</button>
                   <button class="btn btn-primary" onclick="processPayment()">Proceed to Pay</button>
               </div>
           </div>

           <div class="checkout-step" id="checkoutStep4">
               <div style="text-align: center;">
                   <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
                   <h3>Order Placed Successfully!</h3>
                   <p style="margin: 1rem 0; color: var(--text-color-secondary);">Your order has been received and is being processed.</p>
                   <div class="card" style="margin: 1.5rem 0; text-align: left;">
                       <p><strong>Order ID:</strong> <span id="orderIdDisplay"></span></p>
                       <p><strong>Estimated Delivery:</strong> <span id="deliveryTimeDisplay"></span></p>
                   </div>
                   <button class="btn btn-primary" onclick="trackOrder()">Track Your Order</button>
               </div>
           </div>
       </div>
   </div>
</div>
                <section id="chatbotScreen" class="screen">
                    <div class="page-header"><h1 data-key="health_chatbot_title">Health Assistant</h1></div>
                    <div class="card chatbot-container">
                        <div class="chat-window" id="chatWindow"></div>
                        <form class="chat-input" id="chatForm">
                            <input type="text" id="chatInput" class="form-control" placeholder="Ask about symptoms, dosage...">
                            <button type="submit" class="btn btn-primary">Send</button>
                        </form>
                    </div>
                </section>
            </main>
        </div>
    </div>
    
    <nav class="bottom-nav">
        <!-- --- MODIFIED: Corrected viewBox on all nav icons --- -->
        <button class="nav-button active" data-screen="homeScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span data-key="home_nav">Home</span></button>
        <button class="nav-button" data-screen="appointmentsScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span data-key="appointments_nav">Appointments</span></button>
        <button class="nav-button" data-screen="healthRecordScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg><span data-key="records_nav">Records</span></button>
        <button class="nav-button" data-screen="bookingScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"></path><path d="M12 12l4-4"></path><path d="M12 6v6h6"></path></svg><span data-key="book_nav">Book</span></button>
        <button class="nav-button" data-screen="moreScreen"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg><span data-key="more_nav">More</span></button>
    </nav>
    
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div class="modal-actions">
                 <button class="btn btn-primary" id="closeModal">OK</button>
            </div>
        </div>
    </div>
    <div id="sosModal" class="modal"><div class="modal-content"><h3>Emergency SOS</h3><p>This will call emergency services and send your location. Are you sure?</p><div class="modal-actions"><button class="btn" id="cancelSos">Cancel</button><button class="btn btn-sos" id="confirmSos">Confirm</button></div></div></div>
    <div id="prescriptionModal" class="modal"><div class="modal-content prescription-content" id="prescriptionModalContent"></div></div>
    <div id="callScreen" class="call-screen">
        <div class="call-content">
            <h1 id="callWithDoctor"></h1>
            <div class="video-container">
                <div class="video-wrapper">
                    <video id="remoteVideo" class="video-element" autoplay playsinline></video>
                    <video id="localVideo" class="video-element local-video" autoplay playsinline muted></video>
                </div>
            </div>
            <div class="call-actions">
                <button class="btn" id="startCallBtn">Start Call</button>
                <button class="btn" id="muteAudioBtn">Mute Audio</button>
                <button class="btn" id="muteVideoBtn">Mute Video</button>
                <button class="btn btn-sos" id="endCallBtn">End Call</button>
            </div>
            <div id="connectionStatus" style="text-align: center; margin-top: 1rem; padding: 0.5rem; border-radius: 8px; background: rgba(0,0,0,0.1); display: none;">
                <span id="statusText">Connecting...</span>
            </div>
            <div id="videoStatus" style="text-align: center; margin-top: 0.5rem; padding: 0.25rem; font-size: 0.8rem; color: var(--text-color-secondary); display: none;">
                <span id="videoStatusText">Video status will appear here</span>
            </div>
            <div class="message-section">
                <div id="messages" class="messages"></div>
                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="Type a message...">
                    <button class="btn btn-primary" id="sendMessageBtn">Send</button>
                </div>
            </div>
        </div>
    </div>
    <div id="trackingModal" class="modal">
        <div class="modal-content">
            <h3>Track Your Order</h3>
            <div id="trackingStatusContainer" style="text-align: left; margin-top: 1.5rem;"></div>
            <button class="btn btn-primary" id="closeTrackingModal" style="margin-top: 1.5rem;">Close</button>
        </div>
    </div>
    <div id="uploadPrescriptionModal" class="modal">
        <div class="modal-content">
            <h3>Add Offline Prescription</h3>
            <div class="form-group">
                <label for="providerName">Provider Name</label>
                <input type="text" id="providerName" class="form-control" placeholder="e.g., Local Store">
            </div>
            <video id="uploadCameraFeed" playsinline style="width: 100%; max-width: 500px; border-radius: var(--radius-lg); background: #333; aspect-ratio: 4 / 3;"></video>
            <p id="uploadCameraStatus">Click "Open Camera" to start scanning</p>
            <div style="display: flex; gap: 1rem;">
                <button id="openUploadCameraBtn" class="btn btn-primary">Open Camera</button>
                <button id="capturePrescriptionBtn" class="btn" disabled>Save Prescription</button>
            </div>
            <button class="btn" id="closeUploadModal" style="margin-top: 1rem;">Close</button>
        </div>
    </div>
    <div id="medicineReminderModal" class="modal">
        <form class="modal-content" id="medicineReminderForm"> <h3>Add Medicine Reminder</h3>
            <div class="form-group">
                <label for="medicineName">Medicine Name</label>
                <input type="text" id="medicineName" class="form-control" placeholder="e.g., Paracetamol">
            </div>
            <div class="form-group">
                <label for="medicineDosage">Dosage</label>
                <input type="text" id="medicineDosage" class="form-control" placeholder="e.g., 500mg">
            </div>
            <div class="form-group">
                <label for="medicineTimes">Times (comma separated)</label>
                <input type="text" id="medicineTimes" class="form-control" placeholder="e.g., 08:00, 14:00, 20:00">
            </div>
            <div class="form-group">
                <label for="medicineDuration">Duration (days)</label>
                <input type="number" id="medicineDuration" class="form-control" value="30">
            </div>
            <div class="form-group">
                <label for="medicineInstructions">Instructions</label>
                <textarea id="medicineInstructions" class="form-control" rows="2" placeholder="e.g., Take after meals"></textarea>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button id="saveReminderBtn" class="btn btn-primary">Save Reminder</button>
                <button type="button" class="btn" onclick="document.getElementById('medicineReminderModal').classList.remove('active')">Cancel</button>
            </div>
        </form> </div>


    <script>
        // Dynamic API URL configuration
        
        // For local development, uncomment and modify:
        // const API_BASE_URL = 'http://localhost:5000';

        // For Render deployment, uncomment if needed:
         const API_BASE_URL = 'https://sahara-sathi.onrender.com';

        console.log('Using API base URL:', API_BASE_URL);
        let medicineCart = [], selectedPharmacy = null;

        document.addEventListener('DOMContentLoaded', async function() {
            let user = null, currentLanguage = 'en', bookingState = {}, currentMonth = new Date().getMonth(), currentYear = new Date().getFullYear(), medicineCart = [], selectedPharmacy = null, doctors = [];

            const translations = {
                en: { welcome_message: "Welcome, {name}", welcome_subtitle: "Your health dashboard is ready.", next_appointment: "Next Appointment", new_prescriptions: "New Prescriptions", from_last_visit: "From past visits", home_nav: "Home", appointments_nav: "Appointments", records_nav: "Records", book_nav: "Book", more_nav: "More", appointments_title: "My Appointments", records_title: "Digital Health Record", book_title: "Book a Consultation", more_title: "More Options", prescriptions_title: "My Prescriptions", scan_medicine: "Scan Medicine", book_medicine: "Book Medicine", health_chatbot: "Health Chatbot", scan_medicine_title: "Scan Medicine", book_medicine_title: "Book Medicine", health_chatbot_title: "Health Assistant", select_pharmacy: "Select a Pharmacy"},
                hi: { welcome_message: "नमस्ते, {name}", welcome_subtitle: "आपका स्वास्थ्य डैशबोर्ड तैयार है।", next_appointment: "अगली अपॉइंटमेंट", new_prescriptions: "नई दवाइयाँ", from_last_visit: "पिछली मुलाक़ात से", home_nav: "होम", appointments_nav: "अपॉइंटमेंट्स", records_nav: "रिकॉर्ड्स", book_nav: "बुक करें", more_nav: "और", appointments_title: "मेरी अपॉइंटमेंट्स", records_title: "डिजिटल स्वास्थ्य रिकॉर्ड", book_title: "परामर्श बुक करें", more_title: "अन्य विकल्प", prescriptions_title: "मेरे नुस्खे", scan_medicine: "दवा स्कैन करें", book_medicine: "दवा बुक करें", health_chatbot: "स्वास्थ्य चैटबॉट", scan_medicine_title: "दवा स्कैन करें", book_medicine_title: "दवा बुक करें", health_chatbot_title: "स्वास्थ्य सहायक", select_pharmacy: "एक फार्मेसी चुनें"}
            };

            const appData = {
                records: [ { date: "2025-09-15", title: "Consultation with Dr. Priya Sharma", description: "Follow-up regarding skin rash. Prescription for ointment updated." }, { date: "2025-08-02", title: "Blood Test Report Uploaded", description: "Complete Blood Count (CBC) report added." } ],
                appointments: [
                    { id: 1, doctor: "Anjali Verma", type: "General Physician", date: "2025-09-28", time: "04:30 PM", mode: "Video"},
                    { id: 2, doctor: "Priya Sharma", type: "Child Specialist", date: "2025-09-15", time: "10:00 AM", mode: "Video", prescription: { medications: [{name: 'Paracetamol 500mg', dosage: '1 tablet thrice a day', time: 'Morning, Afternoon, Evening'}, {name: 'Azithromycin 250mg', dosage: '1 tablet daily', time: 'Morning'}], tests: ['Blood Test', 'X-Ray'] }},
                    { id: 3, doctor: "Sameer Patel", type: "General Physician", date: "2025-09-20", time: "11:00 AM", mode: "Audio", prescription: { medications: [{name: 'Vitamin C 1000mg', dosage: '1 tablet daily', time: 'Morning'}], tests: ['Complete Blood Count'] }}
                ],
                offlinePrescriptions: [{ doctor: "Local Store", type: "Offline", date: "2025-07-20", prescription: { medications: [{name: 'Antacid Syrup', dosage: '2 spoons after meals', time: 'After meals'}], tests: ['Ultrasound'] }}],
                orders: [],
                pharmacy: [ 
                    {id: 1, name: "Apollo Pharmacy", address: "123, Park Street, Kolkata", delivery: "30-45 mins", contact: "9876543210"},
                    {id: 2, name: "Frank Ross", address: "45, AJC Bose Road, Kolkata", delivery: "45-60 mins", contact: "9876543211"},
                    {id: 3, name: "Wellness Forever", address: "78, Ballygunge Circular, Kolkata", delivery: "20-35 mins", contact: "9876543212"}
                ],
                // START: REPLACE YOUR OLD 'medicines' ARRAY WITH THIS OBJECT
    medicines: {
        'pain-fever': [
            {id: 1, name: "Paracetamol (500mg)", price: 25.00, description: "Effective pain relief and fever reducer"},
            {id: 2, name: "Ibuprofen (400mg)", price: 35.00, description: "Anti-inflammatory pain relief"},
            {id: 3, name: "Crocin Pain Relief", price: 45.00, description: "Advanced pain relief formula"}
        ],
        'cough-cold': [
            {id: 4, name: "Cetirizine (10mg)", price: 18.00, description: "Allergy relief and antihistamine"},
            {id: 5, name: "Grilinctus Cough Syrup (100ml)", price: 85.00, description: "Effective cough suppressant"},
            {id: 6, name: "Vicks Action 500 Advanced", price: 55.00, description: "Multi-symptom cold relief"}
        ],
        'stomach': [
            {id: 7, name: "Digene Antacid Gel", price: 65.00, description: "Fast relief from acidity and gas"},
            {id: 8, name: "Pudin Hara Pearls", price: 45.00, description: "Ayurvedic digestive relief"},
            {id: 9, name: "Eno Fruit Salt", price: 15.00, description: "Instant relief from acidity"}
        ]
    },
    
                
            };
            // In patient.html, add this new function inside the main script area

    async function loadChatHistory() {
        try {
            const response = await fetch(`${API_BASE_URL}/v1/history`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: user.patientId, limit: 50 })
            });
            const data = await response.json();
            if (data.success && data.history) {
                const chatWindow = document.getElementById('chatWindow');
                chatWindow.innerHTML = ''; // Clear the welcome message
                data.history.forEach(turn => {
                    let content = turn.content;
                    if (turn.role === 'assistant') {
                        try {
                            content = JSON.parse(turn.content).response;
                        } catch (e) { /* It's just a string, use as is */ }
                    }
                    enhancedChatbot.displayMessage(content, turn.role);
                });
            }
        } catch (error) {
            console.error('Failed to load chat history:', error);
        }
    }
            async function loadDoctors() {
                try {
                    const response = await fetch(`${API_BASE_URL}/v1/doctors`);
                    const data = await response.json();
                    doctors = (data.doctors || []).filter(d => d && d.id);
                    if (doctors.length === 0) {
                        // Use mock data flattened
                        doctors = [];
                        for (let cat in appData.booking.doctors) {
                            doctors = doctors.concat(appData.booking.doctors[cat]);
                        }
                    }
                } catch (e) {
                    console.error('Failed to load doctors:', e);
                    // Use mock data flattened
                    doctors = [];
                    for (let cat in appData.booking.doctors) {
                        doctors = doctors.concat(appData.booking.doctors[cat]);
                    }
                }
            }
            // In patient.html, add this new function

            async function loadBookingData() {
                try {
                    // Fetch all categories and doctors from the backend endpoint
                    const response = await fetch(`${API_BASE_URL}/v1/booking-data`);
                    const data = await response.json();

                    if (data.success && data.booking_data) {
                        // Update the global appData object with live data from the database
                        appData.booking = data.booking_data;
                        console.log('Successfully loaded booking data from backend.');
                    } else {
                        console.warn('Could not load booking data from backend, using mock data.');
                    }
                } catch (error) {
                    console.error('Failed to fetch booking data:', error);
                }
            }

            function checkAuth() {
                // Check if user is logged in via localStorage (consistent with index.html)
                const userData = localStorage.getItem('sehatSaharaUser');
                if (userData) {
                    user = JSON.parse(userData);
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = 'index.html';
                    return false;
                }
                return true;
            }
            function updateUIText() {
                document.querySelectorAll('[data-key]').forEach(el => {
                    const key = el.getAttribute('data-key');
                    let text = (translations[currentLanguage] || translations.en)[key];
                    if (key === 'welcome_message' && user) text = text.replace('{name}', user.fullName || user.username || 'User');
                    if (text) el.textContent = text;
                });
            }
            function showScreen(screenId) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(screenId)?.classList.add('active'); document.querySelectorAll('.nav-button, .top-nav a').forEach(link => { link.classList.toggle('active', link.dataset.screen === screenId); }); }
            
            function showConfirmationModal(title, message) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('confirmationModal').classList.add('active');
            }

            function setupNavigation() { 
                document.querySelectorAll('[data-screen]').forEach(el => { el.addEventListener('click', (e) => { e.preventDefault(); showScreen(el.dataset.screen); }); });
                document.getElementById('goToTrackOrdersBtn').addEventListener('click', () => showScreen('trackOrdersScreen'));
                document.getElementById('uploadPrescriptionBannerBtn').addEventListener('click', () => document.getElementById('uploadPrescriptionModal').classList.add('active'));
            }
            
            function setupThemeAndLanguage() {
                const themeToggle = document.getElementById('themeToggle');
                const themeIcon = document.getElementById('themeIcon');
                // --- MODIFIED: Corrected viewBox in SVG strings ---
                const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
                const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;

                themeToggle.addEventListener('click', () => {
                    const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
                    document.body.dataset.theme = newTheme;
                    themeIcon.innerHTML = newTheme === 'dark' ? sunIcon : moonIcon;
                });
                
                const langDropdown = document.querySelector('.language-dropdown');
                const langMenu = langDropdown.querySelector('.language-dropdown-menu');
                Object.keys(translations).forEach(lang => { const option = document.createElement('a'); option.href = "#"; option.className = 'language-option'; option.dataset.lang = lang; option.textContent = new Intl.DisplayNames([lang], { type: 'language' }).of(lang); langMenu.appendChild(option); });
                langDropdown.querySelector('.language-dropdown-toggle').addEventListener('click', () => langDropdown.classList.toggle('open'));
                document.addEventListener('click', e => { if (!langDropdown.contains(e.target)) langDropdown.classList.remove('open'); });
                langMenu.addEventListener('click', e => { if (e.target.classList.contains('language-option')) { currentLanguage = e.target.dataset.lang; document.getElementById('selectedLanguage').textContent = e.target.textContent; updateUIText(); langDropdown.classList.remove('open'); } });
            }

            function generateTimeline() { document.getElementById('timeline-container').innerHTML = appData.records.map(rec => `<div class="timeline-item"><div class="timeline-dot"></div><p class="timeline-date">${new Date(rec.date).toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}</p><div class="card"><h4>${rec.title}</h4><p>${rec.description}</p></div></div>`).join(''); }

            async function generateAppointments() {
                try {
                    const response = await fetch(`${API_BASE_URL}/v1/appointments?userId=${user.patientId}`);
                    const data = await response.json();
                    if (data.success && data.appointments) {
                        appData.appointments = data.appointments.map(appt => ({
                            // --- CORRECTED CODE ---
                            // Keep the original, full dateTime string for accurate comparisons
                            dateTime: appt.dateTime, 
                            // --- END OF CORRECTION ---
                            id: appt.id,
                            doctor: appt.doctorName,
                            type: appt.specialization,
                            date: new Date(appt.dateTime).toISOString().split('T')[0],
                            time: new Date(appt.dateTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
                            mode: 'Video' // default
                        }));
                    } else {
                        // Keep mock data if API fails
                        appData.appointments = [
                            { id: 1, doctor: "Anjali Verma", type: "General Physician", date: "2025-09-28", time: "04:30 PM", mode: "Video"},
                            { id: 2, doctor: "Priya Sharma", type: "Child Specialist", date: "2025-09-15", time: "10:00 AM", mode: "Video", prescription: { medications: [{name: 'Paracetamol 500mg', dosage: '1 tablet thrice a day'}, {name: 'Azithromycin 250mg', dosage: '1 tablet daily'}] }},
                            { id: 3, doctor: "Sameer Patel", type: "General Physician", date: "2025-09-20", time: "11:00 AM", mode: "Audio", prescription: { medications: [{name: 'Vitamin C 1000mg', dosage: '1 tablet daily'}] }}
                        ];
                    }
                } catch (e) {
                    console.error('Failed to load appointments:', e);
                     // Keep mock data on network error
                    appData.appointments = [
                        { id: 1, doctor: "Anjali Verma", type: "General Physician", date: "2025-09-28", time: "04:30 PM", mode: "Video"},
                        { id: 2, doctor: "Priya Sharma", type: "Child Specialist", date: "2025-09-15", time: "10:00 AM", mode: "Video", prescription: { medications: [{name: 'Paracetamol 500mg', dosage: '1 tablet thrice a day'}, {name: 'Azithromycin 250mg', dosage: '1 tablet daily'}] }},
                        { id: 3, doctor: "Sameer Patel", type: "General Physician", date: "2025-09-20", time: "11:00 AM", mode: "Audio", prescription: { medications: [{name: 'Vitamin C 1000mg', dosage: '1 tablet daily'}] }}
                    ];
                }

                const container = document.getElementById('appointments-container');
                const now = new Date(); // Use the current actual date and time
                // --- CORRECTED CODE ---
                // Use the full dateTime property for an accurate comparison
                const upcoming = appData.appointments.filter(a => new Date(a.dateTime) >= now).sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));
                const past = appData.appointments.filter(a => new Date(a.dateTime) < now).sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime));
                // --- END OF CORRECTION ---
                // --- NEW CODE TO UPDATE THE HOME SCREEN ---
                const nextAppointmentCard = document.querySelector('#homeScreen .info-card');
                if (nextAppointmentCard) {
                    const highlightEl = nextAppointmentCard.querySelector('.highlight');
                    const doctorNameEl = nextAppointmentCard.querySelector('p:last-of-type');

                    if (upcoming.length > 0) {
                        const nextAppt = upcoming[0];
                        const apptDate = new Date(nextAppt.date);
                        const today = new Date();
                        let dateString;

                        if (apptDate.toDateString() === today.toDateString()) {
                            dateString = `Today, ${nextAppt.time}`;
                        } else {
                            dateString = `${apptDate.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' })}, ${nextAppt.time}`;
                        }
                        
                        highlightEl.textContent = dateString;
                        doctorNameEl.textContent = nextAppt.doctor;
                    } else {
                        highlightEl.textContent = 'No upcoming appointments';
                        doctorNameEl.textContent = 'You can book a new one anytime.';
                    }
                }
                // --- END OF NEW CODE ---
                
                // --- NEW CODE FOR DEMO APPOINTMENT ---
                const demoCallHtml = `
                    <div class="card appointment-card" style="border: 2px solid var(--primary-color-dark);">
                        <div class="appointment-card-header">
                            <div class="appointment-card-doctor">
                                <h4>Live Demo Call</h4>
                                <p>Test the Video Call Feature</p>
                                <p>Available anytime for demonstration</p>
                            </div>
                            <span class="appointment-card-tag tag-video">Demo</span>
                        </div>
                        <div class="appointment-card-footer">
                            <button class="btn btn-primary join-call-btn" data-doctor="Demo Doctor" data-appointment-id="demo-call-123">
                                Join Call Now
                            </button>
                        </div>
                    </div>
                `;
                // --- END OF NEW CODE ---

                let html = `<h3 class="appointments-section-title">Upcoming</h3>`;
                html += demoCallHtml; // Add the demo call to the top of the list
            
                html += upcoming.length ? upcoming.map(a => { const apptTime = new Date(`${a.date} ${a.time}`); const timeDiffMinutes = (apptTime - now) / 60000; const canJoin = timeDiffMinutes <= 10 && timeDiffMinutes >= -15; return `<div class="card appointment-card"><div class="appointment-card-header"><div class="appointment-card-doctor"><h4>${a.doctor}</h4><p>${a.type}</p><p>${new Date(a.date).toDateString()}, ${a.time}</p></div><span class="appointment-card-tag ${a.mode === 'Video' ? 'tag-video' : 'tag-audio'}">${a.mode}</span></div><div class="appointment-card-footer"><button class="btn" style="background: var(--color-secondary); color: var(--text-color);">Reschedule</button><button class="btn btn-primary join-call-btn" data-doctor="${a.doctor}" data-appointment-id="${a.id}" ${canJoin ? '' : 'disabled'}>Join Call</button></div></div>`; }).join('') : '<p>No upcoming appointments.</p>';
                
                html += `<h3 class="appointments-section-title" style="margin-top: 2rem;">Past</h3>`;
                html += past.length ? past.map((a, index) => `<div class="card appointment-card"><div class="appointment-card-header"><div class="appointment-card-doctor"><h4>${a.doctor}</h4><p>${a.type}</p><p>${new Date(a.date).toDateString()}, ${a.time}</p></div><span class="appointment-card-tag ${a.mode === 'Video' ? 'tag-video' : 'tag-audio'}">${a.mode}</span></div><div class="appointment-card-footer">${a.prescription ? `<button class="btn btn-primary view-prescription-btn" data-past-index="${index}">View Prescription</button>` : ''}</div></div>`).join('') : '<p>No past appointments.</p>';

                container.innerHTML = html;
                container.querySelectorAll('.join-call-btn').forEach(btn => btn.addEventListener('click', (e) => showCallScreen(e.currentTarget.dataset.doctor, e.currentTarget.dataset.appointmentId)));
                container.querySelectorAll('.view-prescription-btn').forEach(btn => btn.addEventListener('click', (e) => showPrescription(past[e.currentTarget.dataset.pastIndex])));
            }
            
             async function generateAllPrescriptions() {
                const container = document.getElementById('prescriptions-container');
                try {
                    // Added the required userId query parameter to the URL
                    const response = await fetch(`${API_BASE_URL}/v1/dashboard?userId=${user.patientId}`);
                    // --- END OF CORRECTION ---
                    const data = await response.json();
                    if (data.success && data.healthRecords) {
                        const prescriptions = data.healthRecords.filter(record => record.recordType === 'prescription');
                        container.innerHTML = prescriptions.length ? prescriptions.map((p, index) => `<div class="card appointment-card"><div class="appointment-card-header"><div class="appointment-card-doctor"><h4>${p.title.replace('Prescription from ', '')}</h4><p>Offline</p><p>${new Date(p.date).toDateString()}</p></div><span class="appointment-card-tag tag-offline">Offline</span></div><div class="appointment-card-footer"><button class="btn btn-primary view-prescription-btn" data-prescription='${JSON.stringify(p)}'>View Prescription</button></div></div>`).join('') : '<p>No prescriptions found.</p>';
                        container.querySelectorAll('.view-prescription-btn').forEach(btn => btn.addEventListener('click', e => {
                            const prescriptionData = JSON.parse(e.currentTarget.dataset.prescription);
                            showPrescriptionFromRecord(prescriptionData);
                        }));
                    } else {
                        container.innerHTML = '<p>No prescriptions found.</p>';
                    }
                } catch (e) {
                    console.error('Failed to load prescriptions:', e);
                    container.innerHTML = '<p>Failed to load prescriptions.</p>';
                }
            }


            
            function showPrescription(appointment) {
                const modalContent = document.getElementById('prescriptionModalContent');
                const imageHtml = appointment.prescription.image ? `<img src="${appointment.prescription.image}" style="max-width: 100%; margin-bottom: 1rem; border-radius: var(--radius-lg);" />` : '';

                // Check if AI extracted meaningful data
                const hasExtractedData = appointment.prescription.medications && appointment.prescription.medications.length > 0 &&
                    !appointment.prescription.medications.every(med => med.name === 'Scanned Medication');

                if (!hasExtractedData && appointment.prescription.image) {
                    // Fallback: just show the image
                    modalContent.innerHTML = `<h3>Prescription</h3><div class="prescription-header"><p><strong>Provider:</strong> ${appointment.doctor}</p><p><strong>Date:</strong> ${new Date(appointment.date).toDateString()}</p><p><strong>Mode:</strong> Offline</p></div>${imageHtml}<p style="text-align: center; color: var(--text-color-secondary);">Unable to extract prescription details. Please refer to the image above.</p><button class="btn btn-primary" id="closePrescriptionModal">Close</button>`;
                } else {
                    // Show extracted data
                    const diagnosisHtml = appointment.prescription.diagnosis ? `<p><strong>Diagnosis:</strong> ${appointment.prescription.diagnosis}</p>` : '';
                    const testsHtml = appointment.prescription.tests && appointment.prescription.tests.length ? `<h4>Recommended Tests:</h4><ul class="prescription-med-list">${appointment.prescription.tests.map(test => `<li>${test}</li>`).join('')}</ul>` : '';
                    modalContent.innerHTML = `<h3>Prescription</h3>${imageHtml}<div class="prescription-header"><p><strong>${appointment.mode ? 'Doctor' : 'Provider'}:</strong> ${appointment.doctor}</p><p><strong>Date:</strong> ${new Date(appointment.date).toDateString()}</p><p><strong>Mode:</strong> ${appointment.mode || 'Offline'}</p>${diagnosisHtml}</div><h4>Medications:</h4><ul class="prescription-med-list">${appointment.prescription.medications.map(med => `<li><strong>${med.name}</strong><br><small>${med.dosage} - ${med.time || 'As prescribed'}</small></li>`).join('')}</ul>${testsHtml}<button class="btn btn-primary" id="closePrescriptionModal">Close</button>`;
                }

                document.getElementById('prescriptionModal').classList.add('active');
                document.getElementById('closePrescriptionModal').addEventListener('click', () => document.getElementById('prescriptionModal').classList.remove('active'), { once: true });
            }
             function showPrescriptionFromRecord(record) {
                 const modalContent = document.getElementById('prescriptionModalContent');
                 const imageHtml = record.imageData 
                     ? `<img src="data:image/jpeg;base64,${record.imageData}" style="max-width: 100%; margin-bottom: 1rem; border-radius: var(--radius-lg);" />`
                     : (record.imageUrl ? `<img src="${API_BASE_URL}${record.imageUrl}" style="max-width: 100%; margin-bottom: 1rem; border-radius: var(--radius-lg);" />` : '');
                 // Determine prescription source
                 const isPatientUpload = record.title.includes('Offline') || record.description.includes('offline');
                 const sourceBadge = isPatientUpload ?
                     '<span style="background: #ffc107; color: #000; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Patient Upload</span>' :
                     '<span style="background: #007bff; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Doctor Prescription</span>';
 
                 modalContent.innerHTML = `
                     <h3>Prescription ${sourceBadge}</h3>
                     <div class="prescription-header">
                         <p><strong>Title:</strong> ${record.title}</p>
                         <p><strong>Date:</strong> ${new Date(record.date).toDateString()}</p>
                         <p><strong>Description:</strong> ${record.description}</p>
                     </div>
                     ${imageHtml}
                     <p style="text-align: center; color: var(--text-color-secondary);">
                         ${isPatientUpload ? 'Patient-uploaded prescription. AI-extracted details shown below if available.' : 'Doctor-provided prescription from consultation.'}
                     </p>
                     <button class="btn btn-primary" id="closePrescriptionModal">Close</button>
                 `;
 
                 document.getElementById('prescriptionModal').classList.add('active');
                 document.getElementById('closePrescriptionModal').addEventListener('click', () => document.getElementById('prescriptionModal').classList.remove('active'), { once: true });
             }

            function renderBookingStep(step) {
                 document.querySelectorAll('.booking-step').forEach(s => s.classList.remove('active'));
                 const stepEl = document.getElementById(`bookingStep${step}`);
                 if(stepEl) stepEl.classList.add('active');
                 document.getElementById('prevStep').disabled = step === 1;
                 document.getElementById('appointmentSummary').style.display = 'none';

                 let grid, data, handler;
                 if (step === 1) { grid = document.getElementById('categoryGrid'); data = appData.booking.categories; handler = (item) => { bookingState.category = item; renderBookingStep(2); }; grid.innerHTML = data.map(item => `<div class="selection-card card"><h4>${item}</h4></div>`).join(''); }
                 else if (step === 2) { grid = document.getElementById('doctorGrid'); data = doctors.filter(d => d.specialization === bookingState.category); handler = (item) => { bookingState.doctorId = item.id; bookingState.doctor = item.name; renderBookingStep(3); }; grid.innerHTML = data.map(item => `<div class="doctor-card selection-card card"><img src="${item.img || 'https://placehold.co/100x100/0d9488/FFFFFF?text=Doc'}"><h4>${item.name}</h4><p>${item.languages}</p></div>`).join(''); }
                 else if (step === 3) { generateCalendar(); document.getElementById('timeSlotsGrid').innerHTML = ''; }
                 // --- ADDED THIS MISSING CODE BLOCK ---
                 else if (step === 4) {
                    grid = document.getElementById('modeGrid');
                    data = appData.booking.modes;
                    handler = (item) => {
                        bookingState.mode = item;
                        showSummary();
                    };
                    grid.innerHTML = data.map(item => `<div class="selection-card card"><h4>${item}</h4></div>`).join('');
                 }
                 // --- END OF ADDED CODE ---
                 if (grid) { Array.from(grid.children).forEach((child, index) => { child.addEventListener('click', () => handler(data[index])); }); }
            }
             function generateCalendar() {
                const daysGrid = document.getElementById('calendarDaysGrid');
                const monthYearEl = document.getElementById('currentMonthYear');
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                monthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;
                daysGrid.innerHTML = '';
                const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const today = new Date(); today.setHours(0, 0, 0, 0);
                document.getElementById('prevMonth').disabled = (currentYear < today.getFullYear() || (currentYear === today.getFullYear() && currentMonth <= today.getMonth()));

                for(let i = 0; i < firstDayOfMonth; i++) { daysGrid.insertAdjacentHTML('beforeend', '<div></div>'); }
                for(let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    const currentDate = new Date(currentYear, currentMonth, day);
                    dayEl.textContent = day; dayEl.classList.add('calendar-day');
                    if (currentDate < today) { dayEl.classList.add('disabled'); } 
                    else { dayEl.classList.add('available'); dayEl.addEventListener('click', () => { bookingState.date = `${day} ${monthNames[currentMonth]} ${currentYear}`; document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected')); dayEl.classList.add('selected'); generateTimeSlots(); }); }
                    daysGrid.appendChild(dayEl);
                }
            }
            function generateTimeSlots() {
                const slotsGrid = document.getElementById('timeSlotsGrid');
                let availableSlots = appData.booking.slots;

                // --- NEW LOGIC TO FILTER PAST TIME SLOTS FOR TODAY ---
                const today = new Date();
                const selectedDate = new Date(bookingState.date);
                
                // Check if the selected date is today
                if (selectedDate.toDateString() === today.toDateString()) {
                    const now = new Date();
                    
                    // Filter to keep only future time slots
                    availableSlots = appData.booking.slots.filter(slot => {
                        // Create a full Date object for the slot to compare it accurately
                        const [time, modifier] = slot.split(' ');
                        let [hours, minutes] = time.split(':');
                        hours = parseInt(hours);
                        minutes = parseInt(minutes);

                        if (modifier === 'PM' && hours < 12) {
                            hours += 12;
                        }
                        if (modifier === 'AM' && hours === 12) { // Midnight case
                            hours = 0;
                        }

                        const slotTime = new Date(selectedDate);
                        slotTime.setHours(hours, minutes, 0, 0);

                        return slotTime > now; // Keep the slot only if it's in the future
                    });
                }
                // --- END OF NEW LOGIC ---

                slotsGrid.innerHTML = availableSlots.map(slot => `<div class="time-slot">${slot}</div>`).join('');
                slotsGrid.querySelectorAll('.time-slot').forEach(slotEl => {
                    slotEl.addEventListener('click', () => {
                        document.querySelectorAll('.time-slot.selected').forEach(s => s.classList.remove('selected'));
                        slotEl.classList.add('selected');
                        bookingState.slot = slotEl.textContent;
                        renderBookingStep(4);
                    });
                });
            }
            function showSummary() {
                 if (!user || !user.patientId) {
                     alert('Please login first to book an appointment.');
                     return;
                 }
                 document.querySelectorAll('.booking-step').forEach(s => s.classList.remove('active'));
                 const summaryEl = document.getElementById('appointmentSummary');
                 summaryEl.style.display = 'block';
                 summaryEl.innerHTML = `<h4>Appointment Summary</h4><p><strong>Category:</strong> ${bookingState.category}</p><p><strong>Doctor:</strong> ${bookingState.doctor}</p><p><strong>Date:</strong> ${bookingState.date}</p><p><strong>Time:</strong> ${bookingState.slot}</p><p><strong>Mode:</strong> ${bookingState.mode}</p><button class="btn btn-primary" id="confirmBtn" style="width:100%; margin-top:1rem;">Book Appointment</button>`;
                 document.getElementById('confirmBtn').addEventListener('click', async () => {
                     const appointmentDatetime = new Date(`${bookingState.date} ${bookingState.slot}`).toISOString();

                     const bookingData = {
                         userId: user.patientId,
                         doctorId: bookingState.doctorId,
                         appointmentDatetime: appointmentDatetime,
                         appointmentType: bookingState.category,
                         chiefComplaint: 'General consultation',
                         symptoms: []
                     };

                     try {
                         const response = await fetch(`${API_BASE_URL}/v1/book-doctor`, {
                             method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify(bookingData)
                         });
                         const data = await response.json();
                         if (data.success) {
                             showConfirmationModal('Appointment Booked!', 'Your appointment has been successfully scheduled.');
                             await generateAppointments(); // Refresh appointments
                             setTimeout(() => { document.getElementById('confirmationModal').classList.remove('active'); showScreen('homeScreen'); }, 2500);
                         } else {
                             alert('Failed to book appointment: ' + (data.error || 'Unknown error'));
                         }
                     } catch (e) {
                         console.error('Booking error:', e);
                         alert('Failed to book appointment. Please try again.');
                     }
                 });
                 updateUIText();
             }
            function generateOrdersList() {
    const container = document.getElementById('orders-list-container');
    if (appData.orders.length === 0) {
        container.innerHTML = '<p style="text-align:center;">You have no active or past medicine orders.</p>';
        return;
    }
    container.innerHTML = appData.orders.sort((a,b) => new Date(b.date) - new Date(a.date)).map(order => `
        <div class="card appointment-card">
             <div class="appointment-card-header">
                <div class="appointment-card-doctor">
                    <h4>Order ID: ${order.id}</h4>
                    <p>${order.pharmacyName}</p>
                    <p>Total: ₹${order.total.toFixed(2)}</p>
                </div>
                <span class="appointment-card-tag ${order.status === 'Delivered' ? 'tag-audio' : 'tag-video'}">${order.status}</span>
            </div>
            <div class="appointment-card-footer">
                <button class="btn btn-primary track-order-list-btn" data-order-id="${order.id}">Track</button>
            </div>
        </div>
    `).join('');

    container.querySelectorAll('.track-order-list-btn').forEach(btn => {
        btn.addEventListener('click', (e) => showTrackingModal(e.currentTarget.dataset.orderId));
    });
}

function showTrackingModal(orderId) {
    const order = appData.orders.find(o => o.id === orderId);
    if (!order) return;

    const container = document.getElementById('trackingStatusContainer');
    const statuses = [
        { title: 'Order Confirmed', description: 'Your order has been received and confirmed.', icon: '📋' },
        { title: 'Processing at Pharmacy', description: 'The pharmacy is preparing your items.', icon: '🏥' },
        { title: 'Out for Delivery', description: 'Your delivery partner is on the way.', icon: '🚚' },
        { title: 'Delivered', description: 'Your order has been delivered successfully.', icon: '✅' }
    ];
    const currentStatusIndex = ['Order Placed', 'Preparing Order', 'Out for Delivery', 'Delivered'].indexOf(order.status);

    container.innerHTML = statuses.map((status, index) => {
        const isCompleted = index < currentStatusIndex;
        const isCurrent = index === currentStatusIndex;
        const statusClass = isCompleted ? 'completed' : (isCurrent ? 'current' : '');
        const timestamp = isCompleted ? new Date(order.date).toLocaleString() : '';

        return `
            <div class="tracking-step ${statusClass}">
                <div class="tracking-dot">
                    ${isCompleted ? '✓' : (isCurrent ? status.icon : '○')}
                </div>
                <div class="tracking-content">
                    <div class="tracking-title">${status.title}</div>
                    <div class="tracking-description">${status.description}</div>
                    ${timestamp ? `<div class="tracking-timestamp">${timestamp}</div>` : ''}
                </div>
            </div>
        `;
    }).join('');

    document.getElementById('trackingModal').classList.add('active');
}



            function setupModalsAndActions() {
                document.getElementById('closeModal').addEventListener('click', () => document.getElementById('confirmationModal').classList.remove('active'));
                document.getElementById('sosButton').addEventListener('click', () => document.getElementById('sosModal').classList.add('active'));
                document.getElementById('cancelSos').addEventListener('click', () => document.getElementById('sosModal').classList.remove('active'));
                document.getElementById('endCallBtn').addEventListener('click', endCall);
                document.getElementById('closeTrackingModal').addEventListener('click', () => document.getElementById('trackingModal').classList.remove('active'));
                document.getElementById('uploadPrescriptionBtn').addEventListener('click', () => document.getElementById('uploadPrescriptionModal').classList.add('active'));
                document.getElementById('closeUploadModal').addEventListener('click', () => { const modal = document.getElementById('uploadPrescriptionModal'); modal.classList.remove('active'); const feed = document.getElementById('uploadCameraFeed'); if (feed.srcObject) { feed.srcObject.getTracks().forEach(track => track.stop()); feed.srcObject = null; } openCameraBtn.disabled = false; captureBtn.disabled = true; cameraStatus.textContent = "Click 'Open Camera' to start scanning"; });

                // Medicine reminder modal
                document.getElementById('addReminderBtn').addEventListener('click', () => document.getElementById('medicineReminderModal').classList.add('active'));
                document.getElementById('saveReminderBtn').addEventListener('click', async (event) => {
                event.preventDefault(); // <-- THIS IS THE FIX
                await saveMedicineReminder();
            });

                document.getElementById('confirmSos').addEventListener('click', () => { document.getElementById('sosModal').classList.remove('active'); showConfirmationModal('SOS Activated', 'Emergency services have been notified.'); });
                document.getElementById('reportIssueForm')?.addEventListener('submit', (e) => { e.preventDefault(); showConfirmationModal('Report Submitted', 'Your report has been sent for review.'); e.target.reset(); setTimeout(() => showScreen('moreScreen'), 2000); });
                document.getElementById('prevMonth').addEventListener('click', () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } generateCalendar(); });
                document.getElementById('nextMonth').addEventListener('click', () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } generateCalendar(); });
                document.getElementById('prevStep').addEventListener('click', () => {
                    const activeStep = document.querySelector('.booking-step.active');
                    if (activeStep) {
                        const currentStep = parseInt(activeStep.id.replace('bookingStep', ''));
                        if (currentStep > 1) renderBookingStep(currentStep - 1);
                    }
                });
                document.getElementById('logoutBtn').addEventListener('click', () => { alert("You have been logged out."); window.location.reload(); });
                document.getElementById('viewAllPrescriptions').addEventListener('click', () => showScreen('prescriptionsScreen'));
                document.getElementById('medicineReminders').addEventListener('click', () => { showScreen('medicineRemindersScreen'); loadMedicineRemindersScreen(); });
            }
            function setupBookMedicine() {
    // --- Element Selectors ---
    const pharmacySelectionContainer = document.getElementById('pharmacySelectionContainer');
    const medicineOrderingContainer = document.getElementById('medicineOrderingContainer');
    const pharmacyGrid = document.getElementById('pharmacyGrid');
    const searchInput = document.getElementById('medicineSearch');
    const selectedPharmacyNameEl = document.getElementById('selectedPharmacyName');
    const changePharmacyBtn = document.getElementById('changePharmacyBtn');
    // --- Event Handling & State Management ---

            // Resets the view to show the pharmacy list again
            const resetAndShowPharmacies = () => {
                pharmacySelectionContainer.style.display = 'block';
                medicineOrderingContainer.style.display = 'none';
                selectedPharmacy = null; // Clear the selected pharmacy state
            };

    // --- Core View & Data Functions ---

    // Renders the initial list of pharmacies for the user to select
    const renderPharmacies = () => {
        pharmacyGrid.innerHTML = appData.pharmacy.map(p => `
            <div class="card pharmacy-card" data-pharmacy-id="${p.id}">
               <div class="info">
                 <h4>${p.name}</h4>
                 <p><small>${p.address}</small></p>
               </div>
               <div class="actions">
                    <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 5.5a.5.5 0 0 0-1 0v3.5h3a.5.5 0 0 0 0-1h-2.5V5.5z"/><path d="M6.5 1A.5.5 0 0 1 7 .5h2a.5.5 0 0 1 0 1H7a.5.5 0 0 1-.5-.5zM8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg> ${p.delivery}</span>
                    <a href="tel:${p.contact}" class="btn">Contact</a>
               </div>
            </div>
        `).join('');
        pharmacyGrid.querySelectorAll('.pharmacy-card').forEach(card => card.addEventListener('click', handlePharmacySelection));
    };

    // Handles switching to the medicine ordering view after a pharmacy is chosen
    const handlePharmacySelection = (e) => {
        if (e.target.tagName === 'A') return; // Ignore clicks on the "Contact" button
        const pharmacyId = parseInt(e.currentTarget.dataset.pharmacyId);
        selectedPharmacy = appData.pharmacy.find(p => p.id === pharmacyId);
        
        pharmacySelectionContainer.style.display = 'none';
        medicineOrderingContainer.style.display = 'block';
        selectedPharmacyNameEl.textContent = `Ordering from: ${selectedPharmacy.name}`;
        
        const firstCategoryCard = document.querySelector('.category-card');
        if (firstCategoryCard) {
            firstCategoryCard.classList.add('selected');
            renderMedicines(firstCategoryCard.dataset.category);
        }
    };

    // Renders medicine cards based on category or search results
    const renderMedicines = (source, isSearchResult = false) => {
        const medicineGrid = document.getElementById('medicineGrid');
        let medicinesToShow = isSearchResult ? source : (appData.medicines[source] || []);
        
        medicineGrid.innerHTML = medicinesToShow.map(med => `
            <div class="medicine-card card">
                <div class="medicine-name">${med.name}</div>
                <div class="medicine-price">₹${med.price.toFixed(2)}</div>
                <div class="medicine-description">${med.description}</div>
                <div class="quantity-selector">
                    <button class="quantity-btn" data-action="decrease" data-med-id="${med.id}">-</button>
                    <input type="number" class="quantity-input" data-med-id="${med.id}" value="1" min="1" max="99" readonly>
                    <button class="quantity-btn" data-action="increase" data-med-id="${med.id}">+</button>
                </div>
                <button class="btn btn-primary add-to-cart-btn" data-med-id="${med.id}">Add to Cart</button>
            </div>
        `).join('');
        
        attachMedicineCardListeners(medicinesToShow);
    };

    // Attaches event listeners to the quantity and "Add to Cart" buttons on medicine cards
    const attachMedicineCardListeners = (medicineSource) => {
        const medicineGrid = document.getElementById('medicineGrid');
        medicineGrid.querySelectorAll('.quantity-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const medId = parseInt(e.target.dataset.medId);
                const action = e.target.dataset.action;
                const input = medicineGrid.querySelector(`.quantity-input[data-med-id="${medId}"]`);
                if (!input) return;
                let currentValue = parseInt(input.value);
                if (action === 'increase' && currentValue < 99) input.value = currentValue + 1;
                else if (action === 'decrease' && currentValue > 1) input.value = currentValue - 1;
            });
        });

        medicineGrid.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const medId = parseInt(e.target.dataset.medId);
                const input = medicineGrid.querySelector(`.quantity-input[data-med-id="${medId}"]`);
                if (!input) return;
                const quantity = parseInt(input.value);
                const medicine = medicineSource.find(m => m.id === medId);
                if (medicine) {
                    addToCart(medicine, quantity);
                    updateCartIcon();
                    showConfirmationModal('Added to Cart', `${medicine.name} (${quantity}) has been added.`);
                }
            });
        });
    };

    // --- Cart & Checkout Management ---

    const addToCart = (medicine, quantity) => {
        const existingItem = medicineCart.find(item => item.id === medicine.id);
        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            medicineCart.push({ ...medicine, quantity });
        }
    };

    const updateCartIcon = () => {
        const cartBadge = document.querySelector('.cart-badge');
        if (!cartBadge) return;
        const totalItems = medicineCart.reduce((sum, item) => sum + item.quantity, 0);
        cartBadge.textContent = totalItems;
        cartBadge.style.display = totalItems > 0 ? 'flex' : 'none';
    };

    // Updates the content of the shopping cart modal
    const updateCartModal = () => {
        const cartItemsContainer = document.getElementById('cartItemsContainer');
        const cartTotalEl = document.getElementById('cartTotal');
        if (!cartItemsContainer || !cartTotalEl) return;

        if (medicineCart.length === 0) {
            cartItemsContainer.innerHTML = '<p style="text-align: center; color: var(--text-color-secondary);">Your cart is empty</p>';
            cartTotalEl.textContent = '₹0.00';
            return;
        }

        cartItemsContainer.innerHTML = medicineCart.map(item => `
            <div class="cart-item">
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-details">₹${item.price.toFixed(2)} each</div>
                    <div class="cart-item-price">Subtotal: ₹${(item.price * item.quantity).toFixed(2)}</div>
                </div>
                <div class="cart-item-actions">
                    <div class="cart-quantity">
                        <button class="cart-quantity-btn" onclick="updateCartItemQuantity(${item.id}, ${item.quantity - 1})">-</button>
                        <span style="padding: 0.5rem; min-width: 40px; text-align: center; display: inline-block;">${item.quantity}</span>
                        <button class="cart-quantity-btn" onclick="updateCartItemQuantity(${item.id}, ${item.quantity + 1})">+</button>
                    </div>
                    <button class="cart-remove-btn" onclick="removeCartItem(${item.id})">Remove</button>
                </div>
            </div>
        `).join('');

        const total = medicineCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        cartTotalEl.textContent = `₹${total.toFixed(2)}`;
    };

    // Make cart modification functions globally accessible for the onclick attributes
    window.updateCartItemQuantity = (medicineId, newQuantity) => {
        const item = medicineCart.find(i => i.id === medicineId);
        if (item) {
            if (newQuantity <= 0) {
                removeCartItem(medicineId);
            } else {
                item.quantity = newQuantity;
                updateCartIcon();
                updateCartModal();
            }
        }
    };

    window.removeCartItem = (medicineId) => {
        const index = medicineCart.findIndex(i => i.id === medicineId);
        if (index > -1) {
            medicineCart.splice(index, 1);
            updateCartIcon();
            updateCartModal();
        }
    };

    // --- Checkout Flow Logic ---
    let checkoutStep = 1;
    const showCheckoutStep = (step) => {
        checkoutStep = step;
        document.querySelectorAll('#checkoutModal .checkout-step').forEach(s => s.classList.remove('active'));
        const stepEl = document.getElementById(`checkoutStep${step}`);
        if (stepEl) stepEl.classList.add('active');
    };

    window.nextCheckoutStep = () => {
        if (checkoutStep === 1) {
            if (!document.getElementById('deliveryAddress').value.trim()) {
                showConfirmationModal('Address Required', 'Please enter your delivery address.');
                return;
            }
            document.getElementById('checkoutAddress').textContent = document.getElementById('deliveryAddress').value;
            const checkoutItems = document.getElementById('checkoutItems');
            checkoutItems.innerHTML = medicineCart.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                    <div><strong>${item.name}</strong><br><small>Quantity: ${item.quantity}</small></div>
                    <div style="font-weight: 600;">₹${(item.price * item.quantity).toFixed(2)}</div>
                </div>`).join('');
            const total = medicineCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('checkoutTotal').textContent = `₹${total.toFixed(2)}`;
        }
        if (checkoutStep < 4) showCheckoutStep(checkoutStep + 1);
    };

    window.prevCheckoutStep = () => {
        if (checkoutStep > 1) showCheckoutStep(checkoutStep - 1);
    };

    // --- Payment Form Logic ---
    const showPaymentForm = (method) => {
        document.getElementById('cardPaymentForm').style.display = 'none';
        document.getElementById('upiPaymentForm').style.display = 'none';
        document.getElementById('netbankingForm').style.display = 'none';
        const form = document.getElementById(`${method}PaymentForm`);
        if (form) form.style.display = 'block';
    };

    window.formatCardNumber = (input) => {
        input.value = input.value.replace(/\s/g, '').replace(/(\d{4})/g, '$1 ').trim();
        document.getElementById('previewCardNumber').textContent = input.value || '•••• •••• •••• ••••';
    };

    window.formatExpiryDate = (input) => {
        input.value = input.value.replace(/\D/g, '').replace(/(\d{2})(\d)/, '$1/$2').slice(0, 5);
        document.getElementById('previewExpiryDate').textContent = input.value || '••/••';
    };

    window.setUpiId = (app) => {
        const phone = '9876543210'; // Example phone number
        const suffix = { paytm: '@paytm', gpay: '@oksbi', phonepe: '@ybl' }[app];
        document.getElementById('upiId').value = phone + suffix;
    };

    // A simple validation placeholder
    const validatePaymentForm = (method) => {
        // In a real app, you'd have robust validation here
        if (method === 'card' && document.getElementById('cardNumber').value.length < 19) {
            showConfirmationModal('Invalid Card', 'Please enter a valid 16-digit card number.');
            return false;
        }
        if (method === 'upi' && !document.getElementById('upiId').value.includes('@')) {
            showConfirmationModal('Invalid UPI', 'Please enter a valid UPI ID.');
            return false;
        }
        return true;
    };

    // --- Order Placement ---
    window.processPayment = async () => {
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        if (!validatePaymentForm(paymentMethod)) return;

        const processBtn = document.querySelector('#checkoutStep3 .btn-primary');
        processBtn.textContent = 'Processing...';
        processBtn.disabled = true;

        await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate API call

        placeOrder(); // Place order on successful payment simulation

        processBtn.textContent = 'Proceed to Pay';
        processBtn.disabled = false;
    };

    const placeOrder = async () => {
                // Check for user authentication first
                if (!user || !user.patientId) {
                    showConfirmationModal('Login Required', 'You must be logged in to place an order.');
                    return;
                }
                // Check if a pharmacy is selected
                if (!selectedPharmacy || !selectedPharmacy.id) {
                    showConfirmationModal('Pharmacy Not Selected', 'Please select a pharmacy before placing an order.');
                    return;
                }

                const orderData = {
                    pharmacyId: selectedPharmacy.id, // The backend expects pharmacyId
                    items: medicineCart.map(item => ({ name: item.name, price: item.price, quantity: item.quantity })),
                    deliveryAddress: document.getElementById('deliveryAddress').value.trim(),
                    paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/v1/orders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include', // Important: Sends the session cookie for authentication
                        body: JSON.stringify(orderData)
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Use the REAL order details from the backend for the confirmation screen
                        const newOrder = {
                            id: result.orderId,
                            items: [...medicineCart],
                            total: result.totalAmount,
                            status: 'Order Placed',
                            date: new Date().toISOString(),
                            pharmacyName: selectedPharmacy.name
                        };
                        appData.orders.unshift(newOrder); // Add to local data for immediate UI update

                        // Add to health record timeline
                        appData.records.unshift({
                            date: newOrder.date.split('T')[0],
                            title: `Medicine Order - ${selectedPharmacy.name}`,
                            description: `Ordered ${medicineCart.length} items. Order ID: ${result.orderId}`
                        });

                        // Show confirmation screen using data from the backend
                        document.getElementById('orderIdDisplay').textContent = result.orderId;
                        document.getElementById('deliveryTimeDisplay').textContent = result.estimatedDelivery;
                        showCheckoutStep(4);

                        // Reset and update UI
                        medicineCart = [];
                        updateCartIcon();
                        generateTimeline();
                        generateOrdersList();
                    } else {
                        throw new Error(result.message || 'Failed to place order.');
                    }
                } catch (error) {
                    console.error('Order placement error:', error);
                    showConfirmationModal('Order Failed', `There was an error placing your order: ${error.message}`);
                }
            };
    
    window.trackOrder = () => {
        document.getElementById('checkoutModal').classList.remove('active');
        showCheckoutStep(1); // Reset modal for next time
        showScreen('trackOrdersScreen');
    };
    
    // --- Initial Setup & Event Listeners ---
    
    // Event listener for category card clicks
    document.querySelectorAll('.category-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            searchInput.value = '';
            renderMedicines(card.dataset.category);
        });
    });
    
    // Event listener for the search input
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        if (searchTerm.length > 0) {
            document.querySelectorAll('.category-card').forEach(c => c.classList.remove('selected'));
            const allMedicines = Object.values(appData.medicines).flat();
            const filteredMedicines = allMedicines.filter(med => med.name.toLowerCase().includes(searchTerm));
            renderMedicines(filteredMedicines, true);
        } else {
            const firstCategoryCard = document.querySelector('.category-card');
            if(firstCategoryCard) {
                firstCategoryCard.classList.add('selected');
                renderMedicines(firstCategoryCard.dataset.category);
            }
        }
    });

    changePharmacyBtn.addEventListener('click', resetAndShowPharmacies);

    document.querySelector('.cart-icon').addEventListener('click', () => {
        updateCartModal();
        document.getElementById('cartModal').classList.add('active');
    });

    document.getElementById('cartModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) e.currentTarget.classList.remove('active');
    });
    
    document.getElementById('checkoutModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            e.currentTarget.classList.remove('active');
            showCheckoutStep(1);
        }
    });

    document.getElementById('proceedToCheckoutBtn').addEventListener('click', () => {
        if (medicineCart.length === 0) {
            showConfirmationModal('Cart Empty', 'Please add items to your cart.');
            return;
        }
        document.getElementById('cartModal').classList.remove('active');
        document.getElementById('checkoutModal').classList.add('active');
        showCheckoutStep(1);
    });
    
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', (e) => showPaymentForm(e.target.value));
    });

    // Initial function calls
    renderPharmacies();
    updateCartIcon();
    showPaymentForm('card'); // Default to showing the card form
}

            function setupScanMedicine() {
                const cameraFeed = document.getElementById('camera-feed');
                const openCameraBtn = document.getElementById('openCameraBtn');
                const scanCodeBtn = document.getElementById('scanCodeBtn');
                const cameraStatus = document.getElementById('camera-status');
                let stream = null;

                openCameraBtn.addEventListener('click', async () => {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                        cameraFeed.srcObject = stream;
                        await cameraFeed.play();
                        cameraStatus.textContent = "Camera is active. Point camera at medicine packaging and click 'Scan Medicine'.";
                        openCameraBtn.disabled = true;
                        scanCodeBtn.disabled = false;
                        scanCodeBtn.textContent = "Scan Medicine";
                    } catch (err) {
                        cameraStatus.textContent = "Could not access camera. Please check permissions.";
                        console.error("Camera error:", err);
                    }
                });

                scanCodeBtn.addEventListener('click', async () => {
                    if (!stream) return;

                    // Create canvas to capture image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = cameraFeed.videoWidth;
                    canvas.height = cameraFeed.videoHeight;
                    ctx.drawImage(cameraFeed, 0, 0);

                    // Get base64 image
                    const imageData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

                    cameraStatus.textContent = "Scanning medicine...";
                    scanCodeBtn.disabled = true;

                    try {
                        const response = await fetch(`${API_BASE_URL}/v1/scan-medicine`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ imageData: imageData, message: "Scan this medicine packaging" })
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            showConfirmationModal("Scan Successful", `Medicine Information: ${data.medicine_info}`);
                        } else {
                            showConfirmationModal("Scan Failed", data.error || "Could not identify the medicine.");
                        }
                    } catch (error) {
                        console.error('Scan error:', error);
                        showConfirmationModal("Scan Failed", "Network error. Please try again.");
                    } finally {
                        cameraStatus.textContent = "Camera is active. Point camera at medicine packaging and click 'Scan Medicine'.";
                        scanCodeBtn.disabled = false;
                    }
                });
            }
            
            

            function setupUploadPrescription() {
                const cameraFeed = document.getElementById('uploadCameraFeed');
                const openCameraBtn = document.getElementById('openUploadCameraBtn');
                const captureBtn = document.getElementById('capturePrescriptionBtn');
                const cameraStatus = document.getElementById('uploadCameraStatus');
                let stream = null;

                openCameraBtn.addEventListener('click', async () => {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                        cameraFeed.srcObject = stream;
                        await cameraFeed.play();
                        cameraStatus.textContent = "Camera is active. Point camera at prescription and click 'Save Prescription'.";
                        openCameraBtn.disabled = true;
                        captureBtn.disabled = false;
                    } catch (err) {
                        cameraStatus.textContent = "Could not access camera. Please check permissions.";
                        console.error("Camera error:", err);
                    }
                });

                captureBtn.addEventListener('click', async () => {
                    const providerName = document.getElementById('providerName').value.trim();
                    if (!providerName) {
                        alert('Please enter the provider name.');
                        return;
                    }
                    if (!stream) return;
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = cameraFeed.videoWidth;
                    canvas.height = cameraFeed.videoHeight;
                    ctx.drawImage(cameraFeed, 0, 0);
                    const imageData = canvas.toDataURL('image/jpeg', 0.8);

                    try {
                        // Send to backend
                        const response = await fetch(`${API_BASE_URL}/v1/upload-prescription`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: user.patientId,
                                providerName: providerName,
                                imageData: imageData
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to upload to backend');
                        }

                        const uploadResult = await response.json();
                        const extracted = uploadResult.extractedData || {};

                        
                       
                       // --- NEW LOGIC ---
                        // Check if the upload response includes our summary text
                        if (uploadResult.success && uploadResult.formatted_response) {
                            // Directly display the summary we just received
                            displaySummaryInChat(uploadResult.formatted_response);
                        }
                        // --- END NEW LOGIC ---

                        // Refresh the prescriptions list from backend
                        await generateAllPrescriptions();
                        showConfirmationModal("Prescription Added", "Your offline prescription has been added successfully.");
                    } catch (error) {
                        console.error('Upload error:', error);
                        showConfirmationModal("Upload Failed", "Failed to save prescription. Please try again.");
                    }

                    // Stop stream
                    stream.getTracks().forEach(track => track.stop());
                    document.getElementById('uploadPrescriptionModal').classList.remove('active');
                    document.getElementById('providerName').value = '';
                });
            }

            // Enhanced Chatbot with Smart Button Management
            class SmartSehatSaharaChatbot {
                constructor() {
                    this.chatWindow = document.getElementById('chatWindow');
                    this.currentButtons = [];
                    this.buttonHistory = new Set(); // Track shown buttons to avoid repeats
                    this.userProgress = {};
                    this.lastUserMessage = '';
                    this.currentBookingStep = null;
                    this.bookingContext = {};
                }

                // In patient.html, inside the SmartSehatSaharaChatbot class

                async handleChatbotResponse(response) {
                    this.displayMessage(response.response, 'bot');
                    this.clearButtons(); // Always clear old buttons first
                    // If booking was successful, refresh the appointments list on the page
                    if (response.action === 'BOOKING_SUCCESS') {
                     await generateAppointments();
                     }

                    // Priority 1: If the AI provides buttons from the backend, show them.
                    // This is essential for the multi-step booking flow.
                    if (response.interactive_buttons && response.interactive_buttons.length > 0) {
                        this.showInteractiveButtons(response.interactive_buttons);
                        return;
                    }

                    const intent = response.intent;

                    // Priority 2: If the intent is a general greeting or inquiry, show the clean help buttons.
                    // This calls the CORRECT function inside the class.
                    if (intent === 'general_inquiry') {
                        this.showGeneralHelpButtons(); // This now correctly calls the class method.
                        return;
                    }

                    // Priority 3: Show specific, contextual buttons for Scan/Upload intents.
                    const contextualButtons = [];
                    if (intent === 'medicine_scan' || intent === 'how_to_medicine_scan') {
                        contextualButtons.push({
                            text: '📷 Scan Medicine',
                            action: 'START_MEDICINE_SCANNER',
                            style: 'secondary'
                        });
                    }
                    if (intent === 'prescription_upload' || intent === 'how_to_prescription_upload') {
                        contextualButtons.push({
                            text: '📤 Upload Prescription',
                            action: 'UPLOAD_PRESCRIPTION',
                            style: 'primary'
                        });
                    }
                    
                    if (contextualButtons.length > 0) {
                        this.showInteractiveButtons(contextualButtons);
                    }
                }


                // In patient.html, inside the SmartSehatSaharaChatbot class

                async handleButtonClick(button) {
    console.log('Button clicked:', button.action, button.text, button.parameters);

    // Define actions that should continue the conversation in the chat window
    const conversationalActions = [
        'SELECT_SPECIALTY', 'SELECT_DOCTOR', 'SELECT_DATE', 
        'SELECT_TIME', 'SELECT_MODE'
    ];

    if (conversationalActions.includes(button.action)) {
        // For conversational actions, send the selection back to the backend
        // This simulates the user typing their choice.
        this.displayMessage(button.text, 'user'); // Show the user's choice immediately
        this.clearButtons(); // Remove buttons after selection

        // Send a request to the backend with the button's action and parameters
        await this.sendPredictRequest(button.text, button.action, button.parameters);
        return; // Stop further processing
    }

    // Handle simple NAVIGATION actions as before.
    switch (button.action) {
        case 'START_MEDICINE_SCANNER':
        case 'SCAN_MEDICINE':
            showScreen('scanMedicineScreen');
            break;
        case 'UPLOAD_PRESCRIPTION':
            document.getElementById('uploadPrescriptionModal').classList.add('active');
            break;
        default:
            console.warn(`Unhandled navigation action: ${button.action}`);
            break;
    }

    // Log the click in the background (no changes needed here).
    try {
        await fetch(`${API_BASE_URL}/v1/button-action`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: user.patientId, buttonAction: button.action })
        });
    } catch (error) { console.error('Button action API error:', error); }

    this.clearButtons();
}
// Add this new helper function inside the SmartSehatSaharaChatbot class
async sendPredictRequest(message, buttonAction = null, parameters = null) {
    const chatWindow = document.getElementById('chatWindow');
    const typingIndicator = document.createElement('div');
    typingIndicator.classList.add('chat-message', 'bot-message');
    typingIndicator.textContent = 'Typing...';
    chatWindow.appendChild(typingIndicator);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    try {
        const payload = {
            message: message,
            userId: user.patientId,
            language: currentLanguage
        };
        if (buttonAction) {
            payload.buttonAction = buttonAction;
            payload.parameters = parameters;
        }

        const response = await fetch(`${API_BASE_URL}/v1/predict`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`HTTP Error: ${response.status}`);
        }

        const data = await response.json();
        chatWindow.removeChild(typingIndicator);
        await this.handleChatbotResponse(data);

    } catch (error) {
        console.error('Chat Error:', error);
        chatWindow.removeChild(typingIndicator);
        this.displayMessage("I'm sorry, I'm having trouble connecting. Please try again.", 'bot');
    }
}





                showInteractiveButtons(buttons) {
                    this.clearButtons();
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'interactive-buttons-container';

                    buttons.forEach(button => {
                        const buttonElement = this.createButton(button);
                        buttonsContainer.appendChild(buttonElement);
                    });

                    if (this.chatWindow) {
                        this.chatWindow.appendChild(buttonsContainer);
                        // *** THIS IS THE FIX: Use a short timeout to scroll after the DOM updates ***
                        setTimeout(() => {
                            this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
                        }, 50);
                    }
                    this.currentButtons = buttons;
                }

                createButton(button) {
                    const buttonElement = document.createElement('button');
                    buttonElement.textContent = button.text;
                    buttonElement.className = `btn btn-${button.style === 'primary' ? 'primary' : 'secondary'}`;
                    buttonElement.style.cssText = `
                        padding: 10px 20px;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        margin: 5px;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    `;

                    // Set button color based on style with enhanced gradients
                    if (button.style === 'primary') {
                        buttonElement.style.background = 'linear-gradient(45deg, #0d9488, #14b8a6)';
                        buttonElement.style.color = 'white';
                        buttonElement.style.boxShadow = '0 4px 15px rgba(13, 148, 136, 0.3)';
                    } else {
                        buttonElement.style.background = 'linear-gradient(45deg, #64748b, #94a3b8)';
                        buttonElement.style.color = 'white';
                        buttonElement.style.boxShadow = '0 4px 15px rgba(100, 116, 139, 0.3)';
                    }

                    // Add hover effects
                    buttonElement.addEventListener('mouseenter', () => {
                        if (!buttonElement.disabled) {
                            buttonElement.style.transform = 'translateY(-2px)';
                            buttonElement.style.boxShadow = button.style === 'primary'
                                ? '0 6px 20px rgba(13, 148, 136, 0.4)'
                                : '0 6px 20px rgba(100, 116, 139, 0.4)';
                        }
                    });

                    buttonElement.addEventListener('mouseleave', () => {
                        if (!buttonElement.disabled) {
                            buttonElement.style.transform = 'translateY(0)';
                            buttonElement.style.boxShadow = button.style === 'primary'
                                ? '0 4px 15px rgba(13, 148, 136, 0.3)'
                                : '0 4px 15px rgba(100, 116, 139, 0.3)';
                        }
                    });

                    // Handle button click with enhanced conversational booking support
                    buttonElement.addEventListener('click', async (event) => {
                        event.preventDefault();
                        event.stopPropagation();

                        // Handle different button actions
                        if (button.action === 'NAVIGATE_TO_APPOINTMENT_BOOKING') {
                            // Check if user wants conversational booking or direct navigation
                            const userMessage = this.lastUserMessage || '';
                            if (userMessage.toLowerCase().includes('book appointment') ||
                                userMessage.toLowerCase().includes('appointment book') ||
                                userMessage.toLowerCase().includes('need appointment') ||
                                userMessage.toLowerCase().includes('want appointment')) {
                                // Use conversational booking for explicit appointment requests
                                await this.handleConversationalBooking(button);
                            } else {
                                // Use direct navigation for other cases (like general help buttons)
                                this.handleButtonClick(button);
                            }
                        } else {
                            this.handleButtonClick(button);
                        }
                    });

                    return buttonElement;
                }

                async handleConversationalBooking(button) {
                    try {
                        console.log('Starting conversational booking...');

                        // Show loading state
                        const originalText = button.text;
                        button.text = 'Loading...';
                        button.disabled = true;

                        const response = await fetch(`${API_BASE_URL}/v1/conversational-booking`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: user.patientId,
                                action: 'start'
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const data = await response.json();

                        if (data.success) {
                            // Display the AI response
                            this.displayMessage(data.response, 'bot');

                            // Show interactive buttons if provided
                            if (data.interactive_buttons && data.interactive_buttons.length > 0) {
                                this.showInteractiveButtons(data.interactive_buttons);
                            }

                            // Handle different conversational booking actions
                            if (data.action === 'SELECT_DOCTOR_TYPE') {
                                this.currentBookingStep = 'select_doctor_type';
                                this.bookingContext = {};
                            }
                        } else {
                            this.displayMessage('Sorry, I had trouble starting the booking process. Please try again.', 'bot');
                        }

                    } catch (error) {
                        console.error('Conversational booking error:', error);
                        this.displayMessage('Sorry, I had trouble connecting to the booking system. Please try again.', 'bot');
                    } finally {
                        // Reset button state
                        button.text = originalText;
                        button.disabled = false;
                    }
                }

                // In patient.html, inside the SmartSehatSaharaChatbot class



                clearButtons() {
                    const existingButtons = document.querySelector('.interactive-buttons-container');
                    if (existingButtons) {
                        existingButtons.remove();
                    }
                    this.currentButtons = [];
                    // Scroll to bottom after clearing buttons
                    if (this.chatWindow) {
                        this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
                    }
                }

                displayMessage(message, sender = 'bot') {
                    if (!this.chatWindow) return;

                    const messageElement = document.createElement('div');
                    messageElement.className = `chat-message ${sender}-message`;

                    // Enhanced message formatting for guidance messages
                    if (sender === 'bot' && message.includes('💡')) {
                        messageElement.style.background = 'linear-gradient(135deg, #e3f2fd, #f8f9fa)';
                        messageElement.style.border = '1px solid #0d9488';
                        messageElement.style.borderRadius = '12px';
                        messageElement.style.padding = '16px';
                        messageElement.style.margin = '12px 0';
                    }

                    // Handle multi-line messages with better formatting
                    if (message.includes('\n')) {
                        messageElement.innerHTML = message.replace(/\n/g, '<br>');
                    } else {
                        messageElement.textContent = message;
                    }

                    this.chatWindow.appendChild(messageElement);
                    this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
                }

                async handleAction(action, parameters) {
                    switch (action) {
                        case 'Maps_TO_APPOINTMENT_BOOKING':
                            // Don't redirect immediately - show button instead
                            console.log('Appointment booking intent detected - showing button');
                            break;
                        case 'TRIGGER_SOS':
                            this.displayMessage('🚨 Emergency services activated! Calling 108...', 'bot');
                            setTimeout(() => {
                                window.location.href = 'tel:108';
                            }, 2000);
                            break;
                        case 'CONTINUE_FOLLOWUP':
                            // Check if post-appointment follow-up is needed
                            await this.checkPostAppointmentFollowup();
                            break;
                        case 'SHOW_PRESCRIPTION_SUMMARY':
                            // Don't redirect immediately - show button instead
                            console.log('Prescription inquiry detected - showing button');
                            break;
                    }
                }

                async checkPostAppointmentFollowup() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/v1/user-progress`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId: user.patientId })
                        });

                        const data = await response.json();
                        if (data.followup && data.followup.needed) {
                            this.displayMessage('How are you feeling after your appointment?', 'bot');
                        }
                    } catch (error) {
                        console.error('Follow-up check error:', error);
                    }
                }

                showGeneralHelpButtons() {
                    const generalButtons = [
                        {
                            type: 'medicine_scan',
                            text: '📷 Scan Medicine',
                            action: 'START_MEDICINE_SCANNER',
                            style: 'secondary'
                        },
                        {
                            type: 'prescription_upload',
                            text: '📤 Upload Prescription',
                            action: 'UPLOAD_PRESCRIPTION',
                            style: 'secondary'
                        },
                        {
                            type: 'prescription_view',
                            text: '📋 View Prescriptions',
                            action: 'SHOW_PRESCRIPTION_SUMMARY',
                            style: 'secondary'
                        }
                    ];

                    this.showInteractiveButtons(generalButtons);
                    this.displayMessage('💡 Here are the main features I can help you with:', 'bot');
                }

                showAppointmentGuidance() {
                    const guidanceDiv = document.createElement('div');
                    guidanceDiv.className = 'guidance-message';
                    guidanceDiv.style.cssText = `
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 1rem;
                        border-radius: 12px;
                        margin: 0.5rem 0;
                        border-left: 4px solid #047857;
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    `;
                    guidanceDiv.innerHTML = `
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">📅 How to Book an Appointment</h4>
                        <ol style="margin: 0; padding-left: 1.2rem; line-height: 1.6;">
                            <li>Select doctor type (General Physician, Cardiologist, etc.)</li>
                            <li>Choose your preferred doctor from the list</li>
                            <li>Pick a convenient date and time slot</li>
                            <li>Select consultation mode (Video/Audio/In-person)</li>
                            <li>Confirm your booking and get confirmation</li>
                        </ol>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                            💡 You can also say "book cardiologist" for specific specialists!
                        </p>
                    `;
                    this.chatWindow.appendChild(guidanceDiv);
                    this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
                }


                showMedicineScanGuidance() {
                    const guidanceDiv = document.createElement('div');
                    guidanceDiv.className = 'guidance-message';
                    guidanceDiv.style.cssText = `
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 1rem;
                        border-radius: 12px;
                        margin: 0.5rem 0;
                        border-left: 4px solid #047857;
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    `;
                    guidanceDiv.innerHTML = `
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">📷 How to Scan Medicine</h4>
                        <ol style="margin: 0; padding-left: 1.2rem; line-height: 1.6;">
                            <li>Allow camera access when prompted</li>
                            <li>Point camera at medicine packaging or pill</li>
                            <li>Hold steady for 2-3 seconds while AI analyzes</li>
                            <li>Get medicine name, dosage, and usage info</li>
                            <li>Find nearby pharmacies that stock it</li>
                        </ol>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                            💡 Works with any medicine packaging, tablets, or capsules!
                        </p>
                    `;
                    this.chatWindow.appendChild(guidanceDiv);
                    this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
                }


                showPrescriptionGuidance() {
                    const guidanceDiv = document.createElement('div');
                    guidanceDiv.className = 'guidance-message';
                    guidanceDiv.style.cssText = `
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        padding: 1rem;
                        border-radius: 12px;
                        margin: 0.5rem 0;
                        border-left: 4px solid #047857;
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    `;
                    guidanceDiv.innerHTML = `
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">📋 How to Upload/View Prescriptions</h4>
                        <ol style="margin: 0; padding-left: 1.2rem; line-height: 1.6;">
                            <li>Take a clear photo of your prescription</li>
                            <li>Upload the image using the camera button</li>
                            <li>AI will extract medicine details automatically</li>
                            <li>Set up automatic medicine reminders</li>
                            <li>Track your medication schedule</li>
                        </ol>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                            💡 Both doctor prescriptions and your uploads are stored securely!
                        </p>
                    `;
                    this.chatWindow.appendChild(guidanceDiv);
                    this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
                }


                showEmergencyGuidance() {
                    this.displayMessage('🚨 **EMERGENCY DETECTED!**\n\n**Immediate action being taken:**\n• 📞 Calling emergency services (108)\n• 🏥 Connecting you to medical help\n• ⏱️ Help is on the way!\n\n**What to do now:**\n• Stay calm and stay on the line\n• Tell them your location and condition\n• Follow their instructions\n\n*Calling 108 in 1 second...*', 'bot');
                }
            }

            // Initialize enhanced chatbot
            const enhancedChatbot = new SmartSehatSaharaChatbot();

            

            // --- FIX START ---
            // The addMessage function is moved here, to a higher scope, so the event listener can find it.
            const chatWindow = document.getElementById('chatWindow');
            const addMessage = (text, sender) => {
                const msgEl = document.createElement('div');
                msgEl.classList.add('chat-message', `${sender}-message`);
                msgEl.textContent = text;
                chatWindow.appendChild(msgEl);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            };
            // --- FIX END ---

            function setupChatbot() {
                const chatForm = document.getElementById('chatForm');
                const chatInput = document.getElementById('chatInput');
                // The 'addMessage' function is NO LONGER defined here.

                // This is your FULL original event listener, now it works correctly.
                chatForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userInput = chatInput.value.trim();
                    if (!userInput) return;

                    // Store the last user message for contextual button generation
                    enhancedChatbot.lastUserMessage = userInput;

                    console.log('Frontend: Sending message:', userInput, 'userId:', user.patientId);
                    addMessage(userInput, 'user'); // This call now works
                    chatInput.value = '';

                    const typingIndicator = document.createElement('div');
                    typingIndicator.classList.add('chat-message', 'bot-message');
                    typingIndicator.textContent = 'Typing...';
                    chatWindow.appendChild(typingIndicator);
                    chatWindow.scrollTop = chatWindow.scrollHeight;

                    try {
                        // Your SOS check logic is preserved
                        const sosCheck = await checkForEmergency(userInput);
                        if (sosCheck.emergency_detected) {
                            chatWindow.removeChild(typingIndicator);

                            // Show SOS alert
                            const sosAlert = document.createElement('div');
                            sosAlert.className = 'sos-alert';
                            sosAlert.innerHTML = `
                                <h3>🚨 EMERGENCY DETECTED!</h3>
                                <p>${sosCheck.response}</p>
                                <p><strong>Emergency Number: 108</strong></p>
                            `;
                            chatWindow.appendChild(sosAlert);

                            // Auto-dial for critical emergencies
                            if (sosCheck.critical && sosCheck.parameters.auto_dial) {
                                setTimeout(() => {
                                    window.location.href = `tel:${sosCheck.parameters.emergency_number}`;
                                }, 3000);
                            }

                            chatWindow.scrollTop = chatWindow.scrollHeight;
                            chatInput.value = '';
                            return;
                        }

                        // Your original predict call is preserved
                        const response = await fetch(`${API_BASE_URL}/v1/predict`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: userInput,
                                userId: user.patientId,
                                language: currentLanguage
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP Error: ${response.status}`);
                        }

                        const data = await response.json();
                        chatWindow.removeChild(typingIndicator);

                        // Use enhanced chatbot handler
                        await enhancedChatbot.handleChatbotResponse(data);

                    } catch (error) {
                        console.error('Chat Error:', error);
                        chatWindow.removeChild(typingIndicator);
                        addMessage("I'm sorry, I'm having trouble connecting right now. Please try again in a moment.", 'bot');
                    }
                });

                // The rest of your function is also preserved
                addMessage("Welcome to Enhanced Sehat Sahara! I can help with appointments, prescriptions, medicine reminders, and health guidance.", "bot");

                checkMedicineReminders();
                //loadPrescriptionReminders();
                setTimeout(() => {
                    showAllPrescriptionSources();
                }, 2000);
                testPrescriptionEndpoint();
            }

            // WebRTC variables
            let localStream;
            let peerConnection;
            let dataChannel;
            let isAudioMuted = false;
            let isVideoMuted = false;
            let currentAppointmentId = null;
            let iceCandidateQueue = [];
            let offerQueue = [];
            let isCallActive = false;
            let isInitiator = false; // Role assignment for collision resolution
            let retryCount = 0;
            let maxRetries = 3;
            let retryDelay = 1000; // Start with 1 second

            // Enhanced WebRTC configuration with multiple STUN/TURN servers
            const configuration = {
                iceServers: [
                    // STUN servers for NAT traversal
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' },

                    // TURN servers for fallback when STUN fails
                    {
                        urls: 'turn:openrelay.metered.ca:80',
                        username: 'openrelayproject',
                        credential: 'openrelayproject'
                    },
                    {
                        urls: 'turn:openrelay.metered.ca:443',
                        username: 'openrelayproject',
                        credential: 'openrelayproject'
                    },
                    {
                        urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                        username: 'openrelayproject',
                        credential: 'openrelayproject'
                    }
                ],
                iceCandidatePoolSize: 10,
                bundlePolicy: 'max-bundle',
                rtcpMuxPolicy: 'require'
            };

            function showCallScreen(doctorName, appointmentId) {
                currentAppointmentId = appointmentId;
                document.getElementById('callWithDoctor').textContent = `Consultation with ${doctorName}`;
                document.getElementById('callScreen').classList.add('active');

                // Hide any existing connection status when showing call screen
                hideConnectionStatus();

                initializeWebRTC();
            }

            async function initializeWebRTC() {
                try {
                    console.log('Patient: Initializing WebRTC...');

                    // Check if WebRTC is supported
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('WebRTC is not supported in this browser');
                    }

                    // Show loading state
                    showConnectionStatus('Requesting camera and microphone permissions...', 'info');

                    // Request camera and microphone permissions with better constraints
                    const constraints = {
                        video: {
                            width: { ideal: 640, max: 1280 },
                            height: { ideal: 480, max: 720 },
                            facingMode: "user"
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    };

                    console.log('Patient: Requesting media permissions...');
                    localStream = await navigator.mediaDevices.getUserMedia(constraints);

                    console.log('Patient: Media permissions granted, setting up video...');
                    const localVideo = document.getElementById('localVideo');
                    if (localVideo) {
                        localVideo.srcObject = localStream;
                        try {
                            await localVideo.play();
                            console.log('Patient: Local video playing successfully');
                        } catch (playError) {
                            console.warn('Patient: Local video play failed:', playError);
                            // Continue anyway, the video element might still work
                        }
                    }

                    // Wait a bit before creating peer connection to avoid race conditions
                    await new Promise(resolve => setTimeout(resolve, 500));

                    createPeerConnection();
                    isCallActive = true;
                    console.log('Patient: WebRTC initialized successfully');

                    // Update status
                    showConnectionStatus('WebRTC ready. Click "Start Call" to begin.', 'success');

                } catch (error) {
                    console.error('Patient: Error accessing media devices:', error);

                    let errorMessage = 'Could not access camera/microphone. ';

                    if (error.name === 'NotAllowedError') {
                        errorMessage += 'Please allow camera and microphone permissions and try again.';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += 'No camera or microphone found.';
                    } else if (error.name === 'NotSupportedError') {
                        errorMessage += 'WebRTC is not supported in this browser. Please use Chrome, Firefox, or Safari.';
                    } else if (error.name === 'NotReadableError') {
                        errorMessage += 'Camera or microphone is already in use by another application.';
                    } else {
                        errorMessage += 'Please check your camera and microphone permissions.';
                    }

                    showConnectionStatus(errorMessage, 'error');
                    throw error; // Re-throw to be handled by caller
                }
            }

            function createPeerConnection() {
                try {
                    console.log('Creating peer connection...');
                    peerConnection = new RTCPeerConnection(configuration);

                    // Add local stream tracks
                    if (localStream) {
                        localStream.getTracks().forEach(track => {
                            console.log('Adding track:', track.kind);
                            peerConnection.addTrack(track, localStream);
                        });
                    }

                    // Handle remote stream
                    peerConnection.ontrack = event => {
                        console.log('Patient: Received remote stream from doctor', event.streams[0]);
                        console.log('Patient: Stream tracks:', event.streams[0].getTracks());

                        const remoteVideo = document.getElementById('remoteVideo');
                        if (remoteVideo && event.streams[0]) {
                            // Check if srcObject is already set to avoid unnecessary changes
                            if (remoteVideo.srcObject !== event.streams[0]) {
                                console.log('Patient: Attaching remote stream to video element');
                                remoteVideo.srcObject = event.streams[0];
                            }

                            // More robust play method to handle race conditions and autoplay policies
                            const playVideo = async (videoElement, retryCount = 0) => {
                                try {
                                    console.log('Patient: Attempting to play remote video, attempt:', retryCount + 1);

                                    // Wait for the srcObject to be fully loaded
                                    await new Promise(resolve => setTimeout(resolve, 200));

                                    if (!videoElement) {
                                        console.error('Patient: Video element not found');
                                        return;
                                    }

                                    // Check if video is already playing
                                    if (!videoElement.paused && !videoElement.ended) {
                                        console.log('Patient: Remote video is already playing');
                                        showConnectionStatus('Remote video connected and playing!', 'success');
                                        return;
                                    }

                                    // Try to play the video
                                    await videoElement.play();
                                    console.log('Patient: Remote video playing successfully');

                                    // Update UI to show video is connected
                                    showConnectionStatus('Remote video connected and playing!', 'success');

                                    // Update button text
                                    const startCallBtn = document.getElementById('startCallBtn');
                                    if (startCallBtn) {
                                        startCallBtn.textContent = 'Call Active';
                                    }

                                } catch (e) {
                                    console.warn('Patient: Remote video play failed:', e);

                                    if (e.name === 'NotAllowedError') {
                                        console.error('Patient: Video autoplay blocked by browser policy');
                                        showConnectionStatus('Video autoplay blocked. Click to enable video.', 'warning');

                                        // Add click handler to enable video
                                        videoElement.addEventListener('click', () => {
                                            videoElement.play().then(() => {
                                                console.log('Patient: Video enabled by user click');
                                                showConnectionStatus('Video enabled successfully!', 'success');
                                            }).catch(err => console.error('Patient: Failed to enable video:', err));
                                        }, { once: true });

                                    } else if (e.name === 'AbortError' && retryCount < 3) {
                                        console.log('Patient: Video play aborted, retrying...');
                                        setTimeout(() => playVideo(videoElement, retryCount + 1), 500);
                                    } else {
                                        console.error('Patient: Remote video play failed permanently:', e);
                                        showConnectionStatus('Video connection issue: ' + e.message, 'error');
                                    }
                                }
                            };

                            playVideo(remoteVideo);
                        } else {
                            console.error('Patient: Remote video element or stream not found');
                        }
                    };

                    // Handle connection state changes
                    peerConnection.onconnectionstatechange = () => {
                        console.log('Patient: Connection state changed to:', peerConnection.connectionState);
                        console.log('Patient: Signaling state:', peerConnection.signalingState);

                        if (peerConnection.connectionState === 'connected') {
                            console.log('Patient: Connected to doctor successfully');
                            showConnectionStatus('Connected successfully!', 'success');
                            // Update UI to show connected state
                            const startCallBtn = document.getElementById('startCallBtn');
                            if (startCallBtn) {
                                startCallBtn.textContent = 'Connected';
                                startCallBtn.disabled = true;
                            }
                        } else if (peerConnection.connectionState === 'failed') {
                            console.error('Patient: Connection failed');
                            showConnectionStatus('Connection failed. Please try again.', 'error');
                            handleConnectionFailure();
                        } else if (peerConnection.connectionState === 'connecting') {
                            console.log('Patient: Attempting to connect...');
                            showConnectionStatus('Connecting to doctor...', 'info');
                        } else if (peerConnection.connectionState === 'new') {
                            console.log('Patient: New connection state');
                            hideConnectionStatus();
                        } else if (peerConnection.connectionState === 'disconnected') {
                            console.log('Patient: Disconnected from doctor');
                            showConnectionStatus('Reconnecting...', 'warning');
                            handlePeerDisconnection();
                        } else if (peerConnection.connectionState === 'closed') {
                            console.log('Patient: Connection closed');
                            hideConnectionStatus();
                        }
                    };

                    // Handle signaling state changes for debugging
                    peerConnection.onsignalingstatechange = () => {
                        console.log('Patient: Signaling state changed to:', peerConnection.signalingState);
                    };

                    // Enhanced track event debugging
                    peerConnection.onaddstream = event => {
                        console.log('Patient: Stream added:', event.stream);
                        console.log('Patient: Stream tracks:', event.stream.getTracks());
                    };

                    // Monitor track events for debugging
                    localStream.getTracks().forEach(track => {
                        track.onended = () => {
                            console.warn('Patient: Local track ended:', track.kind);
                            showConnectionStatus(`Local ${track.kind} track ended`, 'warning');
                        };
                        track.onmute = () => {
                            console.warn('Patient: Local track muted:', track.kind);
                        };
                        track.onunmute = () => {
                            console.log('Patient: Local track unmuted:', track.kind);
                        };
                    });

                    // Handle ICE connection state changes
                    peerConnection.oniceconnectionstatechange = () => {
                        console.log('ICE connection state:', peerConnection.iceConnectionState);
                        if (peerConnection.iceConnectionState === 'failed') {
                            console.error('ICE connection failed');
                            handleConnectionFailure();
                        } else if (peerConnection.iceConnectionState === 'disconnected') {
                            console.log('ICE connection disconnected');
                        }
                    };

                    // Handle ICE candidates
                    peerConnection.onicecandidate = event => {
                        if (event.candidate) {
                            console.log('Sending ICE candidate');
                            sendSignalingMessage('ice', event.candidate);
                        }
                    };

                    // Create data channel for messaging
                    try {
                        dataChannel = peerConnection.createDataChannel('messages');
                        dataChannel.onmessage = event => {
                            displayMessage(event.data, 'doctor');
                        };
                        dataChannel.onopen = () => console.log('Data channel opened');
                        dataChannel.onclose = () => console.log('Data channel closed');
                    } catch (error) {
                        console.warn('Failed to create data channel:', error);
                    }

                    // Handle incoming data channels
                    peerConnection.ondatachannel = event => {
                        console.log('Received data channel:', event.channel.label);
                        if (event.channel.label === 'messages') {
                            dataChannel = event.channel;
                            dataChannel.onmessage = event => {
                                displayMessage(event.data, 'doctor');
                            };
                        }
                    };

                    console.log('Peer connection created successfully');
                } catch (error) {
                    console.error('Error creating peer connection:', error);
                    alert('Failed to create video connection. Please refresh and try again.');
                }
            }

            async function startCall() {
                try {
                    if (!peerConnection) {
                        throw new Error('Peer connection not initialized');
                    }

                    if (!localStream) {
                        throw new Error('Local stream not available');
                    }

                    console.log('Patient: Starting call, current signaling state:', peerConnection.signalingState);
                    console.log('Patient: Current connection state:', peerConnection.connectionState);

                    // Check if we're already in a call or have an offer pending
                    if (peerConnection.signalingState !== 'stable') {
                        console.log('Patient: Not in stable state, cannot create offer. Current state:', peerConnection.signalingState);

                        // If we're in 'have-remote-offer' state, it means doctor initiated the call
                        if (peerConnection.signalingState === 'have-remote-offer') {
                            console.log('Patient: Doctor initiated the call, creating answer instead...');
                            return await answerCall();
                        }

                        console.log('Patient: Waiting for stable state before creating offer...');
                        return;
                    }

                    // Set initiator role
                    isInitiator = true;

                    console.log('Patient: Creating offer...');
                    const offer = await peerConnection.createOffer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: true
                    });

                    console.log('Patient: Setting local description...');
                    await peerConnection.setLocalDescription(offer);

                    console.log('Patient: Sending offer via signaling...');
                    await sendSignalingMessageWithRetry('offer', offer);

                    // Update UI
                    const startCallBtn = document.getElementById('startCallBtn');
                    if (startCallBtn) {
                        startCallBtn.disabled = true;
                        startCallBtn.textContent = 'Connecting...';
                    }

                    console.log('Patient: Call started successfully');
                } catch (error) {
                    console.error('Patient: Error starting call:', error);
                    console.error('Patient: Signaling state:', peerConnection.signalingState);
                    console.error('Patient: Connection state:', peerConnection.connectionState);

                    if (retryCount < maxRetries) {
                        retryCount++;
                        console.log(`Patient: Retrying call start (${retryCount}/${maxRetries}) in ${retryDelay}ms...`);
                        setTimeout(() => startCall(), retryDelay);
                        retryDelay *= 2; // Exponential backoff
                    } else {
                        console.error('Patient: Max retries reached, giving up');
                        alert('Failed to start call after multiple attempts. Please refresh and try again.');
                        retryCount = 0;
                        retryDelay = 1000;
                    }
                }
            }

            async function answerCall() {
                try {
                    if (!peerConnection) {
                        throw new Error('Peer connection not initialized');
                    }

                    console.log('Patient: Answering call, creating answer...');

                    const answer = await peerConnection.createAnswer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: true
                    });

                    console.log('Patient: Setting local description with answer...');
                    await peerConnection.setLocalDescription(answer);

                    console.log('Patient: Sending answer via signaling...');
                    sendSignalingMessage('answer', answer);

                    // Update UI
                    const startCallBtn = document.getElementById('startCallBtn');
                    if (startCallBtn) {
                        startCallBtn.disabled = true;
                        startCallBtn.textContent = 'Connected';
                    }

                    console.log('Patient: Answer sent successfully');
                } catch (error) {
                    console.error('Patient: Error answering call:', error);
                    alert('Failed to answer call: ' + error.message);
                }
            }

            async function handleSignalingMessage(type, data) {
                try {
                    console.log(`Patient: Handling ${type} signaling message`);
                    console.log(`Patient: Current signaling state: ${peerConnection?.signalingState}`);
                    console.log(`Patient: Current connection state: ${peerConnection?.connectionState}`);

                    if (!peerConnection) {
                        console.warn('Patient: Peer connection not initialized');
                        return;
                    }

                    if (type === 'offer') {
                        console.log('Patient: Received offer from doctor');

                        // Check if we're already handling an offer or in a call
                        if (peerConnection.signalingState === 'have-remote-offer') {
                            console.log('Patient: Already have a remote offer, ignoring duplicate');
                            return;
                        }

                        if (peerConnection.signalingState === 'have-local-offer') {
                            console.log('Patient: Collision detected - both peers trying to call');
                            console.log('Patient: Patient sent offer, doctor also sent offer');

                            // Implement proper collision resolution
                            // Since both sent offers, we need to decide who becomes the caller
                            // Use a simple deterministic approach based on appointment ID
                            const shouldBeCaller = currentAppointmentId.localeCompare('demo') <= 0;

                            if (shouldBeCaller) {
                                console.log('Patient: Patient becomes caller due to appointment ID priority');
                                // Patient becomes caller - ignore doctor's offer and continue with patient's offer
                                return;
                            } else {
                                console.log('Patient: Doctor becomes caller, patient becomes callee');
                                // Patient becomes callee - reset and accept doctor's offer
                                resetConnection();
                            }
                        }

                        console.log('Patient: Setting remote description with doctor\'s offer...');
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data));

                        console.log('Patient: Creating answer...');
                        const answer = await peerConnection.createAnswer();

                        console.log('Patient: Setting local description with answer...');
                        await peerConnection.setLocalDescription(answer);

                        console.log('Patient: Sending answer via signaling...');
                        sendSignalingMessage('answer', answer);

                        // Update UI to show we're connected
                        const startCallBtn = document.getElementById('startCallBtn');
                        if (startCallBtn) {
                            startCallBtn.textContent = 'Connected';
                            startCallBtn.disabled = true;
                        }

                        console.log('Patient: Successfully answered doctor\'s call');
                        return;
                    }
                    else if (type === 'answer') {
                        console.log('Patient: Received answer, checking if we can handle it...');

                        // Only accept answers if we have sent an offer and are waiting for an answer
                        if (peerConnection.signalingState === 'have-local-offer') {
                            console.log('Patient: Setting remote description with answer...');
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
                            console.log('Patient: Remote description set successfully');

                            // Process any queued candidates after setting the description
                            if (iceCandidateQueue.length > 0) {
                                console.log(`Patient: Processing ${iceCandidateQueue.length} queued ICE candidates`);
                                for (const candidate of iceCandidateQueue) {
                                    try {
                                        await peerConnection.addIceCandidate(candidate);
                                        console.log('Patient: Queued ICE candidate added successfully');
                                    } catch (error) {
                                        console.warn('Patient: Failed to add queued candidate:', error);
                                    }
                                }
                                iceCandidateQueue = [];
                            }
                        } else {
                            console.warn('Patient: Cannot handle answer - wrong signaling state:', peerConnection.signalingState);
                            console.warn('Patient: Expected "have-local-offer" but got:', peerConnection.signalingState);

                            // If we're in stable state but expecting an answer, this indicates a collision
                            // The doctor might have also initiated a call
                            if (peerConnection.signalingState === 'stable') {
                                console.log('Patient: Detected collision - both peers trying to call. Patient will wait...');
                                // Wait for the doctor's offer to arrive and be processed
                                setTimeout(() => {
                                    if (peerConnection && peerConnection.signalingState === 'stable') {
                                        console.log('Patient: No doctor offer received, retrying as caller...');
                                        startCall();
                                    }
                                }, 2000);
                            }
                        }
                    } else if (type === 'ice') {
                        console.log('Patient: Received ICE candidate');
                        const candidate = new RTCIceCandidate(data);

                        if (peerConnection.remoteDescription) {
                            try {
                                await peerConnection.addIceCandidate(candidate);
                                console.log('Patient: ICE candidate added successfully');
                            } catch (error) {
                                console.warn('Patient: Failed to add ICE candidate:', error);
                            }
                        } else {
                            console.log('Patient: Queueing ICE candidate (no remote description yet)');
                            iceCandidateQueue.push(candidate);
                        }
                    }
                } catch (error) {
                    console.error('Patient: Error handling signaling message:', error);
                    console.error('Patient: Signaling state:', peerConnection?.signalingState);
                    console.error('Patient: Connection state:', peerConnection?.connectionState);
                    console.error('Patient: Error details:', error.message);
                }
            }

            function resetConnection() {
                console.log('Patient: Resetting connection due to collision...');

                // Close existing connection
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }

                // Clear queues
                iceCandidateQueue = [];
                offerQueue = [];

                // Reset retry state
                retryCount = 0;
                retryDelay = 1000;

                // Create new peer connection
                createPeerConnection();

                console.log('Patient: Connection reset complete');
            }

            function sendSignalingMessage(type, data) {
                console.log(`Patient: Sending ${type} via signaling`);
                fetch(`${API_BASE_URL}/v1/webrtc/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appointmentId: currentAppointmentId, data: data })
                }).catch(error => {
                    console.error('Patient: Signaling error:', error);
                    // Retry signaling after a short delay
                    setTimeout(() => {
                        console.log(`Patient: Retrying ${type} signaling`);
                        sendSignalingMessage(type, data);
                    }, 2000);
                });
            }

            async function sendSignalingMessageWithRetry(type, data) {
                return new Promise((resolve, reject) => {
                    const attemptSend = (attemptNumber) => {
                        console.log(`Patient: Sending ${type} via signaling (attempt ${attemptNumber})`);

                        fetch(`${API_BASE_URL}/v1/webrtc/${type}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ appointmentId: currentAppointmentId, data: data })
                        }).then(() => {
                            console.log(`Patient: ${type} sent successfully`);
                            resolve();
                        }).catch(error => {
                            console.error(`Patient: Signaling error on attempt ${attemptNumber}:`, error);

                            if (attemptNumber < maxRetries) {
                                const delay = retryDelay * Math.pow(2, attemptNumber - 1);
                                console.log(`Patient: Retrying ${type} in ${delay}ms...`);
                                setTimeout(() => attemptSend(attemptNumber + 1), delay);
                            } else {
                                console.error(`Patient: Max retries reached for ${type}`);
                                reject(error);
                            }
                        });
                    };

                    attemptSend(1);
                });
            }


            function pollSignaling() {
                if (!currentAppointmentId) return;

                fetch(`${API_BASE_URL}/v1/webrtc/poll?appointmentId=${currentAppointmentId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(messages => {
                        if (messages && messages.length > 0) {
                            console.log(`Patient: Received ${messages.length} signaling messages`);
                            messages.forEach((msg, index) => {
                                console.log(`Patient: Processing message ${index + 1}:`, msg);
                                handleSignalingMessage(msg.type, msg.data);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Patient: Polling error:', error);
                        // Don't show error to user for polling failures, just log them
                    });
            }

            function showConnectionStatus(message, type = 'info') {
                const statusDiv = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');

                if (statusDiv && statusText) {
                    statusText.textContent = message;

                    // Set color based on type
                    switch (type) {
                        case 'success':
                            statusDiv.style.background = 'rgba(34, 197, 94, 0.2)';
                            statusDiv.style.color = '#16a34a';
                            break;
                        case 'error':
                            statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                            statusDiv.style.color = '#ef4444';
                            break;
                        case 'warning':
                            statusDiv.style.background = 'rgba(245, 158, 11, 0.2)';
                            statusDiv.style.color = '#f59e0b';
                            break;
                        default:
                            statusDiv.style.background = 'rgba(0, 0, 0, 0.1)';
                            statusDiv.style.color = 'inherit';
                    }

                    statusDiv.style.display = 'block';
                }
            }

            function hideConnectionStatus() {
                const statusDiv = document.getElementById('connectionStatus');
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
            }

            function showVideoStatus(message, type = 'info') {
                const statusDiv = document.getElementById('videoStatus');
                const statusText = document.getElementById('videoStatusText');

                if (statusDiv && statusText) {
                    statusText.textContent = message;

                    // Set color based on type
                    switch (type) {
                        case 'success':
                            statusDiv.style.color = '#16a34a';
                            break;
                        case 'error':
                            statusDiv.style.color = '#ef4444';
                            break;
                        case 'warning':
                            statusDiv.style.color = '#f59e0b';
                            break;
                        default:
                            statusDiv.style.color = 'inherit';
                    }

                    statusDiv.style.display = 'block';
                }
            }

            function hideVideoStatus() {
                const statusDiv = document.getElementById('videoStatus');
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
            }

            function toggleAudio() {
                if (localStream) {
                    const audioTracks = localStream.getAudioTracks();
                    audioTracks.forEach(track => {
                        track.enabled = isAudioMuted;
                    });
                    isAudioMuted = !isAudioMuted;
                    document.getElementById('muteAudioBtn').textContent = isAudioMuted ? 'Unmute Audio' : 'Mute Audio';
                }
            }

            function toggleVideo() {
                if (localStream) {
                    const videoTracks = localStream.getVideoTracks();
                    videoTracks.forEach(track => {
                        track.enabled = isVideoMuted;
                    });
                    isVideoMuted = !isVideoMuted;
                    document.getElementById('muteVideoBtn').textContent = isVideoMuted ? 'Unmute Video' : 'Mute Video';
                }
            }

            function endCall() {
                try {
                    console.log('Ending call...');

                    // Stop local media tracks
                    if (localStream) {
                        localStream.getTracks().forEach(track => {
                            console.log('Stopping track:', track.kind);
                            track.stop();
                        });
                        localStream = null;
                    }

                    // Close peer connection
                    if (peerConnection) {
                        peerConnection.close();
                        peerConnection = null;
                    }

                    // Close data channel
                    if (dataChannel) {
                        dataChannel.close();
                        dataChannel = null;
                    }

                    // Reset UI
                    const callScreen = document.getElementById('callScreen');
                    if (callScreen) {
                        callScreen.classList.remove('active');
                    }

                    const remoteVideo = document.getElementById('remoteVideo');
                    if (remoteVideo) {
                        remoteVideo.srcObject = null;
                    }

                    const localVideo = document.getElementById('localVideo');
                    if (localVideo) {
                        localVideo.srcObject = null;
                    }

                    const messages = document.getElementById('messages');
                    if (messages) {
                        messages.innerHTML = '';
                    }

                    const startCallBtn = document.getElementById('startCallBtn');
                    if (startCallBtn) {
                        startCallBtn.disabled = false;
                        startCallBtn.textContent = 'Start Call';
                    }

                    // Reset state
                    currentAppointmentId = null;
                    isCallActive = false;
                    iceCandidateQueue = [];
                    offerQueue = [];
                    isInitiator = false;
                    retryCount = 0;
                    retryDelay = 1000;

                    // Hide connection status when call ends
                    hideConnectionStatus();

                    // Reset UI - reuse the existing variable from earlier in the function
                    if (startCallBtn) {
                        startCallBtn.disabled = false;
                        startCallBtn.textContent = 'Start Call';
                    }

                    console.log('Call ended successfully');
                } catch (error) {
                    console.error('Error ending call:', error);
                }
            }

            function sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                if (message && dataChannel && dataChannel.readyState === 'open') {
                    dataChannel.send(message);
                    displayMessage(message, 'patient');
                    input.value = '';
                }
            }

            function displayMessage(message, sender) {
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                messageDiv.textContent = message;
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            function handleConnectionFailure() {
                console.error('Patient: Connection failure detected');

                // Get detailed error information
                let errorDetails = 'Unknown error occurred';
                if (peerConnection) {
                    errorDetails = `Connection State: ${peerConnection.connectionState}, Signaling State: ${peerConnection.signalingState}, ICE State: ${peerConnection.iceConnectionState}`;
                    console.error('Patient: Detailed connection info:', {
                        connectionState: peerConnection.connectionState,
                        signalingState: peerConnection.signalingState,
                        iceConnectionState: peerConnection.iceConnectionState,
                        iceGatheringState: peerConnection.iceGatheringState
                    });
                }

                // Show detailed error message
                const errorMessage = `Video call connection failed.
Details: ${errorDetails}

Possible solutions:
• Check your internet connection
• Allow camera and microphone permissions
• Try refreshing the page
• Contact support if the issue persists`;

                showConfirmationModal('Connection Failed', errorMessage);

                // Reset call state
                endCall();
            }

            function handlePeerDisconnection() {
                console.log('Peer disconnected, attempting to reconnect...');

                // Show reconnection status to user
                const startCallBtn = document.getElementById('startCallBtn');
                if (startCallBtn) {
                    startCallBtn.textContent = 'Reconnecting...';
                    startCallBtn.disabled = true;
                }

                // Attempt to reconnect after a short delay
                setTimeout(() => {
                    if (isCallActive && peerConnection) {
                        console.log('Attempting to reconnect...');
                        startCall();
                    }
                }, 2000);
            }

            function processQueuedOffers() {
                if (offerQueue.length === 0) return;

                if (peerConnection && (peerConnection.signalingState === 'stable' || peerConnection.signalingState === 'have-local-offer')) {
                    console.log('Processing queued offers:', offerQueue.length);
                    const offer = offerQueue.shift();

                    // Recursively call handleSignalingMessage with the queued offer
                    handleSignalingMessage('offer', offer);

                    // Process remaining offers if any
                    if (offerQueue.length > 0) {
                        setTimeout(processQueuedOffers, 500);
                    }
                } else {
                    // Still not ready, try again later
                    console.log('Still not ready to process offers, current state:', peerConnection?.signalingState);
                    setTimeout(processQueuedOffers, 1000);
                }
            }

            async function loadDashboard() {
                try {
                    // --- CORRECTED CODE ---
                    // Switched from 'credentials: include' to the reliable userId parameter
                    const response = await fetch(`${API_BASE_URL}/v1/dashboard?userId=${user.patientId}`);
                    // --- END OF CORRECTION ---

                    const data = await response.json();
                    if (data.success) {
                        // Update next appointment
                        const nextApptCard = document.querySelector('.dashboard-grid .info-card');
                        if (nextApptCard) {
                            const highlight = nextApptCard.querySelector('.highlight');
                            const doctorP = nextApptCard.querySelector('p:last-child');
                            if (data.nextAppointment) {
                                const date = new Date(data.nextAppointment.dateTime);
                                highlight.textContent = date.toLocaleDateString() + ', ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                                doctorP.textContent = data.nextAppointment.doctorName;
                            } else {
                                highlight.textContent = 'No upcoming appointment';
                                doctorP.textContent = '';
                            }
                        }
                        // Update prescription count
                        const prescCard = document.getElementById('viewAllPrescriptions');
                        if (prescCard) {
                            const highlight = prescCard.querySelector('.highlight');
                            highlight.textContent = data.prescriptionCount + ' Total';
                        }
                    }
                } catch (e) {
                    console.error('Failed to load dashboard:', e);
                }
            }

            function setupWebRTC() {
                document.getElementById('startCallBtn').addEventListener('click', startCall);
                document.getElementById('muteAudioBtn').addEventListener('click', toggleAudio);
                document.getElementById('muteVideoBtn').addEventListener('click', toggleVideo);
                document.getElementById('endCallBtn').addEventListener('click', endCall);
                document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
                document.getElementById('messageInput').addEventListener('keypress', e => {
                    if (e.key === 'Enter') sendMessage();
                });

                // Poll for signaling messages
                setInterval(pollSignaling, 1000);

                // Test function for debugging WebRTC issues
                function testWebRTCConnection() {
                    console.log('Patient: Testing WebRTC connection...');

                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        console.error('Patient: WebRTC not supported');
                        showConnectionStatus('WebRTC not supported in this browser', 'error');
                        return false;
                    }

                    // Test media device access
                    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                        .then(stream => {
                            console.log('Patient: Media device test successful');
                            stream.getTracks().forEach(track => track.stop()); // Stop test stream
                            showConnectionStatus('WebRTC test successful - ready for calls', 'success');
                            return true;
                        })
                        .catch(error => {
                            console.error('Patient: Media device test failed:', error);
                            showConnectionStatus('Media device test failed: ' + error.message, 'error');
                            return false;
                        });

                    return true;
                }

                // Add test button event listener for debugging
                document.addEventListener('keydown', function(e) {
                    // Press Ctrl+Shift+T to test WebRTC
                    if (e.ctrlKey && e.shiftKey && e.key === 'T') {
                        testWebRTCConnection();
                    }
                });
            }

            // Medicine Reminder Functions
            async function checkMedicineReminders() {
                try {
                    const response = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.patientId,
                            action: 'get'
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        updateRemindersDisplay(data.reminders, data.pending_alerts);
                    }
                } catch (error) {
                    console.error('Medicine reminders check error:', error);
                }
            }

            function updateRemindersDisplay(reminders, alerts) {
                // Update home screen counter
                const pendingEl = document.getElementById('pendingReminders');
                if (pendingEl) {
                    pendingEl.textContent = `${alerts.length} Pending`;
                }

                // Show alerts in chat if any
                if (alerts.length > 0 && document.getElementById('chatbotScreen').classList.contains('active')) {
                    showMedicineAlerts(alerts);
                }
            }

            function showMedicineAlerts(alerts) {
                const chatWindow = document.getElementById('chatWindow');
                if (!chatWindow) return;

                alerts.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'medicine-reminder-card card';
                    alertDiv.innerHTML = `
                        <div class="reminder-item">
                            <div class="reminder-info">
                                <h4>⏰ Medicine Reminder</h4>
                                <p><strong>${alert.medicine_name}</strong> - ${alert.dosage}</p>
                                <p>Time: ${alert.time}</p>
                            </div>
                            <div class="reminder-actions">
                                <button class="btn-taken" onclick="markMedicineTaken('${alert.medicine_name}')">Taken</button>
                                <button class="btn-skip" onclick="skipMedicine('${alert.medicine_name}')">Skip</button>
                            </div>
                        </div>
                    `;
                    chatWindow.appendChild(alertDiv);
                });

                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            

            

            async function loadPrescriptionReminders() {
                try {
                    console.log('Loading prescription reminders for user:', user.patientId);
                    // Get user's prescription summary
                    const response = await fetch(`${API_BASE_URL}/v1/prescription-summary`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.patientId
                        })
                    });

                    console.log('Prescription summary response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('Prescription summary data:', data);

                    if (data.success && data.prescription_summary.medications) {
                        showPrescriptionBasedReminders(data.prescription_summary);
                    }
                } catch (error) {
                    console.error('Load prescription reminders error:', error);
                }
            }

            function showAllPrescriptionSources() {
                const chatWindow = document.getElementById('chatWindow');
                if (!chatWindow) return;

                // Show prescription sources summary
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'medicine-reminder-card card';
                sourcesDiv.innerHTML = `
                    <h4>📋 Prescription Summary</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                        <div style="background: rgba(0,123,255,0.1); padding: 1rem; border-radius: 8px;">
                            <h5 style="color: #007bff; margin: 0 0 0.5rem 0;">👨‍⚕️ Doctor Prescriptions</h5>
                            <p style="margin: 0; font-size: 0.9rem;">From completed appointments</p>
                            <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;">Auto-generates medicine reminders</p>
                        </div>
                        <div style="background: rgba(255,193,7,0.1); padding: 1rem; border-radius: 8px;">
                            <h5 style="color: #ffc107; margin: 0 0 0.5rem 0;">📱 Patient Uploads</h5>
                            <p style="margin: 0; font-size: 0.9rem;">Scanned prescription images</p>
                            <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;">AI extracts medicine details</p>
                        </div>
                    </div>
                    <p style="font-size: 0.9rem; opacity: 0.8; text-align: center;">
                        💡 Both sources automatically create medicine reminders for better health compliance.
                    </p>
                `;
                chatWindow.appendChild(sourcesDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
            function displaySummaryInChat(summaryText) {
                if (!summaryText) {
                    console.log('No summary text provided to display.');
                    return;
                }
                const chatWindow = document.getElementById('chatWindow');
                if (chatWindow) {
                    const summaryCard = document.createElement('div');
                    summaryCard.className = 'card';
                    summaryCard.style.cssText = `
                        background: linear-gradient(135deg, #667eea, #764ba2); 
                        color: white; 
                        margin: 0.5rem 0;
                    `;
                    summaryCard.innerHTML = `
                        <h4>📋 Prescription Summary</h4>
                        <p style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.5rem;">
                            ${summaryText.replace(/\n/g, '<br>')}
                        </p>`;
                    chatWindow.appendChild(summaryCard);
                    // Scroll to the bottom to make it visible
                    setTimeout(() => { chatWindow.scrollTop = chatWindow.scrollHeight; }, 50);
                }
            }

            async function testPrescriptionEndpoint() {
                try {
                    console.log('Testing prescription endpoint...');
                    const response = await fetch(`${API_BASE_URL}/v1/test-prescription`, {
                        method: 'GET'
                    });

                    console.log('Test endpoint response status:', response.status);

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Test endpoint working:', data);
                    } else {
                        console.error('Test endpoint failed:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('Test endpoint error:', error);
                }
            }


            



            function showPrescriptionBasedReminders(prescriptionData) {
                const chatWindow = document.getElementById('chatWindow');
                if (!chatWindow) return;

                const medications = prescriptionData.medications;
                if (medications && medications.length > 0) {
                    const reminderDiv = document.createElement('div');
                    reminderDiv.className = 'medicine-reminder-card card';
                    reminderDiv.innerHTML = `
                        <h4>💊 Prescription-Based Medicine Reminders</h4>
                        <p><strong>Doctor:</strong> ${prescriptionData.doctor_name || 'Doctor'}</p>
                        <p><strong>Medications Found:</strong> ${medications.length}</p>
                        <div style="margin-top: 1rem;">
                            ${medications.map(med => `
                                <div class="reminder-item">
                                    <div class="reminder-info">
                                        <strong>${med.name}</strong> - ${med.dosage || 'As prescribed'}
                                        <br><small>${med.frequency || 'Timing not specified'}</small>
                                    </div>
                                    <div class="reminder-actions">
                                        <button class="btn-taken" onclick="createReminderFromPrescription('${med.name}', '${med.dosage || ''}', '${med.frequency || ''}')">Set Reminder</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
                            💡 These reminders are auto-generated from your prescriptions. Click "Set Reminder" to schedule daily alerts.
                        </p>
                    `;
                    chatWindow.appendChild(reminderDiv);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }

            

            async function saveMedicineReminder(isEdit = false) {
                const medicineName = document.getElementById('medicineName').value.trim();
                const dosage = document.getElementById('medicineDosage').value.trim();
                const times = document.getElementById('medicineTimes').value.trim();
                const duration = document.getElementById('medicineDuration').value;
                const instructions = document.getElementById('medicineInstructions').value.trim();

                if (!medicineName || !dosage || !times) {
                    alert('Please fill in all required fields');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.patientId,
                            action: 'add',
                            medicine_name: medicineName,
                            dosage: dosage,
                            times: times.split(',').map(t => t.trim()),
                            duration_days: parseInt(duration),
                            instructions: instructions
                        })
                    });

                    if (response.ok) {
                        document.getElementById('medicineReminderModal').classList.remove('active');
                        // Clear form
                        document.getElementById('medicineName').value = '';
                        document.getElementById('medicineDosage').value = '';
                        document.getElementById('medicineTimes').value = '';
                        document.getElementById('medicineDuration').value = '30';
                        document.getElementById('medicineInstructions').value = '';

                        // Refresh reminders display
                        await loadMedicineRemindersScreen();
                        await checkMedicineReminders(); // Also refresh home screen counter

                        const actionText = isEdit ? 'updated' : 'added';
                        showConfirmationModal('Success', `Medicine reminder ${actionText} successfully!`);
                    } else {
                        throw new Error('Failed to save reminder');
                    }
                } catch (error) {
                    console.error('Save reminder error:', error);
                    alert('Failed to save medicine reminder. Please try again.');
                }
            }

            // Enhanced SOS Detection in Chatbot
            async function checkForEmergency(message) {
                try {
                    const response = await fetch(`${API_BASE_URL}/v1/enhanced-sos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.patientId,
                            message: message,
                            language: currentLanguage
                        })
                    });

                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('SOS detection error:', error);
                    return { emergency_detected: false };
                }
            }

            // Function to load and display medicine reminders in the dedicated screen
            async function loadMedicineRemindersScreen() {
                try {
                    const response = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.patientId,
                            action: 'get'
                        })
                    });

                    const data = await response.json();
                    const container = document.getElementById('remindersContainer');

                    if (data.success && data.reminders && data.reminders.length > 0) {
                        container.innerHTML = `
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">Active Reminders</h3>
                                <p style="color: var(--text-color-secondary);">${data.total_reminders} medicine reminder(s) scheduled</p>
                            </div>
                            ${data.reminders.map(reminder => `
                                <div class="medicine-card card">
                                    <div class="medicine-name">${reminder.medicine_name}</div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                                        <div>
                                            <strong>Dosage:</strong> ${reminder.dosage}<br>
                                            <strong>Frequency:</strong> ${reminder.frequency}<br>
                                            <strong>Duration:</strong> ${reminder.duration_days} days
                                        </div>
                                        <div>
                                            <strong>Times:</strong><br>
                                            ${reminder.times.map(time => `<span style="display: inline-block; background: var(--primary-color); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; margin: 0.125rem; font-size: 0.8rem;">${time}</span>`).join('')}
                                        </div>
                                    </div>
                                    ${reminder.instructions ? `<div style="margin-bottom: 1rem;"><strong>Instructions:</strong> ${reminder.instructions}</div>` : ''}
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button class="btn btn-primary" onclick="markMedicineTaken('${reminder.medicine_name}')">Mark as Taken</button>
                                        <button class="btn" onclick="editReminder('${reminder.medicine_name}')" style="background: var(--color-secondary);">Edit</button>
                                        <button class="btn" onclick="deleteReminder('${reminder.medicine_name}')" style="background: #ef4444; color: white;">Delete</button>
                                    </div>
                                </div>
                            `).join('')}
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="card" style="text-align: center; padding: 3rem;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">💊</div>
                                <h3>No Medicine Reminders</h3>
                                <p style="color: var(--text-color-secondary); margin-bottom: 2rem;">You don't have any active medicine reminders yet.</p>
                            </div>
                        `;
                    }

                    // Show pending alerts if any
                    if (data.pending_alerts && data.pending_alerts.length > 0) {
                        const alertsHtml = data.pending_alerts.map(alert => `
                            <div class="medicine-reminder-card card" style="border-left: 4px solid var(--sos-color);">
                                <div class="reminder-item">
                                    <div class="reminder-info">
                                        <h4>⏰ Pending Reminder</h4>
                                        <p><strong>${alert.medicine_name}</strong> - ${alert.dosage}</p>
                                        <p>Scheduled for: ${alert.time}</p>
                                    </div>
                                    <div class="reminder-actions">
                                        <button class="btn-taken" onclick="markMedicineTaken('${alert.medicine_name}')">Mark Taken</button>
                                        <button class="btn-skip" onclick="skipMedicine('${alert.medicine_name}')">Skip</button>
                                    </div>
                                </div>
                            </div>
                        `).join('');

                        container.insertAdjacentHTML('afterbegin', `
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="color: var(--sos-color);">⚠️ Pending Alerts</h3>
                                ${alertsHtml}
                            </div>
                        `);
                    }
                } catch (error) {
                    console.error('Load medicine reminders screen error:', error);
                    const container = document.getElementById('remindersContainer');
                    container.innerHTML = `
                        <div class="card" style="text-align: center; padding: 3rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">❌</div>
                            <h3>Failed to Load Reminders</h3>
                            <p style="color: var(--text-color-secondary);">There was an error loading your medicine reminders. Please try again.</p>
                            <button class="btn btn-primary" onclick="loadMedicineRemindersScreen()">Retry</button>
                        </div>
                    `;
                }
            }



            // Function to edit a medicine reminder
           // --- START: FULLY FUNCTIONAL REMINDER BLOCK ---

            // Global variable to track the original name of the reminder being edited
            let currentlyEditing = null;

            // Make functions globally accessible for onclick attributes
            window.markMedicineTaken = async function(medicineName) {
                // ... (This function remains the same as before)
                try {
                    const response = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.patientId,
                            action: 'update_adherence',
                            medicine_name: medicineName,
                            taken_time: new Date().toTimeString().slice(0, 5)
                        })
                    });
                    if (response.ok) {
                        await loadMedicineRemindersScreen();
                        showConfirmationModal('Success', `${medicineName} marked as taken!`);
                    }
                } catch (error) {
                    console.error('Mark medicine taken error:', error);
                }
            }

            window.skipMedicine = async function(medicineName) {
                await loadMedicineRemindersScreen();
            }

            window.deleteReminder = async function(medicineName) {
                if (!confirm(`Are you sure you want to delete the reminder for ${medicineName}?`)) {
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.patientId,
                            action: 'delete',
                            medicine_name: medicineName
                        })
                    });
                    if (response.ok) {
                        showConfirmationModal('Reminder Deleted', `The reminder for ${medicineName} has been removed.`);
                        await loadMedicineRemindersScreen(); // Refresh the display
                    }
                } catch (error) {
                    console.error('Delete reminder error:', error);
                    showConfirmationModal('Error', 'Failed to delete reminder.');
                }
            }

            // ENHANCED editReminder function
            window.editReminder = async function(medicineName) {
                const remindersResponse = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.patientId, action: 'get' })
                });
                const data = await remindersResponse.json();
                const reminderData = data.reminders.find(r => r.medicine_name === medicineName);

                if (reminderData) {
                    // --- NEW: Pre-fill the form with existing data ---
                    document.getElementById('medicineName').value = reminderData.medicine_name;
                    document.getElementById('medicineDosage').value = reminderData.dosage;
                    document.getElementById('medicineTimes').value = reminderData.times.join(', ');
                    document.getElementById('medicineDuration').value = reminderData.duration_days;
                    document.getElementById('medicineInstructions').value = reminderData.instructions;

                    // --- NEW: Track which item is being edited and change button text ---
                    currentlyEditing = reminderData.medicine_name; // Store original name
                    document.getElementById('saveReminderBtn').textContent = 'Update Reminder';
                    document.getElementById('medicineReminderModal').classList.add('active');
                } else {
                    showConfirmationModal('Error', 'Could not find reminder details to edit.');
                }
            }
            
            // ENHANCED saveMedicineReminder function
            async function saveMedicineReminder() {
                const isEdit = currentlyEditing !== null;
                const action = isEdit ? 'update' : 'add';

                const medicineName = document.getElementById('medicineName').value.trim();
                // ... (rest of the data fetching from form)
                const dosage = document.getElementById('medicineDosage').value.trim();
                const times = document.getElementById('medicineTimes').value.trim();
                const duration = document.getElementById('medicineDuration').value;
                const instructions = document.getElementById('medicineInstructions').value.trim();


                if (!medicineName || !dosage || !times) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                let payload = {
                    userId: user.patientId,
                    action: action,
                    medicine_data: {
                        name: medicineName,
                        dosage: dosage,
                        times: times.split(',').map(t => t.trim()),
                        duration_days: parseInt(duration),
                        instructions: instructions
                    }
                };

                // If editing, add the original name to identify which reminder to update
                if (isEdit) {
                    payload.original_medicine_name = currentlyEditing;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/v1/medicine-reminders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        document.getElementById('medicineReminderModal').classList.remove('active');
                        document.getElementById('medicineReminderForm').reset();

                        // --- NEW: Reset editing state ---
                        currentlyEditing = null;
                        document.getElementById('saveReminderBtn').textContent = 'Save Reminder';
                        
                        await loadMedicineRemindersScreen();
                        await checkMedicineReminders(); 

                        const actionText = isEdit ? 'updated' : 'added';
                        showConfirmationModal('Success', `Medicine reminder ${actionText} successfully!`);
                    } else {
                        throw new Error('Failed to save reminder');
                    }
                } catch (error) {
                    console.error('Save reminder error:', error);
                    alert('Failed to save medicine reminder. Please try again.');
                }
            }
            
            // --- END: FULLY FUNCTIONAL REMINDER BLOCK ---
            // New function to handle page load
            function loadAndDisplaySummary() {
                fetch(`${API_BASE_URL}/v1/prescription-summary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.patientId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.formatted_response) {
                        displaySummaryInChat(data.formatted_response);
                    }
                })
                .catch(error => console.error('Error fetching summary on page load:', error));
            }

            

            async function initializeApp() {
                if (!checkAuth()) return;
                await loadDoctors();
                updateUIText();
                setupNavigation();
                setupThemeAndLanguage();
                generateTimeline();
                await loadBookingData(); // <<< ADD THIS LINE
                await generateAppointments();
                await generateAllPrescriptions();
                await loadDashboard();
                await loadChatHistory(); // Add this line
                generateOrdersList();

                loadAndDisplaySummary(); // <-- Use our new function
                renderBookingStep(1);
                setupModalsAndActions();
                setupScanMedicine();
                setupBookMedicine();
                setupUploadPrescription();
                setupChatbot();
                setupWebRTC();

                // Check for post-appointment follow-up
                await checkPostAppointmentFollowup();

                // If medicine reminders screen is active, load reminders
                if (document.getElementById('medicineRemindersScreen').classList.contains('active')) {
                    await loadMedicineRemindersScreen();
                }
            }

            // Post-appointment follow-up check
            async function checkPostAppointmentFollowup() {
                try {
                    const response = await fetch(`${API_BASE_URL}/v1/user-progress`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: user.patientId })
                    });

                    const data = await response.json();
                    if (data.followup && data.followup.needed) {
                        // Show follow-up message in chat if chat is active
                        const chatWindow = document.getElementById('chatWindow');
                        if (chatWindow && chatWindow.children.length > 0) {
                            const followupMessage = document.createElement('div');
                            followupMessage.className = 'chat-message bot-message';
                            followupMessage.textContent = 'How are you feeling after your appointment?';
                            chatWindow.appendChild(followupMessage);
                        }
                    }
                } catch (error) {
                    console.error('Follow-up check error:', error);
                }
            }

            initializeApp();
        });
    </script>
</body>
</html>
